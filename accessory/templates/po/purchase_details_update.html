
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}

<style>

        /* Chrome, Safari, Edge, Opera */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
    }

    /* Firefox */
    input[type=number] {
    -moz-appearance: textfield;
    }

</style>
<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row">
                            <div class="col-sm-12"> 
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title">
                                            <h4 class="m-b-10">Accessory PO  Update</h4>
                                        </div>
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Accessories</a></li>
                                            <li class="breadcrumb-item"><a href="/accessory-po">Accessory PO </a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>


                                
                                 
                                    <div class="card">
 
                                        <div class="card-body row">
                                            <div class="col-sm-12">
                                                
                                                <div class="row">
                                                 <div class="col-md-9">
                    
                                                    {% for po in po %}
                                                    <h2>{{po.po_date}}</h2>
                                                    {% endfor %}
                    
                    
                                                        <form id="update_tm_form">
                                                            {% csrf_token %}
                                                            <div class="row ">

                                                                <div class="col-md-2 mt-2">
                                                                    <label for="order_date" class="form-label">PO No.</label>
                                                                    <input class="form-control" type="text" name="po_no" id="po_no" value="{{parent_stock_instance.po_number}}" disabled>
                                                                    <input class="form-control" type="hidden" name="tm_id" id="tm_id" value="{{parent_stock_instance.id}}" disabled>
                                                                </div>


                                                                 <div class="col-md-2 mt-2">
                                                                     <label for="order_date" class="form-label">PO Date</label>
                                                                     <input class="form-control" type="date" name="po_date" id="po_date" >
                                                                 </div>

                                                                 <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">Party </label>
                                                                    <select id="party_id" name="party_id" class="form-control single-select" >
                                                                        <option value="">Select</option> 
                                                                        {% for k in supplier %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                                

                                                            <!-- <div class="col-md-2 mt-2">
                                                                <label for="order_date" class="form-label">PO Name</label>
                                                                 <input class="form-control" id="po_name" dir="ltr" style="position: relative;width: 150px; vertical-align: top; background-color: transparent;"
                                                                 value="{{parent_stock_instance.po_name}}" name="po_name" type="text" placeholder="PO NAME">
                                                            </div> -->

                                                    

                                                            <div class="col-md-2 mt-4">
                                                                <input type="hidden" id="edit_id" name="edit_id">
                                                                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                                                <button type="submit" id="update_tm" class="btn btn-primary mt-3">Update</button>

                                                            </div>

                                                                
                                                            </div>
                                                        </form>
                    
                                                        <form id="add_new">
                                                            {% csrf_token %}
                                                            <div class="row ">
                                                      
                    
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="product_id" class="form-label">Item Group</label>
                                                                    <select id="item_group_id" name="item_group_id" class="form-control single-select" onchange="LoadItem()">
                                                                        <!-- onchange="uom_load()" -->
                                                                        <option value="">Select</option>
                                                                        {% for k in item_group %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="product_id" class="form-label">Item</label>
                                                                    <select id="item_id" name="item_id" class="form-control single-select" onchange="LoadAccData()">
                                                                        <!-- onchange="uom_load()" -->
                                                                        <option value="">Select</option>
                                                                        {% for k in item %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                                

                                                                <div class="col-md-2 mt-2">
                                                                    <label for="quality_id" class="form-label">Quality </label>
                                                                    <select id="quality_id" name="quality_id" class="form-control form-select single-select" >
                                                                        <!-- onchange="uom_load()" -->
                                                                        <option value="">Select</option>
                                                                        {% for k in quality %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>


                                                                <div class="col-md-2 mt-2">
                                                                    <label for="size_id" class="form-label">Size </label>
                                                                    <select id="size_id" name="size_id" class="form-control form-select single-select" >
                                                                        <!-- onchange="uom_load()" -->
                                                                        <option value="">Select</option>
                                                                        {% for k in size %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>


                                                                <div class="col-md-2 mt-2">
                                                                    <label for="color_id" class="form-label">Color </label>
                                                                    <select id="color_id" name="color_id" class="form-control form-select single-select" >
                                                                        <!-- onchange="uom_load()" -->
                                                                        <option value="">Select</option>
                                                                        {% for k in color %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>


 

                                                          
                                                                
                                                            
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="rate" class="form-label">Rate</label>
                                                                    <input type="number" class="form-control" step="0.001" id="rate" name="rate" oninput="validateDecimal3(this)" >
                                                                </div>
 
                                                                <div class="col-md-2 mt-2 mb-3">
                                                                    <label for="quantity" class="form-label">Quantity </label>
                                                                    <input type="number" class="form-control" name="quantity" id="quantity"  >
                                                                </div>


                                                            
                                                                <div class="col-md-2 mt-2 me-2">
                                                                    <label for="amount" class="form-label">Amount</label>
                                                                    <input type="number" step="0.001" class="form-control" id="amount" name="amount" readonly oninput="validateDecimal3(this)">
                                                                 </div>



 
 
                                                               
                                                            
                                                                <div class="col-md-1 mt-4">
                                                                    <input type="hidden" id="edit_id" name="edit_id">
                                                                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                                                    <button type="submit" id="update" class="btn btn-primary mt-3">+ADD</button>

                                                                </div>

                                                            </div> 
                                                        </form>
                                                    </div>
                                                   


                                                    <div class="col-md-3">
                                                        
                                                        <div class=" m-b-30">
                                                            <div class="card-body">            
                                                                <table id="summaryTable" class="table table-striped table-bordered w-100">
                                                                    <thead>
                                                                        <tr>
                                                                            <th colspan="2">Summary Table</th>
                                                                        </tr> 
                                                                    </thead>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td> Total Quantity</td>
                                                                            <td align="end" colspan="2" id="qty_total_placeholder">0</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td>Sub Total</td>
                                                                            <td align="end" colspan="2" id="sub_total_placeholder">0.000</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td>Total Tax</td>
                                                                            <td align="end" colspan="2" id="tax_placeholder">0.000</td>
                                                                        </tr>
    
                                                                        <tr>
                                                                            <td>Round off</td>
                                                                            <td align="end" colspan="2" id="round_off">0.000</td>
                                                                        </tr>
                                                                        <tr> 
                                                                            <td>Grand Total</td>
                                                                            <td style="background-color: #428bca; color: black; font-size: 21px" align="end" colspan="2" id="total_payable">0.00</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>     
                                                            </div>
                                                        </div>


                                                    </div>


                                                </div> 
                                           
                                                <hr>
                                                <!-- <form id="add_new"> -->
                                                    <div class="">

                                                        <div class="dt-responsive table-hover">
                                                            <input type="hidden" id="tm_id" name="tm_id" value="{{parent_stock_instance.id}}">

                                                            <table id="datatable" class="table table-striped table-bordered nowrap w-100" cellpadding="0" cellspacing="0">
                                                             
                                                             {% csrf_token %} 
                                                             
                                                             <thead>
                                                                    <tr> 
                                                                        <th>id</th>
                                                                        <th>Action</th>
                                                                        <th>Item Group</th>
                                                                        <th>Item</th>
                                                                        <th>Quality</th>
                                                                        <th>Size</th>
                                                                        <th>COlor</th>
                                                                        
                                                                        <th>Rate</th>
																		<th>Quantity</th>
                                                                        <th>Amount</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>                            
                                                                </tbody>
                                                            </table>                                        
                                                        </div>



                                                     
                                                    </div>
                                
                                               

                                               
                                            </div> 
                                        </div>
                                    </div>




                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'includes/footer.html' %}



<script>




if ("{{ parent_stock_instance.po_date }}" && "{{ parent_stock_instance.po_date }}" !== "") {
    var purchaseDate = "{{ parent_stock_instance.po_date }}";
    // Ensure it's in the correct format (YYYY-MM-DD)
    var formattedDate = new Date(purchaseDate).toISOString().split('T')[0];
    $('#po_date').val(formattedDate).trigger("change");
}

if ("{{ parent_stock_instance.delivery_date }}" && "{{ parent_stock_instance.delivery_date }}" !== "") {
    var purchaseDate = "{{ parent_stock_instance.delivery_date }}";
    // Ensure it's in the correct format (YYYY-MM-DD)
    var formattedDate = new Date(purchaseDate).toISOString().split('T')[0];
    $('#delivery_date').val(formattedDate).trigger("change");
}



if ("{{parent_stock_instance.party_id}}" && "{{parent_stock_instance.party_id}}" !== "") {
    $('#party_id').val("{{parent_stock_instance.party_id}}").trigger("change");
}




var id = $('#tm_id').val();
if (id !== '' && !isNaN(id)) {  // Check if id is not empty and is a number
    var table = $('#datatable').DataTable({
        "language": {
            "mesage": "Master purchase not hold any data related to child table !"
        },
        "processing": true,
        "pageLength": 50,
        "destroy": true,
        "order": [],
        columnDefs: [
        {
            targets: [8,9], // Ensure this matches the "Amount" column index
            render: function (data, type, row) {
                return new Intl.NumberFormat('en-IN', { 
                    style: 'currency', 
                    currency: 'INR' 
                }).format(data);
            },
            className: "text-end" // Aligns currency values to the right
        }
    ],
        
        "columns": [
            { "data": "id", "title": "ID" },
            { "data": "action", "title": "Action"},  
            { "data": "item_group", "title": " Item Group " },
            { "data": "item", "title": "Item" },
            { "data": "quality", "title": "Quality" },
            { "data": "size", "title": "Size" },
            { "data": "color", "title": "Color" },
            
            { "data": "rate", "title": "Rate" ,"className": "text-end","render": function (data, type, row) {
                 return parseFloat(data).toFixed(3);
                } },
			{ "data": "quantity", "title": "Quantity"},
            { "data": "amount", "title": "Amount" ,"className": "text-end" ,"render": function (data, type, row) {
                 return parseFloat(data).toFixed(3);
                }},
          
            
        ],
        "ajax": { 
            "url": '/update_po_lists/',
            "type": "POST",
            "data": function(data) {
                data.csrfmiddlewaretoken = $('[name="csrfmiddlewaretoken"]').val();
                data.id = id;  // Use validated id
                
            },
            "dataSrc": function(json) {
                console.log("Received JSON data:", json);

                // Use json.total_quantity directly for the summary update
                updateSummary({
                    total_quantity: json.total_quantity,
                    total_amount: json.total_amount,
                    tax_total: json.tax_total,
                    round_off: json.round_off,
                    grand_total: json.grand_total
                });



            if (json.message === "error") {
                // Display error message in an alert
                showToast('error',json.error_message);
                return []; // Return an empty data array for DataTable
            }
            return json.data; // Return the data if no error
        }
        }
    });
} else {
    console.error("Invalid id:", id);
    // Handle the case where id is invalid or empty
}

 
function updateSummary(data) {
    console.log("Updating summary with data:", data); // Debugging summary update

    $('#qty_total_placeholder').text(data.total_quantity || 0);
    $('#sub_total_placeholder').text(parseFloat(data.total_amount || 0).toFixed(3));
    $('#tax_placeholder').text(parseFloat(data.tax_total || 0).toFixed(3));
    $('#round_off').text(parseFloat(data.round_off || 0).toFixed(3));
    $('#total_payable').text(parseFloat(data.grand_total || 0).toFixed(3));
}




function refresh_data()
{
    table.ajax.reload();
}







document.addEventListener('DOMContentLoaded', function () {
    const rateField = document.getElementById('rate');
    const quantityField = document.getElementById('quantity');
    const amountField = document.getElementById('amount');

    function calculateAmount() {
        const rate = parseFloat(rateField.value) || 0;
        const quantity = parseFloat(quantityField.value) || 0;
        const amount = rate * quantity;

        amountField.value = amount.toFixed(3);
    }

    // Attach event listeners to trigger calculation
    rateField.addEventListener('input', calculateAmount);
    quantityField.addEventListener('input', calculateAmount);
});

    



function LoadItem(callback) {
    var item_group_id = $('#item_group_id').val();
    if (!item_group_id) return;

    $.ajax({
        type: 'GET',
        url: '/get_acc_item_list/',
        data: { 'item_group_id': item_group_id },
        dataType: 'json',
        success: function(data) {
            $('#item_id').empty().append('<option value="">Select</option>');
            if (data.success && data.items.length > 0) {
                $.each(data.items, function(index, item) {
                    $('#item_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }
            if (callback) callback(); // call after loading items
        }
    });
}



<!-- function LoadAccData(callback) { -->
    <!-- var item_id = $('#item_id').val(); -->
    <!-- if (!item_id) return; -->

    <!-- $.ajax({ -->
        <!-- type: 'GET', -->
        <!-- url: '/get_acc_list/', -->
        <!-- data: { 'item_id': item_id }, -->
        <!-- dataType: 'json', -->
        <!-- success: function(data) { -->
            <!-- $('#quality_id').empty().append('<option value="">Select</option>'); -->
            <!-- $('#size_id').empty().append('<option value="">Select</option>'); -->
            <!-- $('#color_id').empty().append('<option value="">Select</option>'); -->

            <!-- if (data.success) { -->
                <!-- if (data.qualities) { -->
                    <!-- $.each(data.qualities, function(index, item) { -->
                        <!-- $('#quality_id').append('<option value="' + item.id + '">' + item.name + '</option>'); -->
                    <!-- }); -->
                <!-- } -->
                <!-- if (data.sizes) { -->
                    <!-- $.each(data.sizes, function(index, item) { -->
                        <!-- $('#size_id').append('<option value="' + item.id + '">' + item.name + '</option>'); -->
                    <!-- }); -->
                <!-- } -->
                <!-- if (data.colors) { -->
                    <!-- $.each(data.colors, function(index, item) { -->
                        <!-- $('#color_id').append('<option value="' + item.id + '">' + item.name + '</option>'); -->
                    <!-- }); -->
                <!-- } -->
            <!-- } -->

            <!-- if (callback) callback(); // call after loading accessories -->
        <!-- } -->
    <!-- }); -->
<!-- } -->


function LoadAccData(callback, selectedValues = {}) {
    var item_id = $('#item_id').val();
    if (!item_id) return;

    $.ajax({
        type: 'GET',
        url: '/get_acc_list/',
        data: { 'item_id': item_id },
        dataType: 'json',
        success: function(data) {
            $('#quality_id').empty().append('<option value="">Select</option>');
            $('#size_id').empty().append('<option value="">Select</option>');
            $('#color_id').empty().append('<option value="">Select</option>');

            if (data.success) {
                if (data.qualities) {
                    $.each(data.qualities, function(index, item) {
                        $('#quality_id').append(`<option value="${item.id}">${item.name}</option>`);
                    });
                    if (selectedValues.quality_id) {
                        $('#quality_id').val(selectedValues.quality_id).trigger('change');
                    }
                }

                if (data.sizes) {
                    $.each(data.sizes, function(index, item) {
                        $('#size_id').append(`<option value="${item.id}">${item.name}</option>`);
                    });
                    if (selectedValues.size_id) {
                        $('#size_id').val(selectedValues.size_id).trigger('change');
                    }
                }

                if (data.colors) {
                    $.each(data.colors, function(index, item) {
                        $('#color_id').append(`<option value="${item.id}">${item.name}</option>`);
                    });
                    if (selectedValues.color_id) {
                        $('#color_id').val(selectedValues.color_id).trigger('change');
                    }
                }
            }

            if (typeof callback === 'function') callback();
        }
    });
}


<!-- function purchase_order_detail_edit(id) { -->
    <!-- var tkn = document.getElementsByName("csrfmiddlewaretoken")[0].value; -->

    <!-- $.post('/acc_po_detail_edit/', { id: id, csrfmiddlewaretoken: tkn }, function(res) { -->
        <!-- $('#tm_id').val(res.tm_id); -->
        <!-- $('#quantity').val(res.quantity); -->
        <!-- $('#rate').val(res.rate); -->
        <!-- $('#amount').val(res.amount);  -->

        <!-- // Load Item List first -->
        <!-- $('#item_group_id').val(res.item_group_id).trigger("change"); -->
        <!-- LoadItem(function() { -->
            <!-- $('#item_id').val(res.item_id); -->

            <!-- // Load accessory data once item is set -->
            <!-- LoadAccData(function() { -->
                <!-- $('#quality_id').val(res.quality_id); -->
                <!-- $('#size_id').val(res.size_id); -->
                <!-- $('#color_id').val(res.color_id); -->
            <!-- }); -->
			
			

        <!-- }); -->

        <!-- $('#update_flag').val('true'); -->
        <!-- $('#update').text('Update'); -->
    <!-- }); -->
<!-- } -->

function purchase_order_detail_edit(id) {
    var tkn = document.getElementsByName("csrfmiddlewaretoken")[0].value;

    $.post('/acc_po_detail_edit/', { id: id, csrfmiddlewaretoken: tkn }, function(res) {
        $('#tm_id').val(res.tm_id);
        $('#quantity').val(res.quantity);
        $('#rate').val(res.rate);
        $('#amount').val(res.amount);
        $('#edit_id').val(res.id || id);

        // Load Item List first
        $('#item_group_id').val(res.item_group_id).trigger("change");

        LoadItem(function() {
            $('#item_id').val(res.item_id).trigger('change');

            // Now load accessories and set values once loaded
            LoadAccData(function() {
                // Callback after data load
            }, {
                quality_id: res.quality_id,
                size_id: res.size_id,
                color_id: res.color_id
            });
        });

        $('#update_flag').val('true');
        $('#update').text('Update');
    });
}



// ````````````````````````````````````````````````````````````````````````````````````````````````````````````
function updateSummary(data) {
    console.log("Updating summary with data:", data);

    $('#qty_total_placeholder').text(data.total_quantity || 0);
    $('#sub_total_placeholder').text(parseFloat(data.total_amount || 0).toFixed(3));
    $('#tax_placeholder').text(parseFloat(data.tax_total || 0).toFixed(3));
    $('#round_off').text(parseFloat(data.round_off || 0).toFixed(3));
    $('#total_payable').text(parseFloat(data.grand_total || 0).toFixed(3));
}

$('#add_new').on('submit', function(e) {
    e.preventDefault();

    var formData = new FormData(this);
    formData.append('tm_id', $('#tm_id').val());
    formData.append('edit_id', $('#edit_id').val());
    console.log('edit-id:',$('#edit_id').val());

    $.ajax({
        url: '/update-acc-po-item/', // Adjust URL as needed
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                notifier.show(
                    'Well Done!', 
                    'PO updated successfully.', 
                    'success', 
                    "{% static 'assets/images/notification/ok-48.png' %}", 
                    4000
                );
                // Refresh DataTable
                refresh_data();

                // Update Summary
                updateSummary(response);

                // Clear Form Fields
                <!-- $('#item_group_id').val('').trigger("change"); -->
                <!-- $('#item_id').val('').trigger("change"); -->
                <!-- $('#quality_id').val('').trigger("change"); -->
                <!-- $('#size_id').val('').trigger("change"); -->
                $('#color_id').val('').trigger("change");
                $('#quantity').val('');
                $('#rate').val('');
                $('#amount').val(''); 
                $('#update_flag').val('false');
                $('#update').text('Add');
            } else {
                // alert(response.error_message || 'An error occurred. Please try again.');
                notifier.show(
                    'Error!', 
                    'Failed to update po:'+response.error_message, 
                    'danger', 
                    "{% static 'assets/images/notification/high_priority-48.png' %}", 
                    4000
                );
            }
        },
        error: function(xhr, status, error) {
            console.error('Request Failed:', error); 
            // alert('Error in processing the request');
            notifier.show(
                    'Error!', 
                    'Error in processing the request.', 
                    'danger', 
                    "{% static 'assets/images/notification/high_priority-48.png' %}", 
                    4000
                );
        }
    });
});



$('#update_tm_form').on('submit', function(e) {
    e.preventDefault();

    var formData = new FormData(this);
    formData.append('tm_id', $('#tm_id').val());

    // formData.append('receive_date', $('#receive_date').val());
    // formData.append('receive_no', $('#receive_no').val());
    formData.append('lot_no', $('#lot_no').val());
    formData.append('po_name', $('#po_name').val());
    formData.append('remarks', $('#remarks').val());
    formData.append('po_date', $('#po_date').val());
    formData.append('party_id', $('#party_id').val());

    $.ajax({
        url: '/accessory-po-details-update/', // Adjust URL as needed
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                notifier.show(
                    'Well Done!', 
                    'Updated successfully.', 
                    'success', 
                    "{% static 'assets/images/notification/ok-48.png' %}", 
                    4000
                );
                // Refresh DataTable
                refresh_data();
                location.reload();
                

                // Update Summary
                // updateSummary(response);

                // Clear Form Fields
                // $('#name').val('');
                // $('#program_date').val('');
                
            } else {
                // alert(response.error_message || 'An error occurred. Please try again.');
                notifier.show(
                    'Error!', 
                    'Failed to update po:'+response.error_message, 
                    'danger', 
                    "{% static 'assets/images/notification/high_priority-48.png' %}", 
                    4000
                );
            }
        },
        error: function(xhr, status, error) {
            console.error('Request Failed:', error); 
            // alert('Error in processing the request');
            notifier.show(
                'Error!', 
                'Error in processing the request.', 
                'danger', 
                "{% static 'assets/images/notification/high_priority-48.png' %}", 
                4000
            );
        }
    });
});

function accessory_po_detail_delete(id) {
    if (confirm('Are you sure you want to delete this data?')) {
    $.ajax({
        url: "/acc_po_detail_delete/",
        method: "POST",
        data: {
            id: id,
            tm_id: $("#tm_id").val(),
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        dataType: "json",
        success: function(data) {
            if (data.message === 'yes') {
                notifier.show(
                    'Well Done!', 
                    'PO deleted successfully.', 
                    'success', 
                    "{% static 'assets/images/notification/ok-48.png' %}", 
                    4000
                );


                // alert('success');
                refresh_data();
            } else {
                
                alert('Failed');
                }
            },
        });

    }
}





function calculateTotal() {
    let totalQuantity = 0;
    let subTotal = 0;
    let totalTax = 0;
    let taxSummary = {}; 

    // Tax rate as a percentage
    const taxRate = 5;

    // Iterate over each row in the table to calculate totals
    $('#datatable tbody > tr').each(function() {
        // Fetch values from each cell
        const quantity = parseInt($(this).find('td:eq(3)').text()) || 0; // Quantity
        const rate = parseFloat($(this).find('td:eq(4)').text()) || 0; // Rate
        const amount = parseFloat($(this).find('td:eq(5)').text()) || 0; // Amount
       
        // Calculate tax amount as 5% of the amount
        const taxAmount = (amount * taxRate) / 100;

        // Update totals 
        totalQuantity += quantity;
        subTotal += amount;
        totalTax += taxAmount;  // Adding calculated tax to total tax

        // Update tax summary (if any tax logic is needed)
        if (taxAmount > 0) {
            if (!taxSummary[taxRate]) {
                taxSummary[taxRate] = { sgst: 0, cgst: 0, igst: 0, totalTax: 0 };
            }
            // Assuming SGST and CGST split equally for simplicity
            const sgstAmount = taxAmount / 2;
            taxSummary[taxRate].sgst += sgstAmount;
            taxSummary[taxRate].cgst += sgstAmount;
            taxSummary[taxRate].totalTax += taxAmount;
        }
    });

    // Calculate round-off value and grand total
    const totalAmount = subTotal + totalTax;
    const roundOff = totalAmount - Math.floor(totalAmount);  // Get the decimal part

    // Apply the round-off logic (if >= 0.5, round up; if < 0.5, round down)
    const adjustedRoundOff = roundOff >= 0.5 ? (1 - roundOff) : -roundOff;

    const grandTotal = (subTotal + totalTax + adjustedRoundOff).toFixed(2);  // Add adjusted round-off to grand total

    // Display totals 
    $('#qty_total_placeholder').text(totalQuantity);
    $('#sub_total_placeholder').text(subTotal.toFixed(2));
    $('#tax_placeholder').text(totalTax.toFixed(2));
    $('#round_off').text(adjustedRoundOff.toFixed(2));
    $('#total_payable').text(grandTotal);

    // Update tax summary table (if needed)
    $('#tax_summary_body').empty();
    for (const [rate, data] of Object.entries(taxSummary)) {
        $('#tax_summary_body').append(`
            <tr>
                <td>${rate}%</td>
                <td>${data.sgst.toFixed(2)}</td>
                <td>${data.cgst.toFixed(2)}</td>
                <td>${data.igst ? data.igst.toFixed(2) : '0.00'}</td>
                <td>${data.totalTax.toFixed(2)}</td>
            </tr>
        `);
    }
}



 
$('.single-select').select2();





    



    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
// });


 </script>
