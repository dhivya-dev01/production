
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}
 
<style>
/* Remove spinner arrows for number fields */
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
  border: none;
}
input[type=number] {
  -moz-appearance: textfield;
}


table td input.form-control {
    border: none !important;
    box-shadow: none !important;
}

/* Table inputs */
#purchaseTable td input.form-control {
  padding: 0.50rem 0.5rem;
  border: none;
  text-align: center;
  font-size: 13px;
}

/* Table cells */
#purchaseTable td {
  padding: 1px !important;
  vertical-align: middle;
  text-align: center;
}

/* Specific input types */
#purchaseTable input[type="number"] {
  margin: 0 auto;
  display: block;
  border: none;
}

/* Fixed column widths for neatness */
#purchaseTable tbody td {
  width: 90px;
  word-break: break-word;
  vertical-align: middle;
}

/* Header */
.table thead th {
  border-bottom: 1px solid #e2e5e8;
  font-size: 13px;
  color: #111;
  background: #eff3f6;
  text-transform: uppercase;
  padding: 4px;
  text-align: center;
}

/* Footer */
.footer {
  padding: 1px !important;
  vertical-align: middle;
  text-align: center;
}
</style>


<style>
    .summary-container {
        max-width: 500px;
        margin: 20px auto;
        background: linear-gradient(135deg, #6a11cb, #2575fc);
        color: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
    }


    
    .summary-table {
        width: 100%;
        background: white;
        color: black;
        border-radius: 10px;
        overflow: hidden;
        padding: 10px;
    }

    .summary-table th {
        /* background: white; */
        color: black    ;
        padding: 10px;
        text-align: center;
    }

    .summary-table td {
        padding: 8px;
        font-weight: bold;
    }

    .highlight {
        background: #428bca;
        color: white;
        font-weight: bold;
        text-align: right;
    }

    .transparent-input {
        width: 100%;
        border: none;
        outline: none; 
        background: transparent;
        text-align: right;
        font-weight: bold;
        font-size: 16px;
        color: black;
    }

    .transparent-input:focus {
        border-bottom: 2px solid #428bca;
    }
</style>


<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title"> <!-- mill to knitting delivery -->
                                            <h4 class="m-b-10">Packing Received  </h4>
                                        </div>
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Production</a></li>
                                            <li class="breadcrumb-item"><a href="/packing-received"> Packing Received</a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false"> 
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>

                                    <div class="card">

                                        <div class="card-body row"> 
                                            <div class="col-sm-12"> 
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <form id="add_new" >
                                                            <div class="row ">
                                                                
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="delivery_no" class="form-lebel">Receive No.</label>
                                                                    <input type="text" class="form-control" value="{{inward_no}}" readonly>
                                                                </div>  
                                                                
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="order_date" class="form-label">Receive Date</label>
                                                                    <input class="form-control" type="date" name="inward_date" id="inward_date" required>
                                                                </div>


                                                               
																<!-- <div class="col-md-2 mt-3">
                                                                    <label for="product_id" class="form-label">Packing Outward</label>
                                                                    <select id="prg_id" name="prg_id" class="form-control form-select single-select" onchange="LoadProgramData()" >
                                                                        <option value="">Select</option>
                                                                        {% for k in packing_outward %}
                                                                        <option value="{{ k.id }}">{{ k.outward_no }} - [{{k.work_order_no}}- {{k.total_quantity}}.wt]</option> 
                                                                        {% endfor %} 
                                                                    </select>
                                                                    <input class="form-control" type="hidden" name="prg_quantity" id="prg_quantity" readonly>
                                                                    <input class="form-control" type="hidden" name="work_order_no" id="work_order_no" readonly>

                                                                </div> -->

 

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="party_id" class="form-label">Party</label>
                                                                    <select id="party_id" name="party_id" class="form-control single-select" readonly onchange="LoadParty_Outward()">
                                                                        <option value="">Select</option>
                                                                        {% for k in party %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>


                                                                <div class="col-md-2 mt-3">
                                                                    <label for="dc_no" class="form-lebel">Party DC No.</label>
                                                                    <input type="text" class="form-control" value="0" id="dc_no" name="dc_no">
                                                                </div>  
                                                                 
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="dc_date" class="form-label">Party DC Date</label>
                                                                    <input class="form-control" type="date" name="dc_date" id="dc_date" required>
                                                                </div>


                                                                
                                                            </div>
                                                            <div class="row">

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="product_id" class="form-label">Packing Outward</label>
                                                                    <select id="prg_id" name="prg_id" class="form-control form-select single-select" >
                                                                    <!-- onchange="LoadProgramData(),LoadParty()"> -->
                                                                        <option value="">Select</option>
                                                                        {% for k in combined_outward %}
                                                                            <option value="{{ k.id }}">
                                                                                {{ k.outward_no }} ({{ k.type }}) - [{{ k.work_order_no }} - {{ k.total_quantity }}.wt]
                                                                            </option>
                                                                        {% endfor %}
                                                                    </select>
                                                                    <input class="form-control" type="hidden" name="prg_quantity" id="prg_quantity" readonly>
                                                                    <input class="form-control" type="hidden" name="work_order_no" id="work_order_no" readonly>
                                                                </div>




                                                                <div class="col-md-2 mt-3">
                                                                    <label for="quality_id" class="form-label">Quality</label>
                                                                    <select id="quality_id" name="quality_id" class="form-control single-select" readonly onchange="LoadStyle()">
                                                                        <option value="">Select</option>
                                                                        {% for k in quality %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Style</label>
                                                                    <select id="style_id" name="style_id" class="form-control single-select" aria-readonly="true" onchange="Loadfabric()">
                                                                        <option value="">Select</option>
                                                                        {% for k in style %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-4">
                                                                    <button id="load_data" class="btn btn-primary mt-3" type="button" onclick="LoadData()">+ Load</button>

                                                                    <!-- <button id="load_data" class="btn btn-primary mt-3" onchange="LoadData()">+Load</button> -->
                                                                </div>
 

                                                            </div>
                                                            <div class="row">

                                                                <!-- <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Size</label>
                                                                    <select id="size_id" name="size_id" class="form-control single-select" >
                                                                        <option value="">Select</option>
                                                                        {% for k in size %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                      
                                                              
  
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Box</label>
                                                                    
                                                                    <input type="number" class="form-control" id="box" name="box" min="1" >
                                                                </div>  -->

 


                                                          
                                                                <div class="col-md-2 mt-4"> 
       
                                                                    <input type="hidden" class="form-control" id="original_quantity" name="original_quantity" >
                                                                    <input type="hidden" class="form-control" id="balance_qty" name="balance_qty" >
                                                                    {% csrf_token %}

                                                                    <!-- <button id="add_button" class="btn btn-primary mt-3" type="button" onclick="addManualRow()">+ Add</button> -->

                                                                    <!-- <button class="btn btn-primary mt-3" type="button" onclick="addManualRow()">+ Add</button> -->

                                                                </div>

                                                            </div>
                                                    
                                                        </div> 


                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="row">
                                                                <div class="col-md-9">
                                                                    <div class="table-responsive table-desi">

                                                                        <!-- <table id="purchaseTable" class="table table-bordered">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th>Size</th>
                                                                                    <th>Box </th>
                                                                                    <th>Loose Pcs </th> 
                                                                                    <th>Seconds Pcs </th>
                                                                                    <th>Shortage Pcs</th>
                                                                                    <th>Total Pcs </th>
                                                                                    <th style="display:none;">Balance Pcs</th>
                                                                                    <th style="display: none;">Size id</th>

                                                                                    <th style="display: none;">Original Qty</th>

                                                                                    <th>Actions</th> 
 
                                                                                </tr>
                                                                            </thead> 
                                                                            <tbody></tbody>  
                                                                        </table> -->


                                                                          <table id="purchaseTable" class="table table-bordered">
                                                                            <thead>
                                                                                <tr> 
                                                                                    <th>Size</th>
                                                                                    <th>Delivered Pcs</th>
                                                                                    <th>Already Rec Pcs</th>
                                                                                    <th>Box</th>
                                                                                    <th>Pcs Per Box</th>
                                                                                    <th>Box Pcs</th>
                                                                                    <th>Loose Pcs </th> 
                                                                                    <th>Seconds Pcs </th>
                                                                                    <th>Shortage Pcs</th>
                                                                                    <th>Total Pcs </th>

                                                                                    <th>Balance Pcs</th>
                                                                                    <th style="display: none;">Size id</th>

                                                                                    <th style="display: none;">Original Qty</th>

                                                                                    <th>Actions</th> 
 
                                                                                </tr>
                                                                            </thead> 
                                                                            <tbody></tbody>  
                                                                            <tfoot>
                                                                                <th>Total</th>
                                                                                <th style="text-align:center;" id="total_delivered_pcs"></th>
                                                                                <th style="text-align:center;" id="total_already_rec_pcs"></th>
                                                                                <th style="text-align:center;" id="total_boxes"></th>
                                                                                <th style="text-align:center;" id="pcs_per_box">0</th>
                                                                                <th style="text-align:center;" id="total_box_pcs"></th>
                                                                                <th style="text-align:center;" id="total_loose_pcs"></th>
                                                                                <th style="text-align:center;" id="total_seconds_pcs"></th>
                                                                                <th style="text-align:center;" id="total_shortage_pcs"></th>
                                                                                <th style="text-align:center;" id="total_pieces"></th>
                                                                                <th style="text-align:center;" id="balance_pieces"></th>
                                                                            </tfoot>
                                                                        </table>

                                                                    
                                                                    
                                                                    </div>
                                                                </div>
                                                            
                                                                <div class="col-md-3">
                                                                    <table id="summary_table" class="table table-striped table-bordered w-100">
                                                                        <thead>
                                                                            <tr>
                                                                                <th colspan="3" style="text-align: center;">Summary Table</th>
                                                                            </tr>
                                                                            <tr>
                                                                                <th></th>  <!-- Empty cell for left-side labels -->
                                                                                <th>Pcs / Boxes</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            <tr>
                                                                                <td>Total(pcs)</td>
                                                                                <td class="highlight"><span id="delivered_pcs">0</span></td>
                                                                            </tr>

                                                                            <tr>
                                                                                <td>Total Boxes</td>
                                                                                <td class="highlight"><span id="total_box">0</span></td>
                                                                            </tr>

                                                                            <tr>
                                                                                <td>Box Pcs</td>
                                                                                <td class="highlight"><span id="box_piece">0</span></td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td>Loose(pcs)</td>
                                                                                <td class="highlight"><span id="loose_pcs">0</span></td>
                                                                            </tr> 
                                                                            <tr>
                                                                                <td>Seconds(pcs)</td>
                                                                                <td class="highlight"><span id="seconds_pcs">0</span></td>
                                                                            </tr>
                                                                            
                                                                            <tr>
                                                                                <td>Shortage(pcs)</td>
                                                                                <td class="highlight"><span id="shortage_pcs">0</span></td>
                                                                            </tr> 

                                                                            <tr>
                                                                                <td>Balance(pcs)</td>
                                                                                <td class="highlight"><span id="balance_pcs">0</span></td>
                                                                            </tr> 
                                                                            <!-- <tr>
                                                                                <td> Total</td>
                                                                                <td class="highlight"><span id="grand_total">0</span></td>
                                                                            </tr> -->
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="row">
                                                             <div class="col-md-6 mt-2">
                                                                    <!-- <label for="order_date" class="form-label">Remarks</label> -->
                                                                    <textarea class="form-control" type="text" name="remarks" id="remarks" placeholder="Remarks"></textarea>
                                                                </div>

                        
                                                            <div class="col-md-2 mt-3">
                                                                <div class="" style="text-align: center;" >
                                                                    <button type="button" id="cancel" class="btn btn-danger" onclick="history.back()">Close</button>
                                                                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                                                                                                                
                                                                    <input type="hidden" id="fabric_id" name="fabric_id" value="">
                                                                    <!-- <span id="fabric_name_display"></span>  optional to show name -->
                                                                    <button type="submit" id="submit" class="btn btn-primary">Save</button>
                                                                </div>
                                                            </div>

                                                            <div class="col-md-4"> 

                                                       


                                                               

                                              
                                                  

                                                        </div>
                                             
                                                    
                                            
                                                    </div>

                                                    <!-- colmn-2 -->
                                                           

                                               
                                                </div>
                                        
                                            </form>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .no-border-input {
            border: none;
            background: transparent;
            text-align: center;
            width: 100%;
            color: inherit; /* Matches text color to the row */
        }

        .no-border-input:focus {
            outline: none;
        }

    </style>
    
</div>
{% include 'includes/footer.html' %}


<script>

$("#prg_id").on("change", function () {
    const selectedOption = $(this).find("option:selected");
    const prgText = selectedOption.text(); // e.g., "12345 - [WO-5678- 250.wt]"

    const match = prgText.match(/\[(.*?)-/);  // Extract work_order_no
    if (match) {
        $("#work_order_no").val(match[1].trim());
    } else {
        $("#work_order_no").val('');
    }

    const qtyMatch = prgText.match(/-\s*(\d+(\.\d+)?)\.wt\]/);  // Extract program quantity
    if (qtyMatch) {
        $("#prg_quantity").val(qtyMatch[1]);
    } else {
        $("#prg_quantity").val('');
    }
});



// $(document).ready(function () {
//     // Load programs when party is selected
//     $('#party_id').change(function () {
//         LoadProgram();
//     });


// });

// function LoadProgram() {
//     let prg_id = $('#prg_id').val();
//     console.log('Cutting Program-ID:', prg_id);

//     $.ajax({
//         type: 'POST',
//         url: '/get_cutting_program_lists/',
//         data: {
//             'prg_id': prg_id,
//             'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
//         },
//         success: function (data) {
//             let $prg_id = $('#prg_id');
//             let $prg_quantity = $('#prg_quantity');
//             let $quality_id = $('#quality_id');
//             let $style_id = $('#style_id');

//             // Reset dropdowns and inputs
//             // $prg_id.empty().append('<option value="">Select</option>');
//             $prg_quantity.val('');
//             $quality_id.val('').change();
//             $style_id.val('').change();

//             if (data.length > 0) {
//                 data.forEach(function (po) {
//                     $prg_id.append(
//                         `<option value="${po.id}" data-total="${po.total_quantity}" data-quality="${po.quality_id}" data-style="${po.style_id}">
//                             ${po.cutting_no}
//                         </option>`
//                     );
//                 });
//             }
//         },
//         error: function (xhr, status, error) {
//             console.error('Error loading program lists:', error);
//         }
//     });
// }

function updateProgramDetails() {
    let selectedOption = $('#prg_id').find(':selected');
    let totalQuantity = selectedOption.data('total') || '';
    let qualityId = selectedOption.data('quality') || '';
    let styleId = selectedOption.data('style') || '';

    console.log('Updating fields:', { totalQuantity, qualityId, styleId });

    $('#prg_quantity').val(totalQuantity);
    $('#quality_id').val(qualityId).change();
    $('#style_id').val(styleId).change();
}


 
$('#prg_id').on('change', function () {
    const prg_id = $(this).val();
    if (prg_id) {
        sizeColorMap = {}; // üßπ Clear previous tracking map
        LoadProgramData();  // Load dropdown values
        // loadProgramDetails(prg_id); // Load and auto-add rows
    }
});

function LoadData() {
    const prg_id = $("#prg_id").val();

    if (!prg_id) {
        notifier.show(
            'Warning!',
            'Please select a packing outward before loading.',
            'warning',
            "{% static 'assets/images/notification/medium_priority-48.png' %}",
            4000
        );
        return;
    }

    // Call your original function
    loadProgramDetails(prg_id);
}



// function loadProgramDetails(prg_id) {
//     $.ajax({
//         type: 'POST', 
//         url: '/get_sub_cutting_program/',
//         data: { 
//             'prg_id': prg_id,
//             'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
//         },
//         success: function (data) {
//             let $tableBody = $('#purchaseTable tbody');
//             $tableBody.empty(); // Clear existing rows

//             if (data.length > 0) {
//                 data.forEach(function (item) {
//                     addRow(item.size_name, item.color_name, item.size_id, item.color_id, item.quantity, 0); // Set wt as 0
//                 });
//             }
//         },
//         error: function (xhr, status, error) {
//             console.error('Error loading program details:', error);
//         }
//     });
// }

// ````````````````````````````````````````````

// üîÅ Declare globally at the top of your script
let sizeColorMap = {};

// function LoadProgramData_test_14_8_2025() {
//     var prg_id = $('#prg_id').val(); 
//     var inward = $('#prg_id option:selected').text().trim();
//     console.log('selected-inward:',inward);
//     console.log('Product-ID:', prg_id); // Debugging output

//     if (!prg_id) {
//         console.warn("No Product ID selected");
//         return;
//     }

//     var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token
 
//     // ‚úÖ Preserve po_quantity value
//     let currentPoQuantity = $('#po_quantity').val();
//     console.log("Stored po_quantity before AJAX:", currentPoQuantity);

//     $.ajax({
//         type: 'POST',   
//         url: '/get_packing_delivery_list/',
//         // url: '/get_stiching_delivery_list/',

//         data: {
//             'prg_id': prg_id,
//             'csrfmiddlewaretoken': csrfToken
//         },

//         dataType: 'json',
//         success: function(data) {
//             console.log('Received Data:', data); // Debugging output

//             // Do NOT clear po_quantity
//             $('#quality_id').empty();
//             $('#style_id').empty();
//             $('#size_id').empty(); 
//             $('#color_id').empty();
//             // $('#party_id').val();

//             // Populate dropdowns only if data exists

//             // if (data.party) {
//             //     // console.log('party:',party);
//             //     $('#party_id').html('<option value="' + data.party.id + '">' + data.party.name + '</option>');
//             // }



//             if (data.quality) {
//                 // console.log('quality:',quality);
//                 $('#quality_id').html('<option value="' + data.quality.id + '">' + data.quality.name + '</option>');
//             }

         

//             if (data.style) {
//                 $('#style_id').html('<option value="' + data.style.id + '">' + data.style.name + '</option>');
//             }
            
//             Loadfabric();

//             if (data.sizes && Array.isArray(data.sizes)) {
//                 data.sizes.forEach(function(item) {
//                     $('#size_id').append('<option value="' + item.id + '">' + item.name + '</option>');
//                                                 $('#box').focus();

//                 });

//             }

         

//             // ‚úÖ Restore po_quantity value
//         },
//         error: function(xhr, status, error) {
//             console.error('Error loading fabric details:', error);
//         } 
//     });
// }



function LoadProgramData() {
    var prg_id = $('#prg_id').val(); 
    var inwardText = $('#prg_id option:selected').text().trim();

    console.log('selected-inward:', inwardText);
    console.log('Product-ID:', prg_id);

    if (!prg_id) {
        console.warn("No Product ID selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

    // ‚úÖ Extract type from text e.g., "DO-001 (P) - [3 - 1269.wt]"
    let inwardType = null;
    const match = inwardText.match(/\((.*?)\)/);
    if (match) {
        inwardType = match[1]; // e.g., P or SP
    }

    console.log("Detected Inward Type:", inwardType);

    let url = '';
    if (inwardType === 'P') {
        url = '/get_packing_delivery_list/';
    } else if (inwardType === 'SP') {
        url = '/get_stiching_packing_delivery_list/';
    } else {
        console.warn("Invalid or unknown inward type:", inwardType);
        return;
    }

    $.ajax({
        type: 'POST',   
        url: url,
        data: {
            'prg_id': prg_id,
            'csrfmiddlewaretoken': csrfToken 
        },
        dataType: 'json',
        success: function(data) {
            console.log('Received Data:', data);

            $('#quality_id').empty();
            $('#style_id').empty();
            $('#size_id').empty(); 
            $('#color_id').empty();
         
            if (data.quality) {
                $('#quality_id').html('<option value="' + data.quality.id + '">' + data.quality.name + '</option>');
            }

            if (data.style) {
                $('#style_id').html('<option value="' + data.style.id + '">' + data.style.name + '</option>');
            }

            Loadfabric();

            if (data.sizes && Array.isArray(data.sizes)) {
                data.sizes.forEach(function(item) {
                    $('#size_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                    $('#box').focus();
                });


            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading delivery list:', error);
        }
    });
}





function LoadParty_Outward() {
    var party_id = $('#party_id').val(); 
    console.log('Party-ID:', party_id); // Debugging output

    if (!party_id) {
        console.warn("No Party ID selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token
 
    // ‚úÖ Preserve po_quantity value
    // let currentPoQuantity = $('#po_quantity').val();
    // console.log("Stored po_quantity before AJAX:", currentPoQuantity);
    $('#prg_id').empty().append('<option value="">Select</option>');

    
    $.ajax({
        type: 'POST',   
        url: '/get_party_outward_lists/',

        data: {
            'party_id': party_id,
            'csrfmiddlewaretoken': csrfToken
        },

        dataType: 'json',
        success: function(data) {
            $('#prg_id').empty().append('<option value="">Select</option>');

            if (data.outward && Array.isArray(data.outward)) {
                data.outward.forEach(function(item) {
                    const label = `${item.outward_no} (${item.type}) - [${item.work_order_no} - ${item.total_quantity}.wt]`;
                    $('#prg_id').append(`<option value="${item.id}">${label}</option>`);
                });
            } else {
                $('#prg_id').append('<option>No outwards found</option>');
            }
        },

        error: function(xhr, status, error) {
            console.error('Error loading fabric details:', error);
        } 
    });
}




$(document).ready(function () {
    // After selecting color, focus quantity
    $('#size_id').on('change', function () {
        $('#box').focus(); 
    });

      // Enter in quantity ‚Üí focus wt
    $('#size_id').on('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            $('#box').focus();
        }
    });

 
    // Enter in cutter ‚Üí focus Add button
    $('#box').on('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            $('#add_button').focus();
        }
    });

    // Enter in Add button ‚Üí trigger row add
    $('#add_button').on('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addManualRow(); // Call your wrapper
        }
    });
    });




// ```````````````````````````


// function LoadStyle() {
//     var quality_id = $('#quality_id').val(); 
//     console.log('Quality-ID:', quality_id); // Debugging output

    
//     if (!quality_id) {
//         console.warn("No Quality ID selected");
//         return;
//     }

//     var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

//     $.ajax({
//         type: 'POST',
//         url: '/get_quality_style_list/',
//         data: {
//             'quality_id': quality_id,
//             'csrfmiddlewaretoken': csrfToken 
//         },
//         dataType: 'json',

//         success: function(data) {
//             console.log('Received Data:', data); // Debugging output

//             // Clear and add default "Select" option
//             $('#style_id').empty().append('<option value="">Select</option>');
//             $('#size_id').empty().append('<option value="">Select</option>');
//             $('#fabric_id').val();

//             // Populate Styles
//             if (data.style && Array.isArray(data.style)) {
//                 data.style.forEach(function(item) {
//                     $('#style_id').append('<option value="' + item.id + '">' + item.name + '</option>');
//                 });
//             }

//             // Loadfabric();

//             if (data.size && Array.isArray(data.size)) {
//                 data.size.forEach(function(item) {
//                     $('#size_id').append('<option value="' + item.id + '">' + item.name + '</option>');
//                 });
//             }

//           $('#fabric_id').val(fabric);
//         },

//         error: function(xhr, status, error) {
//             console.error('Error loading fabric details:', error);
//         } 
//     });
// }





// function Loadfabric() {
//     var quality_id = $('#quality_id').val(); 
//     var style_id = $('#style_id').val(); 

//     if (!quality_id) {
//         console.warn("No Quality ID selected");
//         return;
//     }

//     var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

//     $.ajax({
//         type: 'POST',
//         url: '/get_quality_style_fabrics_list/',
//         data: {
//             'quality_id': quality_id,
//             'style_id': style_id,
//             'csrfmiddlewaretoken': csrfToken 
//         },
//         dataType: 'json',

//         success: function(data) {
//             console.log('Received Data:', data); // Debugging output

//             const fabrics = data.fabric || [];

//             // Clear and populate the fabric dropdown
//             const $fabricDropdown = $('#fabric_id');
//             $fabricDropdown.empty();
//             $fabricDropdown.append(``);

//             fabrics.forEach(fabric => {
//                 $fabricDropdown.append(
//                     `<option value="${fabric.id}">${fabric.name}</option>`
//                 );
//             });

//             // Optional: auto-select first item
//             // if (fabrics.length > 0) {
//             //     $fabricDropdown.val(fabrics[0].id).trigger('change');
//             // }
//         },

//         error: function(xhr, status, error) {
//             console.error('Error loading fabric details:', error);
//         } 
//     });
// }


function Loadfabric() {
    var quality_id = $('#quality_id').val(); 
    var style_id = $('#style_id').val(); 

    if (!quality_id) {
        console.warn("No Quality ID selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

    $.ajax({
        type: 'POST',
        url: '/get_quality_style_fabrics_list/',
        data: {
            'quality_id': quality_id,
            'style_id': style_id,
            'csrfmiddlewaretoken': csrfToken 
        },
        dataType: 'json',
        success: function(data) {
            const fabrics = data.fabric || [];

            if (fabrics.length > 0) {
                const firstFabric = fabrics[0];
                $('#fabric_id').val(firstFabric.id); // Set hidden input value
                $('#fabric_name_display').text(firstFabric.name); // Optional display
            } else {
                $('#fabric_id').val('');
                $('#fabric_name_display').text('');
                console.warn("No fabric found for selected quality/style");
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading fabric details:', error);
        } 
    });
}


function LoadStyle() {
    var quality_id = $('#quality_id').val(); 

    if (!quality_id) {
        console.warn("No Quality ID selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

    $.ajax({
        type: 'POST',
        url: '/get_quality_style_list/',
        data: {
            'quality_id': quality_id,
            'csrfmiddlewaretoken': csrfToken 
        },
        dataType: 'json',
        success: function(data) {
            // Reset all relevant dropdowns
            $('#style_id').empty().append('<option value="">Select</option>');
            $('#size_id').empty().append('<option value="">Select</option>');
            $('#fabric_id').empty().append('<option value="">Select</option>');

            if (data.style && Array.isArray(data.style)) {
                data.style.forEach(function(item) {
                    $('#style_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }

            if (data.size && Array.isArray(data.size)) {
                data.size.forEach(function(item) {
                    $('#size_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }

            // Optionally auto-load fabrics after loading styles/sizes
            // Loadfabric();
        },
        error: function(xhr, status, error) {
            console.error('Error loading style/size list:', error);
        } 
    });
}


 $('#style_id').change(function () {
        Loadfabric(); 
    });

// // ``````````````````````````````````````````````````````````````````````````````````````````````````````````````````````



const loadedItemsMap = {};



let rowCounter = 0; // Initialize row counter





// ```````````````````````````````````````````````           11-03-2025              ```````````````````````````````````````````````



// function storeTblValues() {
//     const TableData = [];
//     let hasInvalidBox = false;

//     $('#purchaseTable tbody tr').each(function () {
//         const $row = $(this);

//         const size = $row.find('td:eq(0)').text().trim();
//         const sizeId = $row.find('.size_id').text().trim(); 
//         const colorId = $row.find('.color_id').text().trim();

//         const box = parseFloat($row.find('.box input').val()) || 0;
//         const pcs_per_box = parseFloat($row.find('.pcs_per_box input').val()) || 0;
//         const box_pcs = parseFloat($row.find('.box_pcs input').val()) || 0;
//         const loose_pcs = parseFloat($row.find('.loose_pcs input').val()) || 0;
//         const seconds_pcs = parseFloat($row.find('.seconds_pcs input').val()) || 0;
//         const shortage = parseFloat($row.find('.shortage input').val()) || 0;
//         const total_pcs = parseFloat($row.find('.total_pcs input').val()) || 0;
//         const balance = parseFloat($row.find('.balance input').val()) || 0;

//         if (box <= 0) {
//             hasInvalidBox = true;
//         }

//         if (size && box > 0) {
//             TableData.push({
//                 size,
//                 size_id: sizeId,
//                 color_id: colorId,
//                 box, 
//                 pcs_per_box,
//                 box_pcs,
//                 loose_pcs,
//                 seconds_pcs,
//                 shortage,  
//                 total_pcs,
//                 balance
//             });
//         }
//     });

//     if (hasInvalidBox) {
//         console.warn('‚ö†Ô∏è Some rows have box <= 0. Please fix before submission.');
//         return [];
//     }

//     console.log('‚úÖ TABLE DATA:', TableData);
//     return TableData;
// }



function storeTblValues() {
    const TableData = [];
    let hasInvalidBox = false;

    $('#purchaseTable tbody tr').each(function () {
        const $row = $(this);

        const size = $row.find('td:eq(0)').text().trim();
        const sizeId = $row.find('.size_id').text().trim(); 
        const colorId = $row.find('.color_id').text().trim();

        const box = parseFloat($row.find('.box input').val()) || 0;
        const pcs_per_box = parseFloat($row.find('.pcs_per_box input').val()) || 0;

        console.log('pcs_per_box:',pcs_per_box);

        // üîë fix: these are plain <td>, not input
        const box_pcs = parseFloat($row.find('.box_pcs').text()) || 0;
        const total_pcs = parseFloat($row.find('.total_pcs').text()) || 0;
        const balance = parseFloat($row.find('.balance').text()) || 0;

        const loose_pcs = parseFloat($row.find('.loose_pcs input').val()) || 0;
        const seconds_pcs = parseFloat($row.find('.seconds_pcs input').val()) || 0;
        const shortage = parseFloat($row.find('.shortage input').val()) || 0;

        if (box <= 0) {
            hasInvalidBox = true;
        }

        if (size && box > 0) {
            TableData.push({
                size,
                size_id: sizeId,
                color_id: colorId,
                box, 
                pcs_per_box,
                box_pcs,
                loose_pcs,
                seconds_pcs,
                shortage,  
                total_pcs,
                balance
            });
        }
    });

    if (hasInvalidBox) {
        console.warn('‚ö†Ô∏è Some rows have box <= 0. Please fix before submission.');
        return [];
    }

    console.log('‚úÖ TABLE DATA:', TableData);
    return TableData;
}


function addManualRow() {
    console.log("Manual row function triggered");

    const box = $("#box").val() || 1;
    let selectedSizes = $("#size_id").val();
    // let selectedColors = $("#color_id").val();

    selectedSizes = Array.isArray(selectedSizes) ? selectedSizes : [selectedSizes];
    // selectedColors = Array.isArray(selectedColors) ? selectedColors : [selectedColors];

    if (!selectedSizes[0] ) {
        notifier.show(
            'Error!',
            'Please select a size.',
            'danger',
            "{% static 'assets/images/notification/high_priority-48.png' %}",
            4000
        );
        return;
    }

    selectedSizes.forEach(sizeId => {
        const sizeName = $("#size_id option[value='" + sizeId + "']").text();

        // selectedColors.forEach(colorId => {
            // const colorName = $("#color_id option[value='" + colorId + "']").text();

            if (!isRowDuplicate(sizeId)) { 
                addRow(sizeName, sizeId, box);
            } else {
                notifier.show(
                    'Error!',
                    `Size: ${sizeName} already exists in the table.`,
                    'danger',
                    "{% static 'assets/images/notification/high_priority-48.png' %}",
                    4000
                );
            }
        // }); 
    });
}

function isRowDuplicate(sizeId, colorId) {
    let isDuplicate = false;

    $("#purchaseTable tbody tr").each(function () {
        const existingSizeId = $(this).find(".size_id").text();
        const existingColorId = $(this).find(".color_id").text();

        if (existingSizeId === sizeId && existingColorId === colorId) {
            isDuplicate = true;
            return false;
        }
    });

    return isDuplicate;
}



// ````````````````````````````````````````````````
// 


function editRow(row) {
    const size = row.querySelector("td:nth-child(1)").innerText.trim();
    const color = row.querySelector("td:nth-child(2)").innerText.trim();
    const quantityCell = row.querySelector(".quantity");
    const wtCell = row.querySelector(".wt");
    const cutter = row.querySelector(".cutter");
    const sizeId = row.querySelector(".size_id").innerText.trim();
    const colorId = row.querySelector(".color_id").innerText.trim();

    // Get the original quantity from the row attribute or initialize it
    let originalQuantity = row.getAttribute("data-original-quantity");
    if (!originalQuantity) {
        originalQuantity = quantityCell.textContent.trim();
        row.setAttribute("data-original-quantity", originalQuantity);
    }
    
    originalQuantity = parseFloat(originalQuantity) || 0;
    const currentQuantity = parseFloat(quantityCell.textContent.trim()) || 0;
    const currentWt = parseFloat(wtCell.textContent.trim()) || 0;
    const cutterName = parseFloat(cutter.textContent.trim()) || 0;

    // Remove the row before updating form fields
    row.remove();
    calculateTotalValue();

    // Append values into form fields
    $("#size_id").val([sizeId]).trigger("change");
    $("#color_id").val([colorId]).trigger("change");
    $("#quantity").val(currentQuantity);
    $("#wt").val(currentWt);
    $("#cutter").val(cutterName);

    // Store the original quantity in a hidden field for balance calculation
    $("#original_quantity").val(originalQuantity);
}


// $("#lot_no").on("change", function () {
//     const selectedOption = $(this).find("option:selected");
//     const lotText = selectedOption.text(); // example: LOT123 (Avl: 150.00 kg)

//     const match = lotText.match(/\(Avl:\s*([\d.]+)\s*kg\)/);
//     if (match) {
//         const availableWt = parseFloat(match[1]);
//         $("#available_wt").val(availableWt);
//     } else {
//         $("#available_wt").val(0);
//     }
// });


function loadProgramDetails(prg_id) {
    // Get the selected option's text to detect type (P or SP)
    let selectedText = $('#prg_id option:selected').text().trim();
    console.log('Selected Inward:', selectedText);

    // Extract type from the text, e.g., (P) or (SP)
    let typeMatch = selectedText.match(/\((.*?)\)/);  // Matches text inside parentheses
    let inwardType = typeMatch ? typeMatch[1] : null;

    // Determine the URL based on type
    let url = '';
    if (inwardType === 'P') {
        url = '/get-packing-delivery-list/';
    } else if (inwardType === 'SP') {
        url = '/get-stiching-delivery-data/';
    } else {
        console.warn('Unknown type. Cannot determine URL.');
        return; 
    }

    $.ajax({ 
        type: 'POST',
        url: url,
        data: {
            'prg_id': prg_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        success: function (data) {
            let $tableBody = $('#purchaseTable tbody');
            $tableBody.empty(); // Clear existing rows

            if (data.length > 0) {
                // data.forEach(function (item) {
                //     let quantity = parseFloat(item.quantity) || 0;
                //     let box = Math.floor(quantity / 10);
                //     let loose_pcs = quantity % 10;

                //     addRow(
                //         item.size_name,
                //         item.color_name,
                //         item.size_id,
                //         item.color_id,
                //         per_box,
                //         box,
                //         loose_pcs,
                //         0, // seconds_pcs
                //         0, // shortage
                //         quantity,
                //         0
                //     );
                // }); 


                data.forEach(function (item) {
                    let per_box = parseInt(item.per_box) || 0;   // from backend

                    let alreadyOut = parseFloat(item.already_out_qty) || 0;
                    let alreadyReceived = parseFloat(item.already_received_qty) || 0;

                    // ‚úÖ Balance = Out - Received
                    let qty = alreadyOut - alreadyReceived;

                    // Break into boxes + loose pieces
                    let box = (per_box > 0) ? Math.floor(qty / per_box) : 0;
                    let loose_pcs = (per_box > 0) ? qty % per_box : qty;

                    addRow(
                        item.size_name,
                        item.color_name,
                        item.size_id,
                        item.color_id,
                        per_box,   // per box capacity
                        alreadyOut,   // other param
                        alreadyReceived,
                        box,
                        loose_pcs,
                        0, // seconds_pcs
                        0, // shortage
                        qty, // ‚úÖ total balance qty
                        
                    );
                });



            //     data.forEach(function (item) {
            //     let per_box = parseInt(item.per_box) || 0;   // get from backend
            //     let qty = (parseFloat(item.already_out_qty))- parseFloat(item.already_received_qty) || 0;
                
            //     let quantity = qty;
            //     let box = (per_box > 0) ? Math.floor(quantity / per_box) : 0;
            //     let loose_pcs = (per_box > 0) ? quantity % per_box : quantity;

            //     addRow(
            //         item.size_name,
            //         item.color_name,
            //         item.size_id,
            //         item.color_id,
            //         per_box,   // ‚úÖ use item.per_box
            //         box,
            //         loose_pcs,
            //         0, // seconds_pcs
            //         0, // shortage
            //         quantity,
            //         0
            //     );
            // });



            }
        },
        error: function (xhr, status, error) {
            console.error('Error loading program details:', error);
        }
    });
}

function loadProgramDetails_test1(prg_id) {
    $.ajax({
        type: 'POST',
        url: '/get-packing-delivery-list/',
        data: {
            'prg_id': prg_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        success: function (data) {
            let $tableBody = $('#purchaseTable tbody');
            $tableBody.empty(); // Clear existing rows

            if (data.length > 0) {
                data.forEach(function (item) {
                    let quantity = parseFloat(item.quantity) || 0;
                    let box = Math.floor(quantity / 10);  // üß† Treat 10 pcs = 1 box
                    addRow(item.size_name, item.color_name, item.size_id, item.color_id, box, 0);
                });
            }
        },
        error: function (xhr, status, error) {
            console.error('Error loading program details:', error);
        }
    });
}


// function addRow(size, color, sizeId, colorId, box = 0, loose_pcs = 0, seconds_pcs = 0, shortage = 0, total_pcs = 0, balance = 0) {
//     const tableBody = document.querySelector("#purchaseTable tbody");
//     if (!tableBody) {
//         console.error("Table body not found!");
//         return;
//     }

//     const key = `${sizeId}_${colorId}`;
//     if (sizeColorMap[key]) {
//         notifier.show(
//             'Duplicate!',
//             `Row for size "${size}" and color "${color}" already exists.`,
//             'warning',
//             "{% static 'assets/images/notification/high_priority-48.png' %}",
//             4000
//         );
//         return;
//     }

//     // If total_pcs is given (e.g., 12), recalculate box & balance
//     if (total_pcs > 0) {
//         box = Math.floor(total_pcs / 10);
//         const extras = total_pcs % 10;
//         const extraFieldsSum = loose_pcs + seconds_pcs + shortage;

//         balance = (extraFieldsSum === 0) ? extras : 0;  
//     } else {
//         total_pcs = (box * 10) + loose_pcs + seconds_pcs + shortage; 
//     }

//     const newRow = document.createElement("tr");
//     newRow.innerHTML = `
//         <td>${size}</td>
//         <td class="box"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control box" value="${box}"></td>
//         <td class="loose_pcs"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control loose_pcs" value="${loose_pcs}"></td>
//         <td class="seconds_pcs"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control seconds_pcs" value="${seconds_pcs}"></td>
//         <td class="shortage"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control shortage" value="${shortage}"></td>
//         <td class="total_pcs"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control total_pcs" readonly value="${total_pcs}"></td>
//         <td class="balance" style="display:none;"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control balance" readonly value="${balance}"></td>
//         <td class="size_id" style="display:none">${sizeId}</td>
//         <td class="color_id" style="display:none">${colorId}</td>
//         <td>
//             <button class="btn btn-danger btn-xs remove-row"><i class="feather icon-trash-2"></i></button>
//         </td>
//     `;

//     tableBody.appendChild(newRow);
//     sizeColorMap[key] = true;

//     calculateTotalValue();
//     calculateSummaryTotalValue();

//     newRow.querySelector(".remove-row").addEventListener("click", function () {
//         delete sizeColorMap[key];
//         newRow.remove();
//         calculateTotalValue();
//         calculateSummaryTotalValue();
//     });

//     // üîÅ Live input update handlers
//     newRow.querySelectorAll("input").forEach(input => {
//         input.addEventListener("input", () => {
//             calculateTotalValue();
//             calculateSummaryTotalValue();
//         });
//     });
// // }



// function addRow(size, color, sizeId, colorId, per_box, box = 0, loose_pcs = 0, seconds_pcs = 0, shortage = 0, total_pcs = 0, balance = 0) {
//     const tableBody = document.querySelector("#purchaseTable tbody");
//     if (!tableBody) {
//         console.error("Table body not found!");
//         return;
//     }


//     const key = `${sizeId}`;
//     let existingRow = document.querySelector(`#purchaseTable tbody tr[data-key="${key}"]`);

//     if (existingRow) {
//         let currentBox = parseInt(existingRow.querySelector(".box input").value) || 0;
//         let currentLoosePcs = parseInt(existingRow.querySelector(".loose_pcs input").value) || 0;
//         let currentSecondsPcs = parseInt(existingRow.querySelector(".seconds_pcs input").value) || 0;
//         let currentShortage = parseInt(existingRow.querySelector(".shortage input").value) || 0;

//         // Recalculate with per_box
//         let newBox = currentBox + box;
//         let newLoose = currentLoosePcs + loose_pcs;
//         let newSeconds = currentSecondsPcs + seconds_pcs;
//         let newShortage = currentShortage + shortage;

//         let newTotalPcs = (newBox * per_box) + newLoose + newSeconds + newShortage;
//         let extras = newTotalPcs % per_box;

//         existingRow.querySelector(".box input").value = newBox;
//         existingRow.querySelector(".loose_pcs input").value = newLoose;
//         existingRow.querySelector(".seconds_pcs input").value = newSeconds;
//         existingRow.querySelector(".shortage input").value = newShortage;
//         existingRow.querySelector(".total_pcs input").value = newTotalPcs;
//         existingRow.querySelector(".balance input").value = extras;

//         calculateTotalValue();
//         calculateSummaryTotalValue();
//         return;
//     }

//     // If no existing row, calculate fresh
//     if (total_pcs > 0) { 
//         box = Math.floor(total_pcs / per_box);
//         box_pcs = box*per_box;
//         console.log('box-pcs:',box_pcs)
//         const extras = total_pcs % per_box;
//         const extraFieldsSum = loose_pcs + seconds_pcs + shortage;
//         balance = (extraFieldsSum === 0) ? extras : 0;
//     } else {
//         total_pcs = (box * per_box) + loose_pcs + seconds_pcs + shortage;
//     }
//     already_rec = 0 ; 
//     const newRow = document.createElement("tr"); 
//     newRow.dataset.key = key;

//     newRow.innerHTML = `
//         <td>${size}</td>
//         <td class="alr_rec"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control alr_rec" readonly value="${already_rec}"></td>
//         <td class="box"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control box" readonly value="${box}"></td>
//         <td class="pcs_per_box"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control pcs_per_box" readonly value="${per_box}"></td>

//         <td class="box_pcs"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control box_pcs" value="${box_pcs}"></td>
//         <td class="loose_pcs"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control loose_pcs" value="${loose_pcs}"></td>
//         <td class="seconds_pcs"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control seconds_pcs" value="${seconds_pcs}"></td>
//         <td class="shortage"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control shortage" value="${shortage}"></td>
//         <td class="total_pcs"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control total_pcs" readonly value="${total_pcs}"></td>
//         <td class="balance" style="display:none;"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control balance" readonly value="${balance}"></td>
//         <td class="size_id" style="display:none">${sizeId}</td>
//         <td class="color_id" style="display:none">${colorId}</td>
//         <td>
//             <button class="btn btn-danger btn-xs remove-row"><i class="feather icon-trash-2"></i></button>
//         </td>
//     `;

//     tableBody.appendChild(newRow);
//     sizeColorMap[key] = true;

//     calculateTotalValue();
//     calculateSummaryTotalValue();

//     newRow.querySelector(".remove-row").addEventListener("click", function () {
//         delete sizeColorMap[key];
//         newRow.remove();
//         calculateTotalValue();
//         calculateSummaryTotalValue();
//     });

//     newRow.querySelectorAll("input").forEach(input => {
//         input.addEventListener("input", () => {
//             calculateTotalValue(); 
//             calculateSummaryTotalValue();
//         });
//     });
// }




// function addRow(size, color, sizeId, colorId, per_box,alreadyOut,alreadyReceived, box = 0, loose_pcs = 0, seconds_pcs = 0, shortage = 0, total_pcs = 0, balance = 0) {
//     const tableBody = document.querySelector("#purchaseTable tbody");
//     if (!tableBody) {
//         console.error("Table body not found!");
//         return;
//     }


//     const key = `${sizeId}`;
//     let existingRow = document.querySelector(`#purchaseTable tbody tr[data-key="${key}"]`);

//     // ‚úÖ Always declare box_pcs
//     let box_pcs = 0;

//     if (existingRow) {
//         let currentBox = parseInt(existingRow.querySelector(".box input").value) || 0;
//         let currentLoosePcs = parseInt(existingRow.querySelector(".loose_pcs input").value) || 0;
//         let currentSecondsPcs = parseInt(existingRow.querySelector(".seconds_pcs input").value) || 0;
//         let currentShortage = parseInt(existingRow.querySelector(".shortage input").value) || 0;

//         // Recalculate with per_box
//         let newBox = currentBox + box;
//         let newLoose = currentLoosePcs + loose_pcs;
//         let newSeconds = currentSecondsPcs + seconds_pcs;
//         let newShortage = currentShortage + shortage;

//         let newTotalPcs = (newBox * per_box) + newLoose + newSeconds + newShortage;
//         let extras = newTotalPcs % per_box;

//         existingRow.querySelector(".box input").value = newBox;
//         existingRow.querySelector(".loose_pcs input").value = newLoose; 
//         existingRow.querySelector(".seconds_pcs input").value = newSeconds;
//         existingRow.querySelector(".shortage input").value = newShortage;
//         existingRow.querySelector(".total_pcs input").value = newTotalPcs;
//         existingRow.querySelector(".balance input").value = extras;

//         calculateTotalValue();
//         calculateSummaryTotalValue();
//         return;
//     }

//     already_received_qty = 0;

//     // If no existing row, calculate fresh
//     if (total_pcs > 0) {  
//         box = Math.floor(total_pcs / per_box);
//         box_pcs = box * per_box;   // ‚úÖ now always defined
//         console.log('box-pcs:', box_pcs)
//         const extras = total_pcs % per_box;
//         const extraFieldsSum = loose_pcs + seconds_pcs + shortage; 
//         balance = (extraFieldsSum === 0) ? extras : 0;
//     } else {
//         total_pcs = (box * per_box) + loose_pcs + seconds_pcs + shortage;
//         box_pcs = box * per_box;   // ‚úÖ set here too
//     }

//     let already_rec = 0; 
//     let already_out = 0; 
//     const newRow = document.createElement("tr"); 
//     newRow.dataset.key = key;

//     newRow.innerHTML = `
//         <td>${size}</td>
//         <td class="alr_out"><input type="number" data-size_id="${sizeId}" style="border:none;background:#eff3f6" class="form-control delivered_qty" readonly value="${alreadyOut}"></td>
//         <td class="alr_rec"><input type="number" data-size_id="${sizeId}" style="border:none;background:#eff3f6" class="form-control alr_rec" readonly value="${alreadyReceived}"></td>
//         <td class="box"><input type="number" data-size_id="${sizeId}" style="border:none;width:50px;" class="form-control box"  value="${box}"></td>
//         <td class="pcs_per_box"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control pcs_per_box" readonly value="${per_box}"></td>
//         <td class="box_pcs"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control box_pcs" value="${box_pcs}"></td>
//         <td class="loose_pcs"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control loose_pcs" value="${loose_pcs}"></td>
//         <td class="seconds_pcs"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control seconds_pcs" value="${seconds_pcs}"></td>
//         <td class="shortage"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control shortage" value="${shortage}"></td>
//         <td class="total_pcs"><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control total_pcs" readonly value="${total_pcs}"></td>
//         <td class="balance" ><input type="number" data-size_id="${sizeId}" style="border:none;" class="form-control balance" readonly value="${balance}"></td>
//         <td class="size_id" style="display:none">${sizeId}</td>
//         <td class="color_id" style="display:none">${colorId}</td>
//         <td>
//             <button class="btn btn-danger btn-xs remove-row"><i class="feather icon-trash-2"></i></button>
//         </td>
//     `;

//     tableBody.appendChild(newRow);
//     sizeColorMap[key] = true;

//     calculateTotalValue();
//     calculateSummaryTotalValue();

//     newRow.querySelector(".remove-row").addEventListener("click", function () {
//         delete sizeColorMap[key];
//         newRow.remove();
//         calculateTotalValue();
//         calculateSummaryTotalValue();
//     });

//     newRow.querySelectorAll("input").forEach(input => {
//         input.addEventListener("input", () => {
//             calculateTotalValue(); 
//             calculateSummaryTotalValue(); 
//         });
//     });  


//     newRow.querySelectorAll("input").forEach(input => {
//     input.addEventListener("input", () => {
//         const boxInput = newRow.querySelector(".box input");
//         const perBoxInput = newRow.querySelector(".pcs_per_box input");
//         const boxPcsInput = newRow.querySelector(".box_pcs input");
//         const looseInput = newRow.querySelector(".loose_pcs input");
//         const secondsInput = newRow.querySelector(".seconds_pcs input");
//         const shortageInput = newRow.querySelector(".shortage input");
//         const totalPcsInput = newRow.querySelector(".total_pcs input");

//         let boxVal = parseInt(boxInput.value) || 0;
//         let perBoxVal = parseInt(perBoxInput.value) || 0;
//         let looseVal = parseInt(looseInput.value) || 0;
//         let secondsVal = parseInt(secondsInput.value) || 0;
//         let shortageVal = parseInt(shortageInput.value) || 0;

//         // ‚úÖ Update box_pcs dynamically
//         let boxPcsVal = boxVal * perBoxVal;
//         boxPcsInput.value = boxPcsVal;

//         // ‚úÖ Update total_pcs
//         totalPcsInput.value = boxPcsVal + looseVal + secondsVal + shortageVal;

//         calculateTotalValue(); 
//         calculateSummaryTotalValue();
//     });
// });



// }


// <style>
//     /* Chrome, Safari, Edge, Opera */
//     input::-webkit-outer-spin-button,
//     input::-webkit-inner-spin-button {
//     -webkit-appearance: none; 
//     margin: 0;
//     }

//     /* Firefox */
//     input[type=number] {
//     -moz-appearance: textfield;
//     }
// </style>




function addRow_test1(size, color, sizeId, colorId, per_box, alreadyOut, alreadyReceived, box = 0, loose_pcs = 0, seconds_pcs = 0, shortage = 0) {
  const tableBody = document.querySelector("#purchaseTable tbody");
  if (!tableBody) {
    console.error("Table body not found!");
    return;
  }

  const key = `${sizeId}`;
  let existingRow = document.querySelector(`#purchaseTable tbody tr[data-key="${key}"]`);

  let total_pcs_to_add = (box * per_box) + loose_pcs + seconds_pcs + shortage;
  let newTotalPcs;
  let newCalculatedBox;
  let newCalculatedLoosePcs;

  if (existingRow) {
    // Get existing values from the input fields
    <!-- let currentBox = parseInt(existingRow.querySelector(".box input").value) || 0; -->
    let currentBox = parseInt(existingRow.querySelector(".box").value) || 0;
    let currentLoosePcs = parseInt(existingRow.querySelector(".loose_pcs input").value) || 0;
    let currentSecondsPcs = parseInt(existingRow.querySelector(".seconds_pcs input").value) || 0;
    let currentShortage = parseInt(existingRow.querySelector(".shortage input").value) || 0;

    // Calculate the new grand total pieces
    const currentTotalPcs = (currentBox * per_box) + currentLoosePcs + currentSecondsPcs + currentShortage;
    newTotalPcs = currentTotalPcs + total_pcs_to_add;

    // Recalculate boxes and loose pieces from the new total 
    newCalculatedBox = Math.floor(newTotalPcs / per_box);
    newCalculatedLoosePcs = newTotalPcs % per_box;

    const remaining = alreadyOut - newTotalPcs;

    // Update the existing row
    existingRow.querySelector(".box ").value = newCalculatedBox;
    // <!-- existingRow.querySelector(".box input").value = newCalculatedBox; -->
    existingRow.querySelector(".loose_pcs input").value = newCalculatedLoosePcs;
    existingRow.querySelector(".seconds_pcs input").value = currentSecondsPcs + seconds_pcs;
    existingRow.querySelector(".shortage input").value = currentShortage + shortage;
    existingRow.querySelector(".total_pcs").textContent = newTotalPcs;
    existingRow.querySelector(".balance").textContent = remaining >= 0 ? remaining : 0;
    existingRow.querySelector(".box_pcs").textContent = newCalculatedBox * per_box;

  } else {
    // Logic for creating a new row
    newTotalPcs = total_pcs_to_add;
    newCalculatedBox = Math.floor(newTotalPcs / per_box);
    console.log('boxes:', newCalculatedBox);
    newCalculatedLoosePcs = newTotalPcs % per_box;
    const calculatedBoxPcs = newCalculatedBox * per_box;
	console.log('pcs:',calculatedBoxPcs);
    const remaining = alreadyOut - newTotalPcs;

    const newRow = document.createElement("tr");
    newRow.dataset.key = key;

    newRow.innerHTML = `
      <td>${size}</td>
      <td class="alr_out"><input type="number" style="border:none;background:#d4f1f1" class="form-control delivered_qty" readonly value="${alreadyOut}"></td>
      <td class="alr_rec"><input type="number" style="border:none;background:#eff3f6" class="form-control alr_rec" readonly value="${alreadyReceived}"></td>
      <td class="box">
		     <input type="number" style="border:none;width:50px;" class="form-control box" value="${newCalculatedBox}">

		</td>
      <td class="pcs_per_box"><input type="number" style="border:none;background:#eff3f6;" class="form-control" readonly value="${per_box}"></td>
      <td class="box_pcs">${calculatedBoxPcs}</td>
      <td class="loose_pcs"><input type="number" style="border:none;" class="form-control" value="${newCalculatedLoosePcs}"></td>
      <td class="seconds_pcs"><input type="number" style="border:none;" class="form-control" value="0"></td>
      <td class="shortage"><input type="number" style="border:none;" class="form-control" value="0"></td>
      <td class="total_pcs">${newTotalPcs}</td>
      <td class="balance">${remaining}</td>
      <td class="size_id" style="display:none">${sizeId}</td>
      <td class="color_id" style="display:none">${colorId}</td>
      <td class="boxess" style="display:none">${newCalculatedBox}</td>
      <td><button class="btn btn-danger btn-xs remove-row"><i class="feather icon-trash-2"></i></button></td>
    `;
    tableBody.appendChild(newRow);

    // remove row
    newRow.querySelector(".remove-row").addEventListener("click", function() {
      newRow.remove();
      calculateTotalValue();
      calculateSummaryTotalValue();
    });

    // update totals when inputs change
    newRow.querySelectorAll("input").forEach(input => {
      input.addEventListener("input", () => {
        const boxVal = parseInt(newRow.querySelector(".box ").value) || 0;
        const perBoxVal = parseInt(newRow.querySelector(".pcs_per_box input").value) || 0;
        const looseVal = parseInt(newRow.querySelector(".loose_pcs input").value) || 0;
        const secondsVal = parseInt(newRow.querySelector(".seconds_pcs input").value) || 0;
        const shortageVal = parseInt(newRow.querySelector(".shortage input").value) || 0;

        const updatedBoxPcs = boxVal * perBoxVal;
        const updatedTotalPcs = updatedBoxPcs + looseVal + secondsVal + shortageVal;

        const updatedRemaining = (alreadyOut - alreadyReceived) - updatedTotalPcs;

        newRow.querySelector(".box_pcs").textContent = updatedBoxPcs;
        newRow.querySelector(".total_pcs").textContent = updatedTotalPcs;
        newRow.querySelector(".balance").textContent = updatedRemaining >= 0 ? updatedRemaining : 0;

        calculateTotalValue();
        calculateSummaryTotalValue();
      });
    });
  }

  calculateTotalValue();
  calculateSummaryTotalValue();
}




function addRow_bk_26(size, color, sizeId, colorId, per_box, alreadyOut, alreadyReceived, box = 0, loose_pcs = 0, seconds_pcs = 0, shortage = 0) {
  const tableBody = document.querySelector("#purchaseTable tbody");
  if (!tableBody) {
    console.error("Table body not found!");
    return;
  }

  const key = `${sizeId}`;
  let existingRow = document.querySelector(`#purchaseTable tbody tr[data-key="${key}"]`);

  // Initial total pcs
  let total_pcs = (box * per_box) + loose_pcs + seconds_pcs + shortage;
  if (existingRow) {
    let currentBox = parseInt(existingRow.querySelector(".box input").value) || 0;
    let currentLoosePcs = parseInt(existingRow.querySelector(".loose_pcs input").value) || 0;
    let currentSecondsPcs = parseInt(existingRow.querySelector(".seconds_pcs input").value) || 0;
    let currentShortage = parseInt(existingRow.querySelector(".shortage input").value) || 0;

    const newBox = currentBox + box;
    const newLoose = currentLoosePcs + loose_pcs;
    const newSeconds = currentSecondsPcs + seconds_pcs;
    const newShortage = currentShortage + shortage;

    const newTotalPcs = (newBox * per_box) + newLoose + newSeconds + newShortage;
    const remaining = alreadyOut - newTotalPcs;

    existingRow.querySelector(".box ").value = newBox;
    existingRow.querySelector(".loose_pcs input").value = newLoose;
    existingRow.querySelector(".seconds_pcs input").value = newSeconds;
    existingRow.querySelector(".shortage input").value = newShortage;
    existingRow.querySelector(".total_pcs").textContent = newTotalPcs;
    existingRow.querySelector(".balance").textContent = remaining >= 0 ? remaining : 0;

    calculateTotalValue();
    calculateSummaryTotalValue();
    return;
  }
   
  const calculatedBox = Math.floor(total_pcs / per_box);
  console.log('boxes:',calculatedBox);
  const calculatedLoosePcs = total_pcs % per_box;
  const calculatedBoxPcs = calculatedBox * per_box;
  const remaining = alreadyOut - total_pcs;

  const newRow = document.createElement("tr");
  newRow.dataset.key = key;

  newRow.innerHTML = `
    <td>${size}</td>
    <td class="alr_out"><input type="number" style="border:none;background:#d4f1f1" class="form-control delivered_qty" readonly value="${alreadyOut}"></td>
    <td class="alr_rec"><input type="number" style="border:none;background:#eff3f6" class="form-control alr_rec" readonly value="${alreadyReceived}"></td>
    <td class="box"><input type="number" style="border:none;width:50px;" class="form-control" value="${calculatedBox}"></td>
    <td class="pcs_per_box"><input type="number" style="border:none;background:#eff3f6;" class="form-control" readonly value="${per_box}"></td>
    <td class="box_pcs">${calculatedBoxPcs}</td>
    <td class="loose_pcs"><input type="number" style="border:none;" class="form-control" value="${calculatedLoosePcs}"></td>
    <td class="seconds_pcs"><input type="number" style="border:none;" class="form-control" value="0"></td>
    <td class="shortage"><input type="number" style="border:none;" class="form-control" value="0"></td>
    <td class="total_pcs">${total_pcs}</td>
    <td class="balance">${remaining}</td>
    <td class="size_id" style="display:none">${sizeId}</td>
    <td class="color_id" style="display:none">${colorId}</td>
    <td><button class="btn btn-danger btn-xs remove-row"><i class="feather icon-trash-2"></i></button></td>
  `;

  tableBody.appendChild(newRow); 
//   calculateSummaryTotalValue()

  // remove row
  newRow.querySelector(".remove-row").addEventListener("click", function() {
    newRow.remove();
    calculateTotalValue();
    calculateSummaryTotalValue();
  });

  // update totals when inputs change
  newRow.querySelectorAll("input").forEach(input => {
    input.addEventListener("input", () => {
      const boxVal = parseInt(newRow.querySelector(".box").value) || 0;
      const perBoxVal = parseInt(newRow.querySelector(".pcs_per_box input").value) || 0;
      const looseVal = parseInt(newRow.querySelector(".loose_pcs input").value) || 0;
      const secondsVal = parseInt(newRow.querySelector(".seconds_pcs input").value) || 0;
      const shortageVal = parseInt(newRow.querySelector(".shortage input").value) || 0;

      const newBoxPcs = boxVal * perBoxVal;
      const newTotalPcs = newBoxPcs + looseVal + secondsVal + shortageVal;

      const remaining = (alreadyOut - alreadyReceived) - newTotalPcs;

      newRow.querySelector(".box_pcs").textContent = newBoxPcs;
      newRow.querySelector(".total_pcs").textContent = newTotalPcs;
      newRow.querySelector(".balance").textContent = remaining >= 0 ? remaining : 0;

      calculateTotalValue();
      calculateSummaryTotalValue();
    });
  });

  calculateTotalValue();
  calculateSummaryTotalValue();
}

function addRow(size, color, sizeId, colorId, per_box, alreadyOut, alreadyReceived, box = 0, loose_pcs = 0, seconds_pcs = 0, shortage = 0) {
  const tableBody = document.querySelector("#purchaseTable tbody");
  if (!tableBody) {
    console.error("Table body not found!");
    return;
  }

  const key = `${sizeId}`;
  let existingRow = document.querySelector(`#purchaseTable tbody tr[data-key="${key}"]`);

  let total_pcs_to_add = (box * per_box) + loose_pcs + seconds_pcs + shortage;
  let newTotalPcs;
  let newCalculatedBox;
  let calculatedBoxPcs;
  let newCalculatedLoosePcs;

  if (existingRow) {
    // Get existing values from the input fields
    let currentBox = parseInt(existingRow.querySelector(".box ").value) || 0;
    let currentLoosePcs = parseInt(existingRow.querySelector(".loose_pcs input").value) || 0;
    let currentSecondsPcs = parseInt(existingRow.querySelector(".seconds_pcs input").value) || 0;
    let currentShortage = parseInt(existingRow.querySelector(".shortage input").value) || 0;

    // Calculate the new grand total pieces
    const currentTotalPcs = (currentBox * per_box) + currentLoosePcs + currentSecondsPcs + currentShortage;
    newTotalPcs = currentTotalPcs + total_pcs_to_add;

    // Recalculate boxes and loose pieces from the new total
    newCalculatedBox = Math.floor(newTotalPcs / per_box);
    newCalculatedLoosePcs = newTotalPcs % per_box;

    const remaining = alreadyOut - newTotalPcs;

    // Update the existing row
    existingRow.querySelector(".box ").value = newCalculatedBox;
    existingRow.querySelector(".loose_pcs input").value = newCalculatedLoosePcs;
    existingRow.querySelector(".seconds_pcs input").value = currentSecondsPcs + seconds_pcs;
    existingRow.querySelector(".shortage input").value = currentShortage + shortage;
    existingRow.querySelector(".total_pcs").textContent = newTotalPcs;
    existingRow.querySelector(".balance").textContent = remaining >= 0 ? remaining : 0;
    existingRow.querySelector(".box_pcs").textContent = newCalculatedBox * per_box;

  } else {
    // Logic for creating a new row
    newTotalPcs = total_pcs_to_add;
    newCalculatedBox = Math.floor(newTotalPcs / per_box);
    const newCalculatedLoosePcs = newTotalPcs % per_box;
    const calculatedBoxPcs = newCalculatedBox * per_box;
    const remaining = alreadyOut - newTotalPcs;

    const newRow = document.createElement("tr");
    newRow.dataset.key = key;

    newRow.innerHTML = `
      <td>${size}</td>
      <td class="alr_out"><input type="number" style="border:none;background:#d4f1f1" class="form-control delivered_qty" readonly value="${alreadyOut}"></td>
      <td class="alr_rec"><input type="number" style="border:none;background:#eff3f6" class="form-control alr_rec" readonly value="${alreadyReceived}"></td>
      <td class="box">
        <input type="number" style="border:none;width:50px;" class="form-control" value="${newCalculatedBox}">
      </td>
      <td class="pcs_per_box">
        <input type="number" style="border:none;background:#eff3f6;" class="form-control" readonly value="${per_box}">
      </td>
      <td class="box_pcs">${calculatedBoxPcs}</td>
      <td class="loose_pcs"><input type="number" style="border:none;" class="form-control" value="${newCalculatedLoosePcs}"></td>
      <td class="seconds_pcs"><input type="number" style="border:none;" class="form-control" value="0"></td>
      <td class="shortage"><input type="number" style="border:none;" class="form-control" value="0"></td>
      <td class="total_pcs">${newTotalPcs}</td>
      <td class="balance">${remaining}</td>
      <td class="size_id" style="display:none">${sizeId}</td>
      <td class="color_id" style="display:none">${colorId}</td>
      <td class="boxess" style="display:none">${newCalculatedBox}</td>
      <td><button class="btn btn-danger btn-xs remove-row"><i class="feather icon-trash-2"></i></button></td>
    `;
    tableBody.appendChild(newRow);

    // Remove row functionality
    newRow.querySelector(".remove-row").addEventListener("click", function () {
      newRow.remove();
      calculateTotalValue();
      calculateSummaryTotalValue();
    });

    // Update calculations on input change
    newRow.querySelectorAll("input").forEach(input => {
      input.addEventListener("input", () => {
        const boxVal = parseInt(newRow.querySelector(".box ").value) || 0;
        const perBoxVal = parseInt(newRow.querySelector(".pcs_per_box input").value) || 0;
        const looseVal = parseInt(newRow.querySelector(".loose_pcs input").value) || 0;
        const secondsVal = parseInt(newRow.querySelector(".seconds_pcs input").value) || 0;
        const shortageVal = parseInt(newRow.querySelector(".shortage input").value) || 0;

        const updatedBoxPcs = boxVal * perBoxVal;
        const updatedTotalPcs = updatedBoxPcs + looseVal + secondsVal + shortageVal;

        const updatedRemaining = (alreadyOut - alreadyReceived) - updatedTotalPcs;

        newRow.querySelector(".box_pcs").textContent = updatedBoxPcs;
        newRow.querySelector(".total_pcs").textContent = updatedTotalPcs;
        newRow.querySelector(".balance").textContent = updatedRemaining >= 0 ? updatedRemaining : 0;

        calculateTotalValue();
        calculateSummaryTotalValue();
      });
    });
  }

  calculateTotalValue();
  calculateSummaryTotalValue();
} 


function calculateSummaryTotalValue() {
    let totalBox = 0;
    let loose_pcs = 0;
    let seconds_pcs = 0;
    let shortage_pcs = 0;
    let totalDeliveredPcs = 0;
    const perBox = 10;


    $('#purchaseTable tbody > tr').each(function () { 
        const $row = $(this);
        // <!-- const box = parseInt($row.find('.box input').val()) || 0; -->
        const box = parseInt($row.find('.box ').val()) || 0;
        const loose = parseInt($row.find('.loose_pcs input').val()) || 0;
        const seconds = parseInt($row.find('.seconds_pcs input').val()) || 0;
        const shortage = parseInt($row.find('.shortage input').val()) || 0;
        // const balance_val = parseInt($row.find('.balance ').val()) || 0;
        const balance_val = parseInt($row.find('.balance').text()) || 0;

        const total = (box * perBox) + loose + seconds + shortage;
        totalDeliveredPcs += total;
        totalBox += box;
        loose_pcs += loose;
        seconds_pcs += seconds;
        shortage_pcs += shortage;
        bal_val = balance_val;

        // Set total_pcs
        $row.find('.total_pcs input').val(total);

        // Set balance logic
        const extras = loose + seconds + shortage;
        const balance = (extras === 0) ? (total % perBox) : 0;
        $row.find('.balance input').val(balance);
    });

    // Update summary
    $('#delivered_pcs').text(totalDeliveredPcs);
    $('#loose_pcs').text(loose_pcs);
    $('#seconds_pcs').text(seconds_pcs);
    $('#shortage_pcs').text(shortage_pcs);
    $('#total_box').text(totalBox);
    $('#per_box').text(perBox);
    $('#balance_pcs').text(bal_val);
    // $('#balance_pcs').text(totalDeliveredPcs - (totalBox * perBox));
}







function calculateTotalValue() {
  let totalDelivered = 0;
  let totalAlreadyRec = 0;
  let totalBoxes = 0;
  let totalBoxPcs = 0;
  let totalLoosePcs = 0;
  let totalSecondsPcs = 0;
  let totalShortagePcs = 0;
  let totalPcs = 0;
  let balancePcs = 0;

  document.querySelectorAll("#purchaseTable tbody tr").forEach(row => {
    totalDelivered += parseInt(row.querySelector(".delivered_qty").value) || 0;
    totalAlreadyRec += parseInt(row.querySelector(".alr_rec input").value) || 0;
    totalBoxes += parseInt(row.querySelector(".box input").value) || 0;
    // <!-- totalBoxes += parseInt(row.querySelector(".box ").value) || 0; -->
    totalBoxPcs += parseInt(row.querySelector(".box_pcs").textContent) || 0;
    totalLoosePcs += parseInt(row.querySelector(".loose_pcs input").value) || 0;
    totalSecondsPcs += parseInt(row.querySelector(".seconds_pcs input").value) || 0;
    totalShortagePcs += parseInt(row.querySelector(".shortage input").value) || 0;
    totalPcs += parseInt(row.querySelector(".total_pcs").textContent) || 0;
    balancePcs += parseInt(row.querySelector(".balance").textContent) || 0;
  });

  document.getElementById("total_delivered_pcs").textContent = totalDelivered;
  document.getElementById("total_already_rec_pcs").textContent = totalAlreadyRec;
  document.getElementById("total_boxes").textContent = totalBoxes;
  document.getElementById("total_box_pcs").textContent = totalBoxPcs;
  document.getElementById("total_loose_pcs").textContent = totalLoosePcs;
  document.getElementById("total_seconds_pcs").textContent = totalSecondsPcs;
  document.getElementById("total_shortage_pcs").textContent = totalShortagePcs;
  document.getElementById("total_pieces").textContent = totalPcs;
  document.getElementById("balance_pieces").textContent = balancePcs;
}


$('#add_new').on('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    console.log("Submit button clicked");

    // Get outward text and extract values
    var outward_text = $('#prg_id option:selected').text().trim();
    console.log('out-text:', outward_text);

    var outward_number_match = outward_text.match(/^([^\s]+)/); // match until first space
    var outward_number = outward_number_match ? outward_number_match[1] : '';
    console.log('outward_number:', outward_number);

    var delivery_from = '';
    if (outward_text.includes('(P)')) {
        delivery_from = 'packing';
    } else if (outward_text.includes('(SP)')) {
        delivery_from = 'stiching';
    }
    console.log('delivery_from:', delivery_from);

    var fab_id = $('#fabric_id').val();
    var TableData = storeTblValues();
    console.log('tbl-data:', TableData);

    if (TableData.length === 0) { 
        notifier.show(
            'Error!', 
            'Some rows have Weight (Wt) <= 0. Please correct them before submitting.',
            'danger', 
            "{% static 'assets/images/notification/high_priority-48.png' %}", 
            4000
        ); 
        return;
    }

    if (confirm("Are you sure you want to save?")) {
        TableData = JSON.stringify(TableData); 
        var mdata = new FormData(this);

        // Append custom data
        mdata.append('cutting_data', TableData);  

        mdata.append('party_id', $('#party_id').val() ); 
        // <!-- mdata.append('total_box', $('#total_box').text() || '0'); -->
        // <!-- mdata.append('delivered_pcs', $('#delivered_pcs').text() || '0'); -->
        // <!-- mdata.append('per_box', $('#per_box').text() || '0'); -->
        // <!-- mdata.append('balance_pcs', $('#balance_pcs').text() || '0');  -->
		
		var delivered_pcs = $('#delivered_pcs').text();
        var total_box = $('#total_box').text();

        var per_box = $('#box_piece').text();  // üîπ Fixed `.text()` to `.text()`
        var balance_pcs = $('#balance_pcs').text();
        var loose_pcs = $('#loose_pcs').text();
        var seconds_pcs = $('#seconds_pcs').text();
        var shortage_pcs = $('#shortage_pcs').text();

        // alert('q-id:', quality_id);


        mdata.append('total_box', total_box);
        mdata.append('delivered_pcs', delivered_pcs);
        mdata.append('per_box', per_box) || 0;
        mdata.append('loose_pcs', loose_pcs) || 0;
        mdata.append('seconds_pcs', seconds_pcs) || 0;
        mdata.append('shortage_pcs', shortage_pcs) || 0;
        mdata.append('balance_pcs', balance_pcs) || 0;
  

        mdata.append('delivery_from', delivery_from);
        mdata.append('outward_number', outward_number);  
        // mdata.append('fabric_id', fab_id);
        
        mdata.append('fab_id',fab_id);
        $.ajax({
            type: "POST", 
            url: "/add-packing-received/", 
            data: mdata,
            processData: false,
            contentType: false,
            beforeSend: function() {
                console.log("Sending AJAX request...");
                $('#submit').attr('disabled', true).text('Processing...');
            },
            success: function(data) {  // üîπ Fixed response handling
                console.log("Server Response:", data);
                $('#submit').attr('disabled', false).text('Save');

                if (data.status === 'yes') {  // ‚úÖ Corrected condition
                    notifier.show(
                        'Well Done!', 
                        'Packing Received Added!', 
                        'success', 
                        "{% static 'assets/images/notification/ok-48.png' %}", 
                        4000
                    );  
                    location.reload();
                    // $('#add_new').trigger('reset'); 
					
					// $('#quality_id').val('').trigger("change");
					// $('#prg_id').val('').trigger("change");
					// $('#style_id').val('').trigger("change");
					// $('#size_id').val('').trigger("change");

					// $('#purchaseTable tbody').empty();      
					// $('#summary_table tbody').empty();     
                
                } else {
                    notifier.show(
                        'Error!', 
                        'Failed To add', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("AJAX Error:", textStatus, errorThrown);
                notifier.show(
                    'Error!', 
                    'Error adding data', 
                    'danger', 
                    "{% static 'assets/images/notification/high_priority-48.png' %}", 
                    4000
                ); 
                $('#submit').attr('disabled', false).text('Save');
            }
        });
    }
});

 


$('.single-select').select2();

            // Get current date and time
    const currentDate = new Date();
    const currentDateString = currentDate.toISOString().slice(0, 10); // Format as YYYY-MM-DD
    const currentTimeString = currentDate.toTimeString().slice(0, 5); // Format as HH:MM

    // Set default values for date and time fields
    document.getElementById('inward_date').value = currentDateString;
    document.getElementById('dc_date').value = currentDateString;

 

</script>