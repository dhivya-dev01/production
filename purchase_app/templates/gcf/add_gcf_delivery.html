
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}

<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title"> <!-- mill to knitting delivery -->
                                            <h4 class="m-b-10">Colored Fabric Outward  </h4>
                                        </div>
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Colored fabric</a></li>
                                            <li class="breadcrumb-item"><a href="/gf-deliver"> Colored Fabric Outward</a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>

                                     
                                    <div class="row"> 
                                        <div class="col-sm-12">
                                            <div class="card">   
                                                
                                                <form id="add_new">

                                                    <div class="row"> 
                                                        <div class="col-md-9">
                                                            {% csrf_token %}
                                                            <div class="row ms-2">
                                                              
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="number" class="form-label">DO No.</label>
                                                                    <input type="number" class="form-control" id="delivery_number" value="{{do_number}}" disabled>

                                                                </div>
                                                              

                                                                <div class="col-md-2 mt-2">
                                                                    <label for="number" class="form-label">DO Date</label> 
                                                                    <input type="date" class="form-control" id="delivery_date" name="do_date">

                                                                </div>


                                                                <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">Deliver To  </label> <!-- Dyeing -->
                                                                    <select id="supplier_id" name="supplier_id" class="form-control single-select" required onchange="LoadOrderThrough()">
                                                                        <option value="">Select</option>
                                                                        {% for k in supplier %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %} 
                                                                    </select> 
                                                                </div>


                                                                <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">Order Through </label> <!-- Compacting -->
                                                                    <select id="order_through_id" name="order_through_id" class="form-control single-select" required onchange="LoadOrderThrough()">
                                                                        <option value="">Select</option>
                                                                        {% for k in through %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %} 
                                                                    </select> 
                                                                </div>
                                                                


                                                                
                                                    

                                                                <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">Lot </label> <!-- Dyeing -->
                                                                    <select id="lot_list" name="lot_list" class="form-control single-select" required onchange="LoadLotDetails()">
                                                                        <option value="">Select</option>
                                                                       
                                                                    </select> 
                                                                </div>
                                                                

                                                                <!-- <div class="col-md-2 mt-2">
                                                                    <label for="unit" class="form-label"> Quantity</label>
                                                                    <input class="form-control" type="text" name="lot_total_quantity" id="lot_total_quantity" required>
                                                                </div>
                                                                -->
                                                               
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="order_date" class="form-label">Remarks</label>
                                                                    <textarea class="form-control" type="text" name="remarks" id="remarks" rows="2"></textarea>
                                                                </div>
                                                            </div>
                    
                    
                                                            <div class="row ms-2">
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="bag" class="form-label">Fabric</label>
                                                                    <select id="fabric_id" name="fabric_id" class="form-control single-select" onchange="LoadFabricValues()">
                                                                        <option value="">Select</option>
                                                                        {% for k in product %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                    
                                                                <div class="col-md-2 mt-3">
                                                                    <div class="form-group">
                                                                        <label for="product_id" class="form-label">Count</label>
                                                                        
                                                                        <select id="count_id" name="count" class="form-control single-select" >
                                                                            <option value="">Select</option>
                                                                            {% for k in count %}
                                                                            <option value="{{ k.id }}">{{ k.count }}</option> 
                                                                            {% endfor %}
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                


                                                                
                                                            
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="per_bag" class="form-label">Gauge</label>
                                                                    <select id="gauge_id" name="gauge" class="form-control single-select" >
                                                                        <option value="">Select</option>
                                                                        {% for k in gauge %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                             
                                                                <div class="col-md-2 mt-3 mb-3">
                                                                    <label for="quantity" class="form-label">TEX/Loop Length</label>
                                                                    <select id="tex_id" name="tex" class="form-control single-select" >
                                                                        <option value="">Select</option>
                                                                        {% for k in tex %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                             
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="rate" class="form-label">GSM</label>
                                                                    <input type="number"  class="form-control" id="gsm" name="gsm"  >
                                                                </div>
                                                                

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="rate" class="form-label">DIA</label>
                                                                    <input type="number"  class="form-control" id="dia" name="dia"  >
                                                                </div>
                                                                
                                                                
                                                            
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="rolls" class="form-label">Rolls</label>
                                                                    <input type="number" class="form-control" id="rolls" name="rolls">
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="wt_per_roll" class="form-label">Wt. Per Roll</label>
                                                                    <input type="number" class="form-control" id="wt_per_roll" name="wt_per_roll">
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="qty" class="form-label">Qty in kg</label>
                                                                    <input type="number" class="form-control" id="quantity" value="1" name="quantity">
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="qty" class="form-label">Total Amount</label>
                                                                    <input type="number" step="0.01" class="form-control" id="total_amount" name="total_amount">
                                                                </div>
                                                                
                                                                <div class="col-md-2 mt-5">
                                                                    <input type="hidden" id="edit_id" name="edit_id">
                                                                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                                                    <button type="button" id="update" class="btn btn-primary " onclick="addRow()">+ Add</button>
                                                                </div>
                                                            </div>
                     
                    
                    
                    
                                                        </div>


                                                   
                                                        
                                                        <div class="col-md-3">
                                                            <div class="row">
                                                                <div class="col-md-12">
                                                                    <div class="p-2">
                                                                        <table id="DeliverTable" class="table table-striped table-bordered">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th></th>
                                                                                    <th colspan="2">Inward</th>
                                                                                    <th colspan="2">Delivered</th>
                                                                                    <th colspan="2">Balance</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                <tr>
                                                                                    <td>Total Quantity</td>
                                                                                    <td colspan="2" id="qty_total_placeholder" class="text-end">0</td>
                                                                                </tr>
                                                                    
                                                                            
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                    
                                                                </div>
                                                            </div>


                                                        </div>
                                                    
                                                    </div>
                                        
                                                
                                                    <div class="card-body">
                                                        <div class="table-responsive table-desi">
                                                            <table id="purchaseTable" class="table table-bordered">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Product</th>
                                                                        <th>Lot No</th>
                                                                        <th>Count</th>
                                                                        <th>Gauge</th>
                                                                        <th>Tex</th>
                                                                        <th>Dia</th>
                                                                        <th>Rolls</th>
                                                                        <th>Wt Per Roll</th>
                                                                        <th>Quantity</th>
                                                                        <th>Rate</th>
                                                                        <th>Total Amount</th>
                                                                        <th>Tax Value</th>
                                                                        <th>Action</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <!-- Rows will be added dynamically here -->
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>

                                                    <div class="row">
                     
                                                        <div class="col-md-8">
                                                            
                                                        </div>
                                                        <!-- <div class="col-md-3"></div> -->
                                                        <div class="col-md-4">
                                                        <div class=" m-b-30">
                                                            <div class="card-body">            
                                                                <table id="summaryTable" class="table table-striped table-bordered w-100">
                                                                    <thead>
                                                                        <tr>
                                                                            <th colspan="2">Summary Table</th>
                                                                        </tr> 
                                                                    </thead>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td> Total Quantity</td>
                                                                            <td align="end" colspan="2" id="qty_total_placeholder">0</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td>Sub Total</td>
                                                                            <td align="end" colspan="2" id="sub_total_placeholder">0.00</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td>Total Tax</td>
                                                                            <td align="end" colspan="2" id="tax_placeholder">0.00</td>
                                                                        </tr>
    
                                                                        <tr>
                                                                            <td>Round off</td>
                                                                            <td align="end" colspan="2" id="round_off">0.00</td>
                                                                        </tr>
                                                                        <tr> 
                                                                            <td>Grand Total</td>
                                                                            <td style="background-color: #428bca; color: black; font-size: 21px" align="end" colspan="2" id="total_payable">0.00</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>      
                                                            </div>
                                                        </div>
                                                    </div>  
                                             
                                                    <div style="text-align: center;">
                                                        <button type="button" id="cancel" class="btn btn-danger" onclick="history.back()">Close</button>
                                                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                                                        <button type="submit" id="submit" class="btn btn-primary">Save</button>
                                                    </div>
                                            
                                            </div>

                                               
                                            </div> </form>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'includes/footer.html' %}

<script>


$(document).on('change', '#do_id', function() {
    const poId = $(this).val(); // Get selected Purchase Order IDs from the multiple select

    if (    !poId) {
        alert("Please select both a Supplier and a Purchase Order.");
        return; // Exit if either is not selected
    }

    // Call the function to load purchases based on the selected supplier and purchase orders
    // LoadDeliver();
    loadPurchases( poId);
});





function LoadFabricValues() {
    var product_id = $('#fabric_id').val(); 
    console.log('Product-ID:', product_id); // Debugging output

    if (!product_id) {
        console.warn("No Product ID selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

    $.ajax({
        type: 'POST',
        url: '/get_fabric_program_lists/',
        data: {
            'product_id': product_id,
            'csrfmiddlewaretoken': csrfToken
        },
        dataType: 'json',
        success: function(data) {
            console.log('Received Data:', data); // Debugging output

            // Clear existing values and add default "Select" option
            $('#count_id').empty().append(''); 
            $('#gauge_id').empty().append('');
            $('#tex_id').empty().append('');
            $('#gsm').val('');  // Clear input field

            // Populate dropdowns only if data exists
            if (data.count) {
                $('#count_id').append('<option value="' + data.count.id + '">' + data.count.count + '</option>');
            }

            if (data.gauge) {
                $('#gauge_id').append('<option value="' + data.gauge.id + '">' + data.gauge.name + '</option>');
            }

            if (data.tex) {
                $('#tex_id').append('<option value="' + data.tex.id + '">' + data.tex.name + '</option>');
            }

            if (data.gsm) {
                $('#gsm').val(data.gsm.gray_gsm);  // Assigning GSM value
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading fabric details:', error);
        } 
    });
} 





function LoadLotDetails() {
    var lot_no = $('#lot_list').val(); 
    console.log('Lot ID:', lot_no); // Debugging output

    if (!lot_no) {
        console.warn("No Lot selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

    $.ajax({
        type: 'POST',
        url: '/get_gcf_lot_details/',
        data: {
            'lot_id': lot_no,
            'csrfmiddlewaretoken': csrfToken
        },
        dataType: 'json',  
        success: function(data) {
            console.log('Received Data:', data); // Debugging output

            // Update Total Quantity Input
            // $('#lot_total_quantity').val(data.inward_total_quantity);  
            // $('#lot_no').val(data.lot_no);   

            $('#lot_total_quantity').val('');  // Clear input field 
            $('#fabric_id').empty().append(''); 
          
            if (data) {
                $('#lot_total_quantity').val(data.inward_total_quantity);  // Assigning GSM value
            }
            $('#lot_no').val('');  // Clear input field

          
            if (data) {
                $('#lot_no').val(data.lot_no);  // Assigning GSM value
            }

            if (data.prd) {
                $('#fabric_id').append('<option value="' + data.prd.id + '">' + data.prd.product.name + '</option>');
            }

            // Update Table Data <td colspan="2" class="text-end">${data.program_total_quantity}</td> 
            var tableHtml = `
                <tr>
                    <td>Total Quantity</td>
                    <td colspan="2" class="text-end">${data.inward_total_quantity}</td> 
                    <td colspan="2" class="text-end">${data.delivered_quantity}</td>
                    <td colspan="2" class="text-end">${data.balance_quantity}</td>
                </tr>
            `;

            // Replace the existing table body with new data
            $('#DeliverTable tbody').html(tableHtml);
        },
        error: function(xhr, status, error) {
            console.error('Error loading lot details:', error);
        } 
    });
}



// function LoadOrderThrough() {
//     var supplier_id = $('#supplier_id').val(); 
//     console.log('Supplier-ID:', supplier_id); // Debugging output

//     if (!supplier_id) {
//         console.warn("No Supplier ID selected");  
//         return;
//     }

//     var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

//     // Clear the previous lot list before making an AJAX call
//     $('#lot_list').empty().append('<option value="">Select</option>'); 

//     $.ajax({
//         type: 'POST',
//         url: '/get_throught_lot_list/', 
//         data: {
//             'supplier_id': supplier_id,
//             'csrfmiddlewaretoken': csrfToken
//         }, 
//         dataType: 'json',
//         success: function(data) {
//             console.log('Received Data:', data); // Debugging output

//             // Ensure that only the current supplier's lots are listed
//             if (data.lots && data.lots.length > 0) {
//                 $.each(data.lots, function(index, lot) {
//                     $('#lot_list').append('<option value="' + lot.id + '">' + lot.lot_no + '</option>');
//                 });
//             } else {
//                 console.warn("No lots found for the selected supplier.");
//             }
//         },
//         error: function(xhr, status, error) {
//             console.error('Error loading lot details:', error);
//         } 
//     });
// }

function LoadOrderThrough() {
    var supplier_id = $('#supplier_id').val(); 
    console.log('Supplier-ID:', supplier_id); // Debugging output

    if (!supplier_id) {
        console.warn("No Supplier ID selected");  
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

    // **Clear the lot list and total quantity input before making the AJAX call**
    // $('#lot_list').empty().append('<option value="">Select</option>');  
    $('#lot_list').empty().append('');

    // $('#lot_total_quantity').val('');  // Clear total quantity

    $.ajax({
        type: 'POST',
        url: '/get_throught_lot_list/', 
        data: {
            'supplier_id': supplier_id,
            'csrfmiddlewaretoken': csrfToken
        }, 
        dataType: 'json',
        success: function(data) {
            console.log('Received Data:', data); // Debugging output

            // **Ensure only the current supplier’s lots are displayed**
            if (data.lots && data.lots.length > 0) {
                $.each(data.lots, function(index, lot) {
                    $('#lot_list').append('<option value="' + lot.id + '">' + lot.lot_no + '</option>');
                });
            } else {
                console.warn("No lots found for the selected supplier.");
            }

            // // **Update total quantity (if available)**
            // if (data.total_quantity && data.total_quantity.length > 0) {
            //     var totalQty = data.total_quantity[0].total_quantity;  // Get first quantity value
            //     $('#lot_total_quantity').val(totalQty);
            // }
        },
        error: function(xhr, status, error) {
            console.error('Error loading lot details:', error);
        } 
    });
}



// function LoadOrderThrough() {
//     var supplier_id = $('#supplier_id').val(); 
//     console.log('Supplier-ID:', supplier_id); // Debugging output

//     if (!supplier_id) {
//         console.warn("No Supplier ID selected"); 
//         return;
//     }

//     var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

//     $.ajax({
//         type: 'POST',
//         url: '/get_throught_lot_list/', 
//         data: {
//             'supplier_id': supplier_id,
//             'csrfmiddlewaretoken': csrfToken
//         }, 
//         dataType: 'json',
//         success: function(data) {
//             console.log('Received Data:', data); // Debugging output

//             // Clear existing values and add default "Select" option
//             $('#lot_list').empty().append(''); 
//             // Populate dropdowns only if data exists
//             if (data.lot) {
//                 $('#lot_list').append('<option value="' + data.lot.id + '">' + data.lot.lot_no + '</option>');
//             }
        
//         },
//         error: function(xhr, status, error) {
//             console.error('Error loading fabric details:', error);
//         } 
//     });
// }



function LoadDeliver() {
    var process_id = $('#process_id').val();  
    console.log('Process-ID:', process_id);  

    $.ajax({
        type: 'POST',
        url: '/get_process_deliver_lists/',  // Ensure this matches Django view URL
        data: {
            'process_id': process_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()  // Include CSRF token
        },
        dataType: 'json', // Ensure JSON response
        success: function(data) {
            $('#deliver_id').empty().append('<option value="">Select</option>');

            if (data.deliveries && data.deliveries.length > 0) {
                data.deliveries.forEach(function(deliver) {
                    $('#deliver_id').append('<option value="' + deliver.id + '">' + deliver.name + '</option>');
                });
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading deliver lists:', error);
        }
    });
}

// ``````````````````````````````````````````````````````````````````````````````````````````````````````````````````````




const loadedItemsMap = {}; 
let rowCounter = 0; // Initialize row counter

function loadPurchases(poIds) {
    const currentLoadedItems = new Set();
 
    $.ajax({
        type: "GET",
        url: "/load-gcf-delivery-orders/",
        data: {
            'po_id': poIds.join(',') // Send as a comma-separated string
        },
        success: function(data) {
            if (data.orders && data.orders.length > 0) {
                data.orders.forEach(function(item) {
                    const uniqueKey = `${item.product_id}_${item.tm_id}`;

                    if (!loadedItemsMap[uniqueKey]) {
                        const price = parseFloat(item.rate) || 0;
                        const tax_value = 5;
 
                        console.log("Adding row:", item);


                        addRow(
                            item.product, item.rate, item.count, item.gauge, item.tex, item.dia, 
                            item.rolls, item.wt_per_roll, item.amount, price, item.id, 
                            item.product_id, item.count_id, item.gauge_id, item.tex_id, 
                            item.tm_id, item.quantity, tax_value, item.delivery_rolls, item.lot_no  // Fix here
                        );

                        loadedItemsMap[uniqueKey] = true;
                        calculateTotalValue();
                    }

                    currentLoadedItems.add(uniqueKey);
                });
            } else {
                alert('No unassigned items found or all items are already assigned.');
            }
        },
        error: function(xhr, status, error) {
            console.log('error:', error);
            alert('Error loading purchases: ' + error);
        }
    });
}





function addRow(product, rate, count, gauge, tex, dia, rolls, wt_per_roll, total_amount, price, id, productId, count_id, gauge_id, tex_id, tmId, quantity, taxValue ,delivery_rolls,lot_no) {
    const tableBody = document.querySelector("#purchaseTable tbody");
    
    if (!tableBody) {
        console.error("Table body not found! Make sure the table exists in the DOM.");
        return;
    }

    rowCounter++;  // Generate unique row ID
    const rowId = `row_${rowCounter}`;

    const newRow = document.createElement("tr");
    newRow.setAttribute("data-product-id", productId);
    newRow.setAttribute("data-tm-id", tmId);
    newRow.setAttribute("data-row-id", rowId);

    newRow.innerHTML = `
        <td>${product}</td>
        <td>${lot_no}</td>
        <td>${count}</td>
        <td>${gauge}</td>
        <td>${tex}</td>
        <td>${dia}</td>
        <td>${rolls}</td>
        <td>${wt_per_roll}</td>
        <td>${quantity}</td> 
        <td>${(parseFloat(rate) || 0).toFixed(2)}</td>
        <td>${(parseFloat(total_amount) || 0).toFixed(2)}</td>
        <td>${taxValue}%</td>
        <td id="tm_id" style="display:none">${tmId}</td>
        <td id="id" style="display:none">${id}</td>
        <td id="product_id" style="display:none">${productId}</td>
        <td id="count_id" style="display:none">${count_id}</td>
        <td id="gauge_id" style="display:none">${gauge_id}</td>
        <td id="tex_id" style="display:none">${tex_id}</td>
        <td> 
            <button class="btn btn-danger btn-xs remove-row">
                <i class="feather icon-trash-2"></i>
            </button>
        </td>
    `; 

    // Append row to table body
    tableBody.appendChild(newRow);
    console.log("Row successfully added:", newRow); // Debugging log

    calculateTotalValue();

    // Event listener to remove row
    newRow.querySelector(".remove-row").addEventListener("click", function() {
        newRow.remove();
        calculateTotalValue();

        console.log("Row removed:", rowId);
    });
}

// Ensure table body is visible in CSS
const css = `
    #purchaseTable tbody {
        display: table-row-group; /* Ensure rows are visible */
    }
`;
const style = document.createElement('style');
style.appendChild(document.createTextNode(css));
document.head.appendChild(style);

 


// Calculation function for the row
function calculateRow(event) {
    var rowId = event.target.getAttribute('data-row-id');
    var row = document.querySelector(`[data-row-id="${rowId}"]`).closest('tr');
    
    var bagElement = row.querySelector('.bag');
    var perBagElement = row.querySelector('.per_bag');
    var quantityElement = row.querySelector('.quantity');
    var rateElement = row.querySelector('.rate');
    
    if (bagElement && perBagElement && quantityElement && rateElement) {
        // Calculate quantity based on bag and per_bag
        var bag = parseFloat(bagElement.value) || 0;
        var perBag = parseFloat(perBagElement.value) || 0;
        var quantity = bag * perBag;
        quantityElement.value = quantity;

        // Calculate amount based on quantity and rate
        var rate = parseFloat(rateElement.value) || 0;
        var amount = quantity * rate;
        row.querySelector('.amount').value = amount.toFixed(2);
    } else {
        console.error('Missing elements in the row.');
    }
    calculateTotalValue();
}


function storeTblValues() {
    var TableData = [];

    // Loop through each row in the table body
    $('#purchaseTable tbody tr').each(function(index) { 
        // Extract values from the columns of the row
        var product = $(this).find('td:eq(0)').text().trim(); // Product name
        var lot_no = $(this).find('td:eq(1)').text().trim(); // Product name
        var rate =parseFloat($(this).find('td:eq(9)').text()) || 0;  // Rate from input field
        var count =  $(this).find('td:eq(2)').text().trim(); // Bag quantity from input field
        var gauge =  $(this).find('td:eq(3)').text().trim();  // Per Bag price
        var tex =  $(this).find('td:eq(4)').text().trim();  // Per Bag price
        var dia =  $(this).find('td:eq(5)').text().trim();  // Per Bag price
        var rolls =  $(this).find('td:eq(6)').text().trim();  // Per Bag price
        var wt_per_roll =  $(this).find('td:eq(7)').text().trim();  // Per Bag price
        var quantity =  $(this).find('td:eq(8)').text().trim(); // Quantity
        var amount = parseFloat($(this).find('td:eq(10)').text()) || 0;  // Amount calculated
        var taxValue = parseFloat($(this).find('td:eq(11)').text()) || 0; // Tax value (as percentage)
        var tmId =  $(this).find('td:eq(12)').text().trim();// TM ID
        var id = $(this).find('td:eq(13)').text().trim();  // ID for the product/order
        var product_id = $(this).find('#product_id').text().trim();  // ID for the product/order
        var count_id = $(this).find('td:eq(15)').text().trim();  // ID for the product/order
        var gauge_id = $(this).find('td:eq(16)').text().trim();  // ID for the product/order
        var tex_id = $(this).find('td:eq(17)').text().trim();  // ID for the product/order

        // Validate that the necessary fields are populated
        if (product && rate && quantity && amount !== undefined && tmId && id) {
            TableData.push({
                "product": product,
                "rate": rate.toFixed(2),  // Fixed decimal format for rate
                "count_id": count_id,
                'gauge_id':gauge_id,
                'tex_id':tex_id,
                'dia':dia,
                'rolls':rolls,
                'wt_per_roll':wt_per_roll,
                "quantity": quantity,
                "amount": amount.toFixed(2),  // Fixed decimal format for amount
                "tax_value": taxValue.toFixed(2), // Fixed decimal format for tax value
                "tm_id": tmId,
                "id": id ,
                'product_id':product_id,
                'lot_no':lot_no
            });
        } else {
            console.error(`Row ${index + 1} is missing required data:`, {
                product_name: product || "Missing", 
                rate: rate || "Missing",
                quantity: quantity || "Missing",
                amount: amount || "Missing",
                tm_id: tmId || "Missing",
                id: id || "Missing"
            });
        }
    });

    // Calculate the total (assuming you have a function for total calculation)
    calculateTotalValue();  // Call to calculate the total after collecting all values
    
    console.log('TABLE-DATA:', TableData);  // Output the collected table data
    return TableData;  // Return the data to be used further (for submission, storage, etc.)
}


// Calculate the total of all rows
function calculateTotalValue() {
    let totalQuantity = 0;
    let subTotal = 0;
    let totalTax = 0;
    let taxSummary = {}; 

    // Tax rate as a percentage
    const taxRate = 5;

    // Iterate over each row in the table to calculate totals
    $('#purchaseTable tbody > tr').each(function() {
        // Fetch values from each cell
        const quantity = parseFloat($(this).find('td:eq(8)').text()) || 0; // Quantity from input field
        const rate = parseFloat($(this).find('td:eq(9)').text()) || 0;// Rate from input field
        const amount = parseFloat($(this).find('td:eq(10)').text()) || 0; // Amount from input field

        // Calculate tax amount as 5% of the amount
        const taxAmount = (amount * taxRate) / 100;

        // Update totals 
        totalQuantity += quantity;
        subTotal += amount;
        totalTax += taxAmount;  // Adding calculated tax to total tax

        // Update tax summary (if any tax logic is needed)
        if (taxAmount > 0) {
            if (!taxSummary[taxRate]) {
                taxSummary[taxRate] = { sgst: 0, cgst: 0, igst: 0, totalTax: 0 };
            }
            // Assuming SGST and CGST split equally for simplicity
            const sgstAmount = taxAmount / 2;
            taxSummary[taxRate].sgst += sgstAmount;
            taxSummary[taxRate].cgst += sgstAmount;
            taxSummary[taxRate].totalTax += taxAmount;
        }
    });

    // Calculate round-off value and grand total
    const totalAmount = subTotal + totalTax;
    const roundOff = totalAmount - Math.floor(totalAmount);  // Get the decimal part

    // Apply the round-off logic (if >= 0.5, round up; if < 0.5, round down)
    const adjustedRoundOff = roundOff >= 0.5 ? (1 - roundOff) : -roundOff;

    const grandTotal = (subTotal + totalTax + adjustedRoundOff).toFixed(2);  // Add adjusted round-off to grand total

    // Display totals 
    $('#qty_total_placeholder').text(totalQuantity);
    $('#sub_total_placeholder').text(subTotal.toFixed(2));
    $('#tax_placeholder').text(totalTax.toFixed(2));
    $('#round_off').text(adjustedRoundOff.toFixed(2));
    $('#total_payable').text(grandTotal);
 
    // Update tax summary table (if needed)
    // $('#tax_summary_body').empty();
    // for (const [rate, data] of Object.entries(taxSummary)) {
    //     $('#tax_summary_body').append(`
    //         <tr>
    //             <td>${rate}%</td>
    //             <td>${data.sgst.toFixed(2)}</td>
    //             <td>${data.cgst.toFixed(2)}</td>
    //             <td>${data.igst ? data.igst.toFixed(2) : '0.00'}</td>
    //             <td>${data.totalTax.toFixed(2)}</td>
    //         </tr>
    //     `);
    // }
}


// `````````````````````````````````````````````````````````````````````




// ```````````````````````````````````````````````````````


$('#add_new').on('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    console.log("Submit button clicked"); // Debugging

    var TableData = storeTblValues();
    console.log('tbl-data:', TableData);

    if (TableData.length === 0) {
        notifier.show(
            'Error!', 
            'Table is empty. Please insert the program details.', 
            'success', 
            "{% static 'assets/images/notification/ok-48.png' %}", 
            4000
        ); 


        return;
    }

    if (confirm("Are you sure you want to save?")) {
        TableData = JSON.stringify(TableData); 
        var mdata = new FormData(this);
        mdata.append('chemical_data', TableData);

        var totalQty = $('#qty_total_placeholder').text();
        var subTotal = $('#sub_total_placeholder').text();
        var taxTotal = $('#tax_placeholder').text();
        var roundOff = $('#round_off').text();
        var totalPayable = $('#total_payable').text();

        // Append total values to FormData
        mdata.append('total_quantity', totalQty);  // This is where total_quantity is added 
        mdata.append('sub_total', subTotal); 
        mdata.append('tax_total', taxTotal);
        mdata.append('round_off', roundOff);
        mdata.append('total_payable', totalPayable);

       

        $.ajax({
            type: "POST", 
            url: "/add-gcf-deliver/",
            data: mdata,
            processData: false,
            contentType: false,
            beforeSend: function() {
                console.log("Sending AJAX request...");
                $('#submit').attr('disabled', true).text('Processing...');
            },
            success: function(data) {
                console.log("Server Response:", data);
                $('#submit').attr('disabled', false).text('Save');

                if (data === 'yes') {
                    notifier.show( 
                        'Well Done!', 
                        'Knitting program added!', 
                        'success', 
                        "{% static 'assets/images/notification/ok-48.png' %}", 
                        4000
                    ); 
                    $('#add_new').trigger('reset');
 
                    // location.reload();
                } else {
                    notifier.show(
                        'Error!', 
                        'Failed To add', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("AJAX Error:", textStatus, errorThrown);
                notifier.show(
                        'Error!', 
                        'Error adding data', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
                // alert('Error Adding data');
                $('#submit').attr('disabled', false).text('Save');
            }
        });
    }
});


$('.single-select').select2();

            // Get current date and time
    const currentDate = new Date();
    const currentDateString = currentDate.toISOString().slice(0, 10); // Format as YYYY-MM-DD
    const currentTimeString = currentDate.toTimeString().slice(0, 5); // Format as HH:MM

    // Set default values for date and time fields
    document.getElementById('delivery_date').value = currentDateString;
    // document.getElementById('purchase_time').value = currentTimeString;



</script>