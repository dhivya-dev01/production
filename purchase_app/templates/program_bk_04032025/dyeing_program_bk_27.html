
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}

<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row"> 
                            <div class="col-sm-12"> 
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title"> <!-- mill to knitting delivery -->
                                            <h4 class="m-b-10">Dyeing Program  </h4>
                                        </div>
                                        <ul class="breadcrumb"> 
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Program</a></li>
                                            <li class="breadcrumb-item"><a href="/purchase/gf-deliver"> Dyeing Program</a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>

                                    <div class="card">  

                                        <div class="card-body row"> 
                                            <form id="add_new">
                                                <div class="col-sm-12">
                                                    <div class="row"> 
                                                        {% csrf_token %}
                                                        <div class="col-md-9">
                                                            <div class="row ">
                                                            

                                                                <div class="col-md-2 mt-2">
                                                                    <label for="number" class="form-label">Program No.</label>
                                                                    <input type="number" class="form-control" id="delivery_number" value="{{prg_number}}" disabled>

                                                                </div>
                                                              
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="order_date" class="form-label">Program Date</label>
                                                                    <input class="form-control" type="date" name="delivery_date" id="delivery_date" required>
                                                                </div>

                                                               
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">Compacting</label>
                                                                    <select id="deliver_id" name="deliver_id" class="form-control form-select single-select" >
                                                                        <option value="">Select</option>
                                                                        {% for k in party %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %} 
                                                                    </select>  
                                                                </div> 
 
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">Lot </label>
                                                                    <select id="lot" name="lot" class="form-control single-select" onchange="LoadLotDetails()">
                                                                        <option value="">Select</option>
                                                                        {% for k in lot %}
                                                                        <option value="{{ k.id }}">{{ k.lot_no }}</option> 
                                                                        {% endfor %} 
                                                                    </select> 
                                                                </div> 
                                                                
                                                               
                                                                <div class="col-md-4 mt-2">
                                                                    <label for="order_date" class="form-label">Remarks</label>
                                                                    <input class="form-control" type="hidden" name="lot_no" id="lot_no">
                                                                    <input class="form-control" type="hidden" name="lot_total_quantity" id="lot_total_quantity">
                                                              
                                                                    <input class="form-control" type="text" name="remarks" id="remarks" >
                                                                </div>
                                                      
                                                                
                                                      
                    

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Fabric</label>
                                                                    <select id="fabric_id" name="fabric_id" class="form-control single-select">
                                                                        <option value="">Select</option>
                                                                        {% for k in fabric_program %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                                
                                                                <!-- Load Button -->
                                                                <div class="col-md-2 mt-5">
                                                                    <input type="hidden" id="edit_id" name="edit_id">
                                                                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                                                    <button type="button" id="update" class="btn btn-primary">+ Load</button>
                                                                </div>

                                                            </div>
                                                        </div>
                     
                                                        
                    
                    
                                                       
                                                    </div>

                                                        
                                                </div>

                                            </form>
                                                    
                                        </div>  
                                        


                                        <div class="modal-footer" >
                                            <button type="button" id="cancel" class="btn btn-danger" onclick="history.back()">Close</button>
                                            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                                            <button type="submit" id="submit" class="btn btn-primary">Save</button>
                                        </div>


                                        <div class="col-md-12" id="tablesContainer">
                                            <!-- Tables will be appended here -->
                                        </div>



                                    </div> 
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'includes/footer.html' %}

<script>

$('.single-select').select2();


function LoadColorTable() {
        let fabricDropdown = $("#fabric_id");
        let selectedFabricId = fabricDropdown.val();
        let selectedFabricText = fabricDropdown.find("option:selected").text();

        if (!selectedFabricId) {
            alert("Please select a fabric first.");
            return;
        }

        // Prevent duplicate table loading for the same fabric
        if ($("#table_" + selectedFabricId).length > 0) {
            alert("Table for this fabric is already loaded.");
            return;
        }

        // Fetch color and dia data from Django
        $.ajax({
            url: "{% url 'get_fabric_details' %}", 
            type: "GET",
            data: { fabric_id: selectedFabricId },
            success: function (response) {
                if (response.success) {
                    let colors = response.colors;
                    let diaValues = response.dia_values;
                    let diaColumns = "";
                    let diaSubColumns = "";
                    let totalColumns = "";

                    // Create Dia Column Headers
                    diaValues.forEach(dia => {
                        diaColumns += `<th colspan="2">Dia ${dia}</th>`;
                        diaSubColumns += `<th>Rolls</th><th>Wt</th>`;
                    });

                    // Create Total Column Headers
                    totalColumns = `<th colspan="2">Total</th>`;

                    // Generate table rows for each color
                    let tableRows = "";
                    colors.forEach(color => {
                        let diaData = "";
                        diaValues.forEach(() => {
                            diaData += `<td class="dia-rolls text-end">0</td><td class="dia-wt text-end">0</td>`;
                        });

                        tableRows += `
                        <tr>
                            <td>${color.name}</td>
                            ${diaData}
                            <td class="total-rolls text-end">0</td>
                            <td class="total-wt text-end">0</td>
                        </tr>`;
                    });

                    // Create new table                        <h5 style="color:#dc0e3a">Fabric: ${selectedFabricText}</h5>

                    let newTable = `
                    <div class="p-2">
                        <h5 >Fabric: ${selectedFabricText}</h5>
                        <table id="table_${selectedFabricId}" class="table table-striped table-bordered w-100">
                            <thead>
                                <tr>
                                    <th rowspan="2">Color</th>
                                    ${diaColumns}
                                    ${totalColumns}
                                </tr>
                                <tr>
                                    ${diaSubColumns}
                                    <th>Rolls</th>
                                    <th>Wt</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                            <tfoot>
                                <tr>
                                    <th>Total</th>
                                    ${diaValues.map(() => `<th class="text-end totalDiaRolls">0</th><th class="text-end totalDiaWt">0</th>`).join('')}
                                    <th class="text-end totalTotalRolls">0</th>
                                    <th class="text-end totalTotalWt">0</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>`;

                    // Append new table
                    $("#tablesContainer").append(newTable);

                    // Recalculate totals for this table
                    calculateTotals("#table_" + selectedFabricId);
                } else {
                    alert(response.message);
                }
            },
            error: function () {
                alert("Error fetching fabric details.");
            }
        });
    }

    function calculateTotals(tableId) {
        let totalDiaRolls = {};
        let totalDiaWt = {};
        let totalTotalRolls = 0;
        let totalTotalWt = 0;

        $(tableId).find(".dia-rolls").each(function (index) {
            let val = parseFloat($(this).text()) || 0;
            totalDiaRolls[index] = (totalDiaRolls[index] || 0) + val;
        });

        $(tableId).find(".dia-wt").each(function (index) {
            let val = parseFloat($(this).text()) || 0;
            totalDiaWt[index] = (totalDiaWt[index] || 0) + val;
        });

        $(tableId).find(".total-rolls").each(function () {
            totalTotalRolls += parseFloat($(this).text()) || 0;
        });

        $(tableId).find(".total-wt").each(function () {
            totalTotalWt += parseFloat($(this).text()) || 0;
        });

        Object.keys(totalDiaRolls).forEach((index) => {
            $(tableId).find(".totalDiaRolls").eq(index).text(totalDiaRolls[index]);
        });

        Object.keys(totalDiaWt).forEach((index) => {
            $(tableId).find(".totalDiaWt").eq(index).text(totalDiaWt[index] + " kg");
        });

        $(tableId).find(".totalTotalRolls").text(totalTotalRolls);
        $(tableId).find(".totalTotalWt").text(totalTotalWt + " kg");
    }

    // Attach event to the button
    $("#update").click(function () {
        LoadColorTable();
    });


// function LoadColorTable() {
//         let fabricDropdown = $("#fabric_id");
//         let selectedFabricId = fabricDropdown.val();
//         let selectedFabricText = fabricDropdown.find("option:selected").text();

//         // Check if fabric is selected
//         if (!selectedFabricId) {
//             alert("Please select a fabric first.");
//             return;
//         }

//         // Prevent duplicate table loading for the same fabric
//         if ($("#table_" + selectedFabricId).length > 0) {
//             alert("Table for this fabric is already loaded.");
//             return;
//         }

//         // Fetch color data from Django backend
//         $.ajax({
//             url: "{% url 'get_colors_for_fabric' %}",  // URL of the Django API
//             type: "GET",
//             data: { fabric_id: selectedFabricId },
//             success: function (response) {
//                 if (response.success) {
//                     let colors = response.colors;
//                     let tableRows = "";

//                     // Generate table rows for each color
//                     colors.forEach(color => {
//                         tableRows += `
//                         <tr>
//                             <td>${color.name}</td>
//                             <td class="dia-rolls text-end">0</td>
//                             <td class="dia-wt text-end">0</td>
//                             <td class="total-rolls text-end">0</td>
//                             <td class="total-wt text-end">0</td>
//                         </tr>`;
//                     });

//                     // Create new table
//                     let newTable = `
//                     <div class="p-2">
//                         <h5>Fabric: ${selectedFabricText}</h5>
//                         <table id="table_${selectedFabricId}" class="table table-striped table-bordered w-100">
//                             <thead>
//                                 <tr>
//                                     <th rowspan="2">Color</th>
//                                     <th colspan="2">Dia</th>
//                                     <th colspan="2">Total</th>
//                                 </tr>
//                                 <tr>
//                                     <th>Rolls</th>
//                                     <th>Wt</th>
//                                     <th>Rolls</th>
//                                     <th>Wt</th>
//                                 </tr>
//                             </thead>
//                             <tbody>${tableRows}</tbody>
//                             <tfoot>
//                                 <tr>
//                                     <th>Total</th>
//                                     <th class="text-end totalDiaRolls">0</th>
//                                     <th class="text-end totalDiaWt">0</th>
//                                     <th class="text-end totalTotalRolls">0</th>
//                                     <th class="text-end totalTotalWt">0</th>
//                                 </tr>
//                             </tfoot>
//                         </table>
//                     </div>`;

//                     // Append new table
//                     $("#tablesContainer").append(newTable);

//                     // Recalculate totals for this table
//                     calculateTotals("#table_" + selectedFabricId);
//                 } else {
//                     alert(response.message);
//                 }
//             },
//             error: function () {
//                 alert("Error fetching color data.");
//             }
//         });
//     }

//     function calculateTotals(tableId) {
//         let totalDiaRolls = 0;
//         let totalDiaWt = 0;
//         let totalTotalRolls = 0;
//         let totalTotalWt = 0;

//         $(tableId).find(".dia-rolls").each(function () {
//             totalDiaRolls += parseFloat($(this).text()) || 0;
//         });

//         $(tableId).find(".dia-wt").each(function () {
//             totalDiaWt += parseFloat($(this).text()) || 0;
//         });

//         $(tableId).find(".total-rolls").each(function () {
//             totalTotalRolls += parseFloat($(this).text()) || 0;
//         });

//         $(tableId).find(".total-wt").each(function () {
//             totalTotalWt += parseFloat($(this).text()) || 0;
//         });

//         $(tableId).find(".totalDiaRolls").text(totalDiaRolls);
//         $(tableId).find(".totalDiaWt").text(totalDiaWt + " kg");
//         $(tableId).find(".totalTotalRolls").text(totalTotalRolls);
//         $(tableId).find(".totalTotalWt").text(totalTotalWt + " kg");
//     }

//     // Attach event to the button
//     $("#update").click(function () {
//         LoadColorTable();
//     });


</script>