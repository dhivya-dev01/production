
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}

<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title"> <!-- mill to knitting delivery -->
                                            <h4 class="m-b-10">Accessory Program  </h4>
                                        </div>
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Program</a></li>
                                            <li class="breadcrumb-item"><a href="/purchase/accessory-program"> Accessory Program</a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>

                                    <div class="card">

                                        <div class="card-body row"> 
                                            <div class="col-sm-12">
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <form id="add_new" >
                                                            {% csrf_token %}
                                                            <div class="row ">
                                                                
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="delivery_no" class="form-lebel">Program No.</label>
                                                                    <input type="text" class="form-control" value="{{prg_number}}" readonly>
                                                                </div>  
                                                                
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="order_date" class="form-label">Program Date</label>
                                                                    <input class="form-control" type="date" name="program_date" id="program_date" required>
                                                                </div>

                                                                 
                                                                <div class="col-md-4 mt-2">
                                                                    <label for="order_date" class="form-label">Remarks</label>
                                                                    <input class="form-control" type="text" name="remarks" id="remarks" >
                                                                </div>
                                                                
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">Party </label>
                                                                    <select id="party_id" name="party_id" class="form-control form-select single-select" onchange="LoadProgram()" >
                                                                        <option value="">Select</option>
                                                                        {% for k in party %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %} 
                                                                    </select>  
                                                                </div> 
 

                                                             
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Quality</label>
                                                                    <select id="quality_id" name="quality_id" class="form-control single-select" readonly onchange="LoadItem()">
                                                                        <option value="">Select</option>
                                                                        {% for k in quality %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                                

                                                            </div>

                                                            <div class="row">
                                                             
                                                                
                                                                
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Item</label>
                                                                    <select id="item_id" name="item_id" class="form-control single-select" >
                                                                        <option value="">Select</option>
                                                                        {% for k in accessory_item %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Program Type</label>
                                                                    <select id="program_type" name="program_type" class="form-control single-select" aria-readonly="true">
                                                                        <option value="">Select</option>
                                                                        <option value="Size">Size</option>
                                                                        <option value="Color">Color</option>
                                                                        <option value="Total Quantity">Total Quantity</option>
                                                                        
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Product Pieces</label>
                                                                    
                                                                    <input type="number" class="form-control" id="product_pieces" name="product_pieces" value="1" required>
                                                                </div>


                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Quantity (no's)</label>
                                                                    
                                                                    <input type="number" class="form-control" id="quantity" name="quantity" value="1" required>
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">UOM</label>
                                                                    
                                                                    <select id="uom_id" name="uom_id" class="form-control single-select" >
                                                                        <option value="">Select</option>
                                                                        {% for k in uom %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select> 
                                                                </div>


                                                          
                                                                <div class="col-md-2 mt-4">
                                                                   
                                                                    <button class="btn btn-primary mt-3" type="button" onclick="addManualRow()">+ Add</button>

                                                                </div>

                                                            </div>
                                                    
                                                        </div> 
                                                        <div class="">
                                                            <div class="table-responsive table-desi">

                                                                <table id="purchaseTable" class="table table-bordered">
                                                                    <thead>
                                                                        <tr>
                                                                            
                                                                            <th>Item</th>
                                                                            <th>Quality</th>
                                                                            <th>Pieces</th>
                                                                            <th>UOM</th>
                                                                            <th>Quantity</th>
                                                                            <th>Program Type</th>
                                                                            <th style="display: none;">Item id</th>
                                                                            <th style="display: none;">Quality id</th>
                                                                            <th style="display: none;">Uom id</th>
                                                                            <th>Actions</th>

                                                                        </tr>
                                                                    </thead> 
                                                                    <tbody></tbody> 
                                                                </table>

                                                            
                                                            
                                                            </div>
                                                        </div>

                                                        <div class="row">
                        
                                                            <div class="col-md-8">
                                                                <div class="" style="text-align: center;" >
                                                                    <button type="button" id="cancel" class="btn btn-danger" onclick="history.back()">Close</button>
                                                                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                                                                    <button type="submit" id="submit" class="btn btn-primary">Save</button>
                                                                </div>
                                                            </div>

                                                            <div class="col-md-4"> 

                                                            <div class="">            
                                                                <table id="summaryTable" class="table table-striped table-bordered w-100">
                                                                    <thead>
                                                                        <tr>
                                                                            <th colspan="2">Summary Table</th>
                                                                        </tr> 
                                                                    </thead>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td> Total Quantity</td>
                                                                            <td align="end" colspan="2"  style="background-color: #428bca;" id="qty_total_placeholder">0</td>
                                                                        </tr>

                                                                        <!-- <tr>
                                                                            <td> Balance Quantity</td>
                                                                            <td align="end" colspan="2"  style="background-color: #428bca;" id="b_qty_total_placeholder">0</td>
                                                                        </tr> -->

                                                                        <tr>
                                                                            <td> Total Pieces</td>
                                                                            <td align="end" colspan="2"  style="background-color: #428bca;" id="pieces_total_placeholder">0</td>
                                                                        </tr>


                                                                
                                                                        
                                                                    </tbody>
                                                                </table>     
                                                            </div>

                                                        </div>
                                             
                                                    
                                            
                                                    </div>

                                               
                                                </div>
                                        
                                            </form>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .no-border-input {
            border: none;
            background: transparent;
            text-align: center;
            width: 100%;
            color: inherit; /* Matches text color to the row */
        }

        .no-border-input:focus {
            outline: none;
        }

    </style>
    
</div>
{% include 'includes/footer.html' %}


<script>



 


$(document).ready(function () {
    // Load programs when party is selected
    $('#party_id').change(function () {
        LoadProgram();
    });

    // Load details when a program is selected
    $('#prg_id').change(function () {
        let prg_id = $(this).val();

        if (prg_id) {
            updateProgramDetails();
            loadProgramDetails(prg_id);
        } else {
            $('#purchaseTable tbody').empty(); // Clear table if no program is selected
        }
    });
});

function LoadProgram() {
    let party_id = $('#party_id').val();
    console.log('Party-ID:', party_id);

    $.ajax({
        type: 'POST',
        url: '/purchase/get_cutting_program_lists/',
        data: {
            'party_id': party_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        success: function (data) {
            let $prg_id = $('#prg_id');
            let $prg_quantity = $('#prg_quantity');
            let $quality_id = $('#quality_id');
            let $style_id = $('#style_id');

            // Reset dropdowns and inputs
            $prg_id.empty().append('<option value="">Select</option>');
            $prg_quantity.val('');
            $quality_id.val('').change();
            $style_id.val('').change();

            if (data.length > 0) {
                data.forEach(function (po) {
                    $prg_id.append(
                        `<option value="${po.id}" data-total="${po.total_quantity}" data-quality="${po.quality_id}" data-style="${po.style_id}">
                            ${po.cutting_no}
                        </option>`
                    );
                });
            }
        },
        error: function (xhr, status, error) {
            console.error('Error loading program lists:', error);
        }
    });
}

function updateProgramDetails() {
    let selectedOption = $('#prg_id').find(':selected');
    let totalQuantity = selectedOption.data('total') || '';
    let qualityId = selectedOption.data('quality') || '';
    let styleId = selectedOption.data('style') || '';

    console.log('Updating fields:', { totalQuantity, qualityId, styleId });

    $('#prg_quantity').val(totalQuantity);
    $('#quality_id').val(qualityId).change();
    $('#style_id').val(styleId).change();
}

function loadProgramDetails(prg_id) {
    $.ajax({
        type: 'POST', 
        url: '/purchase/get_sub_cutting_program/',
        data: {
            'prg_id': prg_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        success: function (data) {
            let $tableBody = $('#purchaseTable tbody');
            $tableBody.empty(); // Clear existing rows

            if (data.length > 0) {
                data.forEach(function (item) {
                    addRow(item.size_name, item.color_name, item.size_id, item.color_id, item.quantity, 0); // Set wt as 0
                });
            }
        },
        error: function (xhr, status, error) {
            console.error('Error loading program details:', error);
        }
    });
}

// ````````````````````````````````````````````


// ```````````````````````````


function LoadItem() {
    var quality_id = $('#quality_id').val(); 
    console.log('Quality-ID:', quality_id); // Debugging output

    if (!quality_id) {
        console.warn("No Quality ID selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

    $.ajax({
        type: 'POST',
        url: '/purchase/get_quality_item_list/',
        data: {
            'quality_id': quality_id,
            'csrfmiddlewaretoken': csrfToken 
        },
        dataType: 'json',

        success: function(data) {
            console.log('Received Data:', data); // Debugging output

            // Clear and add default "Select" option
            $('#item_id').empty().append('');
            
            // Populate Styles
            if (data.item && Array.isArray(data.item)) {
                data.item.forEach(function(item) {
                    $('#item_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }

            

          
        },

        error: function(xhr, status, error) {
            console.error('Error loading fabric details:', error);
        } 
    });
}

</script>



<script>


 



// // ``````````````````````````````````````````````````````````````````````````````````````````````````````````````````````



const loadedItemsMap = {};



let rowCounter = 0; // Initialize row counter





// function storeTblValues() {
//     var TableData = [];
//     var hasInvalidWt = false; // Flag to check if any wt <= 0 

//     $('#purchaseTable tbody tr').each(function () {
//         var item = $(this).find('td:eq(0)').text().trim();
//         var uom = $(this).find('td:eq(1)').text().trim();
//         var quantity = parseFloat($(this).find('.quantity').text()) || 0;
//         var program_type = parseFloat($(this).find('.program_type').text()) || 0;
//         var product_pieces = parseFloat($(this).find('.product_pieces').text()) || 0;
//         // var balance_qty = parseFloat($(this).find('.balance_qty').text()) || 0;
//         // var originalQuantity = parseFloat($(this).attr("data-original-quantity")) || quantity;

//         var sizeId = $(this).find('.size_id').text().trim();
//         var colorId = $(this).find('.color_id').text().trim();

//         // âœ… Validate Wt
//         if (wt <= 0) {
//             hasInvalidWt = true;
//         }

//         // âœ… Add only valid rows
//         if (size && color && quantity > 0 && wt > 0) {
//             TableData.push({
//                 "size": size,
//                 "color": color,
//                 "quantity": quantity,
//                 // "balance_qty": balance_qty,
//                 "wt": wt,
//                 "size_id": sizeId,
//                 "color_id": colorId,
//                 // "original_quantity": originalQuantity
//             });
//         }
//     });

//     // ðŸš¨ If any invalid Wt exists, show alert
//     if (hasInvalidWt) {
//         console.log('Error: Some rows have Weight (Wt) <= 0. Please correct them before submitting.');
//         return []; // Stop submission
//     }

//     calculateTotalValue();
//     console.log('TABLE-DATA:', TableData);
//     return TableData;
// }




function storeTblValues() {
    var TableData = [];
    var hasInvalidWt = false; // Flag to check if any wt <= 0 

    $('#purchaseTable tbody tr').each(function () {
        var item = $(this).find('td:eq(0)').text().trim();
        var quality = $(this).find('td:eq(1)').text().trim();
        var product_pieces = parseFloat($(this).find('.product_pieces').text()) || 0;
        var uom = $(this).find('td:eq(3)').text().trim();
        var quantity = parseFloat($(this).find('.quantity').text()) || 0;
        var program_type = $(this).find('.program_type').text().trim(); // Program Type is text, not a number

        var itemId = $(this).find('.item_id').text().trim();
        var qualityId = $(this).find('.quality_id').text().trim();
        var uomId = $(this).find('.uom_id').text().trim();

        // âœ… Validate quantity and product_pieces
        if (quantity <= 0 || product_pieces <= 0) {
            hasInvalidWt = true;
        }

        // âœ… Add only valid rows
        if (item && quality && quantity > 0 && product_pieces > 0) {
            TableData.push({
                "item": item,
                "quality": quality,
                "product_pieces": product_pieces,
                "uom": uom,
                "quantity": quantity,
                "program_type": program_type,
                "item_id": itemId,
                "quality_id": qualityId,
                "uom_id": uomId
            });
        }
    });

    // ðŸš¨ If any invalid Wt exists, show alert
    if (hasInvalidWt) {
        console.log('Error: Some rows have invalid Quantity or Product Pieces (â‰¤ 0). Please correct them before submitting.');
        return []; // Stop submission
    }

    calculateTotalValue();
    console.log('TABLE-DATA:', TableData);
    return TableData;
}


// ```````````````````````````````````````````````           12-03-2025 (accessory program add-row )              ```````````````````````````````````````````````



function addManualRow() {
    console.log("Manual row function triggered");

    const itemId = $("#item_id").val();
    const itemName = $("#item_id option:selected").text().trim();
    const qualityId = $("#quality_id").val();
    const qualityName = $("#quality_id option:selected").text().trim();
    const uomId = $("#uom_id").val();
    const uomName = $("#uom_id option:selected").text().trim();
    const quantity = parseFloat($("#quantity").val()) || 1;
    const programType = $("#program_type").val();
    const productPieces = parseFloat($("#product_pieces").val()) || 1;

    if (!itemId || !uomId || !quantity || !programType) {
        notifier.show(
            'Error!',
            'Please fill in all required fields: Item, UOM, Quantity, and Program Type.',
            'danger',
            "{% static 'assets/images/notification/high_priority-48.png' %}",
            4000
        );
        return;
    }

    if (!isRowDuplicate(itemId, uomId, programType)) {
        addRow(itemName, itemId, qualityName, qualityId, uomName, uomId, quantity, programType, productPieces);
    } else {
        notifier.show(
            'Error!',
            `Item: ${itemName} and UOM: ${uomName} already exists in the table.`,
            'danger',
            "{% static 'assets/images/notification/high_priority-48.png' %}",
            4000
        );
    }
}

function isRowDuplicate(itemId, uomId, programType) {
    let isDuplicate = false;

    $("#purchaseTable tbody tr").each(function () { 
        const existingItemId = $(this).find(".item_id").text().trim();
        const existingUomId = $(this).find(".uom_id").text().trim();
        const existingprgType = $(this).find(".program_type").text().trim();

        if (existingItemId === itemId && existingUomId === uomId && existingprgType === programType) {
            isDuplicate = true;
            return false;
        }
    });

    return isDuplicate;
}

function calculateTotalValue() {
    let totalQuantity = 0;
    let totalProductPieces = 0;

    $('#purchaseTable tbody > tr').each(function () {
        const quantity = parseFloat($(this).find('.quantity').text()) || 0;
        const productPieces = parseFloat($(this).find('.product_pieces').text()) || 0;

        totalQuantity += quantity;
        totalProductPieces += productPieces;
    });

    $('#qty_total_placeholder').text(totalQuantity);
    $('#pieces_total_placeholder').text(totalProductPieces);
}

function editRow(row) {
    const itemName = row.querySelector("td:nth-child(1)").innerText.trim();
    const qualityName = row.querySelector("td:nth-child(2)").innerText.trim();
    const productPieces = row.querySelector(".product_pieces").textContent.trim();
    const quantity = row.querySelector(".quantity").textContent.trim();
    const uomName = row.querySelector("td:nth-child(4)").innerText.trim();
    const programType = row.querySelector(".program_type").textContent.trim();

    const itemId = row.querySelector(".item_id").textContent.trim();
    const qualityId = row.querySelector(".quality_id").textContent.trim();
    const uomId = row.querySelector(".uom_id").textContent.trim();

    row.remove();
    calculateTotalValue();

    $("#item_id").val([itemId]).trigger("change");
    $("#quality_id").val([qualityId]).trigger("change");
    $("#uom_id").val([uomId]).trigger("change");
    $("#quantity").val(quantity);
    $("#product_pieces").val(productPieces);
    $("#program_type").val(programType).trigger("change");
}

function addRow(itemName, itemId, qualityName, qualityId, uomName, uomId, quantity, programType, productPieces) {
    const tableBody = document.querySelector("#purchaseTable tbody");
    if (!tableBody) {
        console.error("Table body not found!");
        return;
    }

    const newRow = document.createElement("tr");

    newRow.innerHTML = `
        <td>${itemName}</td>
        <td>${qualityName}</td>
        <td class="product_pieces">${productPieces}</td>
        <td>${uomName}</td>
        <td class="quantity">${quantity}</td>
        <td class="program_type">${programType}</td>
        <td class="item_id" style="display:none">${itemId}</td>
        <td class="quality_id" style="display:none">${qualityId}</td>
        <td class="uom_id" style="display:none">${uomId}</td>
        <td>
            <button class="btn btn-primary btn-xs edit-row"><i class="feather icon-edit"></i></button>
            <button class="btn btn-danger btn-xs remove-row"><i class="feather icon-trash-2"></i></button>
        </td>
    `;

    tableBody.prepend(newRow);

    $('#item_id, #uom_id').val('').trigger("change");
    $('#quantity').val('1');
    $('#product_pieces').val('1');
    $('#program_type').val('').trigger("change");

    calculateTotalValue();

    newRow.querySelector(".remove-row").addEventListener("click", function () {
        newRow.remove();
        calculateTotalValue();
    });

    newRow.querySelector(".edit-row").addEventListener("click", function () {
        editRow(newRow);
    });
}



function calculateRow(event) {
    const row = event.target.closest("tr");

    const rate = parseFloat($(row).find('.rate').val()) || 0;
    const quantity = parseFloat($(row).find('.quantity').text()) || 0;

    const amount = (rate * quantity).toFixed(2);
    $(row).find('.amount').text(amount);

    calculateTotalValue();
}



// `````````````````````````````````````````````````````````````````````






$('#add_new').on('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    console.log("Submit button clicked");

    var TableData = storeTblValues();
    console.log('tbl-data:', TableData);

    if (TableData.length === 0) {
        notifier.show(
            'Error!', 
            'Table is empty or contains invalid data. Please check.', 
            'danger', 
            "{% static 'assets/images/notification/high_priority-48.png' %}", 
            4000
        ); 
        return; // ðŸš¨ Stop form submission if invalid
    }

    if (confirm("Are you sure you want to save?")) {
        TableData = JSON.stringify(TableData); 
        var mdata = new FormData(this);
        mdata.append('cutting_data', TableData);

        // âœ… Ensure correct retrieval of total_quantity
        var totalQty = parseFloat($('#qty_total_placeholder').text().trim()) || 0;

        mdata.append('total_quantity', totalQty);

        $.ajax({
            type: "POST", 
            url: "/purchase/add-accessory-program/",
            data: mdata,
            processData: false,
            contentType: false,
            beforeSend: function() {
                console.log("Sending AJAX request...");
                $('#submit').attr('disabled', true).text('Processing...');
            },
            success: function(data) {
                console.log("Server Response:", data);
                $('#submit').attr('disabled', false).text('Save');

                if (data.status === 'yes') { // âœ… Fixed this condition
                    notifier.show(
                        'Well Done!', 
                        'Knitting Delivery added!', 
                        'success', 
                        "{% static 'assets/images/notification/ok-48.png' %}", 
                        4000
                    ); 
                    $('#add_new').trigger('reset');
                } else {
                    notifier.show(
                        'Error!', 
                        'Failed To add: ' + data.message, 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("AJAX Error:", textStatus, errorThrown);
                notifier.show(
                    'Error!', 
                    'Error adding data: ' + errorThrown, 
                    'danger', 
                    "{% static 'assets/images/notification/high_priority-48.png' %}", 
                    4000
                ); 
                $('#submit').attr('disabled', false).text('Save');
            }
        });
    }
});



$('.single-select').select2();  

            // Get current date and time
    const currentDate = new Date();
    const currentDateString = currentDate.toISOString().slice(0, 10); // Format as YYYY-MM-DD
    const currentTimeString = currentDate.toTimeString().slice(0, 5); // Format as HH:MM

    // Set default values for date and time fields
    document.getElementById('program_date').value = currentDateString;
    // document.getElementById('purchase_time').value = currentTimeString;



</script>