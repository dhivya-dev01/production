
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}

<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title"> <!-- mill to knitting delivery -->
                                            <h4 class="m-b-10">Yarn Inward   </h4>
                                        </div>
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Yarn</a></li>
                                            <li class="breadcrumb-item"><a href="/yarn-inward"> Yarn Inward</a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>

                                     
                                    <div class="row"> 
                                        <div class="col-sm-12">
                                            <div class="card">   
                                                
                                                <form id="add_new">
                                                {% csrf_token %}

                                                    <div class="row">  
                                                    

                                                        <div class="col-md-9">
                                                            <div class="row ms-2">

                                                                <div class="col-md-2 mt-2">
                                                                    <label for="yarn_date" class="form-label">Inward No.</label>
                                                                    <input type="text" class="form-control" id="inward_no" name="inward_no" value="{{inward_number}}" disabled>
                                                                </div>


                                                                <div class="col-md-2 mt-2">
                                                                    <label for="yarn_date" class="form-label">Inward Date</label>
                                                                    <input type="date" class="form-control" id="inward_date" name="inward_date">
                                                                </div>
                                                                 <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">Party </label>
                                                                    <select id="supplier_id" name="supplier_id" class="form-control single-select" onchange="LoadPO(), LoadProgram()" required>
                                                                        <option value="">Select</option>
                                                                        {% for k in party %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %} 
                                                                    </select> 
                                                                </div>

                                                               



                                                                <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">PO list </label>
                                                                    <select id="po_list" name="po_list" class="form-control single-select" onchange="LoadDeliverTo(),LoadMill()">
                                                                        <option value="">Select</option>
                                                                       
                                                                    </select> 
                                                                </div>

                                                                <div class="col-md-3 mt-2"> 
                                                                    <label for="through_id" class="form-label"><span style="color: red;">*</span> Mill </label>
                                                                    <select id="through_id" name="through_id" class="form-control form-select single-select" disabled>
                                                                     <option>Select</option>
                                                                       {% for k in party %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %} 
                                                                    </select>
                                                                </div>


                                                                <!-- <div class="col-md-2 mt-5 mb-3">
                                                                    <input class="form-check-input" type="checkbox" id="is_inward" name="is_inward" >
                                                                    <label class="form-label" for="is_inward">Direct Delivery To Knitting</label> 
                                                                </div> -->



                                                            </div>

                                                            <div class="row ms-2 mt-2" style="background-color: #eaeaeb;"> 
                                                                
                                                                <div class="col-md-2 mt-2 mb-3">
                                                                    <input class="form-check-input" type="checkbox" id="is_inward" name="is_inward" >
                                                                    <label class="form-label" for="is_inward">Direct Delivery To Knitting</label>  <!--outward-->
                                                                </div>
                                                              
                                                                <div class="col-md-2 mt-2">

                                                                    <label for="deliver_list" class="form-label"><span style="color: red;">*</span> Deliver To</label>
                                                                    <select class="form-control single-select" id="deliver_to" name="deliver_to">
                                                                        <option value="">Select</option>
                                                                        
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-2">
                                                                    <label for="receive_no" class="form-label"><span style="color: red;">*</span> Receive No.</label>
                                                                    <input type="text" class="form-control" id="receive_no" name="receive_no"  >
                                                                </div>

                                                                <div class="col-md-2 mt-2"> 
                                                                    <label for="receive_date" class="form-label"><span style="color: red;">*</span> Receive Date</label>
                                                                    <input type="date" class="form-control" id="receive_date" name="receive_date"  >
                                                                </div>

                                                                <div class="col-md-2 mt-2"> 
                                                                    <label for="bag" class="form-label"><span style="color: red;">*</span> Knitting Prg.</label>
                                                                    <select class="form-control single-select" id="prg_id" name="prg_id"  >
                                                                    
                                                                        <option>Select</option>
                                                                       
                                                                    </select>
                                                                </div>


                                                                <div class="col-md-2 mt-2"> 
                                                                    <label for="lot" class="form-label"><span style="color: red;">*</span> Lot Name</label>
                                                                    <input type="text" class="form-control" id="lot_name" name="lot_name"  >
                                                                </div>
                                                                
                                                            </div>
                                                            <div class="row ms-2">


                                                                <div class="col-md-2 mt-2">

                                                                    <label for="product_id" class="form-label">Yarn Count</label>
                                                                    <select id="product_id" name="product_id" class="form-control single-select" >
                                                                        <!-- onchange="uom_load()" -->
                                                                        <option value="">Select</option>
                                                                        {% for k in count %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>

                                                                </div>
                                                                


                                                                <div class="col-md-2 mt-2">
                                                                    <label for="bag" class="form-label">Bags</label>
                                                                    <input type="number" class="form-control" id="bag" name="bag" min="0" max="999" oninput="limitBag(this)">
                                                                </div>
                                                            
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="per_bag" class="form-label">per Bag Wt. (kg)</label>
                                                                    <input type="number" class="form-control" id="per_bag" name="per_bag"  >
                                                                </div> 

                                                                <div class="col-md-2 mt-2 mb-3">
                                                                    <label for="quantity" class="form-label">Quantity (kg)</label>
                                                                    <input type="number" class="form-control" name="quantity" id="quantity"  readonly>
                                                                </div>

                                                                <div class="col-md-2 mt-2 mb-3">
                                                                    <label for="quantity" class="form-label">Gross Wt.(kg)</label>
                                                                    <input type="number" class="form-control" name="gross_wt" id="gross_wt" value="0">
                                                                </div>


                            
                                                                <div class="col-md-2 mt-4">
                                                                    <input type="hidden" class="form-control" name="po_id" id="po_id"  readonly>
                                                                    <input type="hidden" class="form-control" name="tx_id" id="tx_id"  readonly>

                                                                    <button class="btn btn-primary mt-3" type="button" onclick="addManualRow()">+ Add</button>

                                                                    <!-- <button class="btn btn-primary mt-2" onclick="addManualRow()">+ Add</button> -->
                                                                </div>
                                                            </div>
                                                             
                                                        </div>
                                                
                                                        <div class="col-md-3">
                                                            <div class="card-body">
                                                          
                                                                <table id="PO_summaryTable" class="table table-striped table-bordered w-100">
                                                                    <thead>
                                                                        <tr>
                                                                            <th></th>
                                                                            <th>Bag</th>
                                                                            <th>Quantity</th>
                                                                        </tr>
                                                                    </thead> 
                                                                    <tbody>
                                                                        <tr>
                                                                            <td>PO</td>
                                                                            <td align="end" id="po_bag_total">0.00</td>
                                                                            <td align="end" id="po_quantity_total">0.00</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td>Inward</td>
                                                                            <td align="end" id="inward_bag_total">0.00</td>
                                                                            <td align="end" id="inward_quantity_total">0.00</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td>Balance</td>
                                                                            <td align="end" id="balance_bag_total">0.00</td>
                                                                            <td align="end" id="balance_quantity_total">0.00</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                                
                                                            </div>
                                                        </div>
                                                        
                                                    </div> 
                                                
                                                    <div class="card-body">
                                                        <div class="table-responsive table-desi">   
                                                            <table id="purchaseTable" class="table table-bordered">
                                                                <thead>
                                                                    <tr> 
                                                                        <th>Deliver To</th>
                                                                        <th>Yarn Count</th> 
                                                                        <!-- <th>Price</th> -->
                                                                        <!-- <th>Net Price</th> -->
                                                                        <th>Bags</th>
                                                                        <th> per Bag Wt.(kg)</th>
                                                                        <th>Quantity(kg)</th>
                                                                        <th>Gross Wt.</th>
                                                                        <!-- <th style="text-align:end">Discount</th> -->

                                                                        <!-- <th style="text-align:end">Amount</th> -->
                                                                        <!-- <th>Tax (%)</th> -->
                                                                        <th style="display: none;"></th>
                                                                        <th style="display: none;"></th>
                                                                        <th style="display: none;"></th>
                                                                        <th style="display: none;"></th>
                                                                        <!-- <th>Receive No.</th>
                                                                        <th>Receive Date</th> -->
                                                                        <th>Action</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <!-- Rows will be added dynamically here -->
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
 
                                                    <div class="row"> 
                                                      
                                                       

                                                        <div class="col-md-4">
                                                            <div class=" m-b-30">
                                                            
                                                               
                                                            </div>
                                                        </div> 
                                                        
                                                        <div class="row ms-2">
                                                            <div class="col-md-12" style="text-align: center;" >
                                                                <button type="button" id="cancel" class="btn btn-danger" onclick="history.back()">Close</button>
                                                                <!-- <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"> -->
            
                                                                <button type="submit" id="submit" class="btn btn-primary">Save</button>
                                                            </div>
                                                         
                                                        </div>
                                                    </div>

                                                
                                                </div> 
                                            </form>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> 
</div>
{% include 'includes/footer.html' %}


<script>

    
function LoadMill() {
    const po_ids = $('#po_list').val();
    console.log('PO ID:', po_ids);

    if (!po_ids) {
        $('#through_id').empty().append('<option value="">Select</option>');
        return;
    }

    $.ajax({
        type: 'POST',
        url: '/get_yarn_mills/',
        data: {
            'po_id': po_ids,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        success: function(data) {
            const $through_id = $('#through_id');
            $through_id.empty().append('<option value="">Select</option>');

            if (data.mills && data.mills.length > 0) {
                data.mills.forEach(function(mill, index) {
                    $through_id.append(
                        $('<option>', {
                            value: mill.id,
                            text: mill.name
                        })
                    );
                });

                // ✅ Auto-select the first real option (after "Select")
                $through_id.val(data.mills[0].id).trigger('change');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading mills:', error);
        }
    });
}




$(document).ready(function () {
    function toggleFields() {
        const isChecked = $('#is_inward').is(':checked');

        // Enable if checked, disable if not
        $('#prg_id, #deliver_to, #receive_no, #receive_date, #lot_name').prop('disabled', !isChecked);
    }

    // Call on page load
    toggleFields();

    // Call when checkbox changes
    $('#is_inward').change(function () {
        toggleFields();
    });
});


    function limitBag(input) {
        // Remove any minus sign first
        input.value = input.value.replace(/-/g, '');
    
        // Allow only up to 3 digits
        if (input.value.length > 3) {
            input.value = input.value.slice(0, 3);
        }
    
        // If value is more than 999, force it back to 999
        if (parseInt(input.value) > 999) {
            input.value = 999;
        }
    }





function LoadPO() {
    var supplier_id = $('#supplier_id').val(); 
    $('#PO_summaryTable').find('td[id$="_total"]').text("0.00"); // Reset summary
    $('#po_list').empty().append('<option value="">Select</option>');
    $('#through_id').empty().append('<option value="">Select</option>');
    console.log('Supplier-ID:', supplier_id); // Adjusted for clarity

    $.ajax({
        type: 'POST',  // Change to POST 
        url: '/get_po_lists/',
        data: {
            'supplier_id': supplier_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()  // Include CSRF token
        },



        success: function(data) {
            // $('#po_list').empty().append('<option value="">Select</option>');
        

            
            if (data.orders && data.orders.length > 0) {
                data.orders.forEach(function(po) {
                    $('#po_list').append('<option value="' + po.id + '">' + po.po_number + ' - ' + po.name + '</option>');

                
                });
            }
             
        },

        error: function(xhr, status, error) {
            console.error('Error loading PO lists:', error);
        } 
    });
}





function LoadProgram() {
    var party_id = $('#supplier_id').val(); 
    console.log('Party-ID:', party_id);

    $.ajax({
        type: 'POST',  
        url: '/get_program_lists/',
        data: {
            'party_id': party_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        success: function(data) {
            let $prg_id = $('#prg_id');

            $prg_id.empty().append('<option value="">Select</option>');

            if (data.length > 0) {
                // data.forEach(function(po) {
                //     $prg_id.append(
                //         `<option value="${po.id}">
                //             ${po.knitting_number} - ${po.name}
                //         </option>`
                //     );
                // });


                data.forEach(function(po) {
                    let displayText = `${po.knitting_number} - ${po.name}`;
                    
                    if (po.po_ids && po.po_ids.length > 0) {
                        displayText += ` (PO: ${po.po_ids.join(', ')})`;
                    }

                    $prg_id.append(
                        `<option value="${po.id}">${displayText}</option>`
                    );
                });



                // // Automatically trigger change event to load the product
                // $prg_id.val($prg_id.find('option:eq(1)').val()).trigger('change');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading program lists:', error);
        } 
    });
}





function LoadDeliverTo() {
    var po_list = $('#po_list').val();  
    console.log('Supplier-ID:', po_list); 
     $('#purchaseTable tbody').empty('');

    // Get all delivery IDs already used in purchaseTable
    let usedDeliverIds = [];
    $('#purchaseTable tbody tr').each(function () {
        let deliver_id = $(this).find('#deliver_id').text();
        if (deliver_id) {
            usedDeliverIds.push(deliver_id);
        }
    });

    $.ajax({
        type: 'POST',
        url: '/get_deliver_lists/',
        data: {
            'po_list': po_list,
            'used_deliver_ids': JSON.stringify(usedDeliverIds),  // Send as JSON string
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        success: function(data) {
            $('#deliver_to').empty().append('<option value="">Select</option>');
            $('#prg_id').empty().append('<option value="">Select</option>');

            // Reset form fields
            $("#product_id").val('').trigger("change");
            $("#bag").val('');
            $("#per_bag").val('');
            $("#actual_rate").val('');
            $("#discount").val('');
            $("#rate").val('');
            $("#quantity").val('');
            $("#gross_wt").val('');
            $("#amount").val('');
            $("#po_id").val('');

            // ✅ Load Deliver To dropdown
            if (data.delivery_to && data.delivery_to.length > 0) {
                data.delivery_to.forEach(function(item) {
                    $('#deliver_to').append('<option value="' + item.party_id + '">' + item.party_name + '</option>');
                });
            }

            // ✅ Load Program dropdown
            if (data.program && data.program.length > 0) {
                data.program.forEach(function(po) {
                    $('#prg_id').append(
                        `<option value="${po.id}">${po.knitting_number} - ${po.name} - [${po.total_quantity}]</option>`
                    );
                });
            }

            
            // Update PO Bag and Quantity
            $('#po_bag_total').text(parseFloat(data.po_bag || 0).toFixed(2));
            $('#po_quantity_total').text(parseFloat(data.po_quantity || 0).toFixed(2));

            // Update Inward Bag and Quantity
            $('#inward_bag_total').text(parseFloat(data.inward_bag || 0).toFixed(2));
            $('#inward_quantity_total').text(parseFloat(data.inward_quantity || 0).toFixed(2));

            // Compute and update balance (PO - Inward)
            const balance_bag = (parseFloat(data.po_bag) || 0) - (parseFloat(data.inward_bag) || 0);
            const balance_quantity = (parseFloat(data.po_quantity) || 0) - (parseFloat(data.inward_quantity) || 0);

            $('#balance_bag_total').text(balance_bag.toFixed(2));
            $('#balance_quantity_total').text(balance_quantity.toFixed(2));




            // Set form values
            $("#product_id").val(data.yarn).trigger("change");
            $("#bag").val(data.bag);
            $("#per_bag").val(data.per_bag);
            $("#quantity").val(data.quantity);
            $("#gross_wt").val(data.quantity);
        },
        error: function(xhr, status, error) {
            console.error('Error loading po lists:', error);
        }
    });
}



function LoadDeliver() {
    var po_id = $('#po_id').val();  // Get selected PO ID
    console.log('PO-ID:', po_id);   // Debugging for clarity

    $.ajax({
        type: 'POST',  // Change to POST
        url: '/get_deliver_lists/',  // URL for delivering list
        data: {
            'po_id': po_id,  // Pass the correct PO ID
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()  // Include CSRF token
        },
        success: function(data) {
            $('#deliver_id').empty().append('<option value="">Select</option>');

            // Iterate over the returned data to populate the dropdown
            if (data.deliveries && data.deliveries.length > 0) {
                data.deliveries.forEach(function(deliver) {
                    $('#deliver_id').append('<option value="' + deliver.id + '">' + deliver.stage + '</option>');
                });
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading deliver lists:', error);
        }
    });
}





// ```````24042025


$(document).on('change', '#deliver_to', function() {
    const supplierId = $('#supplier_id').val();
    const poId = $(this).val(); // Get selected Purchase Order IDs from the multiple select

    // if (!supplierId || !poId) {
    //     alert("Please select both a Supplier and a Purchase Order.");
    //     return; // Exit if either is not selected
    // }

    // Call the function to load purchases based on the selected supplier and purchase orders
    loadPurchases(supplierId, poId);
});

 



function loadPurchases(supplierId, poIds) {
    var po_list = $('#po_list').val();
    var deliver_to = $('#deliver_to').val();

    $.ajax({
        type: "GET",
        url: "/tx_load_po_details_inward/",
        data: {
            supplier_id: supplierId,
            'po_id[]': po_list,  
            'deliver_to': deliver_to
        },
        success: function (data) {
            if (data.orders && data.orders.length > 0) {
                let item = data.orders[0];
                let bagFromServer = parseFloat(item.bag) || 0;
                const per_bag = parseFloat(item.per_bag) || 0;

                // *** NEW CODE: Calculate already assigned bags ***
                let alreadyAssignedBag = 0;
                $('#purchaseTable tbody tr').each(function() {
                    const rowPoId = $(this).find('#po_id').text();
                    const rowDeliverId = $(this).find('#deliver_id').text();
                    if (rowPoId == item.po_id && rowDeliverId == $('#deliver_to').val()) {
                        const rowBag = parseFloat($(this).find('td:nth-child(2)').text()) || 0;
                        alreadyAssignedBag += rowBag;
                    }
                });

                let availableBag = bagFromServer - alreadyAssignedBag;
                if (availableBag < 0) availableBag = 0;

                const calculated_quantity = availableBag * per_bag;

                // ✅ Only show the matching product in the #product_id dropdown
                const $productDropdown = $("#product_id");
                $productDropdown.empty(); // Clear all existing options
                $productDropdown.append(`<option value="${item.product_id}">${item.product_name}</option>`); // Add only the triggered item
                $productDropdown.val(item.product_id).trigger("change");
                
                
                
                // Update PO Bag and Quantity
                $('#po_bag_total').text(parseFloat(item.po_bag || 0).toFixed(2));
                $('#po_quantity_total').text(parseFloat(item.po_quantity || 0).toFixed(2));

                // Update Inward Bag and Quantity
                $('#inward_bag_total').text(parseFloat(item.inward_bag || 0).toFixed(2));
                $('#inward_quantity_total').text(parseFloat(item.inward_quantity || 0).toFixed(2));

                // Compute and update balance (PO - Inward)
                const balance_bag = (parseFloat(item.po_bag) || 0) - (parseFloat(item.inward_bag) || 0);
                const balance_quantity = (parseFloat(item.po_quantity) || 0) - (parseFloat(item.inward_quantity) || 0);

                $('#balance_bag_total').text(balance_bag.toFixed(2));
                $('#balance_quantity_total').text(balance_quantity.toFixed(2));


                // ````````````````````````````
                // Fill other fields
                $("#bag").val(availableBag.toFixed(2));
                $("#per_bag").val(per_bag.toFixed(2)); 
                $("#actual_rate").val(item.actual_rate);
                $("#discount").val(item.discount);
                $("#rate").val(item.rate);
                // $("#product_id").val(item.product_id).trigger('change');
                $("#quantity").val(calculated_quantity.toFixed(2)); 
                $("#gross_wt").val(calculated_quantity.toFixed(2)); 
                $("#amount").val(item.amount);
                $("#po_id").val(item.po_id);

             




            } else {
                notifier.show(
                    'Error!',
                    'No unassigned items found or all items are already assigned.',
                    'error',
                    "{% static 'assets/images/notification/high_priority-48.png' %}",
                    4000
                );
            }
        },
        error: function (xhr, status, error) {
            console.error("Error loading purchases:", error);
        }
    });
}


$('#bag, #per_bag').on('input', function () {
    const bag = parseFloat($('#bag').val()) || 0;
    const perBag = parseFloat($('#per_bag').val()) || 0;
    const quantity = bag * perBag;
    $('#quantity').val(quantity.toFixed(2));
});

// ``````````````````````````````````````````````````````````````````````````````````````````````````````````````````````



document.addEventListener("DOMContentLoaded", function () {
    // Attach event listeners for real-time calculations
    document.getElementById("bag").addEventListener("input", calculateQuantity);
    document.getElementById("per_bag").addEventListener("input", calculateQuantity);
    // document.getElementById("rate").addEventListener("input", calculateAmount);
});

function calculateQuantity() {
    var bag = parseFloat(document.getElementById("bag").value) || 0;
    var perBag = parseFloat(document.getElementById("per_bag").value) || 0;
    var quantity = bag * perBag;
    document.getElementById("quantity").value = quantity;

    // Auto-update amount if rate is already entered
    calculateAmount();
}

function calculateAmount() {
    var quantity = parseFloat(document.getElementById("quantity").value) || 0;
    var gross_wt = parseFloat(document.getElementById("gross_wt").value) || 0;
    // var rate = parseFloat(document.getElementById("rate").value) || 0;
    // var amount = gross_wt * rate;
    // document.getElementById("amount").value = amount.toFixed(2);
}




document.addEventListener('DOMContentLoaded', function () {
        // Get all input fields
        // const actualRateField = document.getElementById('actual_rate');
        const discountField = document.getElementById('discount');
        // const rateField = document.getElementById('rate');
        const quantityField = document.getElementById('quantity');
        const grossWtField = document.getElementById('gross_wt');
        const amountField = document.getElementById('amount');

        // Function to calculate and update fields
        function calculateRateAndAmount() {
            const actualRate = parseFloat(actualRateField.value) || 0;
            const discount = parseFloat(discountField.value) || 0;

            // Calculate rate based on discount
            // const discountedRate = actualRate - (actualRate * (discount / 100));
            const discountedRate = actualRate -discount ;

            // Update the rate field 
            rateField.value = discountedRate.toFixed(2);

            // Calculate amount
            const quantity = parseFloat(quantityField.value) || 0;
            const grossWt = parseFloat(grossWtField.value) || 0;
            let amount = 0;

            // If quantity is provided, calculate amount based on quantity
            if (quantity > 0) {
                amount = discountedRate * grossWt;
            }
            // If gross weight is provided, calculate amount based on gross weight
            else if (grossWt > 0) {
                amount = discountedRate * grossWt;
            }

            // Update the amount field
            amountField.value = amount.toFixed(2);
        }

        // Add event listeners for the fields
        // actualRateField.addEventListener('input', calculateRateAndAmount);
        // discountField.addEventListener('input', calculateRateAndAmount);
        quantityField.addEventListener('input', calculateRateAndAmount);
        grossWtField.addEventListener('input', calculateRateAndAmount);
    });

    


    

 

const loadedItemsMap = {};



let rowCounter = 0; // Initialize row counter




// function addManualRow() {
//     console.log("Manual row function triggered");

//     const product = $("#product_id option:selected").text();
//     const productId = $("#product_id").val();
//     const bag = $("#bag").val(); 
//     const gross_wt = $("#gross_wt").val();
//     const perBag = $("#per_bag").val();
//     const quantity = $("#quantity").val();
//     const lot_name = $("#lot_name").val();
//     const tmId = 0;
//     const id = 0;
//     const po_id = $("#po_id").val();
//     const deliver_to = $("#deliver_to option:selected").text() || '-';
//     const deliver_id = $("#deliver_to").val() || 0;

//     const isInward = $("#is_inward").is(":checked") ? 1 : 0;

//     // Get values from input fields
//     // let receive_no = '';
//     // let receive_date = '';

//     let receive_no = $("#receive_no").val();
//     let receive_date = $("#receive_date").val();


//     // If NOT inward, get values
//     if (!isInward) {
//         receive_no = ' ' //$("#receive_no").val();
//         receive_date ='' // $("#receive_date").val();

//         // Validate required fields for NOT inward
//         if (!lot_name || !receive_no || !receive_date) {
//             notifier.show(
//                 'Error!',
//                 'Lot Name, Receive No, and Receive Date are required when "Is Inward" is unchecked.',
//                 'error',
//                 "{% static 'assets/images/notification/high_priority-48.png' %}",
//                 4000
//             );
//             return;
//         }
//     }
 
//     // Validate bag value
//     if (bag <= 0) {
//         notifier.show(
//             'Error!',
//             'Cannot add. Bag value must be greater than 0.',
//             'error',
//             "{% static 'assets/images/notification/high_priority-48.png' %}",
//             4000
//         );
//         return;
//     }

//     // Proceed to add the row after validation
//     addRow(deliver_to, product, gross_wt, bag, perBag, quantity, id, productId, tmId, po_id, deliver_id, receive_no, receive_date, lot_name, isInward);
// }



function addManualRow() {
    console.log("Manual row function triggered");

    const product = $("#product_id option:selected").text();
    const productId = $("#product_id").val();
    const bag = $("#bag").val(); 
    const gross_wt = $("#gross_wt").val();
    const perBag = $("#per_bag").val();
    const quantity = $("#quantity").val();
    const lot_name = $("#lot_name").val();
    const tmId = 0;
    const id = 0;
    const tx_id = $("#tx_id").val() || 0;
    const prg_id = $("#prg_id").val() || 0;
    const lot_no = $("#lot_name").val() || 0;
    const po_id = $("#po_id").val();
    const deliver_to = $("#deliver_to option:selected").text() || '-';
    const deliver_id = $("#deliver_to").val() || 0;

    const isInward = $("#is_inward").is(":checked") ? 1 : 0;

    let receive_no = $("#receive_no").val();
    let receive_date = $("#receive_date").val();

    // Validate required fields only if "Is Inward" is checked
    if (isInward) {
        if (!lot_name || !receive_no || !receive_date) {
            notifier.show(
                'Error!',
                'Lot Name, Receive No, and Receive Date are required when "Is Inward" is checked.',
                'error',
                "{% static 'assets/images/notification/high_priority-48.png' %}",
                4000
            );
            return;
        }
    } else {
        // If not inward, receive no and date are not required, so clear them
        receive_no = '';
        receive_date = '';
    }

    // Validate bag value
    if (bag <= 0) {
        notifier.show(
            'Error!',
            'Cannot add. Bag value must be greater than 0.',
            'error',
            "{% static 'assets/images/notification/high_priority-48.png' %}",
            4000
        );
        return;
    }

    // Proceed to add the row after validation
    addRow(
        deliver_to, product, gross_wt, bag, perBag, quantity,
        id, productId, tmId, po_id, deliver_id, receive_no, receive_date, lot_name, isInward,prg_id,lot_no, tx_id
    );
}

function addRow(deliver_to, product, gross_wt, bag, perBag, quantity, id, productId, tmId, po_id, deliver_id, receive_no, receive_date, lot_name, isInward, prg_id,lot_no,tx_id) {
    // Set default hyphen for empty or invalid fields
    deliver_to = (deliver_to && deliver_to !== "Select") ? deliver_to : '';
    receive_no = receive_no || ''
    receive_date = receive_date || '';
    lot_name = lot_name || '';

    // If all fields are empty, display only a single hyphen
    let deliverDetails = (deliver_to === '' && receive_no === '' && receive_date === '' && lot_name === '') ? '-' : `${deliver_to} <br>(${receive_no} / ${receive_date} / ${lot_name})`;

    if (!productId || !bag || !perBag || !quantity || !gross_wt) {
        notifier.show(
            'Error!', 
            'Please fill in all required fields: Product, Bag, Bag Wt., Quantity, Gross Wt', 
            'error', 
            "{% static 'assets/images/notification/high_priority-48.png' %}", 
            4000
        );
        return;
    }

    // Locate the table body where rows will be added
    const tableBody = document.querySelector("#purchaseTable tbody");
    if (!tableBody) {
        console.error("Table body not found!");
        return;
    }

    // Generate a unique rowId using the counter
    rowCounter++; // Increment rowCounter for each new row
    const rowId = `row_${rowCounter}`; // Create a unique ID for the row

    // Create a new table row
    const newRow = document.createElement("tr");
    newRow.setAttribute("data-product-id", productId);
    newRow.setAttribute("data-tm-id", tmId);
    newRow.setAttribute("data-row-id", rowId); // Set rowId as data attribute for identification

    newRow.innerHTML = `
    <td>${deliverDetails}</td>    
    <td>${product}</td>    
    <td>${bag}</td>
    <td>${perBag}</td> 
    <td>${quantity}</td>   
    <td>${gross_wt}</td>
    

    <!-- Hidden fields -->
    <td id="tm_id" style="display:none">${tmId}</td>
    <td id="id" style="display:none">${id}</td>
    <td id="product_id" style="display:none">${productId}</td>  
    <td id="po_id" style="display:none">${po_id}</td>
    <td id="deliver_id" style="display:none">${deliver_id}</td> 
    <td id="receive_no" style="display:none">${receive_no}</td> 
    <td id="receive_date" style="display:none">${receive_date}</td> 
    <td id="is_inward" style="display:none">${isInward}</td>
    <td id="prg_id" style="display:none">${prg_id}</td>
    <td id="lot_no" style="display:none">${lot_no}</td>
    <td id="tx_id" style="display:none">${tx_id}</td>

    <!-- Action Column -->
    <td>  
        <button class="btn btn-primary btn-xs" onclick="editRow(this)"><i class='feather icon-edit'></i></button>
        <button class="btn btn-danger btn-xs remove-row"><i class='feather icon-trash-2'></i></button>
    </td>
    `;

    // Append the new row to the table body
    tableBody.appendChild(newRow);

    // Reset fields
    reset_Fields();

    // Add event listener to remove row button
    newRow.querySelector(".remove-row").addEventListener("click", function () {
        newRow.remove();
    });
}



function reset_Fields() { 

// $('#fabric_id').val('').trigger("change");
$('#product_id').val('').trigger("change");
$('#deliver_to').val('').trigger("change");
$('#prg_id').val('').trigger('change');
$('#receive_no').val('');
$('#lot_name').val('');
// $('#receive_date').val('');

// document.getElementById('gauge').value = ''; 
// document.getElementById('tex').value = ''; 
document.getElementById('bag').value = ''; 
document.getElementById('per_bag').value = ''; 
document.getElementById('quantity').value = ''; 
document.getElementById('gross_wt').value = ''; 
}




var editIndex = -1; // Track the row being edited

function editRow(mrow) {
    // Get the row index and assign it to editIndex
    editIndex = $(mrow).closest('tr').index();

    // Fetch values from the selected table row
    var product = $(mrow).closest('tr').find('td:eq(0)').text().trim();
    var bag = $(mrow).closest('tr').find('td:eq(1)').text().trim();
    var perBag = $(mrow).closest('tr').find('td:eq(2)').text().trim();
    var quantity = $(mrow).closest('tr').find('td:eq(3)').text().trim();
    var gross_wt = $(mrow).closest('tr').find('td:eq(4)').text().trim();
    // Fetch hidden values
    var tmId = $(mrow).closest('tr').find('#tm_id').text().trim();
    var id = $(mrow).closest('tr').find('#id').text().trim();
    var productId = $(mrow).closest('tr').find('#product_id').text().trim();
    var po_id = $(mrow).closest('tr').find('#po_id').text().trim(); 
    var receive_no = $(mrow).closest('tr').find('#receive_no').text().trim();
    var receive_date = $(mrow).closest('tr').find('#receive_date').text().trim();
    var deliver_id = $(mrow).closest('tr').find('#deliver_id').text().trim();
    var tx_id = $(mrow).closest('tr').find('#tx_id').text().trim();
    // Set form fields with extracted values
    $("#product_id").val(productId).trigger("change");
    $("#deliver_to").val(deliver_id).trigger("change");
    $("#bag").val(bag);
    $("#receive_no").val(receive_no);
    $("#receive_date").val(receive_date);
    $("#per_bag").val(perBag);
    $("#quantity").val(quantity);
    $("#gross_wt").val(gross_wt);
    
    // Store the values for backend reference if needed
    $("#tm_id").val(tmId);
    $("#tx_id").val(tx_id);
    $("#po_id").val(po_id);

    // Remove the row from the table (so it can be updated after editing)
    $(mrow).closest('tr').remove();
    // calculateTotalValue();
 
}




// Calculation function for the row
function calculateRow(event) {
    var rowId = event.target.getAttribute('data-row-id');
    var row = document.querySelector(`[data-row-id="${rowId}"]`).closest('tr');
    
    var bagElement = row.querySelector('.bag');
    var perBagElement = row.querySelector('.per_bag');
    var quantityElement = row.querySelector('.quantity');
    // var rateElement = row.querySelector('.rate');
    
    if (bagElement && perBagElement && quantityElement && rateElement) {
        // Calculate quantity based on bag and per_bag
        var bag = parseFloat(bagElement.value) || 0;
        var perBag = parseFloat(perBagElement.value) || 0;
        var quantity = bag * perBag;
        quantityElement.value = quantity;

        // Calculate amount based on quantity and rate
        // var rate = parseFloat(rateElement.value) || 0;
        // var amount = quantity * rate;
        // row.querySelector('.amount').value = amount.toFixed(2);
    } else {
        console.error('Missing elements in the row.');
    }
    // calculateTotal();
}






function storeTblValues() {
    var TableData = [];
 
 
    $('#purchaseTable tbody tr').each(function(index) {
    var product = $(this).find('td:eq(1)').text().trim();
    var bag = $(this).find('td:eq(2)').text().trim();
    var perBag = $(this).find('td:eq(3)').text().trim();
    var quantity = $(this).find('td:eq(4)').text().trim(); 
    
    var gross_wt = $(this).find('td:eq(5)').text().trim();

    var tmId = $(this).find('#tm_id').text().trim();
    var id = $(this).find('#id').text().trim();
    var product_id = $(this).find('#product_id').text().trim();
    var po_id = $(this).find('td:eq(9)').text().trim();
    var deliver_id = $(this).find('td:eq(10)').text().trim();
    var receive_no = $(this).find('td:eq(11)').text().trim();
    var receive_date = $(this).find('td:eq(12)').text().trim(); 
    var is_inward = $(this).find('td:eq(13)').text().trim();
    var program_id = $(this).find('td:eq(14)').text().trim();
    var lot_no = $(this).find('td:eq(15)').text().trim();   
    var tx_id = $(this).find('td:eq(16)').text().trim();   

    console.log(`Row ${index + 1} - Data:`, { product, quantity, tmId, id, product_id ,program_id, lot_no});


    if (product_id && quantity ) {
            TableData.push({
                "product_id": product_id,
                "product_name": product,
                "bag": bag, 
                "per_bag": perBag,
                "quantity": quantity, 
                'gross_wt':gross_wt, 
                'po_id':po_id,  
                'deliver_id':deliver_id,
                'receive_no':receive_no,
                'receive_date':receive_date,
                'is_inward':is_inward,
                'program_id':program_id,
                'lot_no':lot_no,
                'tx_id':tx_id,
            });
        } else {
            console.log("Missing data for row, skipping...");
        }
});

    console.log('TABLE-DATA:', TableData);  // Output the collected table data
    return TableData;  // Return the data to be used further (for submission, storage, etc.)
}





// ```````````````````````````````````````````````````````


$('#add_new').on('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    console.log("Submit button clicked"); // Debugging

    var TableData = storeTblValues();
    console.log('tbl-data:', TableData);

    if (TableData.length === 0) {
        notifier.show(
            'Error!', 
            'Table is empty. Please insert the program details.', 
            'success', 
            "{% static 'assets/images/notification/ok-48.png' %}", 
            4000
        ); 


        return;
    }

    if (confirm("Are you sure you want to save?")) {
        TableData = JSON.stringify(TableData); 
        var mdata = new FormData(this);
        mdata.append('chemical_data', TableData); 
        console.log('m-dsta:',mdata);

        var totalQty = $('#qty_total_placeholder').text();
        var totalGross = $('#gross_total_placeholder').text();
        var inw_no =$('#inward_no').val();
        // Append total values to FormData
        mdata.append('total_quantity', totalQty);  // This is where total_quantity is added 
        mdata.append('total_gross', totalGross);  // This is where total_quantity is added 
        mdata.append('inward_no', inw_no);  // This is where total_quantity is added 

        console.log('inw-no:',inw_no);
       

        $.ajax({
            type: "POST", 
            url: "/add-yarn-inward/",
            data: mdata,
            processData: false,
            contentType: false,
            beforeSend: function() {
                console.log("Sending AJAX request...");
                $('#submit').attr('disabled', true).text('Processing...');
            },
            success: function(data) {
                console.log("Server Response:", data);
                $('#submit').attr('disabled', false).text('Save');

                if (data.status === 'success') {
                    notifier.show( 
                        'Well Done!', 
                        data.message || 'Added Successfully!', 
                        'success', 
                        "{% static 'assets/images/notification/ok-48.png' %}", 
                        4000
                    );  
 
					// <!-- $('#inward_no').val(data.inward_number); -->
				   // Temporarily enable, set the value, and disable again
					$('#inward_no').prop('disabled', false);  // Enable the input
					$('#inward_no').val(data.inward_number);  // Set the value
					$('#inward_no').prop('disabled', true);   // Disable it again
					
					
                    // $('#add_new').trigger('reset'); 
                    //     // Clear dynamically added rows in the  table
                    $('#add_new').trigger('reset'); 
                    $('#purchaseTable tbody').empty(); 
                    $('#PO_summaryTable tbody').empty(); 
                    $('#supplier_id').val('').trigger("change");

                    $('#product_id').val('').trigger("change");
                    $('#po_list').val('').trigger("change");

                    $('#deliver_to').val('').trigger("change");

                    // location.reload();
                } else {
                    notifier.show(
                        'Error!', 
                        data.message || 'Failed to add', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("AJAX Error:", textStatus, errorThrown);
                notifier.show(
                        'Error!', 
                        'Error adding data', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    );  
                // alert('Error Adding data');
                $('#submit').attr('disabled', false).text('Save');
            }
        });
    }
});




$('.single-select').select2();

            // Get current date and time
    const currentDate = new Date();
    const currentDateString = currentDate.toISOString().slice(0, 10); // Format as YYYY-MM-DD
    const currentTimeString = currentDate.toTimeString().slice(0, 5); // Format as HH:MM

    // Set default values for date and time fields
    document.getElementById('inward_date').value = currentDateString;
    // document.getElementById('receive_date').value = currentDateString;
    // document.getElementById('purchase_time').value = currentTimeString;



</script>