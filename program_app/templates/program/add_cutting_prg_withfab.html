
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}

<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row"> 
                            <div class="col-sm-12"> 
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title"> <!-- mill to knitting delivery -->
                                            <h4 class="m-b-10">Cutting Program  </h4>
                                        </div>
                                        <ul class="breadcrumb"> 
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Program</a></li>
                                            <li class="breadcrumb-item"><a href="/purchase/cutting-program"> Cutting Program</a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>

                                    <div class="card">  

                                        <div class="card-body row"> 
                                            <form id="cutting_program">
                                                <div class="col-sm-12">
                                                    <div class="row"> 
                                                        {% csrf_token %}
                                                        <div class="col-md-9">
                                                            <div class="row ">
                                                            

                                                                <div class="col-md-2 mt-2">
                                                                    <label for="number" class="form-label">Program No.</label>
                                                                    <input type="number" class="form-control" id="delivery_number" value="{{prg_number}}" disabled>

                                                                </div>
                                                              
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="order_date" class="form-label">Program Date</label>
                                                                    <input class="form-control" type="date" name="program_date" id="program_date" required>
                                                                </div>

                                                               
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">Party</label>
                                                                    <select id="party_id" name="party_id" class="form-control form-select single-select" >
                                                                        <option value="">Select</option>
                                                                        {% for k in party %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %} 
                                                                    </select>  
                                                                </div> 
 
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">Lot </label>
                                                                    <select id="lot" name="lot" class="form-control single-select" onchange="LoadLotDetails()">
                                                                        <option value="">Select</option>
                                                                        {% for k in lot %}
                                                                        <option value="{{ k.id }}">{{ k.lot_no }}</option> 
                                                                        {% endfor %} 
                                                                    </select> 
                                                                </div> 
                                                                
                                                               
                                                                <div class="col-md-4 mt-2">
                                                                    <label for="order_date" class="form-label">Remarks</label>
                                                                    <input class="form-control" type="hidden" name="lot_no" id="lot_no">
                                                                    <input class="form-control" type="hidden" name="lot_total_quantity" id="lot_total_quantity">
                                                              
                                                                    <input class="form-control" type="text" name="remarks" id="remarks" >
                                                                </div>
                                                      
                                                                
                                                      
                    

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Fabric</label>
                                                                    <select id="fabric_id" name="fabric_id" class="form-control single-select">
                                                                        <option value="">Select</option>
                                                                        {% for k in fabric_program %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Quality</label>
                                                                    <select id="quality_id" name="quality_id" class="form-control single-select" onchange="LoadStyle()">
                                                                        <!-- <option value="">Select</option> -->
                                                                        {% for k in quality %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Style</label>
                                                                    <select id="style_id" name="style_id" class="form-control single-select" multiple>
                                                                        <!-- <option value="">Select</option> -->
                                                                        {% for k in style %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Size</label>
                                                                    <select id="size_id" name="size_id" class="form-control single-select" multiple>
                                                                        <!-- <option value="">Select</option> -->
                                                                        {% for k in size %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                             

 

                                                                
                                                                <!-- Load Button -->
                                                                <div class="col-md-2 mt-5">
                                                                    <input type="hidden" id="edit_id" name="edit_id">
                                                                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                                                    <button type="button" id="update" class="btn btn-primary">+ Load</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                            
                                        </div>   
                                        

                                        <div class="col-md-12" id="tablesContainer">  
                                            <!-- Tables will be appended here -->
                                        </div>

                                        <div class="" style="text-align: center;" >
                                            <button type="button" id="cancel" class="btn btn-danger" onclick="history.back()">Close</button>
                                            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                            <button type="button" id="saveButton" class="btn btn-primary">Save</button>

                                        </div>

                                    </div> 
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'includes/footer.html' %}

<script>

$('.single-select').select2();






 

// function LoadStyle() {
//     var quality_id = $('#quality_id').val(); 
//     console.log('Quality-ID:', quality_id); // Debugging output

//     if (!quality_id) {
//         console.warn("No Quality ID selected");
//         return;
//     }

//     var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

//     $.ajax({
//         type: 'POST',
//         url: '/purchase/get_quality_style_list/',
//         data: {
//             'quality_id': quality_id,
//             'csrfmiddlewaretoken': csrfToken 
//         },
//         dataType: 'json',
      

//         success: function(data) {
//             console.log('Received Data:', data); // Debugging output

//             // Clear existing values and add default "Select" option
//             $('#style_id').empty().append('<option value="">Select Style</option>');
//             $('#size_id').empty().append('<option value="">Select Style</option>');
//             $('#color_id').empty().append('<option value="">Select Style</option>');

//             // Check if styles exist and loop through them
//             if (data.style && Array.isArray(data.style)) {
//                 data.style.forEach(function(item) {
//                     $('#style_id').append('<option value="' + item.id + '">' + item.name + '</option>');
//                 });
//             }

//             if (data.size && Array.isArray(data.size)) {
//                 data.size.forEach(function(item) {
//                     $('#size_id').append('<option value="' + item.id + '">' + item.name + '</option>');
//                 });
//             }

//             if (data.color && Array.isArray(data.color)) {
//                 data.color.forEach(function(item) {
//                     $('#color_id').append('<option value="' + item.id + '">' + item.name + '</option>');
//                 });
//             }


//         },

//         error: function(xhr, status, error) {
//             console.error('Error loading fabric details:', error);
//         } 
//     });
// }



function LoadStyle() {
    var quality_id = $('#quality_id').val(); 
    console.log('Quality-ID:', quality_id); // Debugging output

    if (!quality_id) {
        console.warn("No Quality ID selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

    $.ajax({
        type: 'POST',
        url: '/purchase/get_quality_style_list/',
        data: {
            'quality_id': quality_id,
            'csrfmiddlewaretoken': csrfToken 
        },
        dataType: 'json',

        success: function(data) {
            console.log('Received Data:', data); // Debugging output

            // Clear and add default "Select" option
            $('#style_id').empty().append('');
            $('#size_id').empty().append('');
            // $('#color_id').empty().append('<option value="">Select Color</option>');

            // Populate Styles
            if (data.style && Array.isArray(data.style)) {
                data.style.forEach(function(item) {
                    $('#style_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }

            if (data.size && Array.isArray(data.size)) {
                data.size.forEach(function(item) {
                    $('#size_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }

          
        },

        error: function(xhr, status, error) {
            console.error('Error loading fabric details:', error);
        } 
    });
}




function LoadFabricValues() {
    var product_id = $('#fabric_id').val(); 
    console.log('Product-ID:', product_id); // Debugging output

    if (!product_id) {
        console.warn("No Product ID selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

    $.ajax({
        type: 'POST',
        url: '/get_fabric_program_lists/',
        data: {
            'product_id': product_id,
            'csrfmiddlewaretoken': csrfToken
        },
        dataType: 'json',
        success: function(data) {
            console.log('Received Data:', data); // Debugging output

            // Clear existing values and add default "Select" option
            $('#color_id').empty().append(''); 
            
 
            // Populate dropdowns only if data exists
            if (data.color) {
                $('#color_id').append('<option value="' + data.color.id + '">' + data.color.name + '</option>');
            }

        },
        error: function(xhr, status, error) {
            console.error('Error loading fabric details:', error);
        } 
    });
}
// `````````````````````````````````````````````````

function LoadColorTable() {
    let $fabricDropdown = $("#fabric_id"),
        selectedFabricId = $fabricDropdown.val(),
        selectedFabricText = $fabricDropdown.find("option:selected").text(),
        selectedQualityText = $("#quality_id option:selected").text(),
        selectedStyles = $("#style_id").val(),
        selectedSizes = $("#size_id").val(),
        selectedSizeNames = $("#size_id option:selected").map(function () { return $(this).text(); }).get();

    if (!selectedFabricId || !selectedStyles || !selectedSizes) {
        alert("Please select Fabric, Style, and Size first.");
        return;
    }

    $.get("{% url 'get_fabric_details' %}", { fabric_id: selectedFabricId }, function (response) {
        if (!response.success) {
            alert(response.message);
            return;
        }

        let $tablesContainer = $("#tablesContainer"),
            colors = response.colors,
            $mainTable = $("#mainTable");

        if ($mainTable.length === 0) {
            let mainTable = `<div class="p-2">
                <h5>Fabric Details</h5>
                <table id="mainTable" class="table table-striped table-bordered w-100">
                    <thead>
                        <tr style="background-color: white; color: black;"> 
                            <th>Fabric</th>
                            <th>Color</th>
                            <th>Quality</th>
                            <th>Style</th>
                            ${selectedSizeNames.map(size => `<th>Size ${size}</th>`).join('')}
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr>
                            <th colspan="4" style="background-color: white; color: black; text-align: center;">Total</th>
                            ${selectedSizeNames.map(() => `<th class="text-end totalQty">0</th>`).join('')}
                            <th class="text-end grandTotal">0</th>
                        </tr>
                    </tfoot>
                </table>
            </div>`;
            $tablesContainer.append(mainTable);
            $mainTable = $("#mainTable");
        }

        let $tableBody = $mainTable.find("tbody");
        colors.forEach(color => {
            let sizeData = selectedSizeNames.map(size => { 
                let isSizeAvailable = selectedSizes.includes(size);
                return `<td class="size-qty text-end" contenteditable="true" data-size="${size}" 
                            style="background-color: ${isSizeAvailable ? 'white' : 'white'}">${isSizeAvailable ? '0' : ''}</td>`;
            }).join('');

            let newRow = `<tr>
                <td>${selectedFabricText}</td>
                <td>${color.name}</td>
                <td>${selectedQualityText}</td>
                <td>${selectedStyles.map(id => $("#style_id option[value='" + id + "']").text()).join(', ')}</td>
                ${sizeData}
                <td class="row-total text-end">0</td> 
              </tr>`;

            $tableBody.append(newRow);
        });

        $mainTable.on("input", "[contenteditable='true']", function () {
            let $cell = $(this), newValue = $cell.text().trim();
            if (isNaN(newValue) || newValue === "") {
                $cell.text("0");
            }
            calculateTotals(); 
        });

        calculateTotals();
    }).fail(function () {
        alert("Error fetching fabric details.");
    });
}





// function LoadColorTable() {
//     let $fabricDropdown = $("#fabric_id"),
//         selectedFabricId = $fabricDropdown.val(),
//         selectedFabricText = $fabricDropdown.find("option:selected").text(),
//         selectedQualityText = $("#quality_id option:selected").text(),
//         selectedStyles = $("#style_id").val(),
//         selectedSizes = $("#size_id").val(),
//         selectedSizeNames = $("#size_id option:selected").map(function () { return $(this).text(); }).get();

//     if (!selectedFabricId || !selectedStyles || !selectedSizes) {
//         alert("Please select Fabric, Style, and Size first.");
//         return;
//     }

//     $.get("{% url 'get_fabric_details' %}", { fabric_id: selectedFabricId }, function (response) {
//         if (!response.success) {
//             alert(response.message);
//             return;
//         }

//         let $mainTable = $("#mainTable");
//         if ($mainTable.length === 0) {
//             alert("Please create the main table first.");
//             return;
//         }

//         let $tableBody = $mainTable.find("tbody");
//         let colors = response.colors;

//         colors.forEach(color => {
//             let sizeData = selectedSizeNames.map(size => {
//                 return `<td class="size-qty text-end" contenteditable="true" data-size="${size}">0</td>`;
//             }).join('');

//             let newRow = `<tr data-fabric-id="${selectedFabricId}">
//                 <td>${selectedFabricText}</td>
//                 <td>${color.name}</td>
//                 <td>${selectedQualityText}</td>
//                 <td>${selectedStyles.map(id => $("#style_id option[value='" + id + "']").text()).join(', ')}</td>
//                 ${sizeData}
//                 <td class="row-total text-end">0</td> 
//               </tr>`;

//             $tableBody.append(newRow);
//         });

//         $mainTable.on("input", "[contenteditable='true']", function () {
//             let $cell = $(this), newValue = $cell.text().trim();
//             if (isNaN(newValue) || newValue === "") {
//                 $cell.text("0");
//             }
//             calculateTotals(); 
//         });

//         calculateTotals();
//     }).fail(function () {
//         alert("Error fetching fabric details.");
//     });
// }

// function calculateTotals() {
//     let $mainTable = $("#mainTable");
//     $mainTable.find(".totalQty, .grandTotal").text("0");
    
//     let columnTotals = {};
//     $mainTable.find("tbody tr").each(function () {
//         let rowTotal = 0;
//         $(this).find(".size-qty").each(function () {
//             let qty = parseInt($(this).text()) || 0;
//             let size = $(this).data("size");
//             rowTotal += qty;
//             columnTotals[size] = (columnTotals[size] || 0) + qty;
//         });
//         $(this).find(".row-total").text(rowTotal);
//     });
    
//     for (let size in columnTotals) {
//         $mainTable.find(`.totalQty[data-size='${size}']`).text(columnTotals[size]);
//     }
    
//     let grandTotal = Object.values(columnTotals).reduce((a, b) => a + b, 0);
//     $mainTable.find(".grandTotal").text(grandTotal);
// }



// function calculateTotals() {
//     let $mainTable = $("#mainTable");
//     $mainTable.find(".totalQty, .grandTotal").text("0");
    
//     let columnTotals = {};
//     $mainTable.find("tbody tr").each(function () {
//         let rowTotal = 0;
//         $(this).find(".size-qty").each(function () {
//             let qty = parseInt($(this).text()) || 0;
//             let size = $(this).data("size");
//             rowTotal += qty;
//             columnTotals[size] = (columnTotals[size] || 0) + qty;
//         });
//         $(this).find(".row-total").text(rowTotal);
//     });
    
//     for (let size in columnTotals) {
//         $mainTable.find(`.totalQty[data-size='${size}']`).text(columnTotals[size]);
//     }
    
//     let grandTotal = Object.values(columnTotals).reduce((a, b) => a + b, 0);
//     $mainTable.find(".grandTotal").text(grandTotal);
// }


// function LoadColorTable() {
//     let $fabricDropdown = $("#fabric_id"),
//         selectedFabricId = $fabricDropdown.val(),
//         selectedFabricText = $fabricDropdown.find("option:selected").text(),
//         selectedQualityText = $("#quality_id option:selected").text(),
//         selectedStyles = $("#style_id").val(),
//         selectedSizes = $("#size_id").val(),
//         selectedSizeNames = $("#size_id option:selected").map(function () { return $(this).text(); }).get();

//     if (!selectedFabricId || !selectedStyles || !selectedSizes) {
//         alert("Please select Fabric, Style, and Size first.");
//         return;
//     }

//     $.get("{% url 'get_fabric_details' %}", { fabric_id: selectedFabricId }, function (response) {
//         if (!response.success) {
//             alert(response.message);
//             return;
//         }

//         let $tablesContainer = $("#tablesContainer"),
//             colors = response.colors;

//         if ($("#mainTable").length === 0) {
//             let mainTable = `<div class="p-2">
//                 <h5>Fabric Details</h5>
//                 <table id="mainTable" class="table table-striped table-bordered w-100">
//                     <thead>
//                         <tr style="background-color: white; color: black;"> 
//                             <th>Fabric</th>
//                             <th>Color</th>
//                             <th>Quality</th>
//                             <th>Style</th>
//                             ${selectedSizeNames.map(size => `<th colspan="1">Size ${size}</th>`).join('')}
//                             <th>Total</th>
//                         </tr>
//                         <tr>
//                             <th colspan="4"></th>
//                             ${selectedSizeNames.map(() => `<th>Qty</th>`).join('')} 
//                             <th></th>
//                         </tr>
//                     </thead>
//                     <tbody></tbody>
//                     <tfoot>
//                         <tr>
//                             <th colspan="4" style="background-color: white; color: black; text-align: center;">Total</th>
//                             ${selectedSizeNames.map(() => `<th class="text-end totalQty">0</th>`).join('')}
//                             <th class="text-end grandTotal">0</th>
//                         </tr>
//                     </tfoot>
//                 </table>
//             </div>`;
//             $tablesContainer.append(mainTable);
//         }

//         let $tableBody = $("#mainTable tbody");

//         colors.forEach(color => {
//             let sizeData = selectedSizeNames.map(size => {
//                 let isSelectedSize = selectedSizes.includes($("#size_id option:contains('" + size + "')").val());
//                 return `<td class="size-qty text-end" contenteditable="true" data-size="${size}" style="background-color: ${isSelectedSize ? 'white' : 'lightgray'};">0</td>`;
//             }).join('');

//             let newRow = `<tr>
//                 <td>${selectedFabricText}</td>
//                 <td>${color.name}</td>
//                 <td>${selectedQualityText}</td>
//                 <td>${selectedStyles.map(id => $("#style_id option[value='" + id + "']").text()).join(', ')}</td>
//                 ${sizeData}
//                 <td class="row-total text-end">0</td> 
//               </tr>`;

//             $tableBody.append(newRow);
//         });

//         $("#mainTable").on("input", "[contenteditable='true']", function () {
//             let $cell = $(this), newValue = $cell.text().trim();
//             if (isNaN(newValue) || newValue === "") {
//                 $cell.text("0");
//             }
//             calculateTotals(); 
//         });

//         calculateTotals();
//     }).fail(function () {
//         alert("Error fetching fabric details.");
//     });
// }


// function LoadColorTable() {
//     let $fabricDropdown = $("#fabric_id"),
//         selectedFabricId = $fabricDropdown.val(),
//         selectedFabricText = $fabricDropdown.find("option:selected").text(),
//         selectedQualityText = $("#quality_id option:selected").text(),
//         selectedStyles = $("#style_id").val(),
//         selectedSizes = $("#size_id").val(),
//         selectedSizeNames = $("#size_id option:selected").map(function () { return $(this).text(); }).get();

//     if (!selectedFabricId || !selectedStyles || !selectedSizes) {
//         alert("Please select Fabric, Style, and Size first.");
//         return;
//     }

//     $.get("{% url 'get_fabric_details' %}", { fabric_id: selectedFabricId }, function (response) {
//         if (!response.success) {
//             alert(response.message);
//             return;
//         }

//         let $tablesContainer = $("#tablesContainer"),
//             colors = response.colors;

//         if ($("#mainTable").length === 0) {
//             let mainTable = `<div class="p-2">
//                 <h5>Fabric Details</h5>
//                 <table id="mainTable" class="table table-striped table-bordered w-100">
//                     <thead>
//                         <tr style="background-color: white; color: black;"> 
//                             <th>Fabric</th>
//                             <th>Color</th>
//                             <th>Quality</th>
//                             <th>Style</th>
//                             ${selectedSizeNames.map(size => `<th colspan="1">Size ${size}</th>`).join('')}
//                             <th>Total</th>
//                         </tr>
//                         <tr>
//                             <th colspan="4"></th>
//                             ${selectedSizeNames.map(() => `<th>Qty</th>`).join('')} 
//                             <th></th>
//                         </tr>
//                     </thead>
//                     <tbody></tbody>
//                     <tfoot>
//                         <tr>
//                             <th colspan="4" style="background-color: white; color: black; text-align: center;">Total</th>
//                             ${selectedSizeNames.map(() => `<th class="text-end totalQty">0</th>`).join('')}
//                             <th class="text-end grandTotal">0</th>
//                         </tr>
//                     </tfoot>
//                 </table>
//             </div>`;
//             $tablesContainer.append(mainTable);
//         }

//         let $tableBody = $("#mainTable tbody");
//         colors.forEach(color => {
//             let sizeData = selectedSizeNames.map(size => {
//                 return `<td class="size-qty text-end" contenteditable="true" data-size="${size}">0</td>`;
//             }).join('');

//             let newRow = `<tr>
//                 <td>${selectedFabricText}</td>
//                 <td>${color.name}</td>
//                 <td>${selectedQualityText}</td>
//                 <td>${selectedStyles.map(id => $("#style_id option[value='" + id + "']").text()).join(', ')}</td>
//                 ${sizeData}
//                 // <td class="row-total text-end">0</td> 
//               </tr>`;

//             $tableBody.append(newRow);
//         });

//         $("#mainTable").on("input", "[contenteditable='true']", function () {
//             let $cell = $(this), newValue = $cell.text().trim();
//             if (isNaN(newValue) || newValue === "") {
//                 $cell.text("0");
//             }
//             calculateTotals(); 
//         });

//         calculateTotals();
//     }).fail(function () {
//         alert("Error fetching fabric details.");
//     });
// }

function calculateTotals() {
    let columnTotals = {};

    // Reset totals
    $(".totalQty, .grandTotal").text("0");

    $("#mainTable tbody tr").each(function () {
        let rowTotal = 0;

        $(this).find(".size-qty").each(function () {
            let size = $(this).data("size");
            let qty = parseInt($(this).text()) || 0;
            rowTotal += qty;

            // Update column-wise totals
            columnTotals[size] = (columnTotals[size] || 0) + qty;
        });

        $(this).find(".row-total").text(rowTotal);
    });

    // Update column totals
    $(".totalQty").each(function (index) {
        $(this).text(columnTotals[$(this).closest("th").text()] || 0);
    });

    // Update grand total
    let grandTotal = Object.values(columnTotals).reduce((a, b) => a + b, 0);
    $(".grandTotal").text(grandTotal);
}



$("#saveButton").on("click", function () {
    let programDate = $("#program_date").val().trim();

    if (!programDate) {
        alert("Please select a valid program date.");
        return;
    }

    let formData = new FormData();
    formData.append("program_date", programDate); // Ensure correct format
    formData.append("party_id", $("#party_id").val());
    formData.append("total_rolls", $(".totalTotalRolls").text().trim());
    formData.append("total_wt", $(".totalTotalWt").text().trim());
    formData.append("remarks", $("#remarks").val());
    formData.append("csrfmiddlewaretoken", $("input[name=csrfmiddlewaretoken]").val());

    $("#mainTable tbody tr").each(function () {
        let fabric_id = $(this).find("input[name='fabric_id[]']").val();
        let color_id = $(this).find("input[name='color_id[]']").val();

        $(this).find(".dia-rolls").each(function () {
            let dia_id = $(this).data("dia-id");
            let rollsCell = $(this);
            let wtCell = rollsCell.next(".dia-wt");

            // Check background color to exclude shaded cells
            let rollsBgColor = rollsCell.css("background-color");
            let wtBgColor = wtCell.css("background-color");

            if (rollsBgColor === "rgb(255, 255, 255)" && wtBgColor === "rgb(255, 255, 255)") { // White background
                let rolls = rollsCell.text().trim();
                let wt = wtCell.text().trim();

                formData.append("fabric_id[]", fabric_id);
                formData.append("color_id[]", color_id);
                formData.append("dia_id[]", dia_id);
                formData.append("rolls[]", rolls);
                formData.append("wt[]", wt);
            }
        });
    });
 
    $.ajax({
        type: "POST",
        url: "/purchase/save-dyeing-program/",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
            if (response.success) {

                notifier.show( 
                    'Well Done!',  
                    'Dyeing Program Added Successfully!', 
                    'success',  
                    "{% static 'assets/images/notification/ok-48.png' %}", 
                    4000
                );  

                $('#dyeingProgramForm').trigger('reset');

                // alert("Dyeing program saved successfully!");
                // location.reload();
            } else {
                notifier.show(
                    'Error!', 
                    response.message || 'Failed To add', 
                    'danger', 
                    "{% static 'assets/images/notification/high_priority-48.png' %}", 
                    4000
                ); 


                // alert("Error: " + response.message);
            }
        },
        error: function () {
            notifier.show(
                'Error!', 
                response.message || 'Failed To add', 
                'danger', 
                "{% static 'assets/images/notification/high_priority-48.png' %}", 
                4000
            ); 

            // alert("An error occurred while saving.");
        }
    });
});

// `````````````````````````````````````````````````````````````



function calculateTotals(tableId) {
    let $table = $(tableId);
    
    let totalDiaRolls = [],
        totalDiaWt = [],
        totalTotalRolls = 0,
        totalTotalWt = 0;

    // Reset all totals
    $table.find(".totalDiaRolls, .totalDiaWt, .totalTotalRolls, .totalTotalWt").text("0");

    // Iterate over each row
    $table.find("tbody tr").each(function () {
        let rowTotalRolls = 0;
        let rowTotalWt = 0;

        // Loop through each roll column in the row
        $(this).find(".dia-rolls").each(function (index) {
            let val = parseFloat($(this).text()) || 0;
            rowTotalRolls += val;
            totalDiaRolls[index] = (totalDiaRolls[index] || 0) + val;
        });

        // Loop through each weight column in the row
        $(this).find(".dia-wt").each(function (index) {
            let val = parseFloat($(this).text()) || 0;
            rowTotalWt += val;
            totalDiaWt[index] = (totalDiaWt[index] || 0) + val;
        });

        // Update row total in the last two columns
        $(this).find(".total-rolls").text(rowTotalRolls);
        $(this).find(".total-wt").text(rowTotalWt);

        // Add to grand totals
        totalTotalRolls += rowTotalRolls;
        totalTotalWt += rowTotalWt;
    });

    // Update column totals
    $table.find(".totalDiaRolls").each(function (index) {
        $(this).text(totalDiaRolls[index] || 0);
    });

    $table.find(".totalDiaWt").each(function (index) {
        $(this).text((totalDiaWt[index] || 0) + " kg");
    });

    // Update grand totals in <tfoot>
    $table.find(".totalTotalRolls").text(totalTotalRolls);
    $table.find(".totalTotalWt").text(totalTotalWt + " kg");
}



// // Attach event to the button
$("#update").click(LoadColorTable);

const currentDate = new Date();
    const currentDateString = currentDate.toISOString().slice(0, 10); // Format as YYYY-MM-DD
    const currentTimeString = currentDate.toTimeString().slice(0, 5); // Format as HH:MM

    // Set default values for date and time fields
    document.getElementById('program_date').value = currentDateString;
    // document.getElementById('purchase_time').value = currentTimeString;





</script>