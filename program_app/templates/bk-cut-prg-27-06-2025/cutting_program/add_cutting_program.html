
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}


    <!-- Sidebar CSS (Updated) -->
<style>
    .sidebar {
        position: fixed;
        top: 0;
        right: -450px; /* Initially hidden */
        width: 400px;
        height: 100%;
        background: #fff;
        box-shadow: -2px 0px 5px rgba(0, 0, 0, 0.2);
        transition: right 0.3s ease-in-out;
        z-index: 1050;
        padding: 15px;
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
    }

    /* ðŸ”¹ Scrollable Content */
    .sidebar-body {
        overflow-y: auto;
        max-height: calc(100vh - 120px); /* Adjust to fit within viewport */
        flex-grow: 1;
        padding-right: 5px; /* Avoid scrollbar overlapping */
    }

    /* Optional: Custom Scrollbar */
    .sidebar-body::-webkit-scrollbar {
        width: 5px;
    }

    .sidebar-body::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 5px;
    }

    .sidebar-footer {
        padding-top: 10px;
        border-top: 1px solid #ddd;
        text-align: center;
        background: #fff;
    }

    .size-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
       


    
    .table thead th {
    border-bottom: 1px solid #e2e5e8;
    font-size: 13px;
    color: #111;
    background: #eff3f6;
    text-transform: uppercase;
    padding: 4px;
    text-align:center;
}


    .table body th {
    border-bottom: 1px solid #e2e5e8;
    font-size: 13px;
    color: #111;
    background: #eff3f6;
    text-transform: uppercase;
    padding: 3px;
    text-align:center;
}
    
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
    }

    /* Firefox */
    /* input[type=number] {
    -moz-appearance: textfield;
    } */

     #purchaseTable{
        padding: 4px !important;
     }
</style>
                                








<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content"> 
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title">    <!-- mill to knitting delivery -->
                                            <h4 class="m-b-10">Cutting Program  </h4>
                                        </div>
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Program</a></li>
                                            <li class="breadcrumb-item"><a href="/cutting-program"> Cutting Program</a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                    </div>

                                    <div class="card">

                                        <div class="card-body row"> 
                                            <div class="col-sm-12">
                                                <div class="row">
                                                    <div class="col-md-9">
                                                        <form id="add_new" >
                                                            {% csrf_token %}
                                                            <div class="row ">
                                                                
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="delivery_no" class="form-lebel">Program No.</label>
                                                                    <input type="text" class="form-control" value="{{prg_number}}" readonly>
                                                                </div>  

                                                                 <div class="col-md-2 mt-3">
                                                                    <label for="delivery_no" class="form-lebel">Program Date</label>
                                                                    <input type="text" class="form-control" id="program_date" name="program_date">
                                                                </div>  

                                                                 <div class="col-md-2 mt-3">
                                                                    <label for="delivery_no" class="form-lebel"><span style="color: red;">*</span> Work Order No.</label>
                                                                    <input type="text" class="form-control" id="work_ord_no" name="work_ord_no" required>
                                                                </div>  
                                      
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Quality</label>
                                                                    <select id="quality_id" name="quality_id" class="form-control single-select" onchange="LoadStyle()">
                                                                        <option value="">Select</option>
                                                                        {% for k in quality %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>


                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Style</label>
                                                                    <select id="style_id" name="style_id" class="form-control single-select" >
                                                                        <option value="">Select</option>
                                                                        {% for k in style %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>



                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Size</label>
                                                                    <select id="size_id" name="size_id" class="form-control single-select" >
                                                                        <option value="">Select</option>
                                                                        {% for k in size %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                           

                                                         
                                                            </div>
                                                            
                    
                     
                                                    
                                                    </div> 

                                                    <div class="col-md-3"> 

                                                        <div class="">            
                                                            <table id="summaryTable" class="table table-striped table-bordered w-100">
                                                                <thead>
                                                                    <tr>
                                                                        <th colspan="2">Summary Table</th>
                                                                    </tr>  
                                                                </thead>
                                                                <tbody>
                                                                    <tr>
                                                                        <td> Total Quantity</td>
                                                                        <td align="end" colspan="2"  style="background-color: #428bca;" id="qty_total_placeholder">0</td>
                                                                    </tr>
                                                            
                                                                    
                                                                </tbody>
                                                            </table>     
                                                        </div>

                                                    </div>
                                                
                                                    <div class="">
                                                        <div class="table-responsive table-desi">

                                                            <table id="purchaseTable" class="table table-bordered">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Size</th>
                                                                        <th>Color</th>
                                                                        <th>Quantity (kg)</th>
                                                                        <th style="display: none;">Size id</th>
                                                                        <th style="display: none;">Color id</th>
                                                                        <th>Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody></tbody> 
                                                            </table>

                                                        
                                                        
                                                        </div>
                                                    </div>

                                                    <div class="row">

                                                        <div class="col-md-6 mt-2">
                                                            <!-- <label for="order_date" class="form-label">Remarks</label> -->
                                                            <textarea class="form-control" type="text" name="remarks" id="remarks" placeholder="Remarks" required></textarea>
                                                        </div>



                    
                                                        <div class="col-md-2 mt-2">
                                                            <div class="" style="text-align: center;" >
                                                                <button type="button" id="cancel" class="btn btn-danger" onclick="history.back()">Close</button>
                                                                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                                                                <button type="submit" id="submit" class="btn btn-primary">Save</button>
                                                            </div>
                                                        </div>

                                                       
                                             
                                                    
                                            
                                                </div>

                                               
                                            </div>
                                        
                                        </form>
                                    </div>
                                </div>
 


                                <div id="colorSidebar" class="sidebar">
                                    <div class="sidebar-header">
                                        <h4>Select Colors</h4>
                                        <button onclick="closeColorSidebar()">Ã—</button>
                                    </div>
                                
                                    <!-- Scrollable Body -->
                                    <div class="sidebar-body">
                                        <div id="colorModalBody"></div>
                                    </div>
                                
                                    <div class="sidebar-footer">
                                        <button type="button" class="btn btn-success" onclick="saveColorSelection()">+ Add Colors</button>
                                    </div>
                                </div>
                                
                            
                                    <!-- Edit Modal -->
                                    <div class="modal fade" id="editColorModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                            <h5 class="modal-title" id="editModalLabel">Update </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                            <!-- Hidden fields to store IDs -->
                                            <input type="hidden" id="edit_size_id">
                                            <input type="hidden" id="edit_color_id">
                                    
                                            <div class="mb-3">
                                                <label class="form-label">Size</label>
                                                <!-- <input type="text" id="edit_size_name" class="form-control-plaintext"> -->

                                                <input type="text" id="edit_size_name" class="form-control" readonly >
                                            </div>
                                            <div class="mb-3">
                                                
                                                <label class="form-label">Color</label>
                                                <!-- 
                                                <p id="edit_color_name" class="form-control"></p> -->
                                                <input type="text" id="edit_color_name" class="form-control" readonly >

                                            </div>
                                            <div class="mb-3">
                                                <label for="edit_quantity" class="form-label">Quantity</label>
                                                <input type="number" id="edit_quantity" class="form-control" value="1" min="1">
                                            </div> 
                                            </div>
                                            <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button type="button" class="btn btn-primary" onclick="saveUpdatedRow()">Update</button>
                                            </div>
                                        </div>
                                        </div>
                                    </div>
  

                                    <!-- modal end -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <style>
        .no-border-input {
            border: none;
            background: transparent;
            text-align: center;
            width: 100%;
            color: inherit; /* Matches text color to the row */
        }

        .no-border-input:focus {
            outline: none;
        }

    </style>
</div>
{% include 'includes/footer.html' %}


<script>



$('#size_id').on('change', function () {
    loadColors();
});




function loadColors() {
    var size_id = $('#size_id').val();
    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

    if (!size_id) {
        console.warn("Size not selected");
        return;
    }

    $.ajax({
        type: 'POST',
        url: '/get_color_list/',
        data: {
            'size_id': size_id,
            'csrfmiddlewaretoken': csrfToken
        },
        dataType: 'json',
        success: function (data) {
            console.log('Received Colors:', data);
            $('#colorModalBody').empty();

            let selectedColors = JSON.parse(localStorage.getItem('selectedColors')) || [];

            if (data.colors && Array.isArray(data.colors)) {
                data.colors.forEach(function (color) {
                    let existingEntry = selectedColors.find(item => item.size_id === size_id && item.color_id === color.id);
                    let quantity = existingEntry ? existingEntry.quantity : 0;

              

                    $('#colorModalBody').append(`
                        <div class="color-row d-flex justify-content-between align-items-center mb-2">
                            <span class="color-name flex-grow-1">${color.name}</span>
                            <div class="d-flex align-items-center">
                                <button type="button" class="btn btn-sm btn-danger" onclick="decreaseColorQuantity('${color.id}')">-</button>
                                <input type="number" id="color_qty_${color.id}" class="form-control text-center mx-2" value="${quantity}" min="0" style="width: 90px;text-center">
                                <button type="button" class="btn btn-sm btn-success" onclick="increaseColorQuantity('${color.id}')">+</button>
                            </div>
                        </div>
                    `);


                });

                openColorSidebar();
            }
        },
        error: function (xhr, status, error) {
            console.error('Error loading colors:', error);
        }
    });
}



// Sidebar functions
function openColorSidebar() {
    document.getElementById('colorSidebar').style.right = "0";
}

function closeColorSidebar() {
    document.getElementById('colorSidebar').style.right = "-450px";
}
 
// Increase/decrease quantity functions
function increaseColorQuantity(color_id) {
    let input = document.getElementById(`color_qty_${color_id}`);
    input.value = parseInt(input.value) + 1;
}

function decreaseColorQuantity(color_id) {
    let input = document.getElementById(`color_qty_${color_id}`);
    if (parseInt(input.value) > 0) {
        input.value = parseInt(input.value) - 1;
    }
}




function saveColorSelection() {
    let size_id = $('#size_id').val();
    if (!size_id) {
        alert("Please select a size first.");
        return;
    }

    let selectedColors = JSON.parse(localStorage.getItem('selectedColors')) || [];
    let newSelections = [];

    $('.color-row').each(function () {
        let color_id = $(this).find('input[type="number"]').attr('id').split('_')[2]; 
        let color_name = $(this).find('span').text().trim();
        let quantity = parseInt($(this).find('input[type="number"]').val());

        if (quantity > 0) {
            let existsInTable = false;
            let existingItemIndex = -1;

            // Check if this size-color pair already exists in the purchase table (or selectedColors)
            for (let i = 0; i < selectedColors.length; i++) {
                if (selectedColors[i].size_id === size_id && selectedColors[i].color_id === color_id) {
                    existsInTable = true;
                    existingItemIndex = i; // Store index of the existing item
                    break;
                }
            }

            if (existsInTable) {
                // Update the quantity of the existing item
                selectedColors[existingItemIndex].quantity += quantity;
                console.log(`Updated quantity for Size: ${size_id}, Color: ${color_name}. New Quantity: ${selectedColors[existingItemIndex].quantity}`);
            } else {
                // Add new size-color pair to selections
                let newItem = { size_id, color_id, color_name, quantity };
                selectedColors.push(newItem);
                newSelections.push(newItem);  // Store separately for immediate processing
            }
        }
    });

    // Save updated data in localStorage
    localStorage.setItem('selectedColors', JSON.stringify(selectedColors));
    localStorage.setItem('newSelections', JSON.stringify(newSelections));

    console.log('Updated Local Storage:', localStorage.getItem('selectedColors'));

    closeColorSidebar();
    loadPurchaseTable();
}

function loadPurchaseTable() {
    let newSelections = JSON.parse(localStorage.getItem('newSelections')) || [];
    let $tbody = $('#purchaseTable tbody');

    newSelections.reverse().forEach(item => {
        if (item.quantity > 0) {  // Only add if quantity > 0
            let sizeName = $('#size_id option[value="' + item.size_id + '"]').text();
            let colorName = item.color_name || "Unknown Color";

            let row = ` 
                <tr>
                    <td>${sizeName}</td>
                    <td>${colorName}</td>
                    <td>${item.quantity}</td>
                    <td style="display: none;">${item.size_id}</td>
                    <td style="display: none;">${item.color_id}</td>
                    <td><button type="button" class="btn btn-danger btn-xs" onclick="removeRow('${item.size_id}', '${item.color_id}')"><i class="feather icon-trash-2"></i></button> 
                        <button type="button" class="btn btn-primary btn-xs" onclick="editRow('${item.size_id}', '${item.color_id}')"><i class="feather icon-edit"></i></button></td>
                </tr>
            `;

            $tbody.prepend(row);  // Add new row at the top
        }
        $("#size_id").val('').trigger("change"); // Clear the size selection

        calculateTotalValue();
    });

    // Clear "newSelections" storage after adding to table
    localStorage.removeItem('newSelections');
}




function editRow(size_id, color_id) {
    let row = $(`#purchaseTable tbody tr`).filter(function () {
        return $(this).find('td:eq(3)').text() === size_id &&
               $(this).find('td:eq(4)').text() === color_id;
    });

    if (row.length === 0) {
        alert("Row not found!");
        return;
    }

    let sizeName = row.find("td:eq(0)").text().trim();
    let colorName = row.find("td:eq(1)").text().trim();
    let quantity = row.find("td:eq(2)").text().trim();

    // Populate fields in the edit modal
    $("#edit_size_id").val(size_id);
    $("#edit_color_id").val(color_id);
    $("#edit_size_name").val(sizeName);
    $("#edit_color_name").val(colorName);
    $("#edit_quantity").val(quantity);

    // Open the edit modal
    $("#editColorModal").modal("show");
}





// Function to save updated values
function saveUpdatedRow() {
    let size_id = $("#edit_size_id").val();
    let color_id = $("#edit_color_id").val();
    let quantity = parseInt($("#edit_quantity").val());

    if (quantity <= 0) {
        alert("Quantity must be greater than 0");
        return;
    }

    let sizeName = $("#edit_size_name").val();
    let colorName = $("#edit_color_name").val();

    // Remove the old row if it exists
    $(`#purchaseTable tbody tr`).filter(function () {
        return $(this).find('td:eq(3)').text() === size_id &&
               $(this).find('td:eq(4)').text() === color_id;
    }).remove();

    // Append the updated row at the top of the table
    $("#purchaseTable tbody").prepend(`
        <tr>
            <td>${sizeName}</td>
            <td>${colorName}</td>
            <td>${quantity}</td>
            <td style="display: none;">${size_id}</td>
            <td style="display: none;">${color_id}</td>
            <td>
                <button type="button" class="btn btn-danger btn-xs" onclick="removeRow('${size_id}', '${color_id}')">
                    <i class="feather icon-trash-2"></i>
                </button>
                <button type="button" class="btn btn-primary btn-xs" onclick="editRow('${size_id}', '${color_id}')">
                    <i class="feather icon-edit"></i>
                </button>
            </td>
        </tr>
    `);

    // Close the edit modal
    $("#editColorModal").modal("hide");
    calculateTotalValue();
}




function editRo_bk_14(size_id, color_id) {
    let row = $(`#purchaseTable tbody tr`).filter(function () {
        return $(this).find('td:eq(3)').text() === size_id &&
               $(this).find('td:eq(4)').text() === color_id;
    });

    if (row.length === 0) {
        alert("Row not found!");
        return;
    }

    let sizeName = row.find("td:eq(0)").text().trim();
    let colorName = row.find("td:eq(1)").text().trim();
    let quantity = row.find("td:eq(2)").text().trim();

    // Populate modal with selected size and color
    $("#size_id").val(size_id).trigger("change");  
    $("#colorModalBody").empty();  

    // Append color input in modal dynamically
    $("#colorModalBody").append(`
        <div class="color-row d-flex justify-content-between align-items-center mb-2">
            <span class="color-name flex-grow-1">${colorName}</span>
            <div class="d-flex align-items-center">
                <button type="button" class="btn btn-sm btn-danger" onclick="decreaseColorQuantity('${color_id}')">-</button>
                <input type="number" id="color_qty_${color_id}" class="form-control text-center mx-2" value="${quantity}" min="0" style="width: 60px;">
                <button type="button" class="btn btn-sm btn-success" onclick="increaseColorQuantity('${color_id}')">+</button>
            </div>
        </div>
    `);

    // Set values in hidden fields for tracking
    $("#edit_size_id").val(size_id);
    $("#edit_color_id").val(color_id);

    openColorSidebar(); // Open modal for editing
}



function removeRow(size_id, color_id) {
    let selectedColors = JSON.parse(localStorage.getItem('selectedColors')) || [];

    // Check if the entry exists before filtering
    let itemExists = selectedColors.some(item => item.size_id === size_id && item.color_id === color_id);

    if (!itemExists) {
        alert("Error: This entry does not exist!");
        return;
    }

    // Remove the specific size_id & color_id pair
    selectedColors = selectedColors.filter(item => !(item.size_id === size_id && item.color_id === color_id));

    // Update local storage
    localStorage.setItem('selectedColors', JSON.stringify(selectedColors));

    // Remove the row from the table
    $('#purchaseTable tbody tr').each(function () {
        let rowSizeId = $(this).find("td:nth-child(4)").text().trim();
        let rowColorId = $(this).find("td:nth-child(5)").text().trim();

        if (rowSizeId === size_id && rowColorId === color_id) {
            $(this).remove();
        }
    });

    console.log("Updated Local Storage:", localStorage.getItem('selectedColors'));
    calculateTotalValue();
}



// ``````````````````````````````````````````````````````
function LoadStyle() {
    var quality_id = $('#quality_id').val(); 
    console.log('Quality-ID:', quality_id); // Debugging output

    if (!quality_id) {
        console.warn("No Quality ID selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

    $.ajax({
        type: 'POST',
        url: '/get_quality_style_list/',
        data: {
            'quality_id': quality_id,
            'csrfmiddlewaretoken': csrfToken 
        },
        dataType: 'json',

        success: function(data) {
            console.log('Received Data:', data); // Debugging output

            // Clear and add default "Select" option
            $('#style_id').empty().append('<option value="">Select </option>');
            $('#size_id').empty().append('<option value="">Select </option>');
            // $('#color_id').empty().append('<option value="">Select Color</option>');

            // Populate Styles
            if (data.style && Array.isArray(data.style)) {
                data.style.forEach(function(item) {
                    $('#style_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }

            if (data.size && Array.isArray(data.size)) {
                data.size.forEach(function(item) {
                    $('#size_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }

          
        },

        error: function(xhr, status, error) {
            console.error('Error loading fabric details:', error);
        } 
    });
}



function LoadSizes() {
    var quality_id = $('#quality_id').val();
    var style_id = $('#style_id').val();

    if (!quality_id || !style_id) {
        console.warn("Quality or Style not selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();


    $.ajax({
    type: 'POST',
    url: '/get_size_list/',  // Change the URL to match Django's path
    data: {
        'quality_id': quality_id,
        'style_id': style_id,
        'csrfmiddlewaretoken': csrfToken 
    },
    dataType: 'json',

    success: function(data) {
        console.log('Received Sizes:', data);
        $('#sizeModalBody').empty();

        if (data.sizes && Array.isArray(data.sizes)) {
            data.sizes.forEach(function(size) {
                $('#sizeModalBody').append(`
                    <div class="size-row d-flex align-items-center mb-2">
                        <span class="me-2">${size.name}</span>
                        <button type="button" class="btn btn-sm btn-danger" onclick="decreaseQuantity('${size.id}')">-</button>
                        <input type="number" id="size_qty_${size.id}" class="form-control mx-2" value="1" min="0" style="width: 60px;">
                        <button type="button" class="btn btn-sm btn-success" onclick="increaseQuantity('${size.id}')">+</button>
                    </div>
                `);
            });

            $('#sizeModal').modal('show');
        }
    },

    error: function(xhr, status, error) {
        console.error('Error loading sizes:', error);
    } 
});

}

// Increase quantity
function increaseQuantity(sizeId) {
    let input = $(`#size_qty_${sizeId}`);
    let currentValue = parseInt(input.val()) || 0;
    input.val(currentValue + 1);
}

// Decrease quantity
function decreaseQuantity(sizeId) {
    let input = $(`#size_qty_${sizeId}`);
    let currentValue = parseInt(input.val()) || 0;
    if (currentValue > 0) {
        input.val(currentValue - 1);
    }
}



function saveSizeSelection() {
    let selectedSizes = [];

    $('#sizeModalBody .size-row').each(function () {
        let sizeName = $(this).find('span').text();
        let sizeId = $(this).find('input').attr('id').split('_')[2]; // Extract size ID from input ID
        let quantity = parseInt($(this).find('input').val()) || 0;

        if (quantity > 0) {
            selectedSizes.push({ sizeId, sizeName, quantity });
        }
    });

    // Add to table
    selectedSizes.forEach(size => {
        $('#purchaseTable tbody').append(`
            <tr>
                <td>${size.sizeName}</td>
                <td>-</td>
                <td>${size.quantity}</td>
                <td style="display: none;">${size.sizeId}</td>
                <td style="display: none;">-</td>
                <td><button class="btn btn-danger btn-sm" onclick="$(this).closest('tr').remove();">Delete</button></td>
            </tr>
        `);
    });

    $('#sizeModal').modal('hide'); // Close modal
}


</script>
<script>


 



// // ``````````````````````````````````````````````````````````````````````````````````````````````````````````````````````



const loadedItemsMap = {};



let rowCounter = 0; // Initialize row counter

function storeTblValues_bk_14032025() {
    var TableData = [];

    $('#purchaseTable tbody tr').each(function (index) {
        // Extract values from table row
        var size = $(this).find('td:eq(0)').text().trim();  // Size name
        var color = $(this).find('td:eq(1)').text().trim(); // Color name
        var quantity = parseFloat($(this).find('.quantity').val()) || 0; // Get quantity from input field

        // Ensure hidden input values exist
        var sizeId = $(this).find('.size_id').val() ? $(this).find('.size_id').val().trim() : "";
        var colorId = $(this).find('.color_id').val() ? $(this).find('.color_id').val().trim() : "";

        // âœ… Validate required fields
        if (size && color && quantity > 0) {
            TableData.push({
                "size": size,
                "color": color,
                "quantity": quantity,
                "size_id": sizeId,
                "color_id": colorId
            });
        } else {
            console.error(`Row ${index + 1} is missing required data:`, {
                size: size || "Missing",
                color: color || "Missing",
                quantity: quantity || "Missing"
            });
        }
    });

    // Calculate total after storing values
    calculateTotalValue();

    console.log('TABLE-DATA:', TableData);
    return TableData;
}


// ```````````````````````````````````````````````           11-03-2025              ```````````````````````````````````````````````



function addManualRow() {
    console.log("Manual row function triggered");

    const quantity = $("#quantity").val() || 1; // Default to 1 if empty
    let selectedSizes = $("#size_id").val();
    let selectedColors = $("#color_id").val();

    // âœ… Convert to array (handles both single and multi-select cases)
    selectedSizes = Array.isArray(selectedSizes) ? selectedSizes : [selectedSizes];
    selectedColors = Array.isArray(selectedColors) ? selectedColors : [selectedColors];

    if (!selectedSizes[0] || !selectedColors[0]) {
        notifier.show(
            'Error!', 
            'Please select at least one size and one color.', 
            'danger', 
            "{% static 'assets/images/notification/high_priority-48.png' %}", 
            4000
        ); 
        return;
    }

    selectedSizes.forEach(sizeId => {
        const sizeName = $("#size_id option[value='" + sizeId + "']").text();

        selectedColors.forEach(colorId => {
            const colorName = $("#color_id option[value='" + colorId + "']").text();

            // âœ… Check for duplicates before adding a new row
            if (!isRowDuplicate(sizeId, colorId)) { 
                addRow(sizeName, colorName, sizeId, colorId, quantity);
            } else {
                notifier.show(
                    'Error!', 
                    `Size: ${sizeName} and Color: ${colorName} already exists in the table.`, 
                    'danger', 
                    "{% static 'assets/images/notification/high_priority-48.png' %}", 
                    4000
                ); 
            }
        });
    });
}


function isRowDuplicate(sizeId, colorId) {
    let isDuplicate = false;

    $("#purchaseTable tbody tr").each(function () {
        const existingSizeId = $(this).find(".size_id").val();
        const existingColorId = $(this).find(".color_id").val();

        if (existingSizeId === sizeId && existingColorId === colorId) {
            isDuplicate = true;
            return false; // Exit loop early if found
        }
    });

    return isDuplicate;
}



function addRow(size, color, sizeId, colorId, quantity) {
    const tableBody = document.querySelector("#purchaseTable tbody");
    if (!tableBody) {
        console.error("Table body not found!");
        return;
    }

    const newRow = document.createElement("tr");

    newRow.innerHTML = `
        <td>${size}</td>
        <td>${color}</td>
        <td><input type="number" class="quantity no-border-input" value="${quantity}" min="1"></td>
        <td style="display:none"><input type="hidden" class="size_id" value="${sizeId}"></td>
        <td style="display:none"><input type="hidden" class="color_id" value="${colorId}"></td>
        <td>
            <button class="btn btn-primary btn-xs edit-row"><i class="feather icon-edit"></i></button>
            <button class="btn btn-danger btn-xs remove-row"><i class="feather icon-trash-2"></i></button>
        </td>
    `;

    tableBody.appendChild(newRow);

    // Clear selected colors after adding row
    $('#color_id').val('').trigger("change");
    $('#quantity').val('1');
    calculateTotalValue();
    // Attach event to remove row
    newRow.querySelector(".remove-row").addEventListener("click", function () {
        newRow.remove();
    });

    // Attach event to edit row
    newRow.querySelector(".edit-row").addEventListener("click", function () {
        editRow(newRow);
    });
}




// Function to calculate row-wise amount dynamically
function calculateRow(event) {
    const rowId = event.target.dataset.rowId;
    const row = document.querySelector(`tr[data-row-id="${rowId}"]`);

    const rate = parseFloat(row.querySelector('.rate').value) || 0;
    const quantity = parseFloat(row.querySelector('td:eq(2)').text()) || 0; 

    const amount = (rate * quantity).toFixed(2);
    row.querySelector('.amount').textContent = amount;

    calculateTotalValue();
}





function calculateTotalValue() {
    let totalQuantity = 0;
    let subTotal = 0;

    // Iterate over each row in the table
    $('#purchaseTable tbody > tr').each(function() {
        // Fetch values from each cell
        const quantity = parseFloat($(this).find('td:eq(2)').text()) || 0; // Get quantity from input field
        // const gross_wt = parseFloat($(this).find('.gross_wt').val()) || 0; // Assuming you have a 'gross_wt' input field

        // Update totals
        totalQuantity += quantity;
        // subTotal += gross_wt;
    });

    // Display totals
    $('#qty_total_placeholder').text(totalQuantity);
    // $('#sub_total_placeholder').text(subTotal.toFixed(2));
}




// `````````````````````````````````````````````````````````````````````




// ```````````````````````````````````````````````````````

$('#add_new').on('submit', function (e) {
    e.preventDefault(); // Prevent default form submission
    console.log("Submit button clicked");

    var TableData = storeTblValues(); // Get data from the table
    console.log('Table Data:', TableData);

    if (TableData.length === 0) {
        notifier.show(
            'Error!',
            'Table is empty. Please insert the program details.',
            'danger',
            "{% static 'assets/images/notification/high_priority-48.png' %}",
            4000
        );
        return;
    }

    if (confirm("Are you sure you want to save?")) {
        let formData = new FormData(this);
        formData.append('cutting_data', JSON.stringify(TableData)); // Add table data
        formData.append('total_quantity', $('#qty_total_placeholder').text()); // Add total quantity

        $.ajax({
            type: "POST",
            url: "/add-cutting-program/",
            data: formData,
            processData: false,
            contentType: false,
            beforeSend: function () {
                console.log("Sending AJAX request...");
                $('#submit').attr('disabled', true).text('Processing...');
            },
            success: function (response) {
                console.log("Server Response:", response);
                $('#submit').attr('disabled', false).text('Save');

                if (response.status === 'yes') {
                    notifier.show(
                        'Well Done!',
                        response.message,
                        'success',
                        "{% static 'assets/images/notification/ok-48.png' %}",
                        4000
                    );
                    $('#add_new').trigger('reset'); // Reset form
                    localStorage.removeItem('selectedColors'); // Clear local storage
                    loadPurchaseTable(); // Refresh table
                    $('#purchaseTable tbody').empty();  
                    $('#summaryTable tbody').empty();
					$('#size_id').val('').trigger("change");
					$('#quality_id').val('').trigger("change");
					$('#style_id').val('').trigger("change");
					$('#party_id').val('').trigger("change"); 
                } else {
                    notifier.show(
                        'Error!',
                        response.message || 'Failed to add',
                        'danger',
                        "{% static 'assets/images/notification/high_priority-48.png' %}",
                        4000
                    );
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log("AJAX Error:", textStatus, errorThrown);
                notifier.show(
                    'Error!',
                    'Error adding data',
                    'danger',
                    "{% static 'assets/images/notification/high_priority-48.png' %}",
                    4000
                );
                $('#submit').attr('disabled', false).text('Save');
            }
        });
    }
});

// Function to get table data
function storeTblValues() {
    let TableData = [];
    $('#purchaseTable tbody tr').each(function () {
        let size_id = $(this).find('td:eq(3)').text();
        let color_id = $(this).find('td:eq(4)').text();
        let quantity = parseInt($(this).find('td:eq(2)').text());

        if (quantity > 0) { // Only add rows with quantity > 0
            TableData.push({ size_id, color_id, quantity });
        }
    });
    return TableData;
}

$('.single-select').select2(); 

            // Get current date and time
    const currentDate = new Date();
    const currentDateString = currentDate.toISOString().slice(0, 10); // Format as YYYY-MM-DD
    const currentTimeString = currentDate.toTimeString().slice(0, 5); // Format as HH:MM

    // Set default values for date and time fields
    document.getElementById('program_date').value = currentDateString;



</script>