
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}

<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title">
                                            <h4 class="m-b-10">Knitting Program  </h4>
                                        </div>
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Knitting</a></li>
                                            <li class="breadcrumb-item"><a href="/knitting-program"> Knitting Program</a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>


                                
                                 
                                    
                                    <div class="card">
                                        <div class="card-body row">
                                            <div class="col-sm-12">
                                                <div class="row">
                                                    <div class="col-md-12"> <!--Col-12-->
                                                        <form id="add_new"> 
                                                            {% csrf_token %}
                                                            <div class="row ">
                                                                <div class="col-md-2 mt-2">


                                                                    <label for="number" class="form-label"> Program No.</label>
                                                                    <input type="text" class="form-control" id="po_number" value="{{delivery_number}}" disabled>
                                                                </div>


                                                                <div class="col-md-1 mt-5">
                                                                    <input class="form-check-input" type="radio" id="is_yarn" name="material_type" value="yarn">
                                                                    <label class="form-label" for="is_yarn"> Yarn</label>
                                                                    
                                                                    <p><span id="material_type_error" class="text-danger small"></span></p>

                                                                </div>


                                                                <div class="col-md-1 mt-5">
                                                                    <input class="form-check-input" type="radio" id="is_grey_fabric" name="material_type" value="grey">
                                                                    <label class="form-label" for="is_grey_fabric"> Grey Fabric</label>  
                                                                </div>

                                                             
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="number" class="form-label">Program Name</label>
												                     <input class="form-control" id="fabricName" dir="ltr" style="position: relative;width: 240px; vertical-align: top; background-color: transparent;" name="name" type="text">
                                                                </div>


                                                                <div class="col-md-2 mt-2">
                                                                    <label for="order_date" class="form-label">Program Date</label>
                                                                    <input class="form-control" type="date" name="program_date" id="program_date" required>
                                                                </div> 
                                                             

                                                                <input type="hidden" id="tx_id" name="tx_id">
                                                                <input type="hidden" id="tm_po_id" name="tm_po_id">
                                                                <input type="hidden" id="po_id" name="po_id" value="0">
                                                                <input type="hidden" id="lot_no" name="lot_no" value="0">

                                                                <div class="col-md-2 mt-2">
                                                                    <!-- <label for="unit" class="form-label"> PO Quantity</label> -->
                                                                    <input class="form-control" type="hidden" id="poid_quantity" disabled>
                                                                    <!-- <input class="form-control" type="text" id="prd" disabled> -->
                                                                </div>
                                                            </div>
                     
                                                            <hr>
                                                            <div class="row ">
                                                      
                    
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="bag" class="form-label">Fabric</label>
                                                                    <select id="fabric_id" name="fabric_id" class="form-control form-select single-select" onchange="LoadFabricValues()">
                                                                        <option value="">Select</option>
                                                                        {% for k in fabric_programs %}
                                                                        <option value="{{ k.id }}">{{ k.name }}  - {{ k.fabric_name }}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                    
                                                                </div>
                                                                


                                                                <div class="col-md-2 mt-3">
                                                                    <div class="form-group">
                                                                        <label for="product_id" class="form-label">Yarn Count</label>
                                                                        
                                                                        <select id="count" name="count" class="form-control form-select single-select" >
                                                                            <option value="">Select</option>
                                                                            {% for k in count %}
                                                                            <option value="{{ k.id }}">{{ k.count }}</option> 
                                                                            {% endfor %}
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                


                                                            
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="per_bag" class="form-label">Gauge</label>
                                                                    <select id="gauge" name="gauge" class="form-control form-select single-select" >
                                                                        <option value="">Select</option>
                                                                        {% for k in gauge %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                            
                                                                <div class="col-md-2 mt-3 mb-3">
                                                                    <label for="quantity" class="form-label">TEX/Loop Length</label>
                                                                    <select id="tex" name="tex" class="form-control form-select single-select" >
                                                                        <option value="">Select</option> 
                                                                        {% for k in tex %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %} 
                                                                    </select>
                                                                </div>
                                                            
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="rate" class="form-label">GSM</label>
                                                                    <input type="number"  class="form-control" id="gsm" name="gsm"  >
                                                                </div>
 
                                                            </div>
                                                            <div class="row ">
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="rate" class="form-label">DIA</label>
                                                                    <!-- <input type="number"  class="form-control" id="dia" name="dia"  > -->
                                                                     <select class="form-control single-select" id="dia" name="dia" >
                                                                        {% for d in dia %}
                                                                        <option value="{{d.id}}">{{d.dia}}</option>
                                                                        {% endfor %}
                                                                     </select>
                                                                </div>
                                                                
                                                                
                                                            
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="rolls" class="form-label">Rolls</label>
                                                                    <input type="number" class="form-control" id="rolls" name="rolls">
                                                                </div>
 
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="wt_per_roll" class="form-label">Roll Wt.</label>
                                                                    <!-- <input type="number" step="any" inputmode="decimal" class="form-control" id="wt_per_roll" name="wt_per_roll"> -->
                                                                    <!--  -->
                                                                    <input type="number" min="0" class="form-control" id="wt_per_roll" name="wt_per_roll">
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="qty" class="form-label">Quantity (kg)</label>
                                                                    <input type="number" class="form-control" id="quantity"  name="quantity">
                                                                </div>
                                                                
                                                                <div class="col-md-2 mt-5">
                                                                    <input type="hidden" id="edit_id" name="edit_id">
                                                                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                                                    <button type="button" id="update" class="btn btn-primary " onclick="addRow()">+ Add</button>
                                                                </div>
                                                        </div>
                     
                    
                                                    </div>
                                

                                                   
                                                    
                                                </div> 
                                         
                                                <hr>
                                                
                                                    <div class="">
                                                        <div class="table-responsive table-desi">
                                                            <table id="knittingtable" class="table table-striped table-bordered nowrap">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Count</th>
                                                                        <th>fabric</th>
                                                                        <th>Gauge</th>
                                                                        <th>Tex</th>
                                                                        <th>GSM</th>
                                                                        <th>Dia</th>
                                                                        <th>Rolls</th>
                                                                        <th>Roll Wt(kg)</th>
                                                                        <th>Qty (kg)</th>
                                                                        <!-- <th>Rate</th>
                                                                        <th>Total Amount</th> -->
                                                                        <th>Action</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                </tbody>

                                                                <tfoot>
                                                                    <tr>
                                                                        <td colspan="6" class="text-end"><strong>Total</strong></td>
                                                                        <td id="sum_rolls" class="text-end">0</td>
                                                                        <td></td>
                                                                        <td id="sum_quantity" class="text-end">0</td>
                                                                        <td></td>
                                                                    </tr>
                                                                </tfoot>
                                                            </table>
                                                        </div>
                                                    </div>
                                             
                                                    <div class="row">
                    
                                                        <div class="col-md-12">
                                                            <div class="" style="text-align: center;">
                                                                <button type="button" id="cancel" class="btn btn-danger" onclick="history.back()">Close</button>
                                                                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            
                                                                <button type="submit" id="submit" class="btn btn-primary">Save</button>
                                                            </div>
                                                        </div>
                                                        <!-- <div class="col-md-4">
                                                            <div class=" m-b-30">
                                                                <div class="card-body">            
                                                                    <table id="summaryTable" class="table table-striped table-bordered w-100">
                                                                        <thead>
                                                                            <tr>
                                                                                <th colspan="2">Summary Table</th>
                                                                            </tr> 
                                                                        </thead>
                                                                        <tbody>
                                                                            <tr>
                                                                                <td> Total Quantity</td>
                                                                                <td align="end" colspan="2" id="qty_total_placeholder">0</td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td>Sub Total</td>
                                                                                <td align="end" colspan="2" id="sub_total_placeholder">0.00</td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td>Total Tax</td>
                                                                                <td align="end" colspan="2" id="tax_placeholder">0.00</td>
                                                                            </tr>
        
                                                                            <tr>
                                                                                <td>Round off</td>
                                                                                <td align="end" colspan="2" id="round_off">0.00</td>
                                                                            </tr>
                                                                            <tr> 
                                                                                <td>Grand Total</td>
                                                                                <td style="background-color: #428bca; color: black; font-size: 21px" align="end" colspan="2" id="total_payable">0.00</td>
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>     
                                                                </div>
                                                            </div>
                                                        </div> -->
                                            
                                                       <!--summary table  --> 
                                           </div>

                                                
                                            </div> </form>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'includes/footer.html' %}

<script>

// document.getElementById('wt_per_roll').addEventListener('blur', function () {
//     let val = parseFloat(this.value);
//     console.log('test:',val);
//     if (!isNaN(val)) {
//         this.value = val.toFixed(3);
//     }
// });

const input = document.getElementById('wt_per_roll');

input.addEventListener('input', function () {
    const value = this.value;

    // Allow only numbers with up to 3 decimal places
    const match = value.match(/^\d*\.?\d{0,3}$/);

    if (!match) {
        // Remove extra characters if user types more than 3 decimals
        this.value = value.slice(0, -1);
    }
});

input.addEventListener('blur', function () {
    const num = parseFloat(this.value);
    if (!isNaN(num)) {
        this.value = num.toFixed(3);
    } else {
        this.value = ''; 
    }
});



// document.getElementById('wt_per_roll').addEventListener('input', function (e) {
//     const value = parseFloat(this.value);
//     this.value = isNaN(value) ? '' : value.toFixed(3);
// });

function LoadFabricValues() {
    var product_id = $('#fabric_id').val(); 
    console.log('Product-ID:', product_id); // Debugging output

    if (!product_id) {
        console.warn("No Product ID selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

    // ✅ Preserve po_quantity value
    let currentPoQuantity = $('#po_quantity').val();
    console.log("Stored po_quantity before AJAX:", currentPoQuantity);

    $.ajax({
        type: 'POST',   
        url: '/get_fabric_program_lists/',
        data: {
            'product_id': product_id,
            'csrfmiddlewaretoken': csrfToken
        },
        dataType: 'json',
        success: function(data) {
            console.log('Received Data:', data); // Debugging output
            console.log("Before updating fields, po_quantity:", $('#po_quantity').val());

            // Do NOT clear po_quantity
            $('#count').empty();
            $('#dia').empty();
            $('#gauge').empty(); 
            $('#tex').empty();
            $('#gsm').val('');

            // Populate dropdowns only if data exists
            if (data.count) {
                $('#count').html('<option value="' + data.count.id + '">' + data.count.count + '</option>');
            }

            // ✅ Handle multiple dia values (Array)
            // if (data.dia) { 
            //     $('#dia_id').append('<option value="' + data.dia.id + '">' + data.dia.name + '</option>');
            // }


            
            if (data.dia && Array.isArray(data.dia)) {
                let diaOptions = '';
                data.dia.forEach(function(dia) {
                    diaOptions += '<option value="' + dia.id + '">' + dia.name + '</option>';
                });
                $('#dia').html(diaOptions);
            } 


            if (data.gauge) {
                $('#gauge').html('<option value="' + data.gauge.id + '">' + data.gauge.name + '</option>');
            }

            if (data.tex) {
                $('#tex').html('<option value="' + data.tex.id + '">' + data.tex.name + '</option>');
            }

            if (data.gsm) {
                $('#gsm').val(data.gsm.gray_gsm);
            }

            // ✅ Restore po_quantity value
            $('#po_quantity').val(currentPoQuantity);
            console.log("Restored po_quantity after AJAX:", $('#po_quantity').val());
        },
        error: function(xhr, status, error) {
            console.error('Error loading fabric details:', error);
        } 
    });
}


// ````````````````````````````````````````````````````````````````````````````````


$(document).ready(function () {
    // Function to load or update values based on the selected options
    function loadValues() {
        // Get the selected values from the dropdowns
        var fabricId = $('#fabric_id').val();
        var countId = $('#count').val();
        var gaugeId = $('#gauge').val();
        var texId = $('#tex').val();
        var gsm = $('#gsm').val();

        // Example of logging selected values (you can use this data for AJAX calls, etc.)
        console.log("Fabric ID:", fabricId);
        console.log("Count ID:", countId);
        console.log("Gauge ID:", gaugeId);
        console.log("Tex ID:", texId);
        console.log("GSM:", gsm);

        // Perform some action based on selected values
        // For example, you could enable/disable certain fields or update other dropdowns
        if (fabricId && countId && gaugeId && texId) {
            // Enable GSM input if all selections are made (just an example)
            $('#gsm').prop('disabled', false);
        } else {
            // Disable GSM input if not all selections are made
            $('#gsm').prop('disabled', true);
        }

        // You can add more logic here to load additional data via AJAX or perform other actions
    }

    // Trigger loadValues when any of the dropdown values change
    $('#fabric_id, #count, #gauge, #tex').on('change', function () {
        loadValues();
    });

    // Optional: Initial call to load values when the page is loaded (if necessary)
    loadValues();
});


document.addEventListener("DOMContentLoaded", function () {
    // Attach event listeners for real-time calculations
    document.getElementById("rolls").addEventListener("input", calculateAmount);
    document.getElementById("wt_per_roll").addEventListener("input", calculateAmount);
    // document.getElementById("rate").addEventListener("input", calculateAmount);
});

function calculateAmount() {
    var rolls = parseFloat(document.getElementById("rolls").value) || 0;
    var wtPerRoll = parseFloat(document.getElementById("wt_per_roll").value) || 0;
    // var rate = parseFloat(document.getElementById("rate").value) || 0;

    // Calculate quantity
    var quantity = rolls * wtPerRoll;
    document.getElementById("quantity").value = quantity.toFixed(2);

    // Calculate total amount
    // var totalAmount = quantity * rate;
    // document.getElementById("total_amount").value = totalAmount.toFixed(2);
}






function LoadPODetails() {
    var po_id = $('#po_id').val();
    console.log('PO ID:', po_id);

    $.ajax({
        type: 'POST',
        url: '/get_po_fabric_lists/',
        data: {
            'po_id': po_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        success: function (data) { 
            // var fabricDropdown = $('#fabric_id');
            var poQuantityInput = $('#poid_quantity');
            var txIdInput = $('#tx_id'); 
            var tmPoIdInput = $('#tm_po_id');
            // var prd = $('#prd');

            // Clear previous options and values
            // fabricDropdown.empty().append('<option value="">Select</option>');
            poQuantityInput.val('');
            txIdInput.val('');
            tmPoIdInput.val('');
            // prd.val('');
 
            if (data.length > 0) {
                // data.forEach(function (po) {
                //     fabricDropdown.append('<option value="' + po.id + '" data-quantity="' + po.po_quantity + 
                //                          '" data-txid="' + po.tx_id + '" data-tmpoid="' + po.tm_po_id + '">' + po.name + '</option>');
                // });

                // Set default values from the first item 
                let firstOption = data[0];
                if (firstOption) {
                    poQuantityInput.val(firstOption.name + " - " + firstOption.po_quantity);

                    // poQuantityInput.val(firstOption.po_quantity);
                    txIdInput.val(firstOption.tx_id);
                    tmPoIdInput.val(firstOption.tm_po_id);
                    // prd.val(firstOption.name);
                }
            }
        },
        error: function (xhr, status, error) {
            console.error('Error loading PO fabric list:', error);
        }
    });
}





// When fabric is selected, update PO quantity, tx_id, and tm_po_id fields
$('#fabric_id').on('change', function () {
    var selectedOption = $(this).find(':selected');
    var quantity = selectedOption.data('quantity') || 0;
    var txId = selectedOption.data('txid') || '';
    var tmPoId = selectedOption.data('tmpoid') || '';

    $('#po_quantity').val(quantity);
    $('#tx_id').val(txId);
    $('#tm_po_id').val(tmPoId);
});



// ``````````````````````````````````````````````````````
    


$('#add_new').on('submit', function (e) {
    e.preventDefault(); // Prevent default form submission
    console.log("Submit button clicked"); // Debugging

    var TableData = storeTblValues();
    console.log('tbl-data:', TableData);

    if (TableData.length === 0) {
        notifier.show(
            'Error!',
            'Table is empty. Please insert the program details.',
            'danger', // ❌ Fix: Changed 'success' to 'danger' for error messages
            "{% static 'assets/images/notification/high_priority-48.png' %}",
            4000
        );
        return;
    }

    if (confirm("Are you sure you want to save?")) {
        TableData = JSON.stringify(TableData);
        var mdata = new FormData(this);
        mdata.append('chemical_data', TableData);

        var lot_no = $('#lot_no').val();
        console.log('lot-no:',lot_no);  
        var totalQty = $('#qty_total_placeholder').text();
        var subTotal = $('#sub_total_placeholder').text();
        var taxTotal = $('#tax_placeholder').text();
        var roundOff = $('#round_off').text();
        var totalPayable = $('#total_payable').text();

        // Append total values to FormData
        mdata.append('total_quantity', totalQty);
        mdata.append('sub_total', subTotal);
        mdata.append('tax_total', taxTotal);
        mdata.append('round_off', roundOff);
        mdata.append('total_payable', totalPayable);
        mdata.append('lot_no', lot_no);



        $.ajax({
            type: "POST",
            url: "/add-knitting-program/",
            data: mdata,
            processData: false,
            contentType: false,
            beforeSend: function () {
                console.log("Sending AJAX request...");
                $('#submit').attr('disabled', true).text('Processing...');
            },
            success: function (data) {
                console.log("Server Response:", data);

                $('#submit').attr('disabled', false).text('Save');

                if (data.status === 'success') {  // ✅ Fix: Check `data.status` instead of `status`
                    notifier.show(
                        'Well Done!',
                        'Knitting program added successfully!',
                        'success',
                        "{% static 'assets/images/notification/ok-48.png' %}",
                        4000
                    );
                    $('#add_new').trigger('reset');  
                    $('#supplier_id').val('').trigger("change");
                    $('#fabric_id').val('').trigger("change");
                    $('#count').val('').trigger("change");
                    $('#gauge').val('').trigger("change");
                    $('#tex').val('').trigger("change");
                    $('#lot_no').val('');
                    $('#po_number').val('');

                    $('#knittingtable tbody').empty();
                    // $('#summaryTable tbody').empty();
                    // location.reload(); // Uncomment if you want to refresh the page
                
                }
                
                else {
                    $('#material_type_error').text(data.message);

                    notifier.show(
                        'Error!',
                        data.message || 'Failed to add Knitting program.', // ✅ Fix: Display the actual error message
                        'danger',
                        "{% static 'assets/images/notification/high_priority-48.png' %}",
                        4000
                    );
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log("AJAX Error:", textStatus, errorThrown);
                notifier.show(
                    'Error!',
                    'Error adding data: ' + errorThrown,  // ✅ Fix: Show specific error message
                    'danger',
                    "{% static 'assets/images/notification/high_priority-48.png' %}",
                    4000
                );
                $('#submit').attr('disabled', false).text('Save');
            }
        });
    }
});



// else {
//                     // if (data.message && data.message.includes('Yarn or Grey Fabric')) {
//                     //     $('#material_type_error').text(data.message);
//                     // } else {
//                         $('#material_type_error').text(data.message);

//                         notifier.show(
//                             'Error!',
//                             data.message || 'Failed to add Knitting program.',
//                             'danger',
//                             "{% static 'assets/images/notification/high_priority-48.png' %}",
//                             4000
//                         );
//                     }
//                 } 

function storeTblValues() {
    var TableData = [];
    $('#knittingtable tbody tr').each(function(row, tr) {
    console.log("Checking row:", $(tr).html()); // Debugging

    var product_id = $(tr).find("td#product_id span").text().trim(); // ✅ Using ID selector for accuracy

    console.log("Extracted product_id:", product_id); // Debugging

    if (!product_id) {
        console.log("⚠️ Missing product_id, skipping row...");
        return; // Skip this row if no product_id
    }

    TableData.push({
        "product_id": product_id,
        "product_name": $(tr).find('td:eq(1)').text().trim(),
        "gauge": $(tr).find('td:eq(2)').text().trim(),
        "tex": $(tr).find('td:eq(3)').text().trim(), 
        "gsm": $(tr).find('td:eq(4)').text().trim(),
        "dia": $(tr).find('td:eq(5)').text().trim(),
        "rolls": $(tr).find('td:eq(6)').text().trim(),
        "wt_per_roll": $(tr).find('td:eq(7)').text().trim(),
        "quantity": $(tr).find('td:eq(8)').text().trim(),
        // "rate": $(tr).find('td:eq(10)').text().trim(),
        // "total_amount": $(tr).find('td:eq(11)').text().trim(),
        "count_id": $(tr).find('td:eq(10)').text().trim(),
        "gauge_id": $(tr).find('td:eq(11)').text().trim(),
        "tex_id": $(tr).find('td:eq(12)').text().trim(),
        "tm_po_id": $(tr).find('td:eq(13)').text().trim(),
        "dia_id": $(tr).find('td:eq(14)').text().trim(),
        // "dia_id": $(tr).find('td:eq(4)').text().trim()
    });
});



    console.log('Store Table Values:', TableData);
    return TableData;
}



// ``````````````````````````````````````````````````````````````````````````````````````````````````````````````````````

const loadedItemsMap = {};



let rowCounter = 0; // Initialize row counter
 


// function addRow() {   
//     // if (!fabric_id || !count || !gauge || !tex || !gsm || !dia || !rolls || !wt_per_roll || !quantity || !rate || !total_amount || !tx_id || !tm_po_id) {
//     //     alert("All fields are required. Please fill in all fields before adding a row.");
//     //     return; // Stop execution if any field is empty
//     // }
//     var productSelect = $("#fabric_id");
//     var productId = productSelect.val();
//     var productText = productSelect.find("option:selected").text();

//     var count = $("#count option:selected").text();
//     var countId = $("#count").val();

//     var gauge = $("#gauge option:selected").text();
//     var gaugeId = $("#gauge").val();

//     var tex = $("#tex option:selected").text();
//     var texId = $("#tex").val();

//     var gsm = $("#gsm").val();
//     // var dia = $("#dia").val();

//     var dia = $("#dia option:selected").text();
//     var diaId = $("#dia").val();

//     var rolls = $("#rolls").val();
//     var wt_per_roll = $("#wt_per_roll").val();
//     var quantity = $("#quantity").val();
//     // var rate = $("#rate").val();
//     // var total_amount = $("#total_amount").val();
//     var tx_id = $("#tx_id").val() || 0;
//     var tm_po_id = $("#tm_po_id").val() || 0;

//     // // Validate fields before adding the row
//     if (!productId || !countId || !gaugeId || !texId || !gsm || !dia || !rolls || !wt_per_roll || !quantity ) {
//         alert("All fields are required. Please fill in all fields before adding a row.");
//         return; // Stop execution if any field is empty
//     }

//     var tableBody = $("#knittingtable tbody");
// // <td class="text-end">${rate}</td>

// //             <td class="text-end">${total_amount}</td>
//     var newRow = `
//         <tr>
//             <td class="text-start">${count}</td>
//             <td class="text-start">${productText}</td>
//             <td class="text-end">${gauge}</td>
//             <td class="text-end">${tex}</td>
//             <td class="text-end">${gsm}</td>
//             <td class="text-end">${dia}</td>
//             <td class="text-end">${rolls}</td>
//             <td class="text-end">${wt_per_roll}</td>
//             <td class="text-end">${quantity}</td> 
            
//             <td id='product_id' style="display:none"><span>${productId}</span></td> 
            
//             <td id='count_id' style="display:none"><span>${countId}</span></td> 
//             <td id='gauge_id' style="display:none"><span>${gaugeId}</span></td> 
//             <td id='tex_id' style="display:none"><span>${texId}</span></td> 
//             <td id='tm_po_id' style="display:none"><span>${tm_po_id}</span></td> 
//             <td id='tm_po_id' style="display:none"><span>${tm_po_id}</span></td> 
//             <td id='dia_id' style="display:none"><span>${diaId}</span></td> 

//             <td>
//                 <button class="btn btn-xs btn-primary" type="button" onclick="editRow(this)">
//                     <i class="feather icon-edit"></i>
//                 </button>
//                 <button class="btn btn-xs btn-danger" type="button" onclick="removeRow(this)">
//                     <i class="feather icon-trash-2"></i>
//                 </button>
//             </td>
//         </tr>
//     `;

//     tableBody.append(newRow);
//     // calculateTotalValue();
//     resetFields();
// }

function addRow() {
    var productSelect = $("#fabric_id");
    var productId = productSelect.val();
    var productText = productSelect.find("option:selected").text();

    var count = $("#count option:selected").text();
    var countId = $("#count").val();

    var gauge = $("#gauge option:selected").text();
    var gaugeId = $("#gauge").val();

    var tex = $("#tex option:selected").text();
    var texId = $("#tex").val();

    var gsm = $("#gsm").val();
    var dia = $("#dia option:selected").text();
    var diaId = $("#dia").val();

    var rolls = parseFloat($("#rolls").val());
    var wt_per_roll = parseFloat($("#wt_per_roll").val());
    var quantity = parseFloat($("#quantity").val());
    var tx_id = $("#tx_id").val() || 0;
    var tm_po_id = $("#tm_po_id").val() || 0;

    if (!productId || !countId || !gaugeId || !texId || !gsm || !dia || !rolls || !wt_per_roll || !quantity) {
        alert("All fields are required. Please fill in all fields before adding a row.");
        return;
    }

    var tableBody = $("#knittingtable tbody");
    var existingRow = null;

    // Check for existing row
    tableBody.find("tr").each(function () {
        var $row = $(this);
        var existingProductId = $row.find("td#product_id span").text();
        var existingCountId = $row.find("td#count_id span").text();
        var existingDiaId = $row.find("td#dia_id span").text();

        if (existingProductId == productId && existingCountId == countId && existingDiaId == diaId) {
            existingRow = $row;
            return false; // break loop
        }
    });

    if (existingRow) {
        // Update existing row
        var oldRolls = parseFloat(existingRow.find("td:nth-child(7)").text());
        var oldWt = parseFloat(existingRow.find("td:nth-child(8)").text());
        var oldQty = parseFloat(existingRow.find("td:nth-child(9)").text());

        var newRolls = oldRolls + rolls;
        var newWt = oldWt + wt_per_roll;
        var newQty = oldQty + quantity;

        existingRow.find("td:nth-child(7)").text(newRolls.toFixed(2));
        existingRow.find("td:nth-child(8)").text(newWt.toFixed(2));
        existingRow.find("td:nth-child(9)").text(newQty.toFixed(2));
    } else {
        // Append new row
        var newRow = `
            <tr>
                <td class="text-start">${count}</td>
                <td class="text-start">${productText}</td>
                <td class="text-end">${gauge}</td>
                <td class="text-end">${tex}</td>
                <td class="text-end">${gsm}</td>
                <td class="text-end">${dia}</td>
                <td class="text-end">${rolls}</td>
                <td class="text-end">${wt_per_roll}</td>
                <td class="text-end">${quantity}</td> 
                <td id='product_id' style="display:none"><span>${productId}</span></td> 
                <td id='count_id' style="display:none"><span>${countId}</span></td> 
                <td id='gauge_id' style="display:none"><span>${gaugeId}</span></td> 
                <td id='tex_id' style="display:none"><span>${texId}</span></td> 
                <td id='tm_po_id' style="display:none"><span>${tm_po_id}</span></td> 
                <td id='dia_id' style="display:none"><span>${diaId}</span></td> 
                <td>
                    <button class="btn btn-xs btn-primary" type="button" onclick="editRow(this)">
                        <i class="feather icon-edit"></i>
                    </button>
                    <button class="btn btn-xs btn-danger" type="button" onclick="removeRow(this)">
                        <i class="feather icon-trash-2"></i>
                    </button>
                </td>
            </tr>
        `;
        tableBody.append(newRow);
    }

    updateFooter();
    resetFields();
}


// function addRow() {
//     var productSelect = $("#fabric_id");
//     var productId = productSelect.val();
//     var productText = productSelect.find("option:selected").text();

//     var count = $("#count option:selected").text();
//     var countId = $("#count").val();

//     var gauge = $("#gauge option:selected").text();
//     var gaugeId = $("#gauge").val();

//     var tex = $("#tex option:selected").text();
//     var texId = $("#tex").val();

//     var gsm = $("#gsm").val();
//     var dia = $("#dia option:selected").text();
//     var diaId = $("#dia").val();

//     var rolls = $("#rolls").val();
//     var wt_per_roll = $("#wt_per_roll").val();
//     var quantity = $("#quantity").val();
//     var tx_id = $("#tx_id").val() || 0;
//     var tm_po_id = $("#tm_po_id").val() || 0;

//     // Validate fields before adding the row
//     if (!productId || !countId || !gaugeId || !texId || !gsm || !dia || !rolls || !wt_per_roll || !quantity) {
//         alert("All fields are required. Please fill in all fields before adding a row.");
//         return; // Stop execution if any field is empty
//     }

//     var tableBody = $("#knittingtable tbody");

//     var newRow = `
//         <tr>
//             <td class="text-start">${count}</td>
//             <td class="text-start">${productText}</td>
//             <td class="text-end">${gauge}</td>
//             <td class="text-end">${tex}</td>
//             <td class="text-end">${gsm}</td>
//             <td class="text-end">${dia}</td>
//             <td class="text-end">${rolls}</td>
//             <td class="text-end">${wt_per_roll}</td>
//             <td class="text-end">${quantity}</td> 
//             <td id='product_id' style="display:none"><span>${productId}</span></td> 
//             <td id='count_id' style="display:none"><span>${countId}</span></td> 
//             <td id='gauge_id' style="display:none"><span>${gaugeId}</span></td> 
//             <td id='tex_id' style="display:none"><span>${texId}</span></td> 
//             <td id='tm_po_id' style="display:none"><span>${tm_po_id}</span></td> 
//             <td id='dia_id' style="display:none"><span>${diaId}</span></td> 
//             <td>
//                 <button class="btn btn-xs btn-primary" type="button" onclick="editRow(this)">
//                     <i class="feather icon-edit"></i>
//                 </button>
//                 <button class="btn btn-xs btn-danger" type="button" onclick="removeRow(this)">
//                     <i class="feather icon-trash-2"></i>
//                 </button>
//             </td>
//         </tr>
//     `;

//     tableBody.append(newRow);
    
//     // Update footer after adding the row
//     updateFooter();
    
//     // Reset fields (if required)
//     resetFields();
// }

function updateFooter() {
    var totalRolls = 0;
    var totalQuantity = 0;

    // Loop through all rows in the table
    $("#knittingtable tbody tr").each(function() {
        var rolls = parseFloat($(this).find("td:eq(6)").text()) || 0;
        var quantity = parseFloat($(this).find("td:eq(8)").text()) || 0;

        totalRolls += rolls;
        totalQuantity += quantity;
    });

    // Update the footer cells
    $("#sum_rolls").text(totalRolls.toFixed(2));
    $("#sum_quantity").text(totalQuantity.toFixed(2));
}



function calculateTotalValue() {
    let totalQuantity = 0;
    let subTotal = 0;
    let totalTax = 0;
    let taxSummary = {}; 

    // Tax rate as a percentage 
    const taxRate = 5;

    // Iterate over each row in the table to calculate totals
    $('#knittingtable tbody > tr').each(function() {
        // Fetch values from each cell
        const quantity = parseInt($(this).find('td:eq(8)').text()) || 0; // Quantity
        const rate = parseFloat($(this).find('td:eq(10)').text()) || 0; // Rate
        const amount = parseFloat($(this).find('td:eq(11)').text()) || 0; // Amount
       
        // Calculate tax amount as 5% of the amount
        const taxAmount = (amount * taxRate) / 100; 

        // Update totals 
        totalQuantity += quantity;
        subTotal += amount;
        totalTax += taxAmount;  // Adding calculated tax to total tax

        // Update tax summary (if any tax logic is needed)
        if (taxAmount > 0) {
            if (!taxSummary[taxRate]) {
                taxSummary[taxRate] = { sgst: 0, cgst: 0, igst: 0, totalTax: 0 };
            }
            // Assuming SGST and CGST split equally for simplicity
            const sgstAmount = taxAmount / 2;
            taxSummary[taxRate].sgst += sgstAmount;
            taxSummary[taxRate].cgst += sgstAmount;
            taxSummary[taxRate].totalTax += taxAmount;
        }
    });

    // Calculate round-off value and grand total
    const totalAmount = subTotal + totalTax;
    const roundOff = totalAmount - Math.floor(totalAmount);  // Get the decimal part

    // Apply the round-off logic (if >= 0.5, round up; if < 0.5, round down)
    const adjustedRoundOff = roundOff >= 0.5 ? (1 - roundOff) : -roundOff;

    const grandTotal = (subTotal + totalTax + adjustedRoundOff).toFixed(2);  // Add adjusted round-off to grand total

    // Display totals 
    $('#qty_total_placeholder').text(totalQuantity);
    $('#sub_total_placeholder').text(subTotal.toFixed(2)); 
    $('#tax_placeholder').text(totalTax.toFixed(2));
    $('#round_off').text(adjustedRoundOff.toFixed(2));
    $('#total_payable').text(grandTotal);

    // Update tax summary table (if needed)
    $('#tax_summary_body').empty();
    for (const [rate, data] of Object.entries(taxSummary)) {
        $('#tax_summary_body').append(`
            <tr>
                <td>${rate}%</td>
                <td>${data.sgst.toFixed(2)}</td>
                <td>${data.cgst.toFixed(2)}</td>
                <td>${data.igst ? data.igst.toFixed(2) : '0.00'}</td>
                <td>${data.totalTax.toFixed(2)}</td>
            </tr>
        `);
    }
}




 
var editIndex = -1; // Track the row being edited

function editRow(mrow) {
    // Get the row index
    editIndex = $(mrow).closest('tr').index();

    // Fetch values from the selected table row
    var row = $(mrow).closest('tr');

    var count = row.find("td:eq(0)").text().trim();
    var fabric = row.find("#product_id span").text().trim();  // Corrected fabric ID
    var gauge = row.find("td:eq(2)").text().trim();
    var tex = row.find("td:eq(3)").text().trim();
    var dia = row.find("td:eq(4)").text().trim();
    var gsm = row.find("td:eq(5)").text().trim();
    var rolls = row.find("td:eq(6)").text().trim();
    var wt_per_roll = row.find("td:eq(7)").text().trim();
    var quantity = row.find("td:eq(8)").text().trim();
    var rate = row.find("td:eq(10)").text().trim();
    var amount = row.find("td:eq(11)").text().trim();

    // Fetch hidden field values correctly
    var countId = row.find("#count_id span").text().trim();
    var gaugeId = row.find("#gauge_id span").text().trim();
    var texId = row.find("#tex_id span").text().trim();
    var tm_po_id = row.find("#tm_po_id span").text().trim();
    var tx_id = row.find("#tx_id span").text().trim();
    var diaId = row.find("#dia_id span").text().trim();

    // Set the form fields with values from the table row
    $("#count").val(countId).trigger("change");
    $("#fabric_id").val(fabric).trigger("change");
    $("#gauge").val(gaugeId).trigger("change");
    $("#tex").val(texId).trigger("change");
    
    $("#dia").val(dia);
    $("#gsm").val(gsm);
    $("#rolls").val(rolls);
    $("#wt_per_roll").val(wt_per_roll);
    $("#quantity").val(quantity);
    $("#rate").val(rate);
    $("#total_amount").val(amount);

    // Also update hidden fields
    $("#tx_id").val(tx_id);
    $("#tm_po_id").val(tm_po_id);

        $(mrow).closest('tr').remove();
        calculateTotalValue();


}


function resetFields() {

    document.getElementById('dia').value = ''; 
    $('#dia').val('').trigger("change");
    // $('#fabric_id').val('').trigger("change");
    // $('#count').val('').trigger("change");
    // $('#gauge').val('').trigger("change");
    // $('#tex').val('').trigger("change");
    // document.getElementById('gauge').value = ''; 
    // document.getElementById('tex').value = ''; 
    document.getElementById('rolls').value = ''; 
    document.getElementById('wt_per_roll').value = ''; 
    document.getElementById('quantity').value = ''; 
    document.getElementById('rate').value = ''; 
    document.getElementById('total_amount').value = ''; 
}



function removeRow(button) {
    // Remove the row
    $(button).closest('tr').remove();
    calculateTotalValue();
    // Update totals after removing the row
}
 

$('.single-select').select2(); 

            // Get current date and time
    const currentDate = new Date();
    const currentDateString = currentDate.toISOString().slice(0, 10); // Format as YYYY-MM-DD
    const currentTimeString = currentDate.toTimeString().slice(0, 5); // Format as HH:MM

    // Set default values for date and time fields
    document.getElementById('program_date').value = currentDateString;
    // document.getElementById('purchase_time').value = currentTimeString;



</script>