
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}

<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title"> <!-- mill to knitting delivery -->
                                            <h4 class="m-b-10">Cutting Program  </h4> 
                                        </div>
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Program</a></li>
                                            <li class="breadcrumb-item"><a href="/cutting-program"> Cutting Program</a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>

                                    <div class="card">

                                        <div class="card-body row"> 
                                            <div class="col-sm-12">
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <form id="add_new" >
                                                            {% csrf_token %}
                                                            <div class="row ">
                                                                
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="delivery_no" class="form-lebel">Program No.</label>
                                                                    <input type="text" class="form-control" value="{{prg_number}}" readonly>
                                                                </div>  
                                                                
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="order_date" class="form-label">Program Date</label>
                                                                    <input class="form-control" type="date" name="delivery_date" id="delivery_date" required>
                                                                </div>

                                                                <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">Party </label>
                                                                    <select id="party_id" name="party_id" class="form-control form-select single-select" onchange="LoadProgram()" >
                                                                        <option value="">Select</option>
                                                                        {% for k in party %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %} 
                                                                    </select> 
                                                                </div>
                                                              
                                                                
                                                                <div class="col-md-6 mt-2">
                                                                    <label for="order_date" class="form-label">Remarks</label>
                                                                    <input class="form-control" type="text" name="remarks" id="remarks" required>
                                                                </div>


                                                             


                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Quality</label>
                                                                    <select id="quality_id" name="quality_id" class="form-control single-select" onchange="LoadStyle()">
                                                                        <!-- <option value="">Select</option> -->
                                                                        {% for k in quality %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Style</label>
                                                                    <select id="style_id" name="style_id" class="form-control single-select" >
                                                                        <!-- <option value="">Select</option> -->
                                                                        {% for k in style %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Size</label>
                                                                    <select id="size_id" name="size_id" class="form-control single-select" >
                                                                        <!-- <option value="">Select</option> -->
                                                                        {% for k in size %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Color</label>
                                                                    <select id="color_id" name="color_id" class="form-control single-select" >
                                                                        <!-- <option value="">Select</option> -->
                                                                        {% for k in color %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Quantity</label>
                                                                    
                                                                    <input type="number" class="form-control" id="quantity" name="quantity" value="1">
                                                                </div>
                                                          
                                                                <div class="col-md-2 mt-4">
                                                                    <button class="btn btn-primary mt-3" type="button" onclick="addManualRow()">+ Add</button>

                                                                </div>

                                                            </div>
                                                            
                    
                     
                                                    
                                                    </div> 

                                                
                                                    <div class="card-body">
                                                        <div class="table-responsive table-desi">

                                                            <table id="purchaseTable" class="table table-bordered">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Size</th>
                                                                        <th>Color</th>
                                                                        <th>Quantity (kg)</th>
                                                                        <th style="display: none;">Size id</th>
                                                                        <th style="display: none;">Color id</th>
                                                                        <th>Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody></tbody> 
                                                            </table>

                                                        
                                                        
                                                        </div>
                                                    </div>

                                                    <div class="row">
                    
                                                        <div class="col-md-8">
                                                            <div class="" style="text-align: center;" >
                                                                <button type="button" id="cancel" class="btn btn-danger" onclick="history.back()">Close</button>
                                                                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                                                                <button type="submit" id="submit" class="btn btn-primary">Save</button>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4"> 

                                                        <div class="">            
                                                            <table id="summaryTable" class="table table-striped table-bordered w-100">
                                                                <thead>
                                                                    <tr>
                                                                        <th colspan="2">Summary Table</th>
                                                                    </tr> 
                                                                </thead>
                                                                <tbody>
                                                                    <tr>
                                                                        <td> Total Quantity</td>
                                                                        <td align="end" colspan="2"  style="background-color: #428bca;" id="qty_total_placeholder">0</td>
                                                                    </tr>
                                                            
                                                                    
                                                                </tbody>
                                                            </table>     
                                                        </div>

                                                    </div>
                                             
                                                    
                                            
                                            </div>

                                               
                                            </div>
                                        
                                        </form>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .no-border-input {
            border: none;
            background: transparent;
            text-align: center;
            width: 100%;
            color: inherit; /* Matches text color to the row */
        }

        .no-border-input:focus {
            outline: none;
        }

    </style>
</div>
{% include 'includes/footer.html' %}


<script>


    

function LoadStyle() {
    var quality_id = $('#quality_id').val(); 
    console.log('Quality-ID:', quality_id); // Debugging output

    if (!quality_id) {
        console.warn("No Quality ID selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

    $.ajax({
        type: 'POST',
        url: '/get_quality_style_list/',
        data: {
            'quality_id': quality_id,
            'csrfmiddlewaretoken': csrfToken 
        },
        dataType: 'json',

        success: function(data) {
            console.log('Received Data:', data); // Debugging output

            // Clear and add default "Select" option
            $('#style_id').empty().append('');
            $('#size_id').empty().append('');
            // $('#color_id').empty().append('<option value="">Select Color</option>');

            // Populate Styles
            if (data.style && Array.isArray(data.style)) {
                data.style.forEach(function(item) {
                    $('#style_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }

            if (data.size && Array.isArray(data.size)) {
                data.size.forEach(function(item) {
                    $('#size_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }

          
        },

        error: function(xhr, status, error) {
            console.error('Error loading fabric details:', error);
        } 
    });
}


</script>
<script>


 



// // ``````````````````````````````````````````````````````````````````````````````````````````````````````````````````````



const loadedItemsMap = {};



let rowCounter = 0; // Initialize row counter
// function addRow(product, count, gauge, tex, gsm, dia, rolls, wt_per_roll, rate,
//                 quantity, amount, taxValue, id, tm_id, tm_po_id, productId) {

// function addRow(product, count, gauge, tex, gsm, dia, rolls, wt_per_roll, rate,
//                 quantity, amount, taxValue, id, tm_id, tm_po_id, productId) {



// function addRow(product, count, gauge, tex, gsm, dia, rolls, wt_per_roll, quantity, amount, taxValue, id, tm_id, tm_po_id, productId){


function storeTblValues() {
    var TableData = [];

    $('#purchaseTable tbody tr').each(function (index) {
        // Extract values from table row
        var size = $(this).find('td:eq(0)').text().trim();  // Size name
        var color = $(this).find('td:eq(1)').text().trim(); // Color name
        var quantity = parseFloat($(this).find('.quantity').val()) || 0; // Get quantity from input field

        // Ensure hidden input values exist
        var sizeId = $(this).find('.size_id').val() ? $(this).find('.size_id').val().trim() : "";
        var colorId = $(this).find('.color_id').val() ? $(this).find('.color_id').val().trim() : "";

        // ✅ Validate required fields
        if (size && color && quantity > 0) {
            TableData.push({
                "size": size,
                "color": color,
                "quantity": quantity,
                "size_id": sizeId,
                "color_id": colorId
            });
        } else {
            console.error(`Row ${index + 1} is missing required data:`, {
                size: size || "Missing",
                color: color || "Missing",
                quantity: quantity || "Missing"
            });
        }
    });

    // Calculate total after storing values
    calculateTotalValue();

    console.log('TABLE-DATA:', TableData);
    return TableData;
}


// ```````````````````````````````````````````````           11-03-2025              ```````````````````````````````````````````````



function addManualRow() {
    console.log("Manual row function triggered");

    const quantity = $("#quantity").val() || 1; // Default to 1 if empty
    let selectedSizes = $("#size_id").val();
    let selectedColors = $("#color_id").val();

    // ✅ Convert to array (handles both single and multi-select cases)
    selectedSizes = Array.isArray(selectedSizes) ? selectedSizes : [selectedSizes];
    selectedColors = Array.isArray(selectedColors) ? selectedColors : [selectedColors];

    if (!selectedSizes[0] || !selectedColors[0]) {
        notifier.show(
            'Error!', 
            'Please select at least one size and one color.', 
            'danger', 
            "{% static 'assets/images/notification/high_priority-48.png' %}", 
            4000
        ); 
        return;
    }

    selectedSizes.forEach(sizeId => {
        const sizeName = $("#size_id option[value='" + sizeId + "']").text();

        selectedColors.forEach(colorId => {
            const colorName = $("#color_id option[value='" + colorId + "']").text();

            // ✅ Check for duplicates before adding a new row
            if (!isRowDuplicate(sizeId, colorId)) { 
                addRow(sizeName, colorName, sizeId, colorId, quantity);
            } else {
                notifier.show(
                    'Error!', 
                    `Size: ${sizeName} and Color: ${colorName} already exists in the table.`, 
                    'danger', 
                    "{% static 'assets/images/notification/high_priority-48.png' %}", 
                    4000
                ); 
            }
        });
    });
}


function isRowDuplicate(sizeId, colorId) {
    let isDuplicate = false;

    $("#purchaseTable tbody tr").each(function () {
        const existingSizeId = $(this).find(".size_id").val();
        const existingColorId = $(this).find(".color_id").val();

        if (existingSizeId === sizeId && existingColorId === colorId) {
            isDuplicate = true;
            return false; // Exit loop early if found
        }
    });

    return isDuplicate;
}



function addRow(size, color, sizeId, colorId, quantity) {
    const tableBody = document.querySelector("#purchaseTable tbody");
    if (!tableBody) {
        console.error("Table body not found!");
        return;
    }

    const newRow = document.createElement("tr");

    newRow.innerHTML = `
        <td>${size}</td>
        <td>${color}</td>
        <td><input type="number" class="quantity no-border-input" value="${quantity}" min="1"></td>
        <td style="display:none"><input type="hidden" class="size_id" value="${sizeId}"></td>
        <td style="display:none"><input type="hidden" class="color_id" value="${colorId}"></td>
        <td>
            <button class="btn btn-primary btn-xs edit-row"><i class="feather icon-edit"></i></button>
            <button class="btn btn-danger btn-xs remove-row"><i class="feather icon-trash-2"></i></button>
        </td>
    `;

    tableBody.appendChild(newRow);

    // Clear selected colors after adding row
    $('#color_id').val('').trigger("change");
    $('#quantity').val('1');
    calculateTotalValue();
    // Attach event to remove row
    newRow.querySelector(".remove-row").addEventListener("click", function () {
        newRow.remove();
    });

    // Attach event to edit row
    newRow.querySelector(".edit-row").addEventListener("click", function () {
        editRow(newRow);
    });
}

// Function to handle editing
function editRow(row) {
    const size = row.querySelector("td:nth-child(1)").innerText.trim();
    const color = row.querySelector("td:nth-child(2)").innerText.trim();
    const quantity = row.querySelector(".quantity").value;
    const sizeId = row.querySelector(".size_id").value;
    const colorId = row.querySelector(".color_id").value;

    // Populate form fields
    $("#size_id").val([sizeId]).trigger("change"); // Select the size
    $("#color_id").val([colorId]).trigger("change"); // Select the color
    $("#quantity").val(quantity); // Set quantity

    // Remove the row from the table
    row.remove();
}



// Function to calculate row-wise amount dynamically
function calculateRow(event) {
    const rowId = event.target.dataset.rowId;
    const row = document.querySelector(`tr[data-row-id="${rowId}"]`);

    const rate = parseFloat(row.querySelector('.rate').value) || 0;
    const quantity = parseFloat(row.querySelector('td:eq(2)').text()) || 0; 

    const amount = (rate * quantity).toFixed(2);
    row.querySelector('.amount').textContent = amount;

    calculateTotalValue();
}





function calculateTotalValue() {
    let totalQuantity = 0;
    let subTotal = 0;

    // Iterate over each row in the table
    $('#purchaseTable tbody > tr').each(function() {
        // Fetch values from each cell
        const quantity = parseFloat($(this).find('.quantity').val()) || 0; // Get quantity from input field
        // const gross_wt = parseFloat($(this).find('.gross_wt').val()) || 0; // Assuming you have a 'gross_wt' input field

        // Update totals
        totalQuantity += quantity;
        // subTotal += gross_wt;
    });

    // Display totals
    $('#qty_total_placeholder').text(totalQuantity);
    // $('#sub_total_placeholder').text(subTotal.toFixed(2));
}




// `````````````````````````````````````````````````````````````````````




// ```````````````````````````````````````````````````````


$('#add_new').on('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    console.log("Submit button clicked"); // Debugging

    var TableData = storeTblValues();
    console.log('tbl-data:', TableData);

    if (TableData.length === 0) {
        notifier.show(
            'Error!', 
            'Table is empty. Please insert the program details.', 
            'success', 
            "{% static 'assets/images/notification/ok-48.png' %}", 
            4000
        ); 


        return;
    }

    if (confirm("Are you sure you want to save?")) {
        TableData = JSON.stringify(TableData); 
        var mdata = new FormData(this);
        mdata.append('cutting_data', TableData);
 
        var totalQty = $('#qty_total_placeholder').text();
      

        // Append total values to FormData
        mdata.append('total_quantity', totalQty);  // This is where total_quantity is added 
     

       

        $.ajax({
            type: "POST", 
            url: "/add-cutting-program/",
            data: mdata,
            processData: false,
            contentType: false,
            beforeSend: function() {
                console.log("Sending AJAX request...");
                $('#submit').attr('disabled', true).text('Processing...');
            },
       
            success: function(data) {
                console.log("Server Response:", data);
                $('#submit').attr('disabled', false).text('Save');

                if (data.status === 'yes') {  // ✅ Corrected
                    notifier.show( 
                        'Well Done!', 
                        data.message,  // ✅ Use dynamic message
                        'success', 
                        "{% static 'assets/images/notification/ok-48.png' %}", 
                        4000
                    ); 
                    $('#add_new').trigger('reset');
                    // location.reload();
                } else {
                    notifier.show(
                        'Error!', 
                        data.message || 'Failed To add',  // ✅ Handle potential missing message
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
                }
            },

            error: function(jqXHR, textStatus, errorThrown) {
                console.log("AJAX Error:", textStatus, errorThrown);
                notifier.show(
                        'Error!', 
                        'Error adding data', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
                // alert('Error Adding data');
                $('#submit').attr('disabled', false).text('Save');
            }
        });
    }
});


$('.single-select').select2(); 

            // Get current date and time
    const currentDate = new Date();
    const currentDateString = currentDate.toISOString().slice(0, 10); // Format as YYYY-MM-DD
    const currentTimeString = currentDate.toTimeString().slice(0, 5); // Format as HH:MM

    // Set default values for date and time fields
    document.getElementById('delivery_date').value = currentDateString;
    // document.getElementById('purchase_time').value = currentTimeString;



</script>