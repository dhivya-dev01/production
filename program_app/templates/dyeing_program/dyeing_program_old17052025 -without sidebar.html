
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}

<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row"> 
                            <div class="col-sm-12"> 
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title"> <!-- mill to knitting delivery -->
                                            <h4 class="m-b-10">Dyeing Program  </h4>
                                        </div>
                                        <ul class="breadcrumb"> 
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Program</a></li>
                                            <li class="breadcrumb-item"><a href="/dyeing-program"> Dyeing Program</a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>

                                    <div class="card">  

                                        <div class="card-body row"> 
                                            <form id="dyeingProgramForm">
                                                <div class="col-sm-12">
                                                    <div class="row"> 
                                                        {% csrf_token %}
                                                        <div class="col-md-12">
                                                            <div class="row ">
                                                            

                                                                <div class="col-md-2 mt-2">
                                                                    <label for="number" class="form-label">Program No.</label>
                                                                    <input type="text" class="form-control" id="delivery_number" value="{{prg_number}}" disabled>

                                                                </div>
                                                              
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="order_date" class="form-label">Program Date</label>
                                                                    <input class="form-control" type="date" name="program_date" id="program_date" required>
                                                                </div>

                                                                <div class="col-md-2 mt-2">
                                                                    <label class="form-label">Program Name</label>
                                                                    <!-- <input type="text" class="form-control" name="name" id="name" required> -->
                                                                        <input class="form-control" id="fabricName" dir="ltr" style="position: relative;width: 240px; vertical-align: top; background-color: transparent;" name="name" type="text">

                                                                </div>

                                                               
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">Party</label>
                                                                    <select id="party_id" name="party_id" class="form-control single-select" >
                                                                        <option value="">Select</option>
                                                                        {% for k in party %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %} 
                                                                    </select>  
                                                                </div> 
 
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="product_id" class="form-label">Lot </label>
                                                                    <select id="lot" name="lot" class="form-control single-select" onchange="LoadLotDetails()">
                                                                        <option value="">Select</option>
                                                                        {% for k in lot %}
                                                                        <option value="{{ k.id }}">{{ k.lot_no }}</option> 
                                                                        {% endfor %} 
                                                                    </select> 
                                                                </div> 
                                                                 
                                                               
                                                                <div class="col-md-4 mt-2">
                                                                    <label for="order_date" class="form-label">Remarks</label>
                                                                    <input class="form-control" type="hidden" name="lot_no" id="lot_no">
                                                                    <input class="form-control" type="hidden" name="lot_total_quantity" id="lot_total_quantity">
                                                              
                                                                    <textarea class="form-control" type="text" name="remarks" id="remarks" ></textarea>
                                                                </div>
                                                      
                                                                
                                                      
                    

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Fabric</label>
                                                                    <select id="fabric_id" name="fabric_id" class="form-control single-select">
                                                                        <option value="">Select</option>
                                                                        {% for k in fabric_program %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                                
                                                                <!-- Load Button -->
                                                                <div class="col-md-2 mt-5">
                                                                    <input type="hidden" id="edit_id" name="edit_id">
                                                                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                                                    <button type="button" id="update" class="btn btn-primary">+ Load</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                            
                                        </div>   
                                        

                                        <div class="col-md-12" id="tablesContainer">  
                                            <!-- Tables will be appended here --> 
                                        </div>

                                        <div class="" style="text-align: end;" >
                                            <button type="button" id="cancel" class="btn btn-danger" onclick="history.back()">Close</button>
                                            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                            <button type="button" id="saveButton" class="btn btn-primary">Save</button>

                                            <!-- <button type="submit" id="submit" class="btn btn-primary">Save</button> -->
                                        </div>

                                    </div> 
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'includes/footer.html' %}

<script>

$('.single-select').select2();




// function LoadColorTable() {
//     let $fabricDropdown = $("#fabric_id"),
//         selectedFabricId = $fabricDropdown.val(),
//         selectedFabricText = $fabricDropdown.find("option:selected").text();

//     if (!selectedFabricId) {
//         alert("Please select a fabric first.");
//         return;
//     }

//     // Fetch color and dia data from Django
//     $.get("{% url 'get_fabric_details' %}", { fabric_id: selectedFabricId }, function (response) {
//         if (!response.success) {
//             alert(response.message);
//             return;
//         }

//         let $tablesContainer = $("#tablesContainer"),
//             colors = response.colors,
//             diaValues = response.dia_values,
//             fabricDiaIds = response.fabric_dia_ids.map(String);

//         // Check if main table exists, otherwise create it
//         if ($("#mainTable").length === 0) {
//             let mainTable = `<div class="p-2">
//                 <h5>Fabric Details</h5>
//                 <table id="mainTable" class="table table-striped table-bordered w-100">
//                     <thead>
//                         <tr style="background-color: white; color: black;"> 
//                             <th rowspan="2">Fabric</th>
//                             <th rowspan="2">Color</th>
//                             ${diaValues.map(dia => {
//                                 let bgColor = "background-color: #eff3f6; color: black;";
//                                 return `<th colspan="2" style="${bgColor}">Dia ${dia.name}</th>`;
//                             }).join('')}
//                             <th colspan="2" style="background-color: #428bca; color: black; font-size:18px">Total</th>
//                         </tr>
//                         <tr style="background-color: white; color: black;">
//                             ${diaValues.map(dia => {
//                                 let bgColor = fabricDiaIds.includes(dia.id.toString()) ? "background-color: #eff3f6; color: black;" : "background-color: #eff3f6; color: black;";
//                                 return `<th style="${bgColor}">Rolls</th><th style="${bgColor}">Wt</th>`;
//                             }).join('')}
//                             <th>Rolls</th>
//                             <th>Wt</th>
//                         </tr>
//                     </thead>
//                     <tbody></tbody>
//                     <tfoot>
//                         <tr style="background-color: white; color: black;">
//                             <th colspan="2" style="background-color: black; color:white; text-align:center; font-size:18px">Total</th>
//                             ${diaValues.map(dia => {
//                                 let bgColor = "background-color: white; color: black;";
//                                 return `<th class="text-end totalDiaRolls" style="${bgColor}">0</th>
//                                         <th class="text-end totalDiaWt" style="${bgColor}">0</th>`;
//                             }).join('')}
//                             <th class="text-end totalTotalRolls">0</th>
//                             <th class="text-end totalTotalWt">0</th>
//                         </tr>
//                     </tfoot> 
//                 </table>
//             </div>`;
//             $tablesContainer.append(mainTable);
//         }

//         // Append new fabric data into the main table 
//         let $tableBody = $("#mainTable tbody"); 
//         colors.forEach(color => {
//             let diaData = diaValues.map(dia => {
//                 let isEditable = fabricDiaIds.includes(dia.id.toString());
//                 let bgColor = isEditable ? "background-color: white; color: black;" : "background-color: #c2c5c0; color: white;";
//                 let editableAttr = isEditable ? 'contenteditable="true"' : '';

//                 return `<td class="dia-rolls text-end" style="${bgColor}" ${editableAttr} data-dia-id="${dia.id}">0</td>
//                         <td class="dia-wt text-end" style="${bgColor}" ${editableAttr} data-dia-id="${dia.id}">0</td>`;
//             }).join('');
//             let newRow = `<tr style="background-color: white; color: black;">
//                 <td>
//                     ${selectedFabricText}
//                     <input type="hidden" name="fabric_id[]" value="${selectedFabricId}">
//                 </td>
//                 <td>
//                     ${color.name}
//                     <input type="hidden" name="color_id[]" value="${color.id}"> <!-- Ensure correct color_id is passed -->
//                 </td>
//                 ${diaData}
//                 <td class="total-rolls text-end">0</td> 
//                 <td class="total-wt text-end">0</td>
//               </tr>`;

//             $tableBody.append(newRow);
//         });

//         // Recalculate totals when user edits values
//         $("#mainTable").on("input", "[contenteditable='true']", function () {
//             let $cell = $(this);
//             let newValue = $cell.text().trim();

//             // Validate numeric input
//             if (isNaN(newValue) || newValue === "") {
//                 $cell.text("0");
//             }

//             calculateTotals("#mainTable");
//         });

//         calculateTotals("#mainTable");
//     }).fail(function () {
//         alert("Error fetching fabric details.");
//     });
// }



function LoadColorTable() {
    // Check if main table exists, otherwise create it


    let $fabricDropdown = $("#fabric_id"),
        selectedFabricId = $fabricDropdown.val(),
        selectedFabricText = $fabricDropdown.find("option:selected").text();

    if (!selectedFabricId) {
        alert("Please select a fabric first.");
        return;
    }

    // Fetch color and dia data from Django
    $.get("{% url 'get_fabric_details' %}", { fabric_id: selectedFabricId }, function (response) {
        if (!response.success) {
            alert(response.message);
            return;
        }

        let $tablesContainer = $("#tablesContainer"),
            colors = response.colors,
            diaValues = response.dia_values,
            fabricDiaIds = response.fabric_dia_ids.map(String);

        // Check if main table exists, otherwise create it
        if ($("#mainTable").length > 0) {
                $("#mainTable").closest(".p-2").remove();  // Clear old table when switching fabric  #f5a23e             <! // <table id="mainTable" class="table table-striped table-bordered w-100">

            }
        if ($("#mainTable").length === 0) {

            let mainTable = `<div class="p-2 dt-responsive table-responsive table-hover">
                <h5>Fabric Details</h5>
                    <table id="mainTable" class="table table-striped table-bordered nowrap w-100">

                    <thead>
                        <tr style="background-color: white; color: black;">
                            <th rowspan="2">Fabric</th>
                            <th rowspan="2">Color</th>
                            ${diaValues.map(dia => {
                                let bgColor = "background-color: #eff3f6; color: black;";
                                return `<th colspan="2" style="${bgColor}">Dia ${dia.name}</th>`;
                            }).join('')}
                            <th colspan="2" style="background-color: #31b01a; color: black;">Total</th>
                        </tr>
                        <tr style="background-color: white; color: black;">
                            ${diaValues.map(dia => {
                                let bgColor = fabricDiaIds.includes(dia.id.toString()) ? "background-color: white; color: black;" : "background-color: #cfcfcf; color: white;";
                                return `<th style="${bgColor}">Rolls</th><th style="${bgColor}">Wt</th>`;
                            }).join('')}
                            <th>Rolls</th>
                            <th>Wt</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr style="background-color: white; color: black;">
                            <th colspan="2">Total</th>
                            ${diaValues.map(dia => {
                                let bgColor = "background-color: white; color: black;";
                                return `<th class="text-end totalDiaRolls" style="${bgColor}">0</th>
                                        <th class="text-end totalDiaWt" style="${bgColor}">0</th>`;
                            }).join('')}
                            <th class="text-end totalTotalRolls">0</th>
                            <th class="text-end totalTotalWt">0</th>
                        </tr>
                    </tfoot>
                </table>
            </div>`;
            $tablesContainer.append(mainTable);
        }

        // Append new fabric data into the main table
        let $tableBody = $("#mainTable tbody"); 
        colors.forEach(color => {
            let diaData = diaValues.map(dia => {
                let isEditable = fabricDiaIds.includes(dia.id.toString());
                let bgColor = isEditable ? "background-color: white; color: black;" : "background-color: #cfcfcf; color: white;";
                let editableAttr = isEditable ? 'contenteditable="true"' : '';

                return `<td class="dia-rolls text-end" style="${bgColor}" ${editableAttr}  data-dia-id="${dia.id}"> </td>
                        <td class="dia-wt text-end" style="${bgColor}" ${editableAttr}  data-dia-id="${dia.id}"> </td>`;
            }).join('');

            let newRow = `<tr style="background-color: white; color: black;">
                            <td>
                                ${selectedFabricText}
                                <input type="hidden" name="fabric_id[]" value="${selectedFabricId}">

                                </td>
                            <td>
                                ${color.name}
                                <input type="hidden" name="color_id[]" value="${color.id}"> <!-- Ensure correct color_id is passed -->

                                
                                </td>
                            ${diaData}
                            <td class="total-rolls text-end">0</td> 
                            <td class="total-wt text-end">0</td>
                          </tr>`;
            $tableBody.append(newRow);
        });

        // Recalculate totals when user edits values
        $("#mainTable").on("input", "[contenteditable='true']", function () {
            let $cell = $(this);
            let newValue = $cell.text().trim();

            // Validate numeric input
            if (isNaN(newValue) || newValue === "") {
                $cell.text("0");
            }

            calculateTotals("#mainTable");
        }); 

        calculateTotals("#mainTable");
    }).fail(function () {
        alert("Error fetching fabric details.");
    });
}



//     let $fabricDropdown = $("#fabric_id"),
//         selectedFabricId = $fabricDropdown.val(),
//         selectedFabricText = $fabricDropdown.find("option:selected").text();

//     if (!selectedFabricId) {
//         alert("Please select a fabric first.");
//         return;
//     } 
 

//     // Fetch color and dia data from Django
//     $.get("{% url 'get_fabric_details' %}", { fabric_id: selectedFabricId }, function (response) {
//         if (!response.success) {
//             alert(response.message);
//             return;
//         }

//         let $tablesContainer = $("#tablesContainer"),
//             colors = response.colors,
//             diaValues = response.dia_values,
//             fabricDiaIds = response.fabric_dia_ids.map(String),
//             $tableBody = $("#mainTable tbody");

//         // 🔹 Check if the main table exists, otherwise create it
//         if ($("#mainTable").length === 0) {
//             let mainTable = `<div class="p-2 dt-responsive table-responsive table-hover">
//                 <h5>Fabric Details</h5>
//                 <table id="mainTable" class="table table-striped table-bordered nowrap w-100">
//                     <thead>
//                         <tr style="background-color: white; color: black;"> 
//                             <th rowspan="2">Fabric</th>
//                             <th rowspan="2">Color</th>
//                             ${diaValues.map(dia => {
//                                 return `<th colspan="2" style="background-color: #eff3f6; color: black;">Dia ${dia.name}</th>`;
//                             }).join('')}
//                             <th colspan="2" style="background-color: #428bca; color: black; font-size:18px">Total</th>
//                         </tr>
//                         <tr style="background-color: white; color: black;">
                           
//                              ${diaValues.map(dia => {
//                                 let bgColor = fabricDiaIds.includes(dia.id.toString()) ? "background-color: white; color: black;" : "background-color: grey; color: white;";
//                                 return `<th style="${bgColor}">Rolls</th><th style="${bgColor}">Wt</th>`;
//                             }).join('')}

//                             <th>Rolls</th>
//                             <th>Wt</th>
//                         </tr>
//                     </thead>
//                     <tbody></tbody>
//                     <tfoot>
//                         <tr style="background-color: white; color: black;">
//                             <th colspan="2" style="background-color: black; color:white; text-align:center; font-size:18px">Total</th>
//                             ${diaValues.map(() => {
//                                 return `<th class="text-end totalDiaRolls">0</th>
//                                         <th class="text-end totalDiaWt">0</th>`;
//                             }).join('')}
//                             <th class="text-end totalTotalRolls">0</th>
//                             <th class="text-end totalTotalWt">0</th>
//                         </tr>
//                     </tfoot> 
//                 </table>
//             </div>`;
//             $tablesContainer.append(mainTable);
//         }
//  // ${diaValues.map(dia => {
//     //     return `<th style="background-color: #eff3f6; color: black;">Rolls</th>
//     //             <th style="background-color: #eff3f6; color: black;">Wt</th>`;
//     // }).join('')}
//         // 🔹 Check if fabric_id already exists before adding
//         let fabricExists = false;
//         $("#mainTable tbody tr").each(function () {
//             let existingFabricId = $(this).find("input[name='fabric_id[]']").val();
//             if (existingFabricId === selectedFabricId) {
//                 fabricExists = true;
//                 return false;  // Exit loop early
//             }
//         });

//         if (fabricExists) {
//             alert("This fabric is already added to the table.");
//             return;
//         }

//         // 🔹 Append new fabric data into the main table 
//         colors.forEach(color => {
//             let diaData = diaValues.map(dia => {
//                 let isEditable = fabricDiaIds.includes(dia.id.toString()); 
//                 console.log('editable:',isEditable);
//                 let bgColor = isEditable ? "background-color: white; color: black;" : "background-color: #c2c5c0; color: white;";
//                 let editableAttr = isEditable ? 'contenteditable="true"' : '';
//                 let displayValue = isEditable ? "0" : "";

//                 return `
//                     <td class="dia-rolls text-end" style="${bgColor}" ${editableAttr} data-dia-id="${dia.id}">${displayValue}</td>
//                     <td class="dia-wt text-end" style="${bgColor}" ${editableAttr} data-dia-id="${dia.id}">${displayValue}</td>
//                 `;
//             }).join('');

//             let newRow = `<tr style="background-color: white; color: black;">
//                 <td>
//                     ${selectedFabricText}
//                     <input type="hidden" name="fabric_id[]" value="${selectedFabricId}">
//                 </td>
//                 <td>
//                     ${color.name}
//                     <input type="hidden" name="color_id[]" value="${color.id}">
//                 </td>
//                 ${diaData}
//                 <td class="total-rolls text-end">0</td> 
//                 <td class="total-wt text-end">0</td>
//               </tr>`;

//             $tableBody.append(newRow);
//         });

//         // 🔹 Recalculate totals when user edits values
//         $("#mainTable").on("input", "[contenteditable='true']", function () {
//             let $cell = $(this);
//             let newValue = $cell.text().trim();

//             // Validate numeric input
//             if (isNaN(newValue) || newValue === "") {
//                 $cell.text("0");
//             }

//             calculateTotals("#mainTable");
//         });

//         calculateTotals("#mainTable");
//     }).fail(function () {
//         alert("Error fetching fabric details.");
//     });
// }




$("#saveButton").on("click", function () {
    let programDate = $("#program_date").val().trim();

    if (!programDate) {
        alert("Please select a valid program date.");
        return;
    }

    let formData = new FormData();
    formData.append("program_date", programDate); // Ensure correct format
    formData.append("party_id", $("#party_id").val());
    formData.append("total_rolls", $(".totalTotalRolls").text().trim());
    formData.append("total_wt", $(".totalTotalWt").text().trim());
    formData.append("remarks", $("#remarks").val());
    formData.append("name", $("#fabricName").val());
    formData.append("csrfmiddlewaretoken", $("input[name=csrfmiddlewaretoken]").val());

    $("#mainTable tbody tr").each(function () {
        let fabric_id = $(this).find("input[name='fabric_id[]']").val();
        let color_id = $(this).find("input[name='color_id[]']").val();

        $(this).find(".dia-rolls").each(function () {
            let dia_id = $(this).data("dia-id");
            let rollsCell = $(this);
            let wtCell = rollsCell.next(".dia-wt");

            // Check background color to exclude shaded cells
            let rollsBgColor = rollsCell.css("background-color");
            let wtBgColor = wtCell.css("background-color");

            if (rollsBgColor === "rgb(255, 255, 255)" && wtBgColor === "rgb(255, 255, 255)") { // White background
                let rolls = rollsCell.text().trim();
                let wt = wtCell.text().trim();

                formData.append("fabric_id[]", fabric_id);
                formData.append("color_id[]", color_id);
                formData.append("dia_id[]", dia_id);
                formData.append("rolls[]", rolls);
                formData.append("wt[]", wt);
            }
        });
    });
 
    $.ajax({
        type: "POST",
        url: "/save-dyeing-program/",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
            if (response.success) {
 
                notifier.show( 
                    'Well Done!',  
                    'Dyeing Program Added Successfully!', 
                    'success',  
                    "{% static 'assets/images/notification/ok-48.png' %}", 
                    4000
                );  

                $('#dyeingProgramForm').trigger('reset');

                // alert("Dyeing program saved successfully!");
                location.reload();
            } else {
                notifier.show(
                    'Error!', 
                    response.message || 'Failed To add', 
                    'danger', 
                    "{% static 'assets/images/notification/high_priority-48.png' %}", 
                    4000
                ); 


                // alert("Error: " + response.message);
            }
        },
        error: function () {
            notifier.show(
                'Error!', 
                response.message || 'Failed To add', 
                'danger', 
                "{% static 'assets/images/notification/high_priority-48.png' %}", 
                4000
            ); 

            // alert("An error occurred while saving.");
        }
    });
});

// `````````````````````````````````````````````````````````````

function LoadColorTable_without_fab_id() {
    let $fabricDropdown = $("#fabric_id"),
        selectedFabricId = $fabricDropdown.val(),
        selectedFabricText = $fabricDropdown.find("option:selected").text();

    if (!selectedFabricId) {
        alert("Please select a fabric first.");
        return;
    }

    // Fetch color and dia data from Django
    $.get("{% url 'get_fabric_details' %}", { fabric_id: selectedFabricId }, function (response) {
        if (!response.success) {
            alert(response.message);
            return;
        }

        let $tablesContainer = $("#tablesContainer"),
            colors = response.colors,
            diaValues = response.dia_values,
            fabricDiaIds = response.fabric_dia_ids.map(String);

        // Check if main table exists, otherwise create it
        if ($("#mainTable").length === 0) {
            let mainTable = `<div class="p-2">
                <h5>Fabric Details</h5>
                <table id="mainTable" class="table table-striped table-bordered w-100">
                    <thead>
                        <tr style="background-color: white; color: black;">
                            <th rowspan="2">Fabric</th>
                            <th rowspan="2">Color</th>
                            ${diaValues.map(dia => {
                                let bgColor = "background-color: #eff3f6; color: black;";
                                return `<th colspan="2" style="${bgColor}">Dia ${dia.name}</th>`;
                            }).join('')}
                            <th colspan="2" style="background-color: #f5a23e; color: black;">Total</th>
                        </tr>
                        <tr style="background-color: white; color: black;">
                            ${diaValues.map(dia => {
                                let bgColor = fabricDiaIds.includes(dia.id.toString()) ? "background-color: white; color: black;" : "background-color: grey; color: white;";
                                return `<th style="${bgColor}">Rolls</th><th style="${bgColor}">Wt</th>`;
                            }).join('')}
                            <th>Rolls</th>
                            <th>Wt</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr style="background-color: white; color: black;">
                            <th colspan="2">Total</th>
                            ${diaValues.map(dia => {
                                let bgColor = "background-color: white; color: black;";
                                return `<th class="text-end totalDiaRolls" style="${bgColor}">0</th>
                                        <th class="text-end totalDiaWt" style="${bgColor}">0</th>`;
                            }).join('')}
                            <th class="text-end totalTotalRolls">0</th>
                            <th class="text-end totalTotalWt">0</th>
                        </tr>
                    </tfoot>
                </table>
            </div>`;
            $tablesContainer.append(mainTable);
        }

        // Append new fabric data into the main table
        let $tableBody = $("#mainTable tbody"); 
        colors.forEach(color => {
            let diaData = diaValues.map(dia => {
                let isEditable = fabricDiaIds.includes(dia.id.toString());
                let bgColor = isEditable ? "background-color: white; color: black;" : "background-color: grey; color: white;";
                let editableAttr = isEditable ? 'contenteditable="true"' : '';

                return `<td class="dia-rolls text-end" style="${bgColor}" ${editableAttr}>0</td>
                        <td class="dia-wt text-end" style="${bgColor}" ${editableAttr}>0</td>`;
            }).join('');

            let newRow = `<tr style="background-color: white; color: black;">
                            <td>${selectedFabricText}</td>
                            <td>${color.name}</td>
                            ${diaData}
                            <td class="total-rolls text-end">0</td> 
                            <td class="total-wt text-end">0</td>
                          </tr>`;
            $tableBody.append(newRow);
        });

        // Recalculate totals when user edits values
        $("#mainTable").on("input", "[contenteditable='true']", function () {
            let $cell = $(this);
            let newValue = $cell.text().trim();

            // Validate numeric input
            if (isNaN(newValue) || newValue === "") {
                $cell.text("0");
            }

            calculateTotals("#mainTable");
        }); 

        calculateTotals("#mainTable");
    }).fail(function () {
        alert("Error fetching fabric details.");
    });
}


function calculateTotals(tableId) {
    let $table = $(tableId);
    
    let totalDiaRolls = [],
        totalDiaWt = [],
        totalTotalRolls = 0,
        totalTotalWt = 0;

    // Reset all totals
    $table.find(".totalDiaRolls, .totalDiaWt, .totalTotalRolls, .totalTotalWt").text("0");

    // Iterate over each row
    $table.find("tbody tr").each(function () {
        let rowTotalRolls = 0;
        let rowTotalWt = 0;

        // Loop through each roll column in the row
        $(this).find(".dia-rolls").each(function (index) {
            let val = parseFloat($(this).text()) || 0;
            rowTotalRolls += val;
            totalDiaRolls[index] = (totalDiaRolls[index] || 0) + val;
        });

        // Loop through each weight column in the row
        $(this).find(".dia-wt").each(function (index) {
            let val = parseFloat($(this).text()) || 0;
            rowTotalWt += val;
            totalDiaWt[index] = (totalDiaWt[index] || 0) + val;
        });

        // Update row total in the last two columns
        $(this).find(".total-rolls").text(rowTotalRolls);
        $(this).find(".total-wt").text(rowTotalWt);

        // Add to grand totals
        totalTotalRolls += rowTotalRolls;
        totalTotalWt += rowTotalWt;
    });

    // Update column totals
    $table.find(".totalDiaRolls").each(function (index) {
        $(this).text(totalDiaRolls[index] || 0);
    });

    $table.find(".totalDiaWt").each(function (index) {
        // $(this).text((totalDiaWt[index] || 0) + " kg");
        $(this).text((totalDiaWt[index] || 0) );
    });

    // Update grand totals in <tfoot>
    $table.find(".totalTotalRolls").text(totalTotalRolls);
    $table.find(".totalTotalWt").text(totalTotalWt + " kg");
}




// function calculateTotals(tableId) {
//     let totalDiaRolls = {},
//         totalDiaWt = {},
//         totalTotalRolls = 0,
//         totalTotalWt = 0;

//     $(tableId).find(".dia-rolls").each(function (index) {
//         let val = parseFloat($(this).text()) || 0;
//         totalDiaRolls[index] = (totalDiaRolls[index] || 0) + val;
//     });

//     $(tableId).find(".dia-wt").each(function (index) {
//         let val = parseFloat($(this).text()) || 0;
//         totalDiaWt[index] = (totalDiaWt[index] || 0) + val;
//     });

//     $(tableId).find(".total-rolls").each(function () {
//         totalTotalRolls += parseFloat($(this).text()) || 0;
//     });

//     $(tableId).find(".total-wt").each(function () {
//         totalTotalWt += parseFloat($(this).text()) || 0;
//     });

//     $.each(totalDiaRolls, function (index, value) {
//         $(tableId).find(".totalDiaRolls").eq(index).text(value);
//     });

//     $.each(totalDiaWt, function (index, value) {
//         $(tableId).find(".totalDiaWt").eq(index).text(value + " kg");
//     });

//     $(tableId).find(".totalTotalRolls").text(totalTotalRolls);
//     $(tableId).find(".totalTotalWt").text(totalTotalWt + " kg");
// }

// // Attach event to the button
$("#update").click(LoadColorTable);

const currentDate = new Date();
    const currentDateString = currentDate.toISOString().slice(0, 10); // Format as YYYY-MM-DD
    const currentTimeString = currentDate.toTimeString().slice(0, 5); // Format as HH:MM

    // Set default values for date and time fields
    document.getElementById('program_date').value = currentDateString;
    // document.getElementById('purchase_time').value = currentTimeString;




</script>