
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}
 
<style>

    .transparent-input {
        background: transparent;
        border: none;
        text-align: right;
        width: 100%;
        font-weight: bold; 
    }
    .transparent-input:focus {
        outline: none;
    }
    /* Chrome, Safari, Edge, Opera */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
    }

    /* Firefox */
    input[type=number] {
    -moz-appearance: textfield;
    }

</style>

<style>
    .summary-container {
        max-width: 500px;
        margin: 20px auto;
        background: linear-gradient(135deg, #6a11cb, #2575fc);
        color: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
    }

    .summary-table {
        width: 100%;
        background: white;
        color: black;
        border-radius: 10px;
        overflow: hidden;
        padding: 10px;
    }

    .summary-table th {
        /* background: white; */
        color: black    ;
        padding: 10px;
        text-align: center;
    }

    .summary-table td {
        padding: 8px;
        font-weight: bold;
    }

    .highlight {
        background: #428bca;
        color: white;
        font-weight: bold;
        text-align: right;
    }

    .transparent-input {
        width: 100%;
        border: none;
        outline: none;
        background: transparent;
        text-align: right;
        font-weight: bold;
        font-size: 16px;
        color: black;
    }

    .transparent-input:focus {
        border-bottom: 2px solid #428bca;
    }

</style>


<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper"> 
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title"> <!-- mill to knitting delivery -->
                                            <h4 class="m-b-10">Cutting Entry  </h4>
                                        </div>
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Program</a></li>
                                            <li class="breadcrumb-item"><a href="/cutting-entry"> Cutting Entry</a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>

                                    <div class="card">

                                        <div class="card-body row"> 
                                            <div class="col-sm-12"> 
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <form id="add_new" >
                                                            <div class="row ">
                                                                
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="delivery_no" class="form-lebel">Inward No.</label>
                                                                    <input type="text" class="form-control" value="{{inward_no}}" readonly>
                                                                </div>  
                                                                
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="order_date" class="form-label">Inward Date</label>
                                                                    <input class="form-control" type="date" name="inward_date" id="inward_date" required>
                                                                </div>

                                                          
                                                                
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="product_id" class="form-label">Cutting program </label>
                                                                    <select id="prg_id" name="prg_id" class="form-control form-select single-select" onchange="LoadProgramData()" >
                                                                        <option value="">Select</option>
                                                                        {% for k in cutting_program %}
                                                                        <option value="{{ k.id }}">{{ k.cutting_no }} - [WO.NO:({{k.work_order_no}})- {{k.total_quantity}}.wt]</option> 
                                                                        {% endfor %} 
                                                                    </select>
                                                                    <input class="form-control" type="hidden" name="prg_quantity" id="prg_quantity" readonly>
                                                                    <input class="form-control" type="hidden" name="work_order_no" id="work_order_no" readonly>

                                                                </div>
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="lot_no" class="form-label">Lot No./Lot Name</label>
                                                                    <select id="lot_no" name="lot_no" class="form-control single-select">
                                                                        <option value="">Select</option>
                                                                        {% for k in lot_no %} 
                                                                            <option value="{{ k.lot_no }}">
                                                                                {{ k.lot_no }} 
                                                                                <!-- (Avl: {{ k.available_wt|floatformat:2 }} kg) -->
                                                                            </option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                    <input type="hidden" id="available_wt" value="0">


                                                                </div>


                                                                <div class="col-md-2 mt-3">
                                                                    <label for="quality_id" class="form-label">Quality</label>
                                                                    <select id="quality_id" name="quality_id" class="form-control single-select" readonly onchange="LoadStyle()">
                                                                        <option value="">Select</option>
                                                                        {% for k in quality %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Style</label>
                                                                    <select id="style_id" name="style_id" class="form-control single-select" aria-readonly="true" onchange="Loadfabric()">
                                                                        <option value="">Select</option>
                                                                        {% for k in style %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>


                                                            </div>
                                                            <div class="row">

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Size</label>
                                                                    <select id="size_id" name="size_id" class="form-control single-select" >
                                                                        <option value="">Select</option>
                                                                        {% for k in size %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                      
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Color</label>
                                                                    <select id="color_id" name="color_id" class="form-control single-select" >
                                                                        <option value="">Select</option>
                                                                        {% for k in color %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %}
                                                                    </select> 
                                                                </div>
 
                                                                <!-- <div class="col-md-2 mt-3">
                                                                    <label for="fabric_id" class="form-label">Quantity (pcs)</label>
                                                                    
                                                                    <input type="number" class="form-control" id="quantity" name="quantity"  required>
                                                                </div>

                                                                <div class="col-md-2 mt-3"> 
                                                                    <label for="fabric_id" class="form-label">Wt. (kg)</label>
                                                                    
                                                                    <input type="number" step="0.01" class="form-control" id="wt" name="wt" >
                                                                </div> -->



                                                                <div class="col-md-2 mt-3">
                                                                    <label for="quantity" class="form-label">Quantity (pcs)</label>
                                                                    <input type="number" class="form-control" id="quantity" name="quantity" required step="1" min="0" oninput="validateInteger(this)">
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="wt" class="form-label">Wt. (kg)</label>
                                                                    <input type="number" class="form-control" id="wt" name="wt" step="0.001" min="0" oninput="validateDecimal(this, 3)">
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="cutter" class="form-label">Cutter</label> 
                                                                    <input type="text" class="form-control" id="cutter" name="cutter" oninput="allowOnlyLetters(this)">
                                                                </div>


                                                                <!-- <div class="col-md-2 mt-3">
                                                                    <label for="quantity" class="form-label">Quantity (pcs)</label>
                                                                    <input type="number" class="form-control" id="quantity" name="quantity" required step="1" min="0">
                                                                </div>

                                                                <div class="col-md-2 mt-3">
                                                                    <label for="wt" class="form-label">Wt. (kg)</label>
                                                                    <input type="number" class="form-control" id="wt" name="wt" step="0.001" min="0">
                                                                </div> -->



                                                                <!-- 
                                                                <div class="col-md-2 mt-3">
                                                                    <label for="cutter" class="form-label">Cutter</label> 
                                                                    
                                                                    <input type="text" class="form-control" id="cutter" name="cutter" >
                                                                </div> -->
                                                                <div class="col-md-2 mt-4"> 
       
                                                                    <input type="hidden" class="form-control" id="original_quantity" name="original_quantity" >
                                                                    <input type="hidden" class="form-control" id="balance_qty" name="balance_qty" >
                                                                    {% csrf_token %}
                                                                    <button id="add_button" class="btn btn-primary mt-3" type="button" onclick="addManualRow()">+ Add</button>
                                                                </div>

                                                            </div>
                                                    
                                                        </div> 


                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="row">
                                                                <div class="col-md-8">
                                                                    <div class="table-responsive table-desi">

                                                                        <table id="purchaseTable" class="table table-bordered">
                        
                                                                                <thead>
                                                                                    <tr>
                                                                  

                                                                                        <th>S.No</th>
                                                                                        <th>Size</th>
                                                                                        <th>Color</th>
                                                                                        <th>Quantity (pcs)</th>
                                                                                        <th style="display: none;">Size id</th>
                                                                                        <th style="display: none;">Color id</th>
                                                                                        <th>Wt (kg)</th>
 
                                                                                        <th>Cutter</th>
                                                                                        <th style="display: none;">Original Qty</th>

                                                                                        <th>Actions</th>
                                                                                    </tr>
                                                                                    <tr class="table-secondary">
                                                                                        <th colspan="3" class="text-end">Total:</th>
                                                                                        <th id="totalQuantityHeader" class="text-center fw-bold text-primary"></th>
                                                                                        <th id="totalWtHeader" class="text-end fw-bold text-primary"></th>
                                                                                        <th></th>
                                                                                        <th></th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody></tbody>
                                                                                <tfoot> 
                                                                                    <tr>
                                                                                        <th colspan="3" class="text-end">Total:</th>
                                                                                        <th id="totalQuantityFooter" class="text-center fw-bold"></th>
                                                                                        <th id="totalWtFooter" class="text-end fw-bold"></th>
                                                                                        <th></th>
                                                                                        <th></th>
                                                                                    </tr>
                                                                                </tfoot>
                                                                            </table>

                                                                    
                                                                    
                                                                    </div>
                                                                </div>

                                                                
                                                                
                                                                <div class="col-md-4">
                                                                    <table id="summary_table" class="table table-striped table-bordered w-100">
                                                                        <thead>
                                                                            <tr>
                                                                                <th colspan="2" style="text-align: center;">Summary Table</th>
                                                                            </tr>
                                                                            <tr>
                                                                                <th></th>  
                                                                                <th>Wt</th> 
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            

                                                                          
                                                                            <tr>
                                                                                <td>Total Bundles </td>
                                                                                <td class="highlight"><span id="total_bundles">0</span></td>
                                                                            </tr>
 
                                                                            <tr>
                                                                                <td>Total Pieces</td>
                                                                                <td class="highlight"><span id="total_pcs">0</span></td>
                                                                            </tr>

                                                                            <tr>
                                                                                <td>Total Dozen</td>
                                                                                <td class="highlight"><span id="total_dozen">0</span></td>
                                                                            </tr>


                                                                            <tr>
                                                                                <td>Bundle Wt</td>
                                                                                <td class="highlight"><span id="bundle_wt_total">0</span></td>
                                                                            </tr>
                                                                             <tr>
                                                                                <td>Cutting Waste</td>
																				<td>
																					  <input
																						style="text-decoration: none; border: none; outline: none; background: transparent;"
																						type="number"
																						id="cutting_waste"
																						value="0"
																						class="transparent-input"
																						step="0.01">
																				</td>



                                                                                <!-- <td><input style="text-decoration: none;underline:none;" type="number" id="cutting_waste" value="0" class="transparent-input" step="0.01"></td> -->
                                                                            </tr>
                                                                            <tr>
                                                                                <td>Malai Waste</td>
                                                                                <td><input style="text-decoration: none; border: none; outline: none; background: transparent;"

																				type="number" id="malai_waste" value="0" class="transparent-input" step="0.01"></td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td>Damage</td>
                                                                                <td><input style="text-decoration: none; border: none; outline: none; background: transparent;"
																				type="number" id="damage" value="0" class="transparent-input" step="0.01"></td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td>Folding Waste</td>
                                                                                <td><input style="text-decoration: none; border: none; outline: none; background: transparent;"
																				type="number" id="folding_waste" value="0" class="transparent-input" step="0.01"></td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td>AirLoss</td>
                                                                                <td><input style="text-decoration: none; border: none; outline: none; background: transparent;"
																				type="number" id="air_loss" value="0" class="transparent-input" step="0.01"></td>
                                                                            </tr>
<!-- 
                                                                            <tr>
                                                                                <td>Cutting Waste</td>
                                                                                <td><input type="number" style="text-decoration: none;" id="cutting_waste" value="0" class="transparent-input" step="0.01"></td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td>Malai Waste</td>
                                                                                <td><input type="number" style="text-decoration: none;" id="malai_waste" value="0" class="transparent-input" step="0.01"></td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td>Damage</td>
                                                                                <td><input type="number" style="text-decoration: none;" id="damage" value="0" class="transparent-input" step="0.01"></td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td>Folding Waste</td>
                                                                                <td><input type="number" style="text-decoration: none;" id="folding_waste" value="0" class="transparent-input" step="0.01"></td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td>AirLoss</td>
                                                                                <td><input type="number" style="text-decoration: none;" id="air_loss" value="0" class="transparent-input" step="0.01"></td>
                                                                            </tr> -->

                                                                            <tr>
                                                                                <td>Total</td>
                                                                                <td class="highlight"><span id="qty_total_placeholder">0</span></td>
                                                                            </tr>
                                                                            <!-- <tr>
                                                                                <td>Balance</td>
                                                                                <td class="highlight"><span id="b_qty_total_placeholder">0</span></td>
                                                                            </tr> -->
                                                                          
                                                                        </tbody>
                                                                    </table>
                                                                </div>



                                                            </div>
                                                        </div>
                                                    </div>

                                                        <div class="row">
                                                             <div class="col-md-6 mt-2">
                                                                    <!-- <label for="order_date" class="form-label">Remarks</label> -->
                                                                    <textarea class="form-control" type="text" name="remarks" id="remarks" placeholder="Remarks"></textarea>
                                                                </div>

                        
                                                            <div class="col-md-2 mt-3">
                                                                <div class="" style="text-align: center;" >
                                                                    <button type="button" id="cancel" class="btn btn-danger" onclick="history.back()">Close</button>
                                                                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                                                                                                                
                                                                    <input type="hidden" id="fabric_id" name="fabric_id" value="">
                                                                    <!-- <span id="fabric_name_display"></span>  optional to show name -->
                                                                    <button type="submit" id="submit" class="btn btn-primary">Save</button>
                                                                </div>
                                                            </div>

                                                            <div class="col-md-4"> 

                                                       


                                                               

                                              
                                                  

                                                        </div>
                                             
                                                    
                                            
                                                    </div>

                                                    <!-- colmn-2 -->
                                                           

                                               
                                                </div>
                                        
                                            </form>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .no-border-input {
            border: none;
            background: transparent;
            text-align: center;
            width: 100%;
            color: inherit; /* Matches text color to the row */
        }

        .no-border-input:focus {
            outline: none;
        }

    </style>
    
</div>
{% include 'includes/footer.html' %}


<script>





  function validateInteger(input) {
    // Remove decimal if user types it
    input.value = input.value.replace(/\D/g, '');
  }

  function validateDecimal(input, maxDecimalPlaces) {
    const value = input.value;
    if (value.includes('.')) {
      const [intPart, decimalPart] = value.split('.');
      if (decimalPart.length > maxDecimalPlaces) {
        input.value = parseFloat(value).toFixed(maxDecimalPlaces);
      }
    }
  }

 function allowOnlyLetters(input) {
    input.value = input.value.replace(/[^a-zA-Z\s]/g, ''); // allows letters and spaces only
  }
//   ````````````````````````````````````` validation ```````````````````


// $("#prg_id").on("change", function () {
//     const selectedOption = $(this).find("option:selected");
//     const prgText = selectedOption.text(); // e.g., "12345 - [WO-5678- 250.wt]"

//     const match = prgText.match(/\[(.*?)-/);  // Extract work_order_no
//     if (match) {
//         $("#work_order_no").val(match[1].trim());
//     } else {
//         $("#work_order_no").val('');
//     }

//     const qtyMatch = prgText.match(/-\s*(\d+(\.\d+)?)\.wt\]/);  // Extract program quantity
//     if (qtyMatch) {
//         $("#prg_quantity").val(qtyMatch[1]);
//     } else {
//         $("#prg_quantity").val('');
//     }
// });



$("#prg_id").on("change", function () {
    const selectedOption = $(this).find("option:selected");
    const prgText = selectedOption.text(); // e.g., "CP-002 - [WO.NO:(2)- 100.wt]"

    // Regex to extract the number inside the parentheses after "WO.NO:"
    const woMatch = prgText.match(/WO\.NO:\((\d+)\)/);
    if (woMatch) {
        $("#work_order_no").val(woMatch[1]);
    } else {
        $("#work_order_no").val('');  

    }

    const qtyMatch = prgText.match(/-\s*(\d+(\.\d+)?)\.wt\]/);  // Extracts program quantity
    if (qtyMatch) {
        $("#prg_quantity").val(qtyMatch[1]);
    } else {
        $("#prg_quantity").val('');
    }
});



$(document).ready(function () {
    // Load programs when party is selected
    $('#party_id').change(function () {
        LoadProgram();
    });


});

function LoadProgram() {
    let prg_id = $('#prg_id').val();
    console.log('Cutting Program-ID:', prg_id);

    $.ajax({
        type: 'POST',
        url: '/get_cutting_program_lists/',
        data: {
            'prg_id': prg_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        success: function (data) {
            let $prg_id = $('#prg_id');
            let $prg_quantity = $('#prg_quantity');
            let $quality_id = $('#quality_id');
            let $style_id = $('#style_id');

            // Reset dropdowns and inputs
            // $prg_id.empty().append('<option value="">Select</option>');
            $prg_quantity.val('');
            $quality_id.val('').change();
            $style_id.val('').change();

            if (data.length > 0) {
                data.forEach(function (po) {
                    $prg_id.append(
                        `<option value="${po.id}" data-total="${po.total_quantity}" data-quality="${po.quality_id}" data-style="${po.style_id}">
                            ${po.cutting_no}
                        </option>`
                    );
                });
            }
        },
        error: function (xhr, status, error) {
            console.error('Error loading program lists:', error);
        }
    });
}

function updateProgramDetails() {
    let selectedOption = $('#prg_id').find(':selected');
    let totalQuantity = selectedOption.data('total') || '';
    let qualityId = selectedOption.data('quality') || '';
    let styleId = selectedOption.data('style') || '';

    console.log('Updating fields:', { totalQuantity, qualityId, styleId });

    $('#prg_quantity').val(totalQuantity);
    $('#quality_id').val(qualityId).change();
    $('#style_id').val(styleId).change();
}

function loadProgramDetails(prg_id) {
    $.ajax({
        type: 'POST', 
        url: '/get_sub_cutting_program/',
        data: {
            'prg_id': prg_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        success: function (data) {
            let $tableBody = $('#purchaseTable tbody');
            $tableBody.empty(); // Clear existing rows

            if (data.length > 0) {      
                data.forEach(function (item) {
                    addRow(item.size_name, item.color_name, item.size_id, item.color_id, item.quantity, 0); // Set wt as 0
                });
            }
        },
        error: function (xhr, status, error) {
            console.error('Error loading program details:', error);
        }
    });
}

// ````````````````````````````````````````````

// üîÅ Declare globally at the top of your script
let sizeColorMap = {};

function LoadProgramData() {
    var prg_id = $('#prg_id').val(); 
    console.log('Product-ID:', prg_id); // Debugging output

    if (!prg_id) {
        console.warn("No Product ID selected");
        return;
    } 

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token
 
    // ‚úÖ Preserve po_quantity value
    let currentPoQuantity = $('#po_quantity').val();
    console.log("Stored po_quantity before AJAX:", currentPoQuantity);

    $.ajax({
        type: 'POST',   
        url: '/get_cutting_program_list/',
        data: {
            'prg_id': prg_id,
            'csrfmiddlewaretoken': csrfToken
        },
        dataType: 'json',
        success: function(data) {
            console.log('Received Data:', data); // Debugging output

            // Do NOT clear po_quantity
            $('#quality_id').empty();
            $('#style_id').empty(); 
            $('#size_id').empty();  
            $('#color_id').empty();
 
            // Populate dropdowns only if data exists
            if (data.quality) {
                // console.log('quality:',quality);
                $('#quality_id').html('<option value="' + data.quality.id + '">' + data.quality.name + '</option>');
            }

         

            if (data.style) {
                $('#style_id').html('<option value="' + data.style.id + '">' + data.style.name + '</option>');
            }
            
            Loadfabric();

            if (data.sizes && Array.isArray(data.sizes)) {
                data.sizes.forEach(function(item) {
                    $('#size_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }

            
            if (data.colors && Array.isArray(data.colors)) {
                data.colors.forEach(function(item) {
                    
                    $('#color_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                            $('#quantity').focus();

                });
            } 


            // ‚úÖ Restore po_quantity value
        },
        error: function(xhr, status, error) {
            console.error('Error loading fabric details:', error);
        } 
    });
}





$(document).ready(function () {

    // When Size is selected, move focus to Color
    $('#size_id').on('change', function () {
        if ($(this).val()) {
            $('#color_id').focus();
        }
    });

    // When Color is selected, move focus to Lot No
    $('#color_id').on('change', function () {
        if ($(this).val()) {
            $('#lot_no').focus();
        }
    });

    // When Lot No is selected, move focus to Quantity
    $('#lot_no').on('change', function () {
        if ($(this).val()) {
            $('#quantity').focus();
        }
    });

    // Press Enter in Quantity ‚Üí focus Weight
    $('#quantity').on('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            $('#wt').focus();
        }
    });

    // Press Enter in Weight ‚Üí focus Cutter
    $('#wt').on('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            $('#cutter').focus();
        }
    });

    // Press Enter in Cutter ‚Üí focus Add Button
    $('#cutter').on('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            $('#add_button').focus();
        }
    });

    // Press Enter in Add Button ‚Üí trigger function
 $('#add_button').on('keydown', function (e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addManualRow();               // Add the row
        setTimeout(() => {
            $('#quantity').focus();   // Focus quantity after a short delay
        }, 100);                      // Delay ensures DOM update is complete
    }
});
$('#quantity').on('focus', function () {
    $(this).select(); // Auto-select entire value like Ctrl+A
});


$('#wt').on('focus', function () {
    $(this).select(); // Auto-select entire value like Ctrl+A
});

$('#cutter').on('focus', function () {
    $(this).select(); // Auto-select entire value like Ctrl+A
});



// Optional: If you want to select all when pressing '+' key while focused
$('#quantity').on('keydown', function (e) {
    if (e.key === '+') {
        e.preventDefault(); // Prevent '+' from being added
        $(this).select();   // Select the value instead
    }
});

});

// ```````````````````````````


// function LoadStyle() {
//     var quality_id = $('#quality_id').val(); 
//     console.log('Quality-ID:', quality_id); // Debugging output

    
//     if (!quality_id) {
//         console.warn("No Quality ID selected");
//         return;
//     }

//     var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

//     $.ajax({
//         type: 'POST',
//         url: '/get_quality_style_list/',
//         data: {
//             'quality_id': quality_id,
//             'csrfmiddlewaretoken': csrfToken 
//         },
//         dataType: 'json',

//         success: function(data) {
//             console.log('Received Data:', data); // Debugging output

//             // Clear and add default "Select" option
//             $('#style_id').empty().append('<option value="">Select</option>');
//             $('#size_id').empty().append('<option value="">Select</option>');
//             $('#fabric_id').val();

//             // Populate Styles
//             if (data.style && Array.isArray(data.style)) {
//                 data.style.forEach(function(item) {
//                     $('#style_id').append('<option value="' + item.id + '">' + item.name + '</option>');
//                 });
//             }

//             // Loadfabric();

//             if (data.size && Array.isArray(data.size)) {
//                 data.size.forEach(function(item) {
//                     $('#size_id').append('<option value="' + item.id + '">' + item.name + '</option>');
//                 });
//             }

//           $('#fabric_id').val(fabric);
//         },

//         error: function(xhr, status, error) {
//             console.error('Error loading fabric details:', error);
//         } 
//     });
// }





// function Loadfabric() {
//     var quality_id = $('#quality_id').val(); 
//     var style_id = $('#style_id').val(); 

//     if (!quality_id) {
//         console.warn("No Quality ID selected");
//         return;
//     }

//     var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();  // CSRF Token

//     $.ajax({
//         type: 'POST',
//         url: '/get_quality_style_fabrics_list/',
//         data: {
//             'quality_id': quality_id,
//             'style_id': style_id,
//             'csrfmiddlewaretoken': csrfToken 
//         },
//         dataType: 'json',

//         success: function(data) {
//             console.log('Received Data:', data); // Debugging output

//             const fabrics = data.fabric || [];

//             // Clear and populate the fabric dropdown
//             const $fabricDropdown = $('#fabric_id');
//             $fabricDropdown.empty();
//             $fabricDropdown.append(``);

//             fabrics.forEach(fabric => {
//                 $fabricDropdown.append(
//                     `<option value="${fabric.id}">${fabric.name}</option>`
//                 );
//             });

//             // Optional: auto-select first item
//             // if (fabrics.length > 0) {
//             //     $fabricDropdown.val(fabrics[0].id).trigger('change');
//             // }
//         },

//         error: function(xhr, status, error) {
//             console.error('Error loading fabric details:', error);
//         } 
//     });
// }


function Loadfabric() {
    var quality_id = $('#quality_id').val(); 
    var style_id = $('#style_id').val(); 

    if (!quality_id) {
        console.warn("No Quality ID selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

    $.ajax({
        type: 'POST',
        url: '/get_quality_style_fabrics_list/',
        data: {
            'quality_id': quality_id,
            'style_id': style_id,
            'csrfmiddlewaretoken': csrfToken 
        },
        dataType: 'json',
        success: function(data) {
            const fabrics = data.fabric || [];

            if (fabrics.length > 0) {
                const firstFabric = fabrics[0];
                $('#fabric_id').val(firstFabric.id); // Set hidden input value
                $('#fabric_name_display').text(firstFabric.name); // Optional display
            } else {
                $('#fabric_id').val('');
                $('#fabric_name_display').text('');
                console.warn("No fabric found for selected quality/style");
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading fabric details:', error);
        } 
    });
}


function LoadStyle() {
    var quality_id = $('#quality_id').val(); 

    if (!quality_id) {
        console.warn("No Quality ID selected");
        return;
    }

    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

    $.ajax({
        type: 'POST',
        url: '/get_quality_style_list/',
        data: {
            'quality_id': quality_id,
            'csrfmiddlewaretoken': csrfToken 
        },
        dataType: 'json',
        success: function(data) {
            // Reset all relevant dropdowns
            $('#style_id').empty().append('<option value="">Select</option>');
            $('#size_id').empty().append('<option value="">Select</option>');
            $('#fabric_id').empty().append('<option value="">Select</option>');

            if (data.style && Array.isArray(data.style)) {
                data.style.forEach(function(item) {
                    $('#style_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }

            if (data.size && Array.isArray(data.size)) {
                data.size.forEach(function(item) {
                    $('#size_id').append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }

            // Optionally auto-load fabrics after loading styles/sizes
            // Loadfabric();
        },
        error: function(xhr, status, error) {
            console.error('Error loading style/size list:', error);
        } 
    });
}


 $('#style_id').change(function () {
        Loadfabric();
    });

// // ``````````````````````````````````````````````````````````````````````````````````````````````````````````````````````



const loadedItemsMap = {};



let rowCounter = 0; // Initialize row counter



// function storeTblValues() {
//     var TableData = [];
//     var hasInvalidWt = false; // Flag to check if any wt <= 0 

//     $('#purchaseTable tbody tr').each(function () {
//         var size = $(this).find('td:eq(0)').text().trim();
//         var color = $(this).find('td:eq(1)').text().trim();
      
     
//         var quantity = parseFloat($(this).find('.quantity').text()) || 0;

//         var sizeId = $(this).find('.size_id').text().trim();
//         var colorId = $(this).find('.color_id').text().trim();
//         var wt = parseFloat($(this).find('.wt').text()) || 0;
//         // var cutter = parseFloat($(this).find('.cutter').text()) || 0;
//         var cutter = $(this).find('.cutter').text().trim();

//         // ‚úÖ Validate Wt
//         if (wt <= 0) {
//             hasInvalidWt = true;
//         }

//         // ‚úÖ Add only valid rows
//         if (size && color && quantity > 0 && wt > 0) {
//             TableData.push({
//                 "size": size,
//                 "color": color,
//                 "quantity": quantity,
//                 "wt": wt,
//                 "size_id": sizeId,
//                 "color_id": colorId,
//                 'cutter':cutter,
//             });
//         }
//     });

//     // üö® If any invalid Wt exists, show alert
//     if (hasInvalidWt) {
//         console.log('Error: Some rows have Weight (Wt) <= 0. Please correct them before submitting.');
//         return []; // Stop submission
//     }

//     calculateTotalValue();
//     console.log('TABLE-DATA:', TableData);
//     return TableData;
// }




// ``````````````````````````````````// // reverse order store from addrow to storetable values ```````````````````````````````````````````````````````````



function storeTblValues() {
    var TableData = [];
    var hasInvalidWt = false;

    // Select all rows
    var rows = $('#purchaseTable tbody tr').get();

    // Loop from last to first
    for (var i = rows.length - 1; i >= 0; i--) {
        var $row = $(rows[i]);

        var size = $row.find('td:eq(0)').text().trim();
        var color = $row.find('td:eq(1)').text().trim();
        var quantity = parseFloat($row.find('.quantity').text()) || 0;
        var sizeId = $row.find('.size_id').text().trim();
        var colorId = $row.find('.color_id').text().trim();
        var wt = parseFloat($row.find('.wt').text()) || 0;
        var cutter = $row.find('.cutter').text().trim();

        if (wt <= 0) {
            hasInvalidWt = true;
        }

        if (size && color && quantity > 0 && wt > 0) {
            TableData.push({
                "size": size,
                "color": color,
                "quantity": quantity,
                "wt": wt,
                "size_id": sizeId,
                "color_id": colorId,
                "cutter": cutter,
            });
        }
    }

    if (hasInvalidWt) {
        console.log('Error: Some rows have Weight (Wt) <= 0. Please correct them before submitting.');
        return [];
    }

    calculateTotalValue();
    console.log('TABLE-DATA:', TableData); 
    return TableData;
}


// ```````````````````````````````````````````````           11-03-2025              ```````````````````````````````````````````````



// function addManualRow() {
//     console.log("Manual row function triggered");

//     const quantity = $("#quantity").val() || 1;
//     const wt = $("#wt").val() || 0;
//     const cutter = $("#cutter").val() || 0;
//     let selectedSizes = $("#size_id").val();
//     let selectedColors = $("#color_id").val();

//     selectedSizes = Array.isArray(selectedSizes) ? selectedSizes : [selectedSizes];
//     selectedColors = Array.isArray(selectedColors) ? selectedColors : [selectedColors];

//     if (!selectedSizes[0] || !selectedColors[0]) {
//         notifier.show(
//             'Error!',
//             'Please select at least one size and one color.',
//             'danger',
//             "{% static 'assets/images/notification/high_priority-48.png' %}",
//             4000
//         );
//         return;
//     }

//     selectedSizes.forEach(sizeId => {
//         const sizeName = $("#size_id option[value='" + sizeId + "']").text();

//         selectedColors.forEach(colorId => {
//             const colorName = $("#color_id option[value='" + colorId + "']").text();

//             if (!isRowDuplicate(sizeId, colorId)) { 
//                 addRow(sizeName, colorName, sizeId, colorId, quantity, wt,cutter);
//             } else {
//                 notifier.show(
//                     'Error!',
//                     `Size: ${sizeName} and Color: ${colorName} already exists in the table.`,
//                     'danger',
//                     "{% static 'assets/images/notification/high_priority-48.png' %}",
//                     4000
//                 );
//             }
//         }); 
//     });
// }


function addManualRow() {
    console.log("Manual row function triggered");

    const quantity = $("#quantity").val() || 1;
    const wt = $("#wt").val() || 0;
    const cutter = $("#cutter").val() || 0;
    let selectedSizes = $("#size_id").val();
    let selectedColors = $("#color_id").val();

    selectedSizes = Array.isArray(selectedSizes) ? selectedSizes : [selectedSizes];
    selectedColors = Array.isArray(selectedColors) ? selectedColors : [selectedColors];

    if (!selectedSizes[0] || !selectedColors[0]) {
        notifier.show(
            'Error!',
            'Please select at least one size and one color.',
            'danger',
            "{% static 'assets/images/notification/high_priority-48.png' %}",
            4000
        );
        return;
    }

    selectedSizes.forEach(sizeId => {
        const sizeName = $("#size_id option[value='" + sizeId + "']").text();

        selectedColors.forEach(colorId => {
            const colorName = $("#color_id option[value='" + colorId + "']").text();

            // Removed the duplicate check
            addRow(sizeName, colorName, sizeId, colorId, quantity, wt, cutter);
        });
    });
}


function isRowDuplicate(sizeId, colorId) {
    let isDuplicate = false;

    $("#purchaseTable tbody tr").each(function () {
        const existingSizeId = $(this).find(".size_id").text();
        const existingColorId = $(this).find(".color_id").text();

        if (existingSizeId === sizeId && existingColorId === colorId) {
            isDuplicate = true;
            return false;
        }
    });

    return isDuplicate;
}



// ````````````````````````````````````````````````
// 


// function calculateTotalValue() {
//     let totalWeight = 0;

//     // ‚úÖ Loop through purchaseTable rows and sum .wt values
//     $('#purchaseTable tbody > tr').each(function () {
//         const weight = parseFloat($(this).find('.wt').text()) || 0;
//         const quantity = parseFloat($(this).find('.quantity').text()) || 0;
//         totalWeight += weight;
//         totalQuantity += quantity; 
//     });

//     // ‚úÖ Set Bundle Wt
//     $('#bundle_wt_total').text(totalWeight.toFixed(2));
//     $('#total_bundles').text(totalQuantity.toFixed(2));

//     // ‚úÖ Get all waste inputs (convert input values to float)
//     let cutting = parseFloat($('#cutting_waste').val()) || 0;
//     let malai = parseFloat($('#malai_waste').val()) || 0;
//     let damage = parseFloat($('#damage').val()) || 0;
//     let folding = parseFloat($('#folding_waste').val()) || 0;
//     let air = parseFloat($('#air_loss').val()) || 0;

//     // ‚úÖ Total Waste
//     let totalWaste = cutting + malai + damage + folding + air + totalWeight;

//     // ‚úÖ Balance = bundle - waste
//     // let balance = totalWeight - totalWaste;

//     // ‚úÖ Update Summary
//     $('#qty_total_placeholder').text(totalWaste.toFixed(2));
//     // $('#b_qty_total_placeholder').text(balance.toFixed(2));
// }




// function calculateTotalValue() {
//     let totalWeight = 0;
//     let totalQuantity = 0;  // ‚úÖ You missed this line!

//     // ‚úÖ Loop through purchaseTable rows and sum .wt and .quantity 
//     $('#purchaseTable tbody > tr').each(function () {
//         const weight = parseFloat($(this).find('.wt').text()) || 0;
//         const quantity = parseFloat($(this).find('.quantity').text()) || 0;
//         totalWeight += weight;
//         totalQuantity += quantity;
//     });

//     let total_bundle = $('#purchaseTable tbody > tr').length;
//    // ‚úÖ Update header
//     $('#totalQuantityHeader').text(totalQuantity.toFixed(0));
//     $('#totalWtHeader').text(totalWeight.toFixed(3));

//     // ‚úÖ Update footer
//     $('#totalQuantityFooter').text(totalQuantity.toFixed(0));
//     $('#totalWtFooter').text(totalWeight.toFixed(3));
//     // ‚úÖ Set calculated values in UI
//     $('#bundle_wt_total').text(totalWeight.toFixed(3));
//     $('#total_pcs').text(totalQuantity.toFixed(0));  // Show total pcs here
//     let total_dozen = Math.floor(totalQuantity / 12);
//     $('#total_dozen').text(total_dozen);

//     console.log('dozen:',total_dozen);
//     $('#total_bundles').text(total_bundle);
//     // $('#total_dozen').text(total_dozen);

//     // ‚úÖ Get all waste inputs
//     let cutting = parseFloat($('#cutting_waste').val()) || 0;
//     let malai = parseFloat($('#malai_waste').val()) || 0;
//     let damage = parseFloat($('#damage').val()) || 0;
//     let folding = parseFloat($('#folding_waste').val()) || 0;
//     let air = parseFloat($('#air_loss').val()) || 0;

//     // ‚úÖ Total Waste
//     let totalWaste = cutting + malai + damage + folding + air + totalWeight;

//     // ‚úÖ Update total waste in UI
//     $('#qty_total_placeholder').text(totalWaste.toFixed(2));
// }


function calculateTotalValue() {
    let totalWeight = 0;
    let totalQuantity = 0;

    $('#purchaseTable tbody > tr').each(function () {
        const weight = parseFloat($(this).find('.wt').text()) || 0;
        const quantity = parseFloat($(this).find('.quantity').text()) || 0;
        totalWeight += weight;
        totalQuantity += quantity;
    });

    let total_bundle = $('#purchaseTable tbody > tr').length;

    // Update header
    $('#totalQuantityHeader').text(totalQuantity.toFixed(0));
    $('#totalWtHeader').text(totalWeight.toFixed(3));

    // Update footer
    $('#totalQuantityFooter').text(totalQuantity.toFixed(0));
    $('#totalWtFooter').text(totalWeight.toFixed(3));

    // Set calculated values in UI
    $('#bundle_wt_total').text(totalWeight.toFixed(3));
    $('#total_pcs').text(totalQuantity.toFixed(0));

    // Calculate total dozens and excess pieces
    let total_dozen = Math.floor(totalQuantity / 12);
    let excess_pcs = totalQuantity % 12;

    // Display the result in the desired format
    $('#total_dozen').text(`${total_dozen} dozen ${excess_pcs} pcs`);

    console.log('dozen:', total_dozen, 'excess:', excess_pcs);
    $('#total_bundles').text(total_bundle);

    // Get all waste inputs
    let cutting = parseFloat($('#cutting_waste').val()) || 0;
    let malai = parseFloat($('#malai_waste').val()) || 0;
    let damage = parseFloat($('#damage').val()) || 0;
    let folding = parseFloat($('#folding_waste').val()) || 0;
    let air = parseFloat($('#air_loss').val()) || 0;

    // Total Waste
    let totalWaste = cutting + malai + damage + folding + air + totalWeight;

    // Update total waste in UI
    $('#qty_total_placeholder').text(totalWaste.toFixed(2));
}


$('#cutting_waste, #malai_waste, #damage, #folding_waste, #air_loss').on('input', function () {
    calculateTotalValue();
});



function calculateTotalValue_bk_8725() {
    let totalQuantity = 0;
    let totalWeight = 0;
    let totalBalanceQty = 0;

    $('#purchaseTable tbody > tr').each(function () {
        const quantity = parseFloat($(this).find('.quantity').text()) || 0;
        const weight = parseFloat($(this).find('.wt').text()) || 0;
        const originalQuantity = parseFloat($(this).attr("data-original-quantity")) || quantity;
        const balance_qty = originalQuantity - quantity;

        totalQuantity += quantity;
        totalWeight += weight;
        totalBalanceQty += balance_qty;

        // Update balance quantity in row
        $(this).find('.balance_qty').text(balance_qty);
    });

    // Get manual input values
    let lossQty = parseFloat($('#loss_qty_input').val()) || 0;
    let shortageQty = parseFloat($('#shortage_qty_input').val()) || 0;
    let lossWt = parseFloat($('#loss_wt_input').val()) || 0;
    let shortageWt = parseFloat($('#shortage_wt_input').val()) || 0;

    // Calculate grand totals
    let grandTotalQty = totalQuantity + lossQty + shortageQty;
    let grandTotalWt = totalWeight + lossWt + shortageWt;

    // Update placeholders
    $('#qty_total_placeholder').text(totalQuantity);
    $('#wt_total_placeholder').text(totalWeight.toFixed(2));
    $('#b_qty_total_placeholder').text(totalBalanceQty);
    $('#grand_qty_total_placeholder').text(grandTotalQty);
    $('#grand_wt_total_placeholder').text(grandTotalWt.toFixed(2));
}

// Attach event listeners to update when manual inputs change
$('#loss_qty_input, #shortage_qty_input, #loss_wt_input, #shortage_wt_input').on('input', function () {
    calculateTotalValue();
});



function editRow(row) {
    const size = row.querySelector("td:nth-child(1)").innerText.trim();
    const color = row.querySelector("td:nth-child(2)").innerText.trim();
    const quantityCell = row.querySelector(".quantity");
    const wtCell = row.querySelector(".wt");
    const cutter = row.querySelector(".cutter");
    const sizeId = row.querySelector(".size_id").innerText.trim();
    const colorId = row.querySelector(".color_id").innerText.trim();

    // Get the original quantity from the row attribute or initialize it
    let originalQuantity = row.getAttribute("data-original-quantity");
    if (!originalQuantity) {
        originalQuantity = quantityCell.textContent.trim();
        row.setAttribute("data-original-quantity", originalQuantity);
    }
    
    originalQuantity = parseFloat(originalQuantity) || 0;
    const currentQuantity = parseFloat(quantityCell.textContent.trim()) || 0;
    const currentWt = parseFloat(wtCell.textContent.trim()) || 0;
    const cutterName = parseFloat(cutter.textContent.trim()) || 0;

    // Remove the row before updating form fields
    row.remove();
    calculateTotalValue();

    // Append values into form fields
    $("#size_id").val([sizeId]).trigger("change");
    $("#color_id").val([colorId]).trigger("change");
    $("#quantity").val(currentQuantity);
    $("#wt").val(currentWt);
    $("#cutter").val(cutterName);

    // Store the original quantity in a hidden field for balance calculation
    $("#original_quantity").val(originalQuantity);
}



$("#lot_no").on("change", function () {
    const selectedOption = $(this).find("option:selected");
    const lotText = selectedOption.text(); // example: LOT123 (Avl: 150.00 kg)

    const match = lotText.match(/\(Avl:\s*([\d.]+)\s*kg\)/);
    if (match) {
        const availableWt = parseFloat(match[1]);
        $("#available_wt").val(availableWt);
    } else {
        $("#available_wt").val(0);
    }
});




    function addRow(size, color, sizeId, colorId, quantity, wt, cutter) {
        const tableBody = document.querySelector("#purchaseTable tbody");
        if (!tableBody) {
            console.error("Table body not found!");
            return;
        }

        const availableWt = parseFloat($("#available_wt").val()) || 0;
        const newWt = parseFloat(wt) || 0;

        // ‚úÖ Calculate total weight in table
        let totalWtInTable = 0;
        $("#purchaseTable tbody tr").each(function () {
            const rowWt = parseFloat($(this).find(".wt").text()) || 0;
            totalWtInTable += rowWt;
        });

        // Uncomment if you want to restrict by available weight
        // if ((totalWtInTable + newWt) > availableWt) {
        //     notifier.show(
        //         'Error!', 
        //         `Cannot add row: total weight exceeds available lot weight (${availableWt.toFixed(2)} kg).`, 
        //         'danger', 
        //         "{% static 'assets/images/notification/high_priority-48.png' %}", 
        //         4000
        //     );
        //     return;
        // }

        let originalQuantity = parseFloat($("#original_quantity").val()) || quantity;

        const newRow = document.createElement("tr");
        newRow.setAttribute("data-original-quantity", originalQuantity);

        newRow.innerHTML = `
            <td class="serial-no"></td>
            <td>${size}</td>
            <td>${color}</td>
            <td class="quantity" style="text-align:center;">${quantity}</td>  
            <td class="size_id" style="display:none">${sizeId}</td>
            <td class="color_id" style="display:none">${colorId}</td>
            <td class="wt" style="text-align:right;">${parseFloat(wt).toFixed(3)}</td>
            <td class="cutter" style="width: 50px;">${cutter.toUpperCase()}</td>
            <td>
                <button class="btn btn-primary btn-xs edit-row"><i class="feather icon-edit"></i></button>
                <button class="btn btn-danger btn-xs remove-row"><i class="feather icon-trash-2"></i></button>
            </td>
        `;

        // Insert new row at the top (descending order)
        tableBody.prepend(newRow);

        // Reset form fields
        // $('#quantity').val('1');
        // $('#wt').val('');

        calculateTotalValue();

        // Add event listeners to buttons
        newRow.querySelector(".remove-row").addEventListener("click", function () {
            newRow.remove();
            updateSerialNumbers();
            calculateTotalValue();
        });

        newRow.querySelector(".edit-row").addEventListener("click", function () {
            editRow(newRow);
        });

        // Update serial numbers after adding
        updateSerialNumbers();
    }

// ‚úÖ Update serial numbers in descending order
function updateSerialNumbers() {
    const rows = document.querySelectorAll("#purchaseTable tbody tr");
    const total = rows.length;
    rows.forEach((row, index) => {
        const serialCell = row.querySelector(".serial-no");
        if (serialCell) {
            serialCell.textContent = total - index;  // Descending order
        }
    });
}

// $('#size_id').on('change', function () {
//     selectNextAvailableColor();
// });


function refreshColorDropdown() {
    const selectedSizeId = $('#size_id').val();
    if (!selectedSizeId) return;

    const usedColorSizePairs = new Set();

    $('#purchaseTable tbody tr').each(function () {
        const colorId = $(this).find('.color_id').text().trim();
        const sizeId = $(this).find('.size_id').text().trim();
        usedColorSizePairs.add(`${sizeId}_${colorId}`);
    });

    $('#color_id option').each(function () {
        const colorId = $(this).val();
        const colorSizeId = $(this).data('size-id');

        if (
            colorId &&
            colorSizeId == selectedSizeId &&
            usedColorSizePairs.has(`${selectedSizeId}_${colorId}`)
        ) {
            $(this).hide();
        } else if (colorSizeId == selectedSizeId || !colorSizeId) {
            $(this).show();
        } else {
            $(this).hide(); // hide unrelated size-color
        }
    });
}

function selectNextAvailableColor() {
    const selectedSizeId = $('#size_id').val();
    if (!selectedSizeId) return;

    const usedPairs = new Set();

    // Collect used size+color pairs from the table
    $('#purchaseTable tbody tr').each(function () {
        const sizeId = $(this).find('.size_id').text().trim();
        const colorId = $(this).find('.color_id').text().trim();
        usedPairs.add(`${sizeId}_${colorId}`);
    });

    let nextColorId = null;

    $('#color_id option').each(function () {
        const colorId = $(this).val();
        if (!colorId) return;  // skip 'Select'

        const pairKey = `${selectedSizeId}_${colorId}`;
        if (!usedPairs.has(pairKey)) {
            nextColorId = colorId;
            return false; // break loop
        }
    });

    if (nextColorId) {
        $('#color_id').val(nextColorId).trigger('change');
    } else {
        $('#color_id').val('').trigger('change'); // no colors left for this size
    }
}

// ```````````````````````

// function selectNextAvailableColor() {
//     const usedColorIds = new Set();
    
//     // Get all color IDs from existing table rows
//     document.querySelectorAll("#purchaseTable tbody .color_id").forEach(td => {
//         usedColorIds.add(td.textContent.trim());
//     });

//     // Loop through <option> to find first unused
//     let nextColorId = null;
//     $('#color_id option').each(function () {
//         const val = $(this).val();
//         if (val && !usedColorIds.has(val)) {
//             nextColorId = val;
//             return false; // break loop
//         }
//     });

//     if (nextColorId) {
//         $('#color_id').val(nextColorId).trigger("change"); // ‚úÖ auto-select & focus quantity
//     } else {
//         $('#color_id').val('').trigger("change"); // No color left, reset
//     }
// }


// ```````````````````````````````````````````````````````````````````````````````````````````




function calculateRow(event) {
    const row = event.target.closest("tr");

    const rate = parseFloat($(row).find('.rate').val()) || 0;
    const quantity = parseFloat($(row).find('.quantity').text()) || 0;

    const amount = (rate * quantity).toFixed(2);
    $(row).find('.amount').text(amount);

    calculateTotalValue(); 
}



// `````````````````````````````````````````````````````````````````````



$('#add_new').on('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    console.log("Submit button clicked");
    var fab_id = $('#fabric_id').val();
    var TableData = storeTblValues();
    console.log('tbl-data:', TableData);

    // if (TableData.length === 0) {
    //     notifier.show(
    //         'Error!', 
    //         'Some rows have Weight (Wt) <= 0. Please correct them before submitting.',
    //         'danger', 
    //         "{% static 'assets/images/notification/high_priority-48.png' %}", 
    //         4000
    //     ); 
    //     return; // üö® Stop form submission if invalid
    // }

    if (confirm("Are you sure you want to save?")) {
        TableData = JSON.stringify(TableData); 
        var mdata = new FormData(this);
        mdata.append('cutting_data', TableData);  
        var total_bundles = $('#total_bundles').text();
        var total_pcs = $('#total_pcs').text();
        var total_dozen = $('#total_dozen').text();

        var bundle_wt = $('#bundle_wt_total').text();
        var cutting_waste = $('#cutting_waste').val();  // üîπ Fixed `.text()` to `.val()`
        var malai_waste = $('#malai_waste').val();
        var damage = $('#damage').val();
        var folding_waste = $('#folding_waste').val();
        var air_loss = $('#air_loss').text();
        var total_wt = $('#qty_total_placeholder').text();


        console.log('summary-tbl:',$('#total_bundles').text(''),
            $('#total_pcs').text(''),
            $('#total_dozen').text(''),
            $('#bundle_wt_total').text(''),
            $('#cutting_waste').val(''),  // üîπ Fixed `.text()` to `.val()`
            $('#malai_waste').val(''),
            $('#damage').val(''),
            $('#folding_waste').val(''),
            $('#air_loss').text(''),)

        // alert('q-id:', quality_id);
        mdata.append('bundle_wt', bundle_wt);
        mdata.append('cutting_waste', cutting_waste);
        mdata.append('malai_waste', malai_waste);
        mdata.append('damage', damage);
        mdata.append('folding_waste', folding_waste);
        mdata.append('air_loss', air_loss);
        mdata.append('total_wt', total_wt);
        mdata.append('total_pcs', total_pcs);
        mdata.append('total_bundles', total_bundles);
        mdata.append('total_dozen', total_dozen);

        mdata.append('fab_id',fab_id);
        console.log('mdata:',mdata);
        $.ajax({
            type: "POST", 
            url: "/add-cutting-entry/", 
            data: mdata,
            processData: false,
            contentType: false,
            beforeSend: function() {
                console.log("Sending AJAX request...");
                $('#submit').attr('disabled', true).text('Processing...');
            },
            success: function(data) {  // üîπ Fixed response handling
                console.log("Server Response:", data);
                $('#submit').attr('disabled', false).text('Save');

                if (data.status === 'yes') {    // ‚úÖ Corrected condition
                    notifier.show(
                        'Well Done!', 
                        'Cutting Entry Added!', 
                        'success', 
                        "{% static 'assets/images/notification/ok-48.png' %}", 
                        4000
                    );  
                    $('#add_new').trigger('reset');
					
					$('#quality_id').val('').trigger("change");
					$('#prg_id').val('').trigger("change");
					$('#style_id').val('').trigger("change");
					$('#size_id').val('').trigger("change");
					$('#color_id').val('').trigger("change");
					$('#party_id').val('').trigger("change");

					$('#purchaseTable tbody').empty();      
					// $('#summary_table tbody').empty();     
                    
                    // ‚úÖ Update header
                    $('#totalQuantityHeader').text('');
                    $('#totalWtHeader').text('');

                    // ‚úÖ Update footer
                    $('#totalQuantityFooter').text(''); 
                    $('#totalWtFooter').text('');

                    $('#total_bundles').text('');
                    $('#total_pcs').text(''); 
                    $('#total_dozen').text('');
                    $('#bundle_wt_total').text('');
                    $('#cutting_waste').val('');  // üîπ Fixed `.text()` to `.val()`
                    $('#malai_waste').val('');
                    $('#damage').val('');
                    $('#folding_waste').val('');
                    $('#air_loss').text('');

                    $('#qty_total_placeholder').text('');
                
                } else {
                    notifier.show(
                        'Error!', 
                        'Failed To add', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("AJAX Error:", textStatus, errorThrown);
                notifier.show(
                    'Error!', 
                    'Error adding data', 
                    'danger', 
                    "{% static 'assets/images/notification/high_priority-48.png' %}", 
                    4000
                ); 
                $('#submit').attr('disabled', false).text('Save');
            }
        });
    }
});




$('.single-select').select2();

            // Get current date and time
    const currentDate = new Date();
    const currentDateString = currentDate.toISOString().slice(0, 10); // Format as YYYY-MM-DD
    const currentTimeString = currentDate.toTimeString().slice(0, 5); // Format as HH:MM

    // Set default values for date and time fields
    document.getElementById('inward_date').value = currentDateString;

 

</script>