{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}


<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                        <!-- Breadcrumb moved here -->
                                        <div class="d-flex align-items-center">
                                            <div class="page-header-title">

                                                <h4 class="m-b-10 me-1  ">Voucher</h4>
                                            </div>
                                            <a href="/voucher-add" class="btn btn-gradient-primary btn-sm">Add</a>

                                            <div class="transaction-types ms-2">
                                                <label>
                                                    <input type="radio" name="transaction_type" value="debit_note" onclick="refreshPage('debit_note')"> Debit Note
                                                </label>
                                                &nbsp;
                                                <label>
                                                    <input type="radio" name="transaction_type" value="credit_note" onclick="refreshPage('credit_note')" >  Credit Note
                                                </label>
                                                &nbsp;
                                                <label>
                                                    <input type="radio" name="transaction_type" value="receipt" onclick="refreshPage('receipt')"> Receipt
                                                </label>
                                                &nbsp;
                                                <label>
                                                    <input type="radio" name="transaction_type" value="payment" onclick="refreshPage('payment')"> Payment
                                                </label>
                                            </div>
                                            
                                            <!-- Optional: You can also include a manual refresh button -->
                                            <!-- <button type="button" class="btn btn-gradient-success btn-sm" onclick="refreshPage()">Refresh</button> -->
                                           
                                            
                                            <!-- <button type="button" class="btn btn-gradient-primary btn-sm " data-bs-toggle="modal" data-bs-target="#add_modal">Add</button> -->
                                            <!-- <button type="button" class="btn btn-gradient-success btn-sm" onclick="refresh_data()">Refresh</button> -->
                                        </div> 
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Voucher</li>
                                            <li class="breadcrumb-item"><a href="/knitting">Voucher</a></li>
                                        </ul>
                                        
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i class="feather icon-maximize"></i> maximize</span><span style="display:none"><i class="feather icon-minimize"></i> Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i class="feather icon-minus"></i> collapse</span><span style="display:none"><i class="feather icon-plus"></i> expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card-body">                                        
                                        <div class="dt-responsive  table-hover">
                                            <table id="datatable" class="table table-striped table-bordered wrap" cellpadding="0" cellspacing="0">
                                             
                                             {% csrf_token %} 
                                             
                                             <thead>
                                                    <tr>
                                                        <th>ID #</th>
                                                        <th>Action</th>
                                                        <th>Voucher Type</th>
                                                        <th>Voucher Date</th>
                                                        <th>Process Type</th>
                                                        <th>Supplier</th> 
                                                        <th>PO</th>
                                                        <th>Amount</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>                            
                                                </tbody>
                                            </table>                                        
                                        </div>
                                    </div>
                                </div>                                      
                            </div>
                        </div>

                        <!-- Add Category Modal -->
                                  
                        <div id="edit_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLiveLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLiveLabel">Edit Voucher</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <form id="edit_form">
                                        
                                        {% csrf_token %}                                            

                                        <div class="modal-body">
                                            <div class="row">


                                                <div class="col-md-6 mb-3"> 
                                                    <label for="edit_name" class="form-label">Date</label>
                                                    <input class="form-control" type="date" id="date" name="date">
                                                </div>
  
                                                <div class="col-md-6 mb-3"> 
                                                    <label for="edit_name" class="form-label">Voucher Type</label>
                                                    <input class="form-control" type="text" id="voucher_type" name="voucher_type">
                                                </div>


                                                
                                                <div class="col-md-6 mb-3"> 
                                                    <label for="edit_name" class="form-label">Supplier</label>
                                                    <input class="form-control" type="text" id="supplier_name" name="name">
                                                </div>


                                                <div class="col-md-6 mb-3">
                                                    <label for="edit_name" class="form-label">Amount</label>
                                                    <input class="form-control" type="text" id="amount" name="amount">
                                                </div>



                                                <div class="col-md-6">
                                                    <label for="remark" class="form-label">Remarks</label>
                                                    <textarea class="form-control" rows="2" id="remarks" name="remarks"></textarea>
                                                </div>
                                           
                                                
                                                                                                                                
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <input type="hidden" name="id" id="edit_id">
                                            <input type="hidden" name="supplier_id" id="supplier">
                                            <input class="form-control" type="hidden" id="debit_po" name="po_id">
                                            
                                            <input type="hidden" id="process_type" name="process_type" value="Yarn">
                                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                                            <button type="submit" class="btn btn-primary">Create</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div> 
                            
                            
                        

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'includes/footer.html' %}
    
<script>
    $('.select2').select2({
        dropdownParent: $('#edit_modal')
    });
    $('.select').select2({
        dropdownParent: $('#add_modal')
    });
    
</script>

<script>



        function refreshPage(transactionType) {
            // You can use AJAX to refresh specific data without a full page reload.
            // For now, we'll just reload the page.
    
            if(transactionType) {
                // Optional: Store the selected transaction type in a hidden input or session for the server-side to handle
                console.log("Selected Transaction Type: ", transactionType);
                // You can pass this value to the server if needed or filter specific data on the page
            }
    
            // Refresh the page
            location.reload();
        }
              


var selectedVoucherType = '';  // Store the selected voucher type globally

function refreshPage(transactionType) {
    // Store the selected transaction type
    selectedVoucherType = transactionType;

    // Reload the DataTable with the selected voucher type filter
    table.ajax.reload();
}

var table = $('#datatable').DataTable({
    "processing": true,
    "pageLength": 50,
    "destroy": true,
    "order": [],
    "columns": [
        { "data": "id", "title": "ID #" },
        { "data": "action", "title": "Action" }, 
        { "data": "voucher_type", "title": "Voucher Type" }, 
        { "data": "date", "title": "Voucher Date", "className": "text-center" },
        { "data": "process", "title": "Process Type" },
        { "data": "supplier_id", "title": "Supplier" },
        { "data": "po_number", "title": "PO Number" },
        { "data": "amount", "title": "Amount", 'className': 'text-end' },
        { "data": "status", "title": "Status" }
    ], 
    "ajax": {  
        "url": '/voucher-list/',
        "type": "POST", 
        "data": function(data){
            data.csrfmiddlewaretoken = document.getElementsByName("csrfmiddlewaretoken")[0].value;
            data.voucher_type = selectedVoucherType;  // Send the selected voucher type as a parameter
        },
        "dataSrc": function(json) { 
            if (json.message === 'error') {
                console.log('access denied')
                return [];
            }

            console.log(json);  // For debugging
            return json.data;
        }
    }
});



    function refresh_data()
    {
        table.ajax.reload();
    }



    

function voucher_edit (id) {
        var tkn= document.getElementsByName("csrfmiddlewaretoken")[0].value;
        $.post('/voucher-edit/', {id:id, csrfmiddlewaretoken:tkn }, function(res) {
            $('#edit_id').val(res.id); 

            $('#amount').val(res.amount); 
            $('#po_id').val(res.po_id);
            $('#supplier_name').val(res.name);
            $('#voucher_type').val(res.voucher_type);
            $('#supplier').val(res.supplier_id);
            $('#remarks').val(res.remarks);
            $('#date').val(res.date)
            $('#edit_is_active').val(res.is_active).trigger("change");    
            console.log('active',res.is_active);      
            $('#edit_modal').modal('show');
        });
    } 


    


function voucher_delete(id) {
        if (confirm('Are you sure you want to delete this data?')) {
            $.ajax({
                url: "/voucher-delete/",
                method: "POST",
                data: { 
                    id: id, 
                    csrfmiddlewaretoken: '{{ csrf_token }}' 
                },
                dataType: "json",
                success: function(data) {
                    if (response.message === 'error') {  
                        notifier.show(
                            'Access Denied!', 
                            'You do not have permission to delete voucher',  
                            'danger', 
                            "{% static 'assets/images/notification/medium_priority-48.png' %}", 
                            4000
                        );
                    }

                    else if (data.message === 'yes') {
                       notifier.show(
                    'Well Done!', 
                    'Voucher deleted successfully.',  
                    'success', 
                    "{% static 'assets/images/notification/ok-48.png' %}", 
                    4000
                );
                        table.ajax.reload(); 
                    } else {
                        notifier.show( 
                    'Error!', 
                    'Failed to delete voucher.', 
                    'danger', 
                    "{% static 'assets/images/notification/high_priority-48.png' %}", 
                    4000
                );
                    }
                },
            });

        }
    }



</script>