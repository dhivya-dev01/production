
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}

<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title">
                                            <h4 class="m-b-10">Task  &nbsp;  <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                                                data-bs-target="#add_modal">Add</button></h4>
                                        </div>
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Masters</a></li>
                                            <li class="breadcrumb-item"><a href="/task">Task </a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>


                                
                                    <div id="add_modal" class="modal fade"  role="dialog" aria-labelledby="exampleModalLiveLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="exampleModalLiveLabel">Add Task</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <form id="add_form">
                                                    <div class="modal-body">
                                                        {% csrf_token %}
                                                        <div class="row">
                                                            <div class="col-6 mb-3">
                                                                <label for="library" class="form-label">Task Type</label>
                                                                <select class=" form-control single-select" id="library" name="library">
                                                                    <option value="">Select</option>
                                                                    {% for k in library %}
                                                                    <option value="{{k.id}}">{{k.name}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-6 mb-3">
                                                                <label for="technician" class="form-label">Employee</label>
                                                                <select class="single-select form-control " id="employee" name="employee">
                                                                    <option value="">Select</option>
                                                                    {% for k in employee %}
                                                                    <option value="{{k.id}}">{{k.name}}</option>
                                                                    {% endfor %}
                                                                </select> 
                                                            </div>
                                                            <div class="col-4 mb-3">
                                                                <label for="customer_name" class="form-label">Customer Name</label>
                                                                <select class="single-select form-control " id="customer_name" name="customer_name" onchange="loadName()">
                                                                    <option value="">Select</option>
                                                                    {% for k in customer %}
                                                                    <option value="{{k.id}}" data-name="{{ k.name }}">{{k.name}}</option>
                                                                    {% endfor %}
                                                                </select>
                                
                                                            </div>
                                                            
                                                            <div class="col-4 mb-3">
                                                                <label for="name" class="form-label">Name</label>
                                                                <input class="form-control" type="text" id="name" name="name">
                                                            </div> 
                                
                                                            <div class="col-4 mb-3">
                                                                <label for="phone" class="form-label">Phone Number</label>
                                                                <input class="form-control" type="text" id="phone_number" name="phone_number">
                                                            </div> 
                                                            <div class="col-4 mb-3">
                                                                <label for="priority" class="form-label">Priority</label>
                                                                <select class=" form-control single-select" id="priority" name="priority">
                                                                    <option value="">Select</option>
                                                                    <option value="High" selected>High</option>
                                                                    <option value="Medium">Medium</option>
                                                                    <option value="Low" >Low</option>
                                                                </select>
                                                            </div>
                                                           
                                
                                                            <div class="col-4 mb-3">
                                                                <label for="start_date" class="form-label">Start Date</label>
                                                                <input class="form-control" type="date" id="start" name="start">
                                                            </div>
                                
                                                            <div class="col-4 mb-3">
                                                                <label for="edit_name" class="form-label">Followup Date</label>
                                                                <input class="form-control" type="date" id="followup" name="followup">
                                                            </div> 
                                
                                                            <div class="col-4 mb-3">
                                                                <label for="task_followup_status" class="form-label">Followup Status</label>
                                                                <select class=" form-control single-select " id="task_followup_status" name="followup_status">
                                                                    <option value="">Select</option>
                                                                    <option value="Open" selected>Open</option>
                                                                    <option value="Closed">Closed</option>
                                                                </select>
                                                            </div>
                                
                                                            
                                                            <div class="col-8 mb-3">
                                                                <label for="name" class="form-label">Description</label>
                                                                <textarea class="form-control" id="description" rows="3" name="description"></textarea>
                                                            </div>                                                           
                                                        </div>
                                                    </div> 
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                        <button type="submit" class="btn btn-primary">Save</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
 


                                    <div id="edit_modal" class="modal fade"  role="dialog" aria-labelledby="exampleModalLiveLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="exampleModalLiveLabel">Edit Task</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <form id="edit_form">
                                                    <div class="modal-body">
                                                        {% csrf_token %}
                                                        <div class="row">
                                                            <div class="col-6 mb-3">
                                                                <label for="edit_library" class="form-label">Task Library</label>
                                                                <select class=" form-control edit" id="edit_library" name="library">
                                                                    <option value="">Select</option>
                                                                    {% for k in library %}
                                                                    <option value="{{k.id}}">{{k.name}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-6 mb-3">
                                                                <label for="edit_agent" class="form-label">Technician</label>
                                                                <select class=" form-control edit" id="edit_employee" name="employee">
                                                                    <option value="">Select</option>
                                                                    {% for k in employee %}
                                                                    <option value="{{k.id}}">{{k.name}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-4 mb-3">
                                                                <label for="edit_name" class="form-label">Name</label>
                                                                <input class="form-control" type="text" id="edit_name" name="name">
                                                            </div> 
                                                            <div class="col-4 mb-3">
                                                                <label for="edit_priority" class="form-label">Priority</label>
                                                                <select class=" form-control edit" id="edit_priority" name="priority">
                                                                    <option value="">Select</option>
                                                                    <option value="High" selected>High</option>
                                                                    <option value="Medium">Medium</option>
                                                                    <option value="Low" >Low</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-4 mb-3">
                                                                <label for="edit_status" class="form-label">Task Status</label>
                                                                <select class=" form-control edit" id="edit_status" name="status">
                                                                    <option value="">Select</option>
                                                                    <option value="Pending">Pending</option>
                                                                    <option value="In Progress">In progress</option>
                                                                    <option value="Hold">Hold</option>
                                                                    <option value="Completed">Completed</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-4 mb-3">
                                                                <label for="edit_start" class="form-label">Start Date</label>
                                                                <input class="form-control" type="date" id="edit_start" name="start">
                                                            </div>
                                
                                                            <div class="col-4 mb-3">
                                                                <label for="edit_followup" class="form-label">Followup Date</label>
                                                                <input class="form-control" type="date" id="edit_followup" name="followup">
                                                            </div> 
                                                            <div class="col-4 mb-3">
                                                                <label for="edit_is_active" class="form-label">Status</label> 
                                                                <select class=" form-control edit" id="edit_is_active" name="is_active">
                                                                    <option value="">Select</option>
                                                                    <option value="1">Active</option>
                                                                    <option value="0">Inactive</option>                 
                                                                </select> 
                                                            </div>
                                
                                                            
                                                            <div class="col-12 mb-3">
                                                                <label for="name" class="form-label">Description</label>
                                                                <textarea class="form-control" id="edit_description" rows="3" name="description"></textarea>
                                                            </div> 
                                
                                
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <input type="hidden" name="id" id="edit_id">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                        <button type="submit" class="btn btn-primary">Update</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>  
                                

                                    <div id="followup_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLiveLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="exampleModalLiveLabel">Task Followup</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <form id="follow_form">
                                                  {% csrf_token %}
                                                    <div class="modal-body">
                                                        <div class="row">
                                                            <div class="col-4 mb-3">
                                                                <label for="name" class="form-label">Task Library</label>
                                                                <select class=" form-control followup" id="followup_library" name="library" disabled>
                                                                    <option value="0">Select</option>
                                                                    {% for l in library %}
                                                                    <option value="{{l.id}}">{{l.name}}</option>
                                                                    {% endfor %}
                                                                    
                                                                </select>
                                                            </div>
                                                            <div class="col-4 mb-3">
                                                                <label for="name" class="form-label">Employee</label>
                                                                <select class=" form-control followup" id="followup_agent" name="agent" disabled>
                                                                    <option value="0">Select</option>
                                                                    {% for e in employee %}
                                                                    <option value="{{e.id}}">{{e.name}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-4 mb-3">
                                                                <label for="edit_name" class="form-label">Name</label>
                                                                <input class="form-control" type="text" id="followup_name" name="name" disabled>
                                                            </div> 
                                                            <div class="col-2 mb-3">
                                                                <label for="edit_name" class="form-label">Total Count</label>
                                                                <input class="form-control" type="text" id="followup_count" name="name" disabled>
                                                            </div> 
                                                            <div class="col-2 mb-3">
                                                                <label for="edit_name" class="form-label">Start Date</label>
                                                                <input class="form-control" type="text" id="followup_start" name="start" disabled>
                                                            </div>
                                                            <div class="col-8 mb-3">
                                                                <label for="name" class="form-label">Description</label>
                                                                <textarea class="form-control" id="followup_description" rows="2" name="description" disabled></textarea>
                                                            </div> <hr>  
                                                       

                                                           <div class="col-6 mb-3">
                                                                <label for="name" class="form-label">Followup Status</label>
                                                                <select class=" form-control followup" id="followup_status" name="followup_status">
                                                                    <option value="open">Open</option>
                                                                    <option value="closed">Closed</option>
                                                                </select>
                                                            </div>

                                                            <div class="col-6 mb-3">
                                                                <label for="edit_name" class="form-label">Next Followup Date</label>
                                                                <input class="form-control" type="date" id="followup_date" name="task_followup">
                                                            </div> 
                                                            <div class="col-12 mb-3">
                                                                <label for="followup_description" class="form-label">Follow-up Description
                                                                    <button type="button" class="btn btn-success mt-2 rounded-circle btn-xs" onclick="openRemarksModal('followup_descriptions', 'followup_library')">
                                                                        <i class="fas fa-plus"></i>
                                                                    </button>

                                                                </label> 
                                                                <textarea class="form-control" id="followup_descriptions" rows="3" name="task_description"></textarea>
                                                            </div>
                                                            <hr>
                                                                <div class="table-responsive">
                                                                    <table id="history_table" class="table table-striped wrap table-bordered" style="width: 100%;">
                                                                        <thead>
                                                                            <tr>
                                                                                <th>Followup Date</th>
                                                                                <th>Followed By</th>
                                                                                <th>Remarks</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>                            
                                                                        </tbody>
                                                                    </table>                        
                                                                </div>

                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <input type="hidden" name="task_id" id="task_id">
                                                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                                                        <button type="submit" class="btn btn-success">Update</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>


                                    


                                        
                                    <div class="modal fade" id="remarksModal" tabindex="-1" aria-labelledby="remarksModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="remarksModalLabel">Select Remarks</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div id="remarks_container"></div> <!-- Container for checkboxes -->
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="button" class="btn btn-success" id="saveRemarks">Save</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>




                                        <div class="card-body">
                                            {% csrf_token %}
                                            <div class="dt-responsive table-responsive table-hover">
                                                <table id="datatable" class="table table-striped table-bordered nowrap">
                                                    <thead>
                                                        <tr>
                                                            <th>ID #</th>
                                                            <th>Action</th>
                                                            <th>Name</th>
                                                            <th>Task Library</th>
                                                            <th>Employee</th>
                                                            <th>Priority</th>
                                                            <th>Task Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>                            
                                                    </tbody>
                                                </table>                                        
                                            </div>

                                            
                                        </div>

                                 

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'includes/footer.html' %}

<script>



 
$('.single-select').select2({
        dropdownParent: $('#add_modal')
    });


    $('.edit').select2({
        dropdownParent: $('#edit_modal')
    });


$('.followup').select2({
    dropdownParent: $('#followup_modal')
});

function openRemarksModal(descriptionId, libraryId) {
    var taskLibraryId = $('#' + libraryId).val();

    if (!taskLibraryId || taskLibraryId == 0) {
        alert('Please select a task library first.');
        return;
    }

    console.log('Setting description field to:', descriptionId);

    // Set the description field data
    $('#remarksModal').data('descriptionField', descriptionId);

    var remarksContainer = $('#remarks_container');
    remarksContainer.html('<p>Loading remarks...</p>'); // Display loader

    $.ajax({
        url: '/get_remarks/',
        data: { 'task_library_id': taskLibraryId },
        success: function (response) {
            var remarks = response.remarks;
            remarksContainer.empty(); // Clear previous remarks

            var currentDescription = $('#' + descriptionId).val().trim();
            var currentRemarks = currentDescription
                ? currentDescription.split(",").map(item => item.trim())
                : [];

            if (remarks.length === 0) {
                remarksContainer.html('<p>No remarks available for this task library.</p>');
            } else {
                remarks.forEach(function (remark) {
                    var isChecked = currentRemarks.includes(remark.description);

                    remarksContainer.append(
                        '<div class="form-check">' +
                        '<input class="form-check-input" type="checkbox" value="' + remark.description + '" id="remark_' + remark.id + '" ' + (isChecked ? 'checked' : '') + '>' +
                        '<label class="form-check-label" for="remark_' + remark.id + '">' +
                        remark.description +
                        '</label>' +
                        '</div>'
                    );
                });
            }

            var modalElement = document.getElementById('remarksModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement, {
                    backdrop: 'static',
                    keyboard: false
                });
                modal.show();
            } else {
                console.error("Modal element not found.");
            }
        },
        error: function (xhr, status, error) {
            console.error("Error fetching remarks:", error);
            remarksContainer.html('<p>Error loading remarks. Please try again later.</p>');
        }
    });
}





$('#saveRemarks').click(function () {
    var descriptionFieldId = $('#remarksModal').data('descriptionField');
    console.log('Updating field:', descriptionFieldId); // Debug log

    if (!descriptionFieldId) {
        console.error('Description field ID is undefined!');
        return;
    }

    var selectedRemarks = [];
    $('#remarks_container input:checked').each(function () {
        selectedRemarks.push($(this).val());
    });

    var currentContent = $('#' + descriptionFieldId).val().trim();
    var updatedContent = currentContent
        ? currentContent + ", " + selectedRemarks.join(", ")
        : selectedRemarks.join(", ");

    var uniqueContent = [...new Set(updatedContent.split(",").map(item => item.trim()))].join(", ");
    $('#' + descriptionFieldId).val(uniqueContent);

    $('#remarksModal').modal('hide');
});



// ``````````````````````````````````````````````````````````
function loadName() {
    // Get the selected option from the dropdown
    const customerSelect = document.getElementById('customer_name');
    const selectedOption = customerSelect.options[customerSelect.selectedIndex];

    // Get the data-name attribute from the selected option
    const customerName = selectedOption.getAttribute('data-name');

    // Set the customer name into the input field
    document.getElementById('name').value = customerName || ''; // If no name, set an empty string
}




    var currentDate = new Date().toISOString().split('T')[0];
    document.getElementById('start').value = currentDate;
    document.getElementById('followup').value = currentDate;
    document.getElementById('followup_date').value = currentDate;

 

    var table = $('#datatable').DataTable({
        "processing": true,
        "pageLength": 50,
        "destroy": true,
        "order": [],
        "columns": [
            { "data": "id", "title": "ID" },
            { "data": "action", "title": "Action" },
            { "data": "name", "title": "Name" },
            { "data": "library", "title": "Task Library" },            
            { "data": "agent", "title": "Employee" },            
            { "data": "priority", "title": "Priority" },            
            { "data": "status", "title": "Task Status" }
        ],
        "ajax": {
            "url": '/task_report/',
            "type": "POST",
            "data": function(data) {
                data.csrfmiddlewaretoken = document.getElementsByName("csrfmiddlewaretoken")[0].value;
            }
        }
    });


    $("#add_form").submit(function (e) {
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: '/task_add/',
            data: $(this).serialize(),
            success: function (response) {
                if (response.data === 'Success') {
                    notifier.show(
                        'Well Done!', 
                        'Task added successfully.', 
                        'success', 
                        "{% static 'assets/images/notification/ok-48.png' %}", 
                        4000
                    ); 

                    $('#add_modal').modal('hide'); 

                    $('#add_form').trigger('reset'); 

                    refresh_data(); 
                } else {
                    notifier.show(
                        'Error!', 
                        'Failed to add task.', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
                           }
            },
            error: function(xhr, status, error) {
                notifier.show(
                        'Error!', 
                        error,
                        'Failed to task.', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
            }
        });
    });
 

    function task_edit(id,name) {
        var tkn= document.getElementsByName("csrfmiddlewaretoken")[0].value;
        $.post('/task_edit/', {id:id, csrfmiddlewaretoken:tkn }, function(res) {
            $('#edit_id').val(res.id); 
            $('#edit_library').val(res.task_library).trigger("change"); 
            $('#edit_employee').val(res.employee_id).trigger("change"); 
            $('#edit_priority').val(res.priority).trigger("change"); 
            $('#edit_status').val(res.task_status).trigger("change"); 
            $('#edit_is_active').val(res.is_active).trigger("change"); 
            $('#edit_name').val(res.name);
            $('#edit_start').val(res.start_date);
            $('#edit_followup').val(res.followup_date);
            $('#edit_description').val(res.descriptions);
            $('#edit_modal').modal('show');
        });
    }  
    

   $("#edit_form").submit(function (e) {
        e.preventDefault();
        var formData = new FormData(this);

        var dataArray = [];
        for (var pair of formData.entries()) {
            dataArray.push(pair);
        }

        var serializedData = {};
        dataArray.forEach(function(pair) {
            serializedData[pair[0]] = pair[1];
        });

        $.ajax({
            type: 'POST',
            url: '/task_update/',
            data: serializedData,
            success: function (response) { 
                if (response.data === 'Success') {  // Check response.data instead of response.message
                    notifier.show(
                        'Well Done!', 
                        'Task Updated successfully.', 
                        'success', 
                        "{% static 'assets/images/notification/ok-48.png' %}", 
                        4000
                    ); 
                } 
                else {
                    notifier.show(
                        'Error!', 
                        'Failed to update task.', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
                }
                $('#edit_modal').modal('hide');
                $('#edit_form').trigger('reset');
                refresh_data();
            },
            error: function(xhr, errmsg, err){
                notifier.show(
                    'Error!', 
                    err,
                    'Failed to update.', 
                    'danger', 
                    "{% static 'assets/images/notification/high_priority-48.png' %}", 
                    4000
                ); 
                $('#edit_modal').modal('hide');
            }
        });
});



    function task_delete(id) {
        if (confirm('Are you sure you want to delete this data?')) {
            $.ajax({
                url: "/task_delete/",
                method: "POST",
                data: { 
                    id: id, 
                    csrfmiddlewaretoken: '{{ csrf_token }}' 
                },
                dataType: "json",
                success: function(data) {
                    if (data.message === 'yes') {
                        notifier.show(
                        'Well Done!', 
                        'Task Deleted successfully.', 
                        'success', 
                        "{% static 'assets/images/notification/ok-48.png' %}", 
                        4000
                    ); 
                        refresh_data(); 
                    } else {
                        notifier.show(
                        'Error!', 
                        'Failed to delete.', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
                    }
                },
            });

        }
    }


    function refresh_data(){
        table.ajax.reload();
    }






    $("#follow_form").submit(function (e) {
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: '/followup_add/',
            data: $(this).serialize(),  // Serialize the form data
            success: function (response) {
                if (response.data === 'Success') {
                    notifier.show(
                        'Well Done!', 
                        'Followup added successfully.', 
                        'success', 
                        "{% static 'assets/images/notification/ok-48.png' %}", 
                        4000
                    ); 

                    $('#followup_modal').modal('hide');  
                    $('#follow_form')[0].reset();  
                    refresh_data();  

                } else {
                    notifier.show(
                        'Error!', 
                        'Failed to add followup.', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
                }
            },
            error: function (xhr, errmsg, err) {
                console.log(xhr.status + ": " + xhr.responseText);
                notifier.show(
                        'Error!', 
                        errmsg,err, 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
            }
        });
    });
    


    function task_followup(id, name) {
        var tkn = document.getElementsByName("csrfmiddlewaretoken")[0].value;
        $.post('/task_followup/', { id: id, csrfmiddlewaretoken: tkn }, function (res) {
            $('#task_id').val(res.id); 
            $('#history_ids').val(res.id); 
            console.log('check',res.id);
            $('#followup_library').val(res.task_library).trigger("change"); 
            $('#followup_agent').val(res.agent).trigger("change"); 
            $('#followup_priority').val(res.priority).trigger("change"); 
            $('#followup_status').val(res.followup_status).trigger("change"); 
            $('#followup_name').val(res.name);
            $('#followup_count').val(res.count);
            $('#followup_start').val(res.start_date);
            $('#followup_followup').val(res.followup_date);
            $('#followup_description').val(res.descriptions);
            $('#followup_modal').modal('show');
            
        loadHistory();
        });
    }


function loadHistory() {
    var taskId = $('#task_id').val();    

    var table = $('#history_table').DataTable({
    "processing": true,
    "pageLength": 50,
    "destroy": true,
    "order": [],
    "dom": 't',
    "columns": [
        { "data": "followup", "title": "Followup Date" },
        { "data": "followed", "title": "Followed By" },
        { 
            "data": "remarks", 
            "title": "Remarks",
            "className": "wrap-text" // Add a class for styling
        }
    ],
    "ajax": {
        "url": '/followup_report/',
        "type": "POST",
        "data": function (data) {
            data.csrfmiddlewaretoken = document.getElementsByName("csrfmiddlewaretoken")[0].value;
            data.history = taskId; // Pass the validated task ID
            console.log('Sending task ID:', taskId);
        }
    }
});

}




</script>
