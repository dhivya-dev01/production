
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}

<style>
    element.style {
    position: relative;
    width: 240px;
    vertical-align: top;
    background-color: transparent;
}

.table td, .table th {
    border-top: 1px solid #e2e5e8;
    white-space: nowrap;
    padding: 1.05rem 0.75rem;
    border-bottom: none;
    padding: 4px;
}
    td[rowspan] {
        vertical-align: middle !important;
        text-align: center;
    }
    th, td {
        text-align: center;
        vertical-align: middle;
    }
</style>

<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content"> 
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="page-header-title">
                                            <h4 class="m-b-10">Dyed Fabric PO Update </h4>
                                        </div>
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Dyed Fabric</a></li>
                                            <li class="breadcrumb-item"><a href="/dyed-fabric-po">Dyed Fabric PO</a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>


                                
                                  
                                 <div class="card">  
                                     <div class="card-body row">
                                        <div class="col-sm-12">
                                            <div class="row">
                                                <div class="">
                                                   
                                                    <form id="add_new" method="POST"> 
                                                            {% csrf_token %}

                                                               <!-- <h6>PO No. {{purchase_number}}</h6> -->
                                                        <div class="row mt-3">
                                                            <div class="col-md-4 mt-2">
                                                                <label for="number" class="form-label"><span style="color: red;">*</span> PO No.</label>

                                                                <input class="form-control col-1" type="text" name="po_number" value="{{parent_stock_instance.po_number}}" id="po_number" disabled>
                                                            </div>
                                                    
                                                            

                                                            <div class="col-md-4 mt-2">
                                                                <label for="order_date" class="form-label"><span style="color: red;">*</span> PO Date</label>
                                                                <input class="form-control" type="date" name="purchase_date" id="purchase_date" required>
                                                            </div>

                                                            <div class="col-md-4 mt-2">
                                                                <label for="order_date" class="form-label"><span style="color: red;">*</span> PO Name</label>
                                                                <input class="form-control" type="text" name="name" id="name" value="{{parent_stock_instance.po_name}}" required>
                                                                 <!-- <input class="form-control" id="fabricName" dir="ltr" style="position: relative;width: 100%; vertical-align: top; background-color: transparent;" name="name" type="text" placeholder="PO NAME"> -->

                                                            </div>
                                                        </div>


                                                            

                                                        <div class="row ">


                                                            <div class="col-md-4 mt-2"> 
                                                                <label for="product_id" class="form-label"><span style="color: red;">*</span> Party </label>
                                                                <select id="party_id" name="party_id" class="form-control single-select" required>
                                                                    <option value="">Select</option>
                                                                    {% for k in party %}   <!-- trader -->
                                                                    <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
 
                                                            <div class="col-md-4 mt-2">
                                                                <label for="prg" class="form-label">Dyeing Program {{parent_stock_instance.program_id}}</label>
                                                             
                                                                <!-- <select id="program_id" name="program_id" class="form-control single-select" onchange="LoadProgram()"> -->
                                                                <select id="program_id" name="program_id" class="form-control single-select" >
                                                                    <option value="">Select</option>
                                                                    {% for k in program %}
                                                                    <option value="{{ k.id }}">{{ k.name }}  - {{ k.program_no }} ({{k.total_wt}})</option>
                                                                    {% endfor %} 
                                                                </select>
                                                            </div>

                                                            <div class="col-md-4 mt-2">
                                                                <label for="order_date" class="form-label"><span style="color: red;">*</span> Lot No.</label>
                                                                <!-- <input class="form-control" type="text" name="name" id="name" required> -->
                                                                 <input class="form-control" id="lot_no"  name="lot_no" type="text" placeholder="lot no" value="{{parent_stock_instance.lot_no}}" required>

                                                            </div>
                                                        </div>

                                                        <div class="row ">



                                                            <div class="col-md-4 mt-2">
                                                                    <label for="rate" class="form-label"><span style="color: red;">*</span> Rate (Incl.GST)</label>
                                                                    <input type="number" step="0.1" class="form-control" id="actual_rate" name="actual_rate" value="{{parent_stock_instance.rate}}"  oninput="validateDecimal2(this)" required>
                                                                </div>

                                                                <div class="col-md-4 mt-2">
                                                                     <label for="rate" class="form-label"> Discount (&#8377;)</label>
                                                                    <input type="number" step="0.1" class="form-control" id="discount"  value="{{parent_stock_instance.discount}}" name="discount" oninput="validateDecimal2(this)" >
                                                                </div>
                                                            
                                                            
                                                            
                                                              
                                                                
                                                                <div class="col-md-4 mt-2">
                                                                    <label for="rate" class="form-label"><span style="color: red;">*</span> Net price  (Incl.GST)</label>
                                                                    <input type="number" step="0.001" class="form-control" id="rate" name="rate" value="{{parent_stock_instance.net_rate}}" oninput="validateDecimal2(this)" required>
                                                                </div>

                                                    
                                                            </div>


                                                                    
                                                                



                                                         
                                                            <div class="col-md-12 mt-4">

                                                                
                                                                <div class=" table-responsive table-desi mt-2">
                                                                 
                                                                 
                                                              <!-- <table class="table table-bordered w-100" id="program_details">
                                                                <thead>
                                                                    <tr id="dia_header">
                                                                        <th>Color</th>

                                                                    </tr>
                                                                </thead>
                                                                <tbody id="pivot_table_body">

                                                                </tbody>
                                                            </table> -->

                                                            <table id="program_detail_table" class="table table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th>Fabric</th>
                                                            <th>Dia</th>
                                                            <th>Color</th>
                                                            <th>Roll</th>
                                                            <th>Roll Wt.(in kg)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                    <tfoot>
                                                        <tr>
                                                            <th colspan="3" style="text-align:right">Totals:</th>
                                                            <th id="total_rolls">0.00</th>
                                                            <th id="total_quantity">0.00</th>
                                                        </tr>
                                                    </tfoot>
                                                </table>



                                                                    <!-- <table class="table table-bordered w-100" id="program_details">
                                                                        <thead>
                                                                            <tr>
                                                                                 
                                                                                <th>Fabric</th>
                                                                                <th>Dia</th>
                                                                                <th>Color</th>
                                                                                <th>Rolls</th>
                                                                                <th>Wt. Per Roll</th>
                                                                               
                                                                            </tr> 
                                                                        </thead> 
                                                                        <tbody>
                                                                            
                                                                            
                                                                        
                                                                        </tbody> 

                                                                       <tfoot>
                                                                            <tr>
                                                                                <th colspan="3" style="text-align:right">Total:</th>
                                                                                <th id="total_rolls">0</th>
                                                                                <th id="total_quantity">0</th>
                                                                            </tr>
                                                                        </tfoot>
                                                                    </table> -->
                                                                </div> 


                                                                


                                                                <!-- po-deliver table -->
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-md-2">

                                                                </div>
                                                                <div class="col-md-6 mt-2 ">
                                                                    <!-- <label for="remarks" class="form-label"> Remarks </label> -->
                                                                    <textarea type="text" class="form-control" name="remarks" id="remarks" rows="2">{{parent_stock_instance.remarks}}</textarea>
                                                                </div>

                                                                <div class="col-md-4 mt-4" >
                                                                    <button type="button" id="cancel" class="btn btn-danger"  onclick="history.back()">Close</button>
                                                                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                                                      <input type="hidden" id="edit_id" name="edit_id" value="{{parent_stock_instance.id}}">
                                                                    <input type="hidden" id="tm_id" name="tm_id" value="{{parent_stock_instance.id}}">
                                                                    <button type="submit" id="update" class="btn btn-primary">Save</button>
                                                                </div>
                                                                

                                                                 

                                                            </div>
                                                              
                                                
                                                        
                                                
                                                           
            
                     
                                                        </div>



                                                    </div> 


                                               

                                             
                                                </div> 
                                            </form>
                                        
                                        </div>
                                    </div>


                                    

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'includes/footer.html' %}


<script>
// typeahead call footer js


// ```````````````````` delivery part ``````````````````````````



$(document).ready(function () {
    function toggleFields() { 
        const isChecked = $('#is_delivery').is(':checked');
        $('#knitting, #deliver_date, #deliver_roll, #deliver_roll_wt, #dia')
            .prop('disabled', !isChecked);
    }

    // Run on page load
    toggleFields();

    // Run on checkbox change
    $('#is_delivery').change(function () {
        toggleFields();
    });
});

    // ````````````````````````````````````````````````````````````````
if ("{{ parent_stock_instance.po_date }}" && "{{ parent_stock_instance.po_date }}" !== "") {
    var purchaseDate = "{{ parent_stock_instance.po_date }}";
    // Ensure it's in the correct format (YYYY-MM-DD)
    var formattedDate = new Date(purchaseDate).toISOString().split('T')[0];
    $('#purchase_date').val(formattedDate).trigger("change");
}



if ("{{parent_stock_instance.party_id}}" && "{{parent_stock_instance.party_id}}" !== "") {
    $('#party_id').val("{{parent_stock_instance.party_id}}").trigger("change");
}



if ("{{parent_stock_instance.program_id}}" && "{{parent_stock_instance.program_id}}" !== "") {
    $('#program_id').val("{{parent_stock_instance.program_id}}").trigger("change");
    LoadProgram();
}


// ````````````````````````````````` program details `````````````````````````````````````````````````````````````````````````


function LoadProgram() {
    const prg_id = $("#program_id").val();
    const csrfToken = $('[name="csrfmiddlewaretoken"]').val();

    $.post('/gf-dye-prg-list/', { prg_id, csrfmiddlewaretoken: csrfToken }, function(response) {
        if (!response || !response.rows || !response.dias) {
            alert("Invalid response from server.");
            return;
        }

        const dias = response.dias; // should be array of [dia_id, dia_name]
        const rows = response.rows;

        // Build thead
        let thead = `<thead>
            <tr>
                <th rowspan="2">Fabric</th>
                <th rowspan="2">Color</th>`;
        dias.forEach(([dia_id, dia_name]) => {
            thead += `<th colspan="2" style="text-align:center;" data-dia-id="${dia_id}">${dia_name}</th>`;
        });
        thead += `</tr><tr>`;
        dias.forEach(() => {
            thead += `<th>Roll</th><th>Roll Wt</th>`;
        });
        thead += `</tr></thead>`;

        // Group rows by fabric + fabric_id
        let grouped = {};
        rows.forEach(row => {
            const key = `${row.fabric_id}_${row.fabric}`;
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(row);
        });

        // Build tbody
        let tbody = `<tbody>`;
        for (let key in grouped) {
            const fabricRows = grouped[key];
            fabricRows.forEach((row, index) => {
                tbody += `<tr data-fabric-id="${row.fabric_id}" data-color-id="${row.color_id}">`;

                if (index === 0) {
                    tbody += `<td rowspan="${fabricRows.length}" style="vertical-align: middle; text-align: center;">${row.fabric}</td>`;
                }

                tbody += `<td>${row.color}</td>`;

                dias.forEach(([dia_id, dia_name]) => {
                    const diaData = row[dia_name] || { roll: 0, roll_wt: 0, dia_id: dia_id };

                    tbody += `<td data-dia-id="${dia_id}">${diaData.roll}</td>`;
                    tbody += `<td data-dia-id="${dia_id}" style="text-align:end;">${parseFloat(diaData.roll_wt).toFixed(3)}</td>`;
                });

                tbody += `</tr>`;
            });
        }
        tbody += `</tbody>`;

        // Inject into table
        $('#program_detail_table').html(thead + tbody);
    });
}




function storeDyeingTableValues() {
    const program_id = $("#program_id").val();
    const TableData = [];
    const dias = [];

    // Get dia headers and IDs
    $("#program_detail_table thead tr:nth-child(1) th").each(function(index) {
        if (index >= 2) {
            const diaName = $(this).text().trim();
            const diaId = $(this).attr("data-dia-id") || null;
            dias.push({ name: diaName, id: diaId });
        }
    });

    let lastFabric = "";
    let lastFabricId = null;
    let lastColorId = null;

    $("#program_detail_table tbody tr").each(function () {
        const row = $(this);
        const cells = row.find("td");
        let cellIndex = 0;

        let fabric = "";
        let fabric_id = "";
        let color = "";
        let color_id = "";

        if (cells.length === dias.length * 2 + 2) {
            fabric = cells.eq(0).text().trim();
            fabric_id = row.data("fabric-id");
            color = cells.eq(1).text().trim();
            color_id = row.data("color-id");
            lastFabric = fabric;
            lastFabricId = fabric_id;
            lastColorId = color_id;
            cellIndex = 2;
        } else {
            fabric = lastFabric;
            fabric_id = lastFabricId;
            color = cells.eq(0).text().trim();
            color_id = lastColorId;
            cellIndex = 1;
        }

        dias.forEach((dia, idx) => {
            const roll = parseFloat(cells.eq(cellIndex).text().trim()) || 0;
            const roll_wt = parseFloat(cells.eq(cellIndex + 1).text().trim()) || 0;
            const dia_id = cells.eq(cellIndex).data("dia-id") || null;

            TableData.push({
                program_id: program_id,
                fabric_id: fabric_id,
                color_id: color_id,
                dia_id: dia_id,
                roll: roll,
                roll_wt: roll_wt
            });

            cellIndex += 2;
        });
    });

    console.log('table-data:', TableData);
    return TableData;
}



// function storeDyeingTableValues() {
//     const program_id = $("#program_id").val();
//     const TableData = [];
//     const dias = [];

//     // Get dia headers dynamically (first <tr>, skipping first 2)
//     $("#program_detail_table thead tr:nth-child(1) th").each(function(index) {
//         if (index >= 2) {
//             dias.push($(this).text().trim());
//         }
//     });

//     let lastFabric = "";

//     // Iterate through table rows
//     $("#program_detail_table tbody tr").each(function () {
//         const cells = $(this).find("td");
//         let cellIndex = 0;

//         let fabric = "";
//         let color = "";

//         if (cells.length === dias.length * 2 + 2) {
//             // Fabric present in this row
//             fabric = cells.eq(0).text().trim();
//             lastFabric = fabric;
//             color = cells.eq(1).text().trim();
//             cellIndex = 2;
//         } else {
//             // Fabric not present due to rowspan
//             fabric = lastFabric;
//             color = cells.eq(0).text().trim();
//             cellIndex = 1;
//         }

//         dias.forEach((dia, idx) => {
//             const roll = parseFloat(cells.eq(cellIndex).text().trim()) || 0;
//             const roll_wt = parseFloat(cells.eq(cellIndex + 1).text().trim()) || 0;

//             TableData.push({
//                 program_id: program_id,
//                 fabric_name: fabric,
//                 color_name: color,
//                 dia: dia,
//                 roll: roll,
//                 roll_wt: roll_wt
//             });

//             cellIndex += 2;
//         });
//     });

//     console.log('table-data:', TableData);
//     return TableData;
// }



// function storeDyeingTableValues() {
//     const program_id = $("#program_id").val();
//     const TableData = [];
//     const dias = [];

//     // Get dia headers dynamically (you used dias array in LoadProgram)
//     $("#program_detail_table thead tr:nth-child(1) th").each(function(index) {
//         if (index >= 2) { // Skip 'Fabric' and 'Color' columns
//             dias.push($(this).text().trim());
//         }
//     });

//     // Iterate through table rows
//     $("#program_detail_table tbody tr").each(function () {
//         const cells = $(this).find("td");
//         const fabric = $(this).closest("tr").find("td:eq(0)").text().trim();
//         const color = $(this).find("td:eq(0)").text().trim(); // After rowspan logic, this becomes color

//         let colIndex = 1; // Start from the 2nd column (color)
//         dias.forEach(dia => {
//             const roll = parseFloat($(this).find(`td:eq(${colIndex})`).text().trim()) || 0;
//             const roll_wt = parseFloat($(this).find(`td:eq(${colIndex + 1})`).text().trim()) || 0;

//             TableData.push({
//                 program_id: program_id,
//                 fabric_name: fabric,
//                 color_name: color,
//                 dia: dia,
//                 roll: roll,
//                 roll_wt: roll_wt
//             });

//             colIndex += 2;
//         });
//     });

//     console.log('table-data:', TableData);
//     return TableData;
// }



// ``````````````````````````````````````````````` add function  ```````````````````````````````````````````````


$('#add_new').on('submit', function(e) {
    e.preventDefault();

    var formData = new FormData(this);
    formData.append('tm_id', $('#tm_id').val());

    $.ajax({
        url: '/dyed-fab-po-update/', // Adjust URL as needed
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                notifier.show(
                    'Well Done!', 
                    'PO updated successfully.', 
                    'success', 
                    "{% static 'assets/images/notification/ok-48.png' %}", 
                    4000
                );
                // Refresh DataTable
                refresh_data();
                

                // Update Summary
                updateSummary(response);

                // Clear Form Fields
          
                $('#party_id').val('').trigger("change");
                $('#program_id').val('').trigger("change");
            
                $('#update_flag').val('false');
                $('#update').text('Add');
            } else {
                // alert(response.error_message || 'An error occurred. Please try again.');
                notifier.show(
                    'Error!', 
                    'Failed to update po:'+response.error_message, 
                    'danger', 
                    "{% static 'assets/images/notification/high_priority-48.png' %}", 
                    4000
                );
            }
        },
        error: function(xhr, status, error) {
            console.error('Request Failed:', error); 
            // alert('Error in processing the request');
            notifier.show(
                'Error!', 
                'Error in processing the request.', 
                'danger', 
                "{% static 'assets/images/notification/high_priority-48.png' %}", 
                4000
            );
        }
    });
});





function getCSRFToken() {
    const csrfToken = document.cookie.match(/csrftoken=([^;]+)/);
    return csrfToken ? csrfToken[1] : null;
}


// // `````````````````` calculate discount in percentage-% `````````````````````````````````````````


// ````````````` discount calculate in rupees `````````````````````

$(document).ready(function () {
    function calculateQuantity() {
        let roll = parseFloat($('#roll').val()) || 0;
        let roll_wt = parseFloat($('#roll_wt').val()) || 0;
        let quantity = roll * roll_wt;

        $('#quantity').val(quantity.toFixed(2));
    }

    $('#roll, #roll_wt').on('input', calculateQuantity);
});



document.addEventListener('DOMContentLoaded', function () {
    const actualRateField = document.getElementById('actual_rate');
    const discountField = document.getElementById('discount');
    const rateField = document.getElementById('rate');
    // const bagField = document.getElementById('roll');
    // const perBagField = document.getElementById('roll_wt');
    // const grossWtField = document.getElementById('gross_wt'); 
    // const amountField = document.getElementById('amount');


    function calculateRateAndAmount() {
        const actualRate = parseFloat(actualRateField.value) || 0;
        const discount = parseFloat(discountField.value) || 0;

        // Discount is now considered in rupees, not percentage
        const discountedRate = actualRate - discount;
        rateField.value = discountedRate.toFixed(2);

        let amount = 0;

        if (quantity > 0) {
            amount = discountedRate * quantity;
        } else if (grossWt > 0) {
            amount = discountedRate * grossWt;
        }

        amountField.value = amount.toFixed(2);
    }

    actualRateField.addEventListener('input', calculateRateAndAmount);
    discountField.addEventListener('input', calculateRateAndAmount);
  
});

    
// `````````````````````````````````````` ```````````````````````````````````


function getPurchaseTableRolls() {
    let totalRoll = parseInt($("#add_new [name='roll']").val().trim()) || 0; // Get value from add_new form
    return totalRoll > 0 ? totalRoll : -1; // Return -1 if no valid purchase rolls exist
}



 
function getDeliveryTableRolls() {
    let totalRoll = 0;

    $("#delivery_table tbody tr").each(function () {
        // let rowFabricId = $(this).data("fabric-id");
        let roll = parseInt($(this).find("td:eq(2)").text().trim()) || 0;

        // if (rowFabricId == fabricId) {
        
            totalRoll += roll;
       
    });

    return totalRoll;
}


// function addDeliveryRow() {
//     // let rollsToAdd = parseInt($("#deliver_roll").val().trim()) || NaN;
//     // let rollWt = parseFloat($("#add_new [name='roll_wt']").val()) || 0;

//     // if (isNaN(rollsToAdd) || rollsToAdd <= 0) {
//     //     notifier.show(
//     //         'Error!', 
//     //         'Please select a valid fabric and enter a valid number of rolls!', 
//     //         'danger', 
//     //         "{% static 'assets/images/notification/high_priority-48.png' %}", 
//     //         4000
//     //     ); 
//     //     return;
//     // }

//     let purchaseRolls = getPurchaseTableRolls();
//     let currentDeliveryRolls = getDeliveryTableRolls();

//     if (purchaseRolls === -1) {
//         notifier.show(
//             'Error!', 
//             'Yarn Count is not available in the purchase records. Kindly select the yarn count!', 
//             'danger', 
//             "{% static 'assets/images/notification/high_priority-48.png' %}", 
//             4000
//         ); 
//         return;
//     }

//     // let remainingRolls = purchaseRolls - currentDeliveryRolls;
//     // console.log('remaining-rolls:', remainingRolls);

//     // if (rollsToAdd > remainingRolls) {
//     //     notifier.show(
//     //         'Error!', 
//     //         `You can only add ${remainingRolls} more rolls. Cannot exceed purchased rolls.`, 
//     //         'danger', 
//     //         "{% static 'assets/images/notification/high_priority-48.png' %}", 
//     //         4000
//     //     ); 
//     //     return;
//     // }

//     let deliverDate = $("#deliver_date").val();
//     let partyId = $("#knitting").val();
//     // let diaId = $("#dia").val();
//     // let dia = $("#dia option:selected").text();
//     let party = $("#knitting option:selected").text();
//     console.log('party-', party, partyId);

//     // ** Check for duplicate diaId in delivery_table **
//     let duplicate = false;
//     $("#delivery_table tbody tr").each(function() {
//         // Assuming diaId is in the 7th <td> (index 6), matching your code
//         let existingDiaId = $(this).find('td').eq(6).text();
//         if (existingDiaId === diaId) {
//             duplicate = true;
//             return false; // break .each loop
//         }
//     });

//     // if (duplicate) {
//     //     notifier.show(
//     //         'Error!', 
//     //         `DIA "${dia}" already exists in the delivery table!`, 
//     //         'warning', 
//     //         "{% static 'assets/images/notification/warning-48.png' %}", 
//     //         4000
//     //     );
//     //     return;
//     // }


//     // Store calculated values in hidden fields
//     $("#deliver_roll_wt").val(rollWt.toFixed(2));

//     // Append new row
//     let newRow = `<tr>
//                     <td>${party}</td>
//                     <td>${deliverDate}</td>
//                     <td>${rollWt.toFixed(2)}</td> 
//                     <td style="display:none">${partyId}</td>
//                     <td><button class='btn btn-danger btn-xs' onclick="removeRow(this)"><i class="feather icon-trash-2"></i></button></td>
//                   </tr>`;

//     $("#delivery_table tbody").append(newRow);
//     $('#knitting').val('').trigger("change");
//     $('deliver_roll_wt').val('');
// }


function addDeliveryRow() {
    let rollWt = parseFloat($("#deliver_roll_wt").val().trim()) || 0;
    let programTotalQty = parseFloat($('#total_quantity').text().trim()) || 0;

    // <!-- if (rollWt <= 0) { -->
    //     <!-- notifier.show( -->
    //         <!-- 'Error!',  -->
    //         <!-- 'Please enter a valid roll weight.',  -->
    //         <!-- 'danger',  -->
    //         <!-- "{% static 'assets/images/notification/high_priority-48.png' %}",  -->
    //         <!-- 4000 -->
    //     <!-- );  -->
    //     <!-- return; -->
    // <!-- } -->

    // Sum current delivery quantities
    let totalDeliveredQty = 0;
    $("#delivery_table tbody tr").each(function () {
        let qty = parseFloat($(this).find('td').eq(2).text()) || 0;
        totalDeliveredQty += qty;
    });

    if ((totalDeliveredQty + rollWt) > programTotalQty) {
        let remainingQty = (programTotalQty - totalDeliveredQty).toFixed(2);
        notifier.show(
            'Error!',
            `You can only add up to ${remainingQty} kg more. Total program quantity is ${programTotalQty.toFixed(2)} kg.`,
            'danger',
            "{% static 'assets/images/notification/high_priority-48.png' %}",
            4000
        );
        return;
    }

    let deliverDate = $("#deliver_date").val();
    let partyId = $("#knitting").val();
    let party = $("#knitting option:selected").text();

    if (!deliverDate || !partyId || partyId === "company") {
        notifier.show(
            'Error!',
            'Please select a party and enter delivery date.',
            'danger',
            "{% static 'assets/images/notification/high_priority-48.png' %}",
            4000
        );
        return;
    }

    // Add the row
    let newRow = `<tr>
                    <td>${party}</td>
                    <td>${deliverDate}</td>
                    <td>${rollWt.toFixed(2)}</td> 
                    <td style="display:none">${partyId}</td>
                    <td><button class='btn btn-danger btn-xs' onclick="removeRow(this)"><i class="feather icon-trash-2"></i></button></td>
                  </tr>`;

    $("#delivery_table tbody").append(newRow);

    // Clear fields
    $('#knitting').val('').trigger("change");
    $('#deliver_roll_wt').val('');
}



// function addDeliveryRow() {
//     // let fabricId = $("#deliver_fabric_id").val();
//     // let fabricName = $("#deliver_fabric_id option:selected").text();
//     let rollsToAdd = parseInt($("#deliver_roll").val().trim()) || NaN;

//     // Ensure `bag_wt` and `rate` are correctly fetched from the add_new form
//     let rollWt = parseFloat($("#add_new [name='roll_wt']").val()) || 0;

//     if (  isNaN(rollsToAdd) || rollsToAdd <= 0) {
//         // alert("❌ Please select a valid fabric and enter a valid number of rolls!");
//         notifier.show(
//             'Error!', 
//             'Please select a valid fabric and enter a valid number of rolls!', 
//             'danger', 
//             "{% static 'assets/images/notification/high_priority-48.png' %}", 
//             4000
//         ); 
//         return;
//     }

//     let purchaseRolls = getPurchaseTableRolls();
//     let currentDeliveryRolls = getDeliveryTableRolls();

//     if (purchaseRolls === -1) {
//         // alert("⚠️ This fabric is not available in the purchase records. Cannot proceed.");
//         notifier.show(
//             'Error!', 
//             ' Yarn Count is not available in the purchase records. Kindly select the yarn count!', 
//             'danger', 
//             "{% static 'assets/images/notification/high_priority-48.png' %}", 
//             4000
//         ); 
//         return;
//     }

//     let remainingRolls = purchaseRolls - currentDeliveryRolls;
//     console.log('remaining-rolls:',remainingRolls);

//     if (rollsToAdd > remainingRolls) {
//         notifier.show(
//             'Error!', 
//             'You can only add ${remainingRolls} more rolls. Cannot exceed purchased rolls.', 
//             'danger', 
//             "{% static 'assets/images/notification/high_priority-48.png' %}", 
//             4000
//         ); 
//         // alert(`❌ You can only add ${remainingRolls} more rolls. Cannot exceed purchased rolls.`);
//         return;
//     }



//     // let partyId = $("#knitting").val();
//     // let diaId = $("#dia").val();
//     // let dia = $("#dia option:selected").text();
//     // let party = $("#party option:selected").text();
//     // console.log('party-',party, partyId);
//     let deliverDate = $("#deliver_date").val();

//     let partyId = $("#knitting").val();
//     let diaId = $("#dia").val();
//     let dia = $("#dia option:selected").text();
//     let party = $("#knitting option:selected").text();  // fixed here
//     console.log('party-', party, partyId);


//     // **New Calculations**
//     let deliveryQuantity = rollsToAdd * rollWt;  // (bags * weight per bag)
//     // let deliveryAmount = deliveryQuantity * rate;  // (quantity * rate)

//     // Store calculated values in hidden fields
//     $("#delivery_bag_wt").val(rollWt.toFixed(2));
//     $("#delivery_quantity").val(deliveryQuantity.toFixed(2));
//     // $("#delivery_amount").val(deliveryAmount.toFixed(2));

//     let newRow = `<tr >
//                     <td>${party}</td>
//                     <td>${deliverDate}</td>
//                     <td>${dia}</td>
//                     <td>${rollsToAdd}</td>
//                     <td>${rollWt.toFixed(2)}</td> 
//                     <td style="display:none">${partyId}</td>
//                     <td style="display:none">${diaId}</td>
//                     <td><button class='btn btn-danger btn-xs' onclick="removeRow(this)"><i class="feather icon-trash-2"></i></button></td>
//                   </tr>`;

//     $("#delivery_table tbody").append(newRow);
//     $('#kniting').val('').trigger("change");

// }



// program_details

function storeKnittingTableValues() {
    let program_id = $("#program_id").val();
    let TableData = [];

    let table = $('#program_details').DataTable();

    table.rows().every(function () {
        let data = this.data();

        TableData.push({
            program_id: program_id,
            fabric_id: data.fabric_id_raw,
            count_id: data.count_id_raw,
            gauge_id: data.gauge_id_raw,
            tex_id: data.tex_id_raw,
            gsm: data.gsm,
            dia_id: data.dia_id_raw,
            roll: data.rolls,
            roll_wt: data.wt_per_roll,
            quantity: data.quantity
        });
    });

    return TableData;
    console.log('table-data:',TableData);
}


function storeDeliveryTblValues() {
    let TableData = [];
    $('#delivery_table tbody tr').each(function () {
        TableData.push({
            "knitting": $(this).find('td:eq(0)').text(), 
            "delivery_date": $(this).find('td:eq(1)').text(),
            // "dia": $(this).find('td:eq(2)').text(),
            // "roll": $(this).find('td:eq(3)').text(),
            "roll_wt": $(this).find('td:eq(2)').text(),  
            "knitting_id": $(this).find('td:eq(3)').text(),
        });
    });

    console.log('Stored Delivery Table Data:', TableData);
    return TableData;
}

    
$('.single-select').select2({
        dropdownParent: $('#add_new')
    }); 
    

  
var first = true; 

function remove_row(mrow) { 
    $(mrow).closest('tr').remove();
} 

 
// ```````````````````````````````````````````````````````````````


function resetFields() {
    $('#product_id').val('').trigger("change");
    document.getElementById('bag_value').value = ''; 
    document.getElementById('per_bag').value = ''; 
    document.getElementById('quantity').value = ''; 
    document.getElementById('rate').value = ''; 
    document.getElementById('actual_rate').value = ''; 
    document.getElementById('discount').value = ''; 
    document.getElementById('gross_wt').value = ''; 
    document.getElementById('amount').value = ''; 
}



function removeRow(button) {
    // Remove the row
    $(button).closest('tr').remove();

    // Update totals after removing the row
    calculateTotalValue();
}
 


function calculateTotalValue() {
    let totalQuantity = 0;
    let subTotal = 0;
    let totalTax = 0;
    let taxSummary = {}; 

    // Tax rate as a percentage 
    const taxRate = 5;

    // Iterate over each row in the table to calculate totals
    $('#productstable tbody > tr').each(function() {
        // Fetch values from each cell
        const quantity = parseInt($(this).find('td:eq(3)').text()) || 0; // Quantity
        const rate = parseFloat($(this).find('td:eq(4)').text()) || 0; // Rate
        const amount = parseFloat($(this).find('td:eq(9)').text()) || 0; // Amount
       
        // Calculate tax amount as 5% of the amount
        const taxAmount = (amount * taxRate) / 100; 

        // Update totals 
        totalQuantity += quantity;
        subTotal += amount;
        totalTax += taxAmount;  // Adding calculated tax to total tax

        // Update tax summary (if any tax logic is needed)
        if (taxAmount > 0) {
            if (!taxSummary[taxRate]) {
                taxSummary[taxRate] = { sgst: 0, cgst: 0, igst: 0, totalTax: 0 };
            }
            // Assuming SGST and CGST split equally for simplicity
            const sgstAmount = taxAmount / 2;
            taxSummary[taxRate].sgst += sgstAmount;
            taxSummary[taxRate].cgst += sgstAmount;
            taxSummary[taxRate].totalTax += taxAmount;
        }
    });

    // Calculate round-off value and grand total
    const totalAmount = subTotal + totalTax;
    const roundOff = totalAmount - Math.floor(totalAmount);  // Get the decimal part

    // Apply the round-off logic (if >= 0.5, round up; if < 0.5, round down)
    const adjustedRoundOff = roundOff >= 0.5 ? (1 - roundOff) : -roundOff;

    const grandTotal = (subTotal + totalTax + adjustedRoundOff).toFixed(2);  // Add adjusted round-off to grand total

    // Display totals 
    $('#qty_total_placeholder').text(totalQuantity);
    $('#sub_total_placeholder').text(subTotal.toFixed(2)); 
    $('#tax_placeholder').text(totalTax.toFixed(2));
    $('#round_off').text(adjustedRoundOff.toFixed(2));
    $('#total_payable').text(grandTotal);

    // Update tax summary table (if needed)
    $('#tax_summary_body').empty();
    for (const [rate, data] of Object.entries(taxSummary)) {
        $('#tax_summary_body').append(`
            <tr>
                <td>${rate}%</td>
                <td>${data.sgst.toFixed(2)}</td>
                <td>${data.cgst.toFixed(2)}</td>
                <td>${data.igst ? data.igst.toFixed(2) : '0.00'}</td>
                <td>${data.totalTax.toFixed(2)}</td>
            </tr>
        `);
    }
}





 
$('.single-select').select2();

            // Get current date and time
            const currentDate = new Date();
    const currentDateString = currentDate.toISOString().slice(0, 10); // Format as YYYY-MM-DD

    // Set default values for date and time fields
    document.getElementById('purchase_date').value = currentDateString;




    
    
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
// });


 </script>
