
{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}

<style>
    /* #program_table th,  */
    #purchaseTable td {
        padding: 1px !important;
        /* text-align: center; */
        vertical-align: middle;
        text-align:center;

    }

    #purchaseTable input[type="number"] {
        margin: 0 auto;
        display: block;

        text-align:center;

    }


    .table thead th {
    border-bottom: 1px solid #e2e5e8;
    font-size: 13px;
    color: #111;
    background: #eff3f6;
    text-transform: uppercase;
    padding: 4px;
    text-align:center;
}


    .table body th {
    border-bottom: 1px solid #e2e5e8;
    font-size: 13px;
    color: #111;
    background: #eff3f6;
    text-transform: uppercase;
    padding: 3px;
    text-align:center;
}


.footer{
    padding: 1px !important;
    /* text-align: center; */
    vertical-align: middle;
    text-align: center;

}


   input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
    }

</style>

<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                         <div class="page-header-title"> <!-- mill to knitting delivery -->
                                            <h4 class="m-b-10">Dyed Fabric Inward   </h4>
                                        </div>
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i
                                                        class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Dyed Fabric</a></li>
                                            <li class="breadcrumb-item"><a href="/dyed-fabric-inward"> Dyed Fabric Inward</a></li>
                                        </ul>
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon"
                                                    data-bs-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i
                                                                    class="feather icon-maximize"></i>
                                                                maximize</span><span style="display:none"><i
                                                                    class="feather icon-minimize"></i>
                                                                Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i
                                                                    class="feather icon-minus"></i> collapse</span><span
                                                                style="display:none"><i class="feather icon-plus"></i>
                                                                expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i
                                                                class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i
                                                                class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                      
                                        
                                    </div>

                                    <div class="card">   

                                        <div class="card-body">  
                                            <div class="col-sm-12">
                                                
                                                <form id="add_new" method="POST">
                                                {% csrf_token %}

                                                    <div class="row">  
                                                    

                                                        <div class="col-md-12">
                                               

                                                            <!-- Radio Buttons -->
                                                            <div class="row ">
                                                                 <div class="col-md-2 mt-2">
                                                                    <label class="form-label">Inward No.</label>
                                                                    <input type="text" class="form-control" id="inward_no" name="inward_no" value="{{inward_number}}" disabled>
                                                                </div>

                                                                <div class="col-md-2 mt-2">
                                                                    <label class="form-label">Inward Date</label>
                                                                    <input type="date" class="form-control" id="inward_date" name="inward_date">
                                                                </div>
                                                              
                                                               

                                                                <div class="col-md-2 mt-4 d-flex flex-column justify-content-between" style="height: 60px;"> 
                                                                    <!-- Top Radio Button -->
                                                                    <div>
                                                                        <input class="form-check-input" type="radio" id="is_grey_fabric" name="material_type" value="grey" checked>
                                                                        <label class="form-label" for="is_grey_fabric">Grey Fabric Outward</label>
                                                                    </div>

                                                                    <!-- Bottom Radio Button -->
                                                                    <div>
                                                                        <input class="form-check-input" type="radio" id="is_dyed_po" name="material_type" value="dye">
                                                                        <label class="form-label" for="is_dyed_po">Dyed Fabric PO</label>
                                                                        <p><span id="material_type_error" class="text-danger small"></span></p>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="col-md-2 mt-2">
                                                                    <label class="form-label">Party</label>
                                                                    <select id="supplier_id" name="supplier_id" class="form-control single-select"  required>
                                                                        <option value="">Select</option> 
                                                                    </select> 
                                                                </div>
                                                                
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="due_receive_no" class="form-label"><span style="color:red">*</span>  Receive No.(Dyeing)</label>
                                                                    <input type="text" class="form-control" id="dye_receive_no" name="dye_receive_no" value="0">
                                                                </div>


                                                                <div class="col-md-2 mt-2">
                                                                    <label for="dye_receive_date" class="form-label"><span style="color:red">*</span>   Receive Date (Dyeing)</label>
                                                                    <input type="date" class="form-control" id="dye_receive_date" name="dye_receive_date" >
                                                                </div>


                                                                <div class="col-md-2 mt-2"> 
                                                                    <label class="form-label">PO list</label>
                                                                    <select id="po_list" name="po_list" class="form-control single-select" disabled>
                                                                        <option value="">Select</option>
                                                                    </select> 
                                                                </div>


                                                                <div class="col-md-2 mt-2"> 
                                                                    <label for="lot_name" class="form-label"><span style="color: red;">*</span> Lot No.</label>
                                                                    <select class="form-control single-select" id="lot_name" name="lot_name" required  >
                                                                        <option value="">Select</option>
                                                                    </select>
                                                                </div>

                                                        

 
                                                                <div class="col-md-2 mt-2">
                                                                    <label class="form-label">Outward List</label>
                                                                    <select id="do_list" name="do_list" class="form-control single-select" disabled onchange="LoadOutwarddetail_List()">
                                                                        <!-- <option value="">Select</option> -->

                                                                         {% for k in order_through %}
                                                                        <option value="{{ k.id }}">{{ k.name }}</option> 
                                                                        {% endfor %} 
                                                                    </select>  
                                                                </div>  
                                                                
                                                                <div class="col-md-2 mt-2">
                                                                    <label class="form-label">Order Through</label>
                                                                    <select id="through_id" name="through_id" class="form-control single-select" >
                                                                        <option value="">Select</option> <!--  // mill-trader-->
                                                                 
                                                                    </select> 
                                                                </div>

                                                                 
                                                                <div class="col-md-2 mt-2">
                                                                    <label for="receive_no" class="form-label"><span style="color:red">*</span>   Receive No.</label>
                                                                    <input type="text" class="form-control" id="receive_no" name="receive_no" value="0">
                                                                </div>


                                                                <div class="col-md-2 mt-2">
                                                                    <label for="receive_date" class="form-label"><span style="color:red">*</span>   Receive Date</label>
                                                                    <input type="date" class="form-control" id="receive_date" name="receive_date" >
                                                                </div>

                                                               
 
                                                            </div>
                                                            <div class="row">
                                                                
                                                                <div class="col-md-2 mt-2">
                                                                    <label class="form-label">Fabric</label>
                                                                    <select id="fab_id" name="fab_id" class="form-control single-select"  disabled>
                                                                        <option value="">Select</option> <!--  // mill-trader-->

                                                                        {% for f in fabric_program_with_name %}
                                                                        <option value="{{f.id}}">{{f.name}} - {{f.fabric_name}}</option> <!--  // mill-trader-->
                                                                        {% endfor %}

                                                                    </select> 
                                                                </div>

                                                                <div class="col-md-2 mt-2">
                                                                    <label class="form-label">Program</label>
                                                                    <select id="program" name="program" class="form-control single-select"  disabled>
                                                                        <option value="">Select</option> <!--  // mill-trader-->
                                                                        {% for p in dyeing %}
                                                                        <option value="{{p.id}}">{{p.name}}</option> <!--  // mill-trader-->
                                                                        {% endfor %}
                                                                        
                                                                    </select> 
                                                                </div>
  
                                                                 <div class="col-md-4 mt-2">
                                                                    <label class="form-label">Color</label>
                                                                    <select id="color_id" name="color_id" class="form-control single-select" multiple>
                                                                        <option value="">Select</option> <!--  // mill-trader-->
                                                                       
                                                                    </select> 
                                                                </div>


                                                                    <div class="col-md-2 mt-3" style="text-align: center;">
                                                                        <input type="hidden" id="prg_id" name="prg_id">
                                                                        <button id="load_outward" class="btn btn-primary mt-4">+Add</button>
                                                                    </div>
                                                            </div>
    


                                                        </div>
                                             
                                                    </div> 
                                                
                                                    <div class="">  
                                                    

                                                        <div class="col-md-12">
                                               
                                                            <div class="table-responsive ">   
                                                       
                                                                <!-- <table id="purchaseTable" class="table table-bordered w-100">
                                                                    <thead>
                                                                        <tr>
                                                                            <th style="display: none;" rowspan="3">Fabric</th>
                                                                          
                                                                            <th style="display: none;" rowspan="3">Program Name</th>
                                                                            <th rowspan="3">Color</th>
                                                                            <th rowspan="3">Dia</th>

                                                                            <th colspan="2" class="text-center">Outward</th>
                                                                            <th colspan="2" class="text-center">Already Received</th>
                                                                            <th colspan="2" style="display:none;" class="text-center">Balance</th>
                                                                            <th colspan="3" class="text-center">Inward</th>


                                                                            <th rowspan="3" style="display: none;">fabric_id</th>
                                                                            <th rowspan="3" style="display: none;">yarn count id</th> 
                                                                            <th rowspan="3" style="display: none;">tex id</th>
                                                                            <th rowspan="3" style="display: none;">Gauge id</th>
                                                                            <th rowspan="3" style="display: none;">Dia id</th>
                                                                            <th rowspan="3" style="display: none;">Color id</th>
                                                                            <th rowspan="3" style="display: none;">PO id</th> 

                                                                            <th rowspan="3">Action</th>     
                                                                        </tr>
                                                                        <tr>
                                                                            <th rowspan="2">Roll</th>
                                                                            <th rowspan="2">Roll Wt. (kg)</th>

                                                                            <th rowspan="2">Roll</th>
                                                                            <th rowspan="2">Roll Wt. (kg)</th>

                                                                            <th rowspan="2" style="display:none;" >Roll</th>
                                                                            <th rowspan="2" style="display:none;" >Roll Wt. (kg)</th>

                                                                            <th rowspan="2">Roll</th>
                                                                            <th rowspan="2">Gross Wt. (kg)</th>
                                                                            <th rowspan="2"> Roll Wt. (kg)</th>

                                                                        </tr> 
                                                                    </thead>
                                                                    <tbody>

                                                                    </tbody>


                                                                    <tfoot class="footer">
                                                                        <tr>
                                                                            <td colspan="6" style="text-align:center;"><strong>Total</strong></td>
                                                                            <td align="center"><span id="footer-roll-total">0</span></td>
                                                                            <td tyle="text-align: center;"><span id="footer-gross-wt-total">0.000</span></td>
                                                                            <td colspan="4"></td>
                                                                        </tr>
                                                                    </tfoot>
                                                                </table> -->



                                                                <table id="purchaseTable" class="table table-bordered w-100">
                                                                    <thead>
                                                                        <tr>
                                                                            <!-- Optional hidden headers -->
                                                                            <th style="display: none;">Fabric</th>
                                                                            <th style="display: none;">Program Name</th>

                                                                            <!-- Visible headers -->
                                                                            <th rowspan="2">Color</th>
                                                                            <th rowspan="2">Dia</th>

                                                                            <th colspan="2" class="text-center">Outward</th>
                                                                            <th colspan="2" class="text-center">Already Received</th>
                                                                            <th colspan="2" class="text-center">Inward</th>

                                                                            <th style="display: none;" rowspan="2">Roll Wt. (kg)</th>

                                                                            <!-- Hidden metadata columns -->
                                                                            <th rowspan="2" style="display: none;">fabric_id</th>
                                                                            <th rowspan="2" style="display: none;">PO id</th>
                                                                            <th rowspan="2" style="display: none;">Program Id</th>
                                                                            <th rowspan="2" style="display: none;">Lot No</th>
                                                                            <th rowspan="2" style="display: none;">Dia Id</th>
                                                                            <th rowspan="2" style="display: none;">Color Id</th>
                                                                            <th rowspan="2" style="display: none;">Out Id</th>
                                                                            <th rowspan="2" style="display: none;">Program Id</th>
                                                                            <th rowspan="2" style="display: none;">tmId</th>
                                                                            <th rowspan="2" style="display: none;">id</th>

                                                                            <th rowspan="2">Action</th>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>Roll</th>
                                                                            <th>Roll Wt. (kg)</th>
                                                                            <th>Roll</th>
                                                                            <th>Roll Wt. (kg)</th>
                                                                            <th>Roll</th>
                                                                            <th>Gross Wt. (kg)</th>
                                                                        </tr>
                                                                    </thead>

                                                                    <tbody>
                                                                        <!-- Rows will be dynamically added via JavaScript -->
                                                                    </tbody>

                                                                    <tfoot class="footer">
                                                                        <tr style="font-weight: bold; text-align: center;">
                                                                        <td colspan="2">Total</td>
                                                                        <td><span id="footer-outward-roll">0</span></td>
                                                                        <td><span id="footer-outward-wt">0.000</span></td>
                                                                        <td><span id="footer-received-roll">0</span></td>
                                                                        <td><span id="footer-received-wt">0.000</span></td>
                                                                        <td><span id="footer-inward-roll">0</span></td>
                                                                        <td><span id="footer-inward-gross-wt">0.000</span></td>
                                                                        <td style="display: none;"><span id="footer-inward-roll-wt">0.000</span></td>
                                                                        <td></td>
                                                                        </tr>
                                                                    </tfoot>
                                                                </table>


                                                            </div>
                                                        </div> 
                                                    </div>

                                                <div class="row"> 
                                                      
                                                       

                                                    <div class="col-md-4">
                                                        <div class=" m-b-30">
                                                        
                                                            
                                                        </div>
                                                    </div> 
                                                    
                                                    <div class="row ms-2">
                                                        <div class="col-md-12" style="text-align: center;" >
                                                            <button type="button" id="cancel" class="btn btn-danger" onclick="history.back()">Close</button>
                                                            <!-- <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"> -->
        
                                                            <button type="submit" id="submit" class="btn btn-primary">Save</button>
                                                        </div>
                                                        
                                                    </div>
                                                </div>

                                            
                                            </div> 
                                        </form>
                                    </div>
                                </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> 
</div>
{% include 'includes/footer.html' %}



<script>



function reset(){
    $('#supplier_id').val('').trigger('change');
    $('#po_list').val('').trigger('change');
}





$(document).ready(function () {
    // Attach event listeners
    $('#is_grey_fabric, #is_dyed_po').on('change', function () {
        loadPartyList(); // Reload supplier list when material type changes
        reset(); // Clear previous supplier selection
    });

    $('#supplier_id').on('change', function () {
        checkAndLoadData(); // Only load DO or PO after party is selected
    });

    // Initial load
    loadPartyList();
});

function reset() {
    $('#supplier_id').val('').trigger('change');
}

// Load supplier/party list based on material type
function loadPartyList() {
    var materialType = $('#is_grey_fabric').is(':checked') ? 'grey' :
                       $('#is_dyed_po').is(':checked') ? 'dye' : '';

    if (!materialType) {
        console.warn("No material type selected");
        $('#supplier_id').html('<option value="">Select</option>');
        return;
    }

    $.ajax({
        type: 'POST',
        url: '/get_dyed_inward_party_list/',
        data: {
            'material_type': materialType
        },
        dataType: 'json',
        success: function(data) {
            var $supplierSelect = $('#supplier_id');
            $supplierSelect.html('<option value="">Select</option>');

            if (data.length > 0) {
                $.each(data, function (_, party) {
                    $supplierSelect.append($('<option>', {
                        value: party.id,
                        text: party.name
                    }));
                });
            }
        },
        error: function (xhr, status, error) {
            console.error('Error fetching party list:', error);
        }
    });
}

// Called only after party is selected
function checkAndLoadData() {
    const supplierId = $('#supplier_id').val();
    if (!supplierId) return; // Do nothing if party not selected

    if ($('#is_grey_fabric').is(':checked')) {
        $('#do_list').prop('disabled', false);
        $('#po_list').prop('disabled', true).val('').trigger('change');

        LoadDO(); // ✅ Only this is called

    } else if ($('#is_dyed_po').is(':checked')) {
        $('#po_list').prop('disabled', false);
        $('#do_list').prop('disabled', true).val('').trigger('change');
        LoadPO(); // ✅ Only this is called
    }
}


// ```````````````````````````````test07062025````````````````````````````````````````````````


document.addEventListener("DOMContentLoaded", function () {
            const rollInput = document.getElementById("roll");
            const rollWtInput = document.getElementById("roll_wt");

            if (rollInput && rollWtInput) {
                rollInput.addEventListener("input", calculateQuantity);
                rollWtInput.addEventListener("input", calculateQuantity);
            }
        });

        function calculateQuantity() {
            const roll = parseFloat(document.getElementById("roll").value) || 0;
            const rollWt = parseFloat(document.getElementById("roll_wt").value) || 0;
            const totalWt = roll * rollWt;

            const totalWtInput = document.getElementById("total_wt");
            if (totalWtInput) {
                totalWtInput.value = totalWt.toFixed(2);
            }

            calculateAmount();
        }

        function calculateAmount() {
            const totalWt = parseFloat(document.getElementById("total_wt").value) || 0;
            const grossWt = parseFloat(document.getElementById("gross_wt").value) || 0;
            console.log("Total Wt:", totalWt);
            console.log("Gross Wt:", grossWt);
        }




$('#load_outward').on('click', function(e) {
    e.preventDefault(); // Just in case

    const selectedMaterial = $('input[name="material_type"]:checked').val();
    console.log("Selected Material:", selectedMaterial);
    console.log("is_grey_fabric checked:", $('#is_grey_fabric').is(':checked'));

    if (selectedMaterial === 'grey') {
        LoadOutward();      // Call when Yarn is selected
    } else if (selectedMaterial === 'dye') {
        LoadDeliverTo();    // Call when Grey Fabric is selected
    } else {
        alert("Please select a material type first.");
    }
}); 




function LoadPO() {
    var supplier_id = $('#supplier_id').val().trim();
    $('#lot_name').val('').trigger("change");
    $('#po_list').val('').trigger("change");

    if (!supplier_id) {
        console.log("No supplier selected, skipping LoadDO.");
        return;  // Exit early if supplier_id is empty
    }



    // var supplier_id = $('#supplier_id').val(); 
    $('#PO_summaryTable').find('td[id$="_total"]').text("0.00"); // Reset summary
    $('#po_list').empty().append('<option value="">Select</option>');
    $('#lot_name').empty().append('<option value="">Select</option>');
    // $('#through_id').empty().append('<option value="">Select</option>');
    console.log('Supplier-ID:', supplier_id); // Adjusted for clarity

    $.ajax({ 
        type: 'POST',  // Change to POST 
        url: '/get_dyed_fabric_po_lists/',
        data: {
            'supplier_id': supplier_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()  // Include CSRF token
        },



        success: function(data) {
            // $('#po_list').empty().append('<option value="">Select</option>');
            $('#lot_name').empty().append('<option value="">Select</option>');
        
            if (data.orders && data.orders.length > 0) {
                data.orders.forEach(function(po) {
                    $('#po_list').append('<option value="' + po.id + '">' + po.po_number + ' - ' + po.po_name + '</option>');

                
                });

            }

            $('#po_list').on('change', function () {
                LoadLot();
            });



        },

        error: function(xhr, status, error) {
            console.error('Error loading PO lists:', error);
        } 
    });
}



function LoadLot() {
    var po_list = $('#po_list').val();  
    console.log('Supplier-ID:', po_list); 
    $('#purchaseTable tbody').empty('');



    // Get all delivery IDs already used in purchaseTable
    let usedDeliverIds = [];
    $('#purchaseTable tbody tr').each(function () {
        let deliver_id = $(this).find('#deliver_id').text();
        if (deliver_id) {
            usedDeliverIds.push(deliver_id);
        }
    }); 

    $.ajax({
        type: 'POST',
        url: '/get_dyed_po_detail_lists/',
        data: {
            'po_list': po_list,
            'used_deliver_ids': JSON.stringify(usedDeliverIds),  // Send as JSON string
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
     

        success: function(data) {
            $('#do_list').empty().append('<option value="">Select</option>');
            $('#lot_name').empty().append('<option value="">Select</option>');




              if (data.orders && data.orders.length > 0) {
                data.orders.forEach(function(po) {
                    $('#lot_name').append('<option selected value="' + po.id + '">' + po.lot_no + '</option>');

                
                });

            }


            // ✅ Load Deliver To dropdown
            if (data.delivery_to && data.delivery_to.length > 0) {
                data.delivery_to.forEach(function(item) {
                    $('#deliver_to').append('<option value="' + item.party_id + '">' + item.party_name + '</option>');
                });
            }

            // ✅ Load Program dropdown
            if (data.program && data.program.length > 0) {
                data.program.forEach(function(po) {
                    $('#prg_id').append(
                        `<option value="${po.id}">${po.program_no} - ${po.name} - [${po.total_wt}]</option>`
                    );
                });
            }



            if (Array.isArray(data.program) && data.program.length > 0) {
                const firstProgram = data.program[0];
                
                if (firstProgram.id) {
                    $("#program").val(firstProgram.id).trigger("change");
                }
 
            }
            
            if (data.fabric_id) {
                $("#fab_id").val(data.fabric_id).trigger("change");
            }




            // ✅ Update PO Bag and Quantity
            $('#po_bag_total').text(parseFloat(data.po_bag || 0).toFixed(2));
            $('#po_quantity_total').text(parseFloat(data.po_quantity || 0).toFixed(2));
            $('#inward_bag_total').text(parseFloat(data.inward_bag || 0).toFixed(2));
            $('#inward_quantity_total').text(parseFloat(data.inward_quantity || 0).toFixed(2));

            const balance_bag = (parseFloat(data.po_bag) || 0) - (parseFloat(data.inward_bag) || 0);
            const balance_quantity = (parseFloat(data.po_quantity) || 0) - (parseFloat(data.inward_quantity) || 0);
            $('#balance_bag_total').text(balance_bag.toFixed(2));
            $('#balance_quantity_total').text(balance_quantity.toFixed(2));



            if ((!data.deliveries || data.deliveries.length === 0) && Array.isArray(data.program_details) && data.program_details.length > 0) {
                // Ensure selectedProgramIds is an array of numbers
                let selectedProgramIds = [];
                if (Array.isArray(data.program_id)) {
                    selectedProgramIds = data.program_id.map(Number);
                } else if (data.program_id) {
                    selectedProgramIds = [Number(data.program_id)];
                } else if (data.program && data.program.length > 0) {
                    // fallback: take program ids from data.program array
                    selectedProgramIds = data.program.map(p => Number(p.id));
                }



                data.program_details.forEach((detail, index) => {
                console.log("Detail", index, "program_id:", detail.program_id, "dia:", detail.dia);
                // const detailProgramId = Number(detail.program_id);

                let detailProgramIds = [];
            if (Array.isArray(detail.program_id)) {
                detailProgramIds = detail.program_id.map(Number);
            } else {
                detailProgramIds = [Number(detail.program_id)];
            }

            if (detailProgramIds.some(id => selectedProgramIds.includes(id))) {
           
        } else {
            console.log("Skipping detail with program_id:", detail.program_id);
        }
    });



    }


    },



    error: function(xhr, status, error) {
        console.error('Error loading po lists:', error);
    }
    });
}
    
// ``````````

function LoadDeliverTo() {

    var po_list = $('#po_list').val();  
    console.log('Supplier-ID:', po_list); 
    var lot_no = $('#lot_name').val(); // Usually an array if multiple select

    $('#purchaseTable tbody').empty('');

    $('#lot_name').empty().append('<option value="">Select</option>');


    // Get all delivery IDs already used in purchaseTable
    let usedDeliverIds = [];
    $('#purchaseTable tbody tr').each(function () {
        let deliver_id = $(this).find('#deliver_id').text();
        if (deliver_id) {
            usedDeliverIds.push(deliver_id);
        }
    }); 

    $.ajax({
        type: 'POST',
        url: '/get_dyed_po_detail_lists/',
        data: {
            'po_list': po_list,
            'used_deliver_ids': JSON.stringify(usedDeliverIds),  // Send as JSON string
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
     

        success: function(data) {
            $('#do_list').empty().append('<option value="">Select</option>');
            $('#prg_id').empty().append('<option value="">Select</option>');

            // Reset form fields
            $("#fabric_id").val('').trigger("change");
            $("#gauge_id").val('').trigger("change");
            $("#tex_id").val('').trigger("change");
            $("#yarn_count_id").val('').trigger("change");
            $("#gsm").val('');
            $("#roll").val('');
            $("#roll_wt").val('');
            $("#quantity").val('');
            $("#gross_wt").val('');
            $("#po_id").val(''); 

            $('#lot_name').val('').trigger('change');

              if (data.orders && data.orders.length > 0) {
                data.orders.forEach(function(po) {
                    $('#lot_name').append('<option selected value="' + po.lot_no + '">' + po.lot_no + '</option>');

                
                });

            }


            // ✅ Load Deliver To dropdown
            if (data.delivery_to && data.delivery_to.length > 0) {
                data.delivery_to.forEach(function(item) {
                    $('#deliver_to').append('<option value="' + item.party_id + '">' + item.party_name + '</option>');
                });
            }

            $('#prg_id').val(data.program_id);


            // ✅ Update PO Bag and Quantity
            $('#po_bag_total').text(parseFloat(data.po_bag || 0).toFixed(2));
            $('#po_quantity_total').text(parseFloat(data.po_quantity || 0).toFixed(2));
            $('#inward_bag_total').text(parseFloat(data.inward_bag || 0).toFixed(2));
            $('#inward_quantity_total').text(parseFloat(data.inward_quantity || 0).toFixed(2));

            const balance_bag = (parseFloat(data.po_bag) || 0) - (parseFloat(data.inward_bag) || 0);
            const balance_quantity = (parseFloat(data.po_quantity) || 0) - (parseFloat(data.inward_quantity) || 0);
            $('#balance_bag_total').text(balance_bag.toFixed(2));
            $('#balance_quantity_total').text(balance_quantity.toFixed(2));



            if ((!data.deliveries || data.deliveries.length === 0) && Array.isArray(data.program_details) && data.program_details.length > 0) {
                // Ensure selectedProgramIds is an array of numbers
                let selectedProgramIds = [];
                if (Array.isArray(data.program_id)) {
                    selectedProgramIds = data.program_id.map(Number);
                } else if (data.program_id) {
                    selectedProgramIds = [Number(data.program_id)];
                } else if (data.program && data.program.length > 0) {
                    // fallback: take program ids from data.program array
                    selectedProgramIds = data.program.map(p => Number(p.id));
                }



                data.program_details.forEach((detail, index) => {
                console.log("Detail", index, "program_id:", detail.program_id, "dia:", detail.dia);
                // const detailProgramId = Number(detail.program_id);
                console.log("Detail", index, detail);

                    // Safely get program_name and fabric_name using fallback keys
                    // Safely get program_name and fabric_name using fallback keys
                    const programName = detail.program_name || (detail.program && detail.program.name) || '';
                    console.log('prg-name:',programName);
                    // Properly extract fabric name when it's in an array
                    let fabricName = '';
                    if (Array.isArray(detail.fabric) && detail.fabric.length > 0) {
                        const fabricItem = detail.fabric[0];
                        fabricName = `${fabricItem.name || ''} - ${fabricItem.fabric_name || ''}`.trim();
                    } else if (typeof detail.fabric === 'object' && detail.fabric !== null) {
                        fabricName = `${detail.fabric.fabric_name || ''} - ${detail.fabric.fabric_name || ''}`.trim();
                    } else {
                        fabricName = detail.fabric_name || '';
                    }



                     let fabricInfo = '';
                    if (programName && fabricName) {
                        fabricInfo = ` ${fabricName}`;
                    } else if (programName) {
                        fabricInfo = programName;
                    } else if (fabricName) {
                        fabricInfo = fabricName;
                    } else if (detail.name) {
                        fabricInfo = detail.name;
                    } else {
                        fabricInfo = 'N/A';
                    }

                    

                    let prg_name = '';
                    if (programName ) {
                        prg_name = `${programName} `;
                    } else if (programName) {
                        prg_name = programName; 
                    console.log("Fabric Info:", prg_name);

                    }
                let detailProgramIds = [];
                if (Array.isArray(detail.program_id)) {
                    detailProgramIds = detail.program_id.map(Number);
                } else {
                    detailProgramIds = [Number(detail.program_id)];
                }


            
                let pg_bal = detail.program_bal_value || [];
                let program_roll = 0, program_quantity = 0;
                let total_roll = 0, total_wt = 0, total_balance_roll = 0, balance_wt = 0;
                pg_bal.forEach(entry => {
                    console.log('entry:', entry);

                    if (Number(entry.program_id) === Number(detail.program_id)) {
                        program_roll = parseFloat(entry.pg_roll) || 0;
                        program_quantity = parseFloat(entry.pg_wt) || 0;
                        total_roll = parseFloat(entry.in_rolls) || 0;
                        total_wt = parseFloat(entry.in_wt) || 0;
                        total_balance_roll = parseFloat(entry.balance_roll) || 0;
                        balance_wt = parseFloat(entry.balance_wt) || 0;
                    }
                });


            if (detailProgramIds.some(id => selectedProgramIds.includes(id))) {
   

                addRow(
                    fabricInfo || '',                         // fabric
                    detail.yarn_count || '',                  // yarn_count
                    detail.tex || '',                         // tex
                    detail.gauge || '',                       // gauge
                    detail.gsm || '',                         // gsm
                    prg_name || '',                            // prg_name
                    
                    detail.dia || '',                         // dia
                    detail.color || '',                         // dia
                         
                    program_roll,
                    program_quantity,

                    total_roll,
                    total_wt,


                    total_balance_roll,
                    balance_wt,
                    // total_roll - balance_roll,
                    // total_wt - balance_wt,
                        detail.inward_roll || 0,                  // inward_roll
                    detail.inward_gross_wt || 0,              // inward_gross_wt
                    detail.inward_total_wt || 0,              // inward_total_wt
                    '',                                       // id
                    detail.fabric_id || '',                   // fabricId
                    '',                                       // tmId
                    detail.po_id || 0,                                       // po_id
                    '',                                       // deliver_id
                    '',                                       // lot_name
                    false,                                    // isInward
                    detail.program_id || '',                  // prg_id
                    lot_no,                                   // lot_no
                    detail.yarn_count_id || '',               // yarn_countId
                    detail.tex_id || '',                      // texId
                    detail.gauge_id || '',                    // gaugeId
                    detail.dia_id || '',                      // diaId
                    detail.color_id || '',                      // diaId
                    detail.out_id || 0,                      // outId
                    detail.program_id || ''                   // program_id
                );

            }else {
        console.log("Skipping detail with program_id:", detail.program_id);
        }
    });



}


        },



        error: function(xhr, status, error) {
            console.error('Error loading po lists:', error);
        }
    });
}
    






function LoadProgram() {
    let po_id = $("#po_list").val();

    // Check if the table is already initialized
    if ($.fn.DataTable.isDataTable('#purchaseTable')) {
        $('#purchaseTable').DataTable().destroy();  // Destroy old instance
    }

    $('#purchaseTable').DataTable({
        "processing": true,
        "pageLength": 50,
        "destroy": true, // Allow reinitialization
        "order": [],
        "ajax": { 
            "url": '/grey-fab-po-detail-list/',
            "type": "POST",
            "data": function (data) {
                data.csrfmiddlewaretoken = document.getElementsByName("csrfmiddlewaretoken")[0].value;
                data.po_id = po_id;
            },
            "dataSrc": function (json) {
                if (json.message === 'error') {
                    console.log('Access denied');
                    return [];
                }
                console.log(json);
                return json.data;
            }
        },
        "columns": [
            { "data": "fabric_id", "title": "Item" },
            { "data": "count", "title": "Yarn count" },
            { "data": "gauge", "title": "Gauge" },
            { "data": "tex", "title": "Tex" },
            { "data": "gsm", "title": "GSM" },
            { "data": "dia", "title": "Dia" },
            { "data": "rolls", "title": "Rolls" },
            { "data": "wt_per_roll", "title": "Wt. Per Roll" },
            { "data": "quantity", "title": "Quantity" },

            // Raw ID columns (can be hidden)
            // { data: 'gsm', visible: false },
            { data: 'fabric_id_raw', visible: false },
            { data: 'count_id_raw', visible: false },
            { data: 'gauge_id_raw', visible: false },
            { data: 'tex_id_raw', visible: false },
            { data: 'dia_id_raw', visible: false }
            // { "data": "rate", "title": "Rate" },
            // { "data": "total_amount", "title": "Total Amount" }
        ],
        
        "footerCallback": function (row, data, start, end, display) {
            var api = this.api();

            // Helper to get column total
            var intVal = function (i) {
                return typeof i === 'string' ?
                    parseFloat(i.replace(/[,]/g, '')) || 0 :
                    typeof i === 'number' ?
                        i : 0;
            };

            // Sum rolls (column 7)
            var totalRolls = api.column(6, { page: 'current' }).data()
                .reduce(function (a, b) {
                    return intVal(a) + intVal(b);
                }, 0);

            // Sum quantity (column 9)
            var totalQty = api.column(8, { page: 'current' }).data()
                .reduce(function (a, b) {
                    return intVal(a) + intVal(b);
                }, 0);

            // Update footer
            $('#total_rolls').html(totalRolls.toFixed(2));
            $('#total_quantity').html(totalQty.toFixed(2));
        },
    });
}

// ````````````````````````````````````````````


function LoadDO() {
    var supplier_id = $('#supplier_id').val(); 
    $('#PO_summaryTable').find('td[id$="_total"]').text("0.00"); // Reset summary
    $('#do_list').empty().append('<option value="">Select</option>');
    $('#lot_name').empty().append('<option value="">Select</option>');
    // $('#through_id').empty().append('<option value="">Select</option>');
    console.log('Supplier-ID:', supplier_id); // Adjusted for clarity

    $.ajax({
        type: 'POST',  // Change to POST 
        url: '/get_grey_out_lot_lists/',
        data: {
            'supplier_id': supplier_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()  // Include CSRF token
        },

        success: function(data) {
            if (data.orders && data.orders.length > 0) {
                data.orders.forEach(function(po) {
                    $('#lot_name').append('<option value="' + po.lot_no + '">' + po.lot_no + '</option>');

                });
            }
    

        },
        error: function(xhr, status, error) {
            console.error('Error loading PO lists:', error);
        } 
    });
} 


$(document).ready(function () {
    $('#lot_name').on('change', function () {
        const isGreyChecked = $('#is_grey_fabric').is(':checked');
        const selectedLot = $(this).val();

        if (isGreyChecked && selectedLot) {
            LoadOutward_List(); // Only load if grey fabric is checked and lot selected
        } else {
            console.log("Grey fabric not checked or lot not selected.");
        }
    });
});



function LoadOutward_List() {
    var supplier_id = $('#supplier_id').val(); 
    var lot_name = $('#lot_name').val(); 

    $('#do_list').empty().append('<option value="">Select</option>');
    $('#through_id').empty().append('<option value="">Select</option>');

    $.ajax({
        type: 'POST',
        url: '/get_grey_outward_lists/',
        data: {
            'supplier_id': supplier_id,
            'lot_no': lot_name,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },

        success: function(data) {
            // Populate DO list
            if (data.orders && data.orders.length > 0) {
                data.orders.forEach(function(po) {
                    $('#do_list').append(
                        '<option value="' + po.id + '">' + po.do_number + ' - ' + po.lot_no + ' (' + po.total_wt + ' kg)</option>'
                    );
                });
            }


        },

        error: function(xhr, status, error) {
            console.error('Error loading PO lists:', error);
        }
    });
}



$('#do_list').on('change', function () {
  LoadOutward_Color();
});





function LoadOutward_Color() {
    var supplier_id = $('#supplier_id').val(); 
    var lot_name = $('#lot_name').val(); 
    var outward_id = $('#do_list').val();  

    $.ajax({
        type: 'POST', 
        url: '/get_grey_outward_color_list/', 
        data: {
            'supplier_id': supplier_id,
            'lot_no': lot_name,
            'outward_id': outward_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },

        success: function(data) {
            $('#color_id').empty().append('');
            // $('#color_id').empty().append('<option value="">Select</option>');

            if (data.color && data.color.length > 0) {
                data.color.forEach(function(color) {
                    $('#color_id').append(
                        '<option value="' + color.id + '">' + color.name + '</option>'
                    );
                });
            }
        },
        error: function(xhr, status, error) { 
            console.error('Error loading outward delivery details:', error);
        }
    });
}





function LoadOutwarddetail_List() {
    var supplier_id = $('#supplier_id').val(); 
    var lot_name = $('#lot_name').val(); 
    var outward_id = $('#do_list').val(); 

    $.ajax({
        type: 'POST', 
        url: '/get_grey_outward_delivery_lists/', 
        data: {
            'supplier_id': supplier_id,
            'lot_no': lot_name,
            'outward_id': outward_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },

        success: function(data) {
            $('#through_id').empty().append('');
            // $('#through_id').empty().append('<option value="">Select</option>');

            if (data.order_through && data.order_through.length > 0) {
                data.order_through.forEach(function(party) {
                    $('#through_id').append(
                        '<option value="' + party.id + '">' + party.name + '</option>'
                    );
                });
            }
        },
        error: function(xhr, status, error) { 
            console.error('Error loading outward delivery details:', error);
        }
    });
}




// ``````````````````````````````````````````````````````````````````````````````



// function LoadOutward() {
//     // <!-- var outward_list = $('#do_list').val(); -->
// 	var lot_no = $('#lot_name').val(); // Usually an array if multiple select
// 	var prg_id = $('#prg_id').val(); // Usually an array if multiple select
// 	var outward_list_array = $('#do_list').val(); // Usually an array if multiple select
//     var outward_list = '';

//     if (Array.isArray(outward_list_array)) {
//         outward_list = outward_list_array.join(',');  // Convert array to comma-separated string
//     } else {
//         outward_list = outward_list_array || '';
//     }
	
	
//     console.log('Supplier-ID:', outward_list);
//     $('#purchaseTable tbody').empty();

//     // Get all delivery IDs already used in purchaseTable
//     let usedDeliverIds = [];
//     $('#purchaseTable tbody tr').each(function () {
//         let deliver_id = $(this).find('#deliver_id').text();
//         if (deliver_id) {
//             usedDeliverIds.push(deliver_id);
//         }
//     });

//     $.ajax({
//         type: 'POST',
//         url: '/get_grey_outward_detail_lists/',
//         data: {
//             'outward_list': outward_list,
//             'used_deliver_ids': JSON.stringify(usedDeliverIds),  // Send as JSON string
//             'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
//         },
//         success: function(data) {
//             // Reset dropdowns and form fields
//             $('#deliver_to').empty().append('<option value="">Select</option>');
//             // $('#prg_id').empty().append('<option value="">Select</option>');

           
//             $("#gauge_id").val('').trigger("change");
//             $("#tex_id").val('').trigger("change");
//             $("#yarn_count_id").val('').trigger("change");
//             $("#gsm").val('');
//             $("#prg_id").val('');
//             $("#roll").val('');
//             $("#roll_wt").val('');  
//             $("#quantity").val('');  
//             $("#gross_wt").val(''); 
//             $("#po_id").val('');
//             $("#out_id").val('');
//             console.log('prgs:',data.program);
//             // Load Deliver To dropdown
//             if (data.delivery_to && data.delivery_to.length > 0) {
//                 data.delivery_to.forEach(function(item) {
//                     $('#deliver_to').append('<option value="' + item.party_id + '">' + item.party_name + '</option>');
//                 });
//             }
//             $('#prg_id').val(data.program_id);
      
//             // Update PO Bag and Quantity totals
//             $('#po_bag_total').text(parseFloat(data.po_bag || 0).toFixed(2));
//             $('#po_quantity_total').text(parseFloat(data.po_quantity || 0).toFixed(2));
//             $('#inward_bag_total').text(parseFloat(data.inward_bag || 0).toFixed(2));
//             $('#inward_quantity_total').text(parseFloat(data.inward_quantity || 0).toFixed(2));

//             const balance_bag = (parseFloat(data.po_bag) || 0) - (parseFloat(data.inward_bag) || 0);
//             const balance_quantity = (parseFloat(data.po_quantity) || 0) - (parseFloat(data.inward_quantity) || 0);
//             $('#balance_bag_total').text(balance_bag.toFixed(2));
//             $('#balance_quantity_total').text(balance_quantity.toFixed(2));
 
//             // Logic to add rows if no deliveries but program_details exist
//             // if ((!data.deliveries || data.deliveries.length === 0) && Array.isArray(data.program_details) && data.program_details.length > 0) {

//             if (Array.isArray(data.program) && data.program.length > 0) {
//                 const firstProgram = data.program[0];
                
//                 if (firstProgram.id) {
//                     $("#program").val(firstProgram.id).trigger("change");
//                 }

//             }

//             if (data.fabric_id) {
//                 $("#fab_id").val(data.fabric_id).trigger("change");
//             }




//             if ((!data.deliveries || data.deliveries.length === 0) && Array.isArray(data.program_details) && data.program_details.length > 0) {
//                 // ✅ Sort by out_id (converted to number for proper numeric order)
//                 data.program_details.sort((a, b) => Number(a.out_id) - Number(b.out_id));

//                 // Determine selectedProgramIds array safely
//                 let selectedProgramIds = [];
//                 if (Array.isArray(data.program_id)) {
//                     selectedProgramIds = data.program_id.map(Number);
//                 } else if (data.program_id) {
//                     selectedProgramIds = [Number(data.program_id)];
//                 } else if (data.program && data.program.length > 0) {
//                     selectedProgramIds = data.program.map(p => Number(p.id));
//                 }

//                 // data.program_details.forEach((detail, index) => {

//                 // ✅ Sort by out_id so that rows are grouped properly
//                 data.program_details.sort((a, b) => Number(a.out_id) - Number(b.out_id));

//                 data.program_details.forEach((detail, index) => {

//                     console.log("Detail", index, detail);

//                     // Safely get program_name and fabric_name using fallback keys
//                     // Safely get program_name and fabric_name using fallback keys
//                     const programName = detail.program_name || (detail.program && detail.program.name) || '';
//                     console.log('prg-name:',programName);
//                     // Properly extract fabric name when it's in an array
//                     let fabricName = '';
//                     if (Array.isArray(detail.fabric) && detail.fabric.length > 0) {
//                         const fabricItem = detail.fabric[0];
//                         fabricName = `${fabricItem.name || ''} - ${fabricItem.fabric_name || ''}`.trim();
//                     } else if (typeof detail.fabric === 'object' && detail.fabric !== null) {
//                         fabricName = `${detail.fabric.fabric_name || ''} - ${detail.fabric.fabric_name || ''}`.trim();
//                     } else {
//                         fabricName = detail.fabric_name || '';
//                     }
 


//                      let fabricInfo = '';
//                     if (programName && fabricName) {
//                         fabricInfo = ` ${fabricName}`;
//                     } else if (programName) {
//                         fabricInfo = programName;
//                     } else if (fabricName) {
//                         fabricInfo = fabricName;
//                     } else if (detail.name) {
//                         fabricInfo = detail.name;
//                     } else {
//                         fabricInfo = 'N/A';
//                     }

                    

//                     let prg_name = '';
//                     if (programName ) {
//                         prg_name = `${programName} `;
//                     } else if (programName) {
//                         prg_name = programName;
//                     console.log("Fabric Info:", prg_name);

//                     }

//                     // console.log("Fabric Info:", fabricInfo);

//                     // Handle detail.program_id as array or single value
//                     let detailProgramIds = [];
//                     if (Array.isArray(detail.program_id)) {
//                         detailProgramIds = detail.program_id.map(Number);
//                     } else {
//                         detailProgramIds = [Number(detail.program_id)];
//                     }

//                     let pg_bal = detail.program_bal_value || [];
//                     let program_roll = 0, program_quantity = 0;
//                     let out_roll = 0, out_wt = 0;
//                     let total_roll = 0, total_wt = 0, total_balance_roll = 0, balance_wt = 0;
//                     pg_bal.forEach(entry => {
//                         console.log('entry:', entry);

//                         if (Number(entry.program_id) === Number(detail.program_id)) {
//                             program_roll = parseFloat(entry.pg_roll) || 0;
//                             program_quantity = parseFloat(entry.pg_wt) || 0;

//                             out_roll = parseFloat(entry.out_rolls) || 0;
//                             out_wt = parseFloat(entry.out_wt) || 0;


//                             total_roll = parseFloat(entry.in_rolls) || 0;
//                             total_wt = parseFloat(entry.in_wt) || 0;
//                             total_balance_roll = parseFloat(entry.balance_roll) || 0;
//                             balance_wt = parseFloat(entry.balance_wt) || 0;
//                         }
//                     });

                

//                     if (detailProgramIds.some(id => selectedProgramIds.includes(id))) {
                        
//                         addRow(
//                             fabricInfo || '',                         // fabric
//                             detail.yarn_count || '',                  // yarn_count
//                             detail.tex || '',                         // tex
//                             detail.gauge || '',                       // gauge
//                             detail.gsm || '',                         // gsm
//                             prg_name || '',                           // prg_name
//                             detail.dia || '',                         // dia
//                             detail.color || '',                         // dia

//                             // program_roll,
//                             // program_quantity,
//                             out_roll,
//                             out_wt,

//                             total_roll,
//                             total_wt,


//                             total_balance_roll,
//                             balance_wt,
//                             // total_roll - balance_roll,
//                             // total_wt - balance_wt,
//                             detail.inward_roll || 0,                  // inward_roll
//                             detail.inward_gross_wt || 0,              // inward_gross_wt
//                             detail.inward_total_wt || 0,              // inward_total_wt
//                             '',                                       // id
//                             detail.fabric_id || '',                   // fabricId
//                             '',                                       // tmId
//                             detail.po_id || 0,                                       // po_id
//                             '',                                       // deliver_id
//                             '',                                       // lot_name
//                             false,                                    // isInward
//                             detail.program_id || '',                  // prg_id
//                             lot_no,                                   // lot_no
//                             detail.yarn_count_id || '',               // yarn_countId
//                             detail.tex_id || '',                      // texId
//                             detail.gauge_id || '',                    // gaugeId
//                             detail.dia_id || '',                      // diaId
//                             detail.color_id || '',                      // diaId
//                             detail.out_id || 0,                      // outId
//                             detail.program_id || ''                   // program_id
//                         );



//                     } else {
//                         console.log("Skipping detail with program_id:", detail.program_id);
//                     }
//                 });
//             }
//         },
//         error: function(xhr, status, error) {
//             console.error('Error loading po lists:', error);
//         }
//     });
// }



// function LoadOutward() {
//     var lot_no = $('#lot_name').val();
//     var prg_id = $('#prg_id').val();
//     var outward_list_array = $('#do_list').val();
//     var outward_list = Array.isArray(outward_list_array) ? outward_list_array.join(',') : (outward_list_array || '');

//     var color_ids = $('#color_id').val();
//     var colorIds = Array.isArray(color_ids) ? color_ids.join(',') : (color_ids || '');

//     console.log('Supplier-ID:', outward_list);
//     $('#purchaseTable tbody').empty();

//     let usedDeliverIds = [];
//     $('#purchaseTable tbody tr').each(function () {
//         let deliver_id = $(this).find('#deliver_id').text();
//         if (deliver_id) usedDeliverIds.push(deliver_id);
//     });

//     $.ajax({
//         type: 'POST',
//         url: '/get_grey_outward_detail_lists/',
//         data: {
//             'outward_list': outward_list,
//             'color_id': colorIds,
//             'used_deliver_ids': JSON.stringify(usedDeliverIds),
//             'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
//         },
//         success: function (data) {
//             $('#deliver_to').empty().append('<option value="">Select</option>');

//             $("#gauge_id, #tex_id, #yarn_count_id").val('').trigger("change");
//             $("#gsm, #prg_id, #roll, #roll_wt, #quantity, #gross_wt, #po_id, #out_id").val('');

//             if (data.delivery_to && data.delivery_to.length > 0) {
//                 data.delivery_to.forEach(item => {
//                     $('#deliver_to').append(`<option value="${item.party_id}">${item.party_name}</option>`);
//                 });
//             }

//             $('#prg_id').val(data.program_id);

//             $('#po_bag_total').text(parseFloat(data.po_bag || 0).toFixed(2));
//             $('#po_quantity_total').text(parseFloat(data.po_quantity || 0).toFixed(2));
//             $('#inward_bag_total').text(parseFloat(data.inward_bag || 0).toFixed(2));
//             $('#inward_quantity_total').text(parseFloat(data.inward_quantity || 0).toFixed(2));

//             const balance_bag = (parseFloat(data.po_bag) || 0) - (parseFloat(data.inward_bag) || 0);
//             const balance_quantity = (parseFloat(data.po_quantity) || 0) - (parseFloat(data.inward_quantity) || 0);
//             $('#balance_bag_total').text(balance_bag.toFixed(2));
//             $('#balance_quantity_total').text(balance_quantity.toFixed(2));

//             if (Array.isArray(data.program) && data.program.length > 0) {
//                 const firstProgram = data.program[0];
//                 if (firstProgram.id) {
//                     $("#program").val(firstProgram.id).trigger("change");
//                 }
//             }

//             if (data.fabric_id) {
//                 $("#fab_id").val(data.fabric_id).trigger("change");
//             }

//             if (data.color_grouped_details && typeof data.color_grouped_details === 'object') {
//                 let selectedProgramIds = [];

//                 if (Array.isArray(data.program_id)) {
//                     selectedProgramIds = data.program_id.map(Number);
//                 } else if (data.program_id) {
//                     selectedProgramIds = [Number(data.program_id)];
//                 } else if (data.program && data.program.length > 0) {
//                     selectedProgramIds = data.program.map(p => Number(p.id));
//                 }

//                 Object.keys(data.color_grouped_details).forEach(colorId => {
//                     const diaDetails = data.color_grouped_details[colorId];
//                     let dias = [];
//                     let aggregated = {
//                         yarn_count: '', tex: '', gauge: '', gsm: '', fabricInfo: '', prg_name: '',
//                         out_roll: 0, out_wt: 0, in_roll: 0, in_wt: 0,
//                         balance_roll: 0, balance_wt: 0, inward_roll: 0, inward_gross_wt: 0, inward_total_wt: 0,
//                         fabric_id: '', po_id: 0, program_id: '', yarn_count_id: '', tex_id: '', gauge_id: '', dia_id: '', color_id: '', out_id: ''
//                     };

//                     Object.keys(diaDetails).forEach(diaId => {
//                         const details = diaDetails[diaId];

//                         details.forEach(detail => {
//                             let detailProgramIds = Array.isArray(detail.program_id)
//                                 ? detail.program_id.map(Number)
//                                 : [Number(detail.program_id)];

//                             if (!detailProgramIds.some(id => selectedProgramIds.includes(id))) return;

//                             dias.push(detail.dia || diaId);

//                             if (!aggregated.fabricInfo) {
//                                 const fabricName = Array.isArray(detail.fabric) && detail.fabric.length
//                                     ? `${detail.fabric[0].name || ''} - ${detail.fabric[0].fabric_name || ''}`
//                                     : (detail.fabric?.fabric_name || detail.fabric_name || '');

//                                 aggregated.fabricInfo = fabricName.trim() || detail.program_name || 'N/A';
//                                 aggregated.prg_name = detail.program_name || '';
//                                 aggregated.yarn_count = detail.yarn_count || '';
//                                 aggregated.tex = detail.tex || '';
//                                 aggregated.gauge = detail.gauge || '';
//                                 aggregated.gsm = detail.gsm || '';
//                                 aggregated.fabric_id = detail.fabric_id || '';
//                                 aggregated.po_id = detail.po_id || 0;
//                                 aggregated.program_id = detail.program_id || '';
//                                 aggregated.yarn_count_id = detail.yarn_count_id || '';
//                                 aggregated.tex_id = detail.tex_id || '';
//                                 aggregated.gauge_id = detail.gauge_id || '';
//                                 aggregated.dia_id = detail.dia_id || '';
//                                 aggregated.color_id = detail.color_id || '';
//                                 aggregated.out_id = detail.out_id || '';
//                             }

//                             const pg_bal = detail.program_bal_value || [];
//                             pg_bal.forEach(entry => {
//                                 if (Number(entry.program_id) === Number(detail.program_id)) {
//                                     aggregated.out_roll += parseFloat(entry.out_rolls) || 0;
//                                     aggregated.out_wt += parseFloat(entry.out_wt) || 0;
//                                     aggregated.in_roll += parseFloat(entry.in_rolls) || 0;
//                                     aggregated.in_wt += parseFloat(entry.in_wt) || 0;
//                                     aggregated.balance_roll += parseFloat(entry.balance_roll) || 0;
//                                     aggregated.balance_wt += parseFloat(entry.balance_wt) || 0;
//                                 }
//                             });

//                             aggregated.inward_roll += parseFloat(detail.inward_roll) || 0;
//                             aggregated.inward_gross_wt += parseFloat(detail.inward_gross_wt) || 0;
//                             aggregated.inward_total_wt += parseFloat(detail.inward_total_wt) || 0;
//                         });
//                     });
//                     let colorName = detail.color || colorIdNameMap[detail.color_id] || 'Unknown';

//                     if (dias.length > 0) {
//                         const uniqueDias = [...new Set(dias)].sort((a, b) => parseFloat(a) - parseFloat(b));
//                         addRow(
//                             aggregated.fabricInfo,
//                             aggregated.yarn_count,
//                             aggregated.tex,
//                             aggregated.gauge,
//                             aggregated.gsm,
//                             aggregated.prg_name,
//                             colorName, // or use actual color name if available
//                             uniqueDias,
//                             aggregated.out_roll,
//                             aggregated.out_wt,
//                             aggregated.in_roll,
//                             aggregated.in_wt,
//                             aggregated.balance_roll,
//                             aggregated.balance_wt,
//                             aggregated.inward_roll,
//                             aggregated.inward_gross_wt,
//                             aggregated.inward_total_wt,
//                             '',
//                             aggregated.fabric_id,
//                             '',
//                             aggregated.po_id,
//                             '',
//                             '',
//                             false,
//                             aggregated.program_id,
//                             lot_no,
//                             aggregated.yarn_count_id,
//                             aggregated.tex_id,
//                             aggregated.gauge_id,
//                             aggregated.dia_id,
//                             aggregated.color_id,
//                             aggregated.out_id,
//                             aggregated.program_id
//                         );
//                     }
//                 });
//             }
//         },
//         error: function (xhr, status, error) {
//             console.error('Error loading po lists:', error);
//         }
//     });
// }




// function LoadOutward() {
//     var lot_no = $('#lot_name').val();
//     var prg_id = $('#prg_id').val();
//     var outward_list_array = $('#do_list').val();
//     var outward_list = Array.isArray(outward_list_array) ? outward_list_array.join(',') : (outward_list_array || '');

//     var color_ids = $('#color_id').val();
//     var colorIds = Array.isArray(color_ids) ? color_ids.join(',') : (color_ids || '');

//     console.log('Supplier-ID:', outward_list);
//     $('#purchaseTable tbody').empty();

//     let usedDeliverIds = [];
//     $('#purchaseTable tbody tr').each(function () {
//         let deliver_id = $(this).find('#deliver_id').text();
//         if (deliver_id) usedDeliverIds.push(deliver_id);
//     });

//     $.ajax({
//         type: 'POST',
//         url: '/get_grey_outward_detail_lists/',
//         data: {
//             'outward_list': outward_list,
//             'color_id': colorIds,
//             'used_deliver_ids': JSON.stringify(usedDeliverIds),
//             'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
//         },
//         success: function (data) {
//             $('#deliver_to').empty().append('<option value="">Select</option>');
//             $("#gauge_id, #tex_id, #yarn_count_id").val('').trigger("change");
//             $("#gsm, #prg_id, #roll, #roll_wt, #quantity, #gross_wt, #po_id, #out_id").val('');

//             if (data.delivery_to?.length > 0) {
//                 data.delivery_to.forEach(item => {
//                     $('#deliver_to').append(`<option value="${item.party_id}">${item.party_name}</option>`);
//                 });
//             }

//             $('#prg_id').val(data.program_id);

//             $('#po_bag_total').text(parseFloat(data.po_bag || 0).toFixed(2));
//             $('#po_quantity_total').text(parseFloat(data.po_quantity || 0).toFixed(2));
//             $('#inward_bag_total').text(parseFloat(data.inward_bag || 0).toFixed(2));
//             $('#inward_quantity_total').text(parseFloat(data.inward_quantity || 0).toFixed(2));

//             const balance_bag = (parseFloat(data.po_bag) || 0) - (parseFloat(data.inward_bag) || 0);
//             const balance_quantity = (parseFloat(data.po_quantity) || 0) - (parseFloat(data.inward_quantity) || 0);
//             $('#balance_bag_total').text(balance_bag.toFixed(2));
//             $('#balance_quantity_total').text(balance_quantity.toFixed(2));

//             if (Array.isArray(data.program) && data.program.length > 0) {
//                 const firstProgram = data.program[0];
//                 if (firstProgram.id) {
//                     $("#program").val(firstProgram.id).trigger("change");
//                 }
//             }

//             if (data.fabric_id) {
//                 $("#fab_id").val(data.fabric_id).trigger("change");
//             }

//             // Build color ID to name map
//             let colorIdNameMap = {};
//             if (Array.isArray(data.color_list)) {
//                 data.color_list.forEach(c => {
//                     colorIdNameMap[c.id] = c.name;
//                 });
//             }

//             if (data.color_grouped_details && typeof data.color_grouped_details === 'object') {
//                 let selectedProgramIds = [];
//                 if (Array.isArray(data.program_id)) {
//                     selectedProgramIds = data.program_id.map(Number);
//                 } else if (data.program_id) {
//                     selectedProgramIds = [Number(data.program_id)];
//                 } else if (Array.isArray(data.program)) {
//                     selectedProgramIds = data.program.map(p => Number(p.id));
//                 }

//                 Object.keys(data.color_grouped_details).forEach(colorId => {
//                     const diaDetails = data.color_grouped_details[colorId];

//                     Object.keys(diaDetails).forEach(diaId => {
//                         const detailsArray = diaDetails[diaId];

//                         detailsArray.forEach(detail => {
//                             const programName = detail.program_name || (detail.program?.name) || '';
//                             let fabricName = '';

//                             if (Array.isArray(detail.fabric) && detail.fabric.length > 0) {
//                                 const fabricItem = detail.fabric[0];
//                                 fabricName = `${fabricItem.name || ''} - ${fabricItem.fabric_name || ''}`.trim();
//                             } else if (typeof detail.fabric === 'object' && detail.fabric !== null) {
//                                 fabricName = `${detail.fabric.fabric_name || ''}`.trim();
//                             } else {
//                                 fabricName = detail.fabric_name || '';
//                             }

//                             const fabricInfo = fabricName || programName || detail.name || 'N/A';
//                             const prg_name = programName || '';
//                             const detailProgramIds = Array.isArray(detail.program_id)
//                                 ? detail.program_id.map(Number)
//                                 : [Number(detail.program_id)];

//                             let out_roll = 0, out_wt = 0;
//                             let total_roll = 0, total_wt = 0;
//                             let total_balance_roll = 0, balance_wt = 0;

//                             const pg_bal = detail.program_bal_value || [];
//                             pg_bal.forEach(entry => {
//                                 if (Number(entry.program_id) === Number(detail.program_id)) {
//                                     out_roll = parseFloat(entry.out_rolls) || 0;
//                                     out_wt = parseFloat(entry.out_wt) || 0;
//                                     total_roll = parseFloat(entry.in_rolls) || 0;
//                                     total_wt = parseFloat(entry.in_wt) || 0;
//                                     total_balance_roll = parseFloat(entry.balance_roll) || 0;
//                                     balance_wt = parseFloat(entry.balance_wt) || 0;
//                                 }
//                             });

//                             const colorName = detail.color || colorIdNameMap[detail.color_id] || 'Unknown';

//                             if (detailProgramIds.some(id => selectedProgramIds.includes(id))) {
//                                 addRow(
//                                     fabricInfo,
//                                     detail.yarn_count || '',
//                                     detail.tex || '',
//                                     detail.gauge || '',
//                                     detail.gsm || '',
//                                     prg_name,
//                                     colorName, // ✅ Now shows proper color name
//                                     detail.dia || '',
//                                     out_roll,
//                                     out_wt,
//                                     total_roll,
//                                     total_wt,
//                                     total_balance_roll,
//                                     balance_wt,
//                                     detail.inward_roll || 0,
//                                     detail.inward_gross_wt || 0,
//                                     detail.inward_total_wt || 0,
//                                     '',
//                                     detail.fabric_id || '',
//                                     '',
//                                     detail.po_id || 0,
//                                     '',
//                                     '',
//                                     false,
//                                     detail.program_id || '',
//                                     lot_no,
//                                     detail.yarn_count_id || '',
//                                     detail.tex_id || '',
//                                     detail.gauge_id || '',
//                                     detail.dia_id || '',
//                                     detail.color_id || '',
//                                     detail.out_id || 0,
//                                     detail.program_id || ''
//                                 );
//                             } else {
//                                 console.log("Skipping detail with program_id:", detail.program_id);
//                             }
//                         });
//                     });
//                 });
//             }
//         },
//         error: function (xhr, status, error) {
//             console.error('Error loading po lists:', error);
//         }
//     });
// }





function LoadOutward() {
  const lot_no = $('#lot_name').val();
  const outward_list = Array.isArray($('#do_list').val()) ? $('#do_list').val().join(',') : ($('#do_list').val() || '');
  const colorIds = Array.isArray($('#color_id').val()) ? $('#color_id').val().join(',') : ($('#color_id').val() || '');

  console.log('Supplier-ID:', outward_list);
//   $('#purchaseTable tbody').empty();

  const usedDeliverIds = [];
  $('#purchaseTable tbody tr').each(function () {
    const deliver_id = $(this).find('#deliver_id').text();
    if (deliver_id) usedDeliverIds.push(deliver_id);
  });

  $.ajax({
    type: 'POST',
    url: '/get_grey_outward_detail_lists/',
    data: {
      outward_list,
      color_id: colorIds,
      used_deliver_ids: JSON.stringify(usedDeliverIds),
      csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
    },
    success: function (data) {
      // Reset filters
      $('#deliver_to').html('<option value="">Select</option>');
      $("#gauge_id,#tex_id,#yarn_count_id").val('').trigger("change");
      $("#gsm,#prg_id,#roll,#roll_wt,#quantity,#gross_wt,#po_id,#out_id").val('');

      // Populate Deliver To
      if (Array.isArray(data.delivery_to)) {
        data.delivery_to.forEach(item =>
          $('#deliver_to').append(`<option value="${item.party_id}">${item.party_name}</option>`)
        );
      }

      $('#prg_id').val(data.program_id);
      $('#po_bag_total').text((data.po_bag || 0).toFixed(2));
      $('#po_quantity_total').text((data.po_quantity || 0).toFixed(2));
      $('#inward_bag_total').text((data.inward_bag || 0).toFixed(2));
      $('#inward_quantity_total').text((data.inward_quantity || 0).toFixed(2));
      const bb = (data.po_bag - data.inward_bag);
      const bq = (data.po_quantity - data.inward_quantity);
      $('#balance_bag_total').text(bb.toFixed(2));
      $('#balance_quantity_total').text(bq.toFixed(2));

      if (Array.isArray(data.program) && data.program[0]?.id) {
        $("#program").val(data.program[0].id).trigger("change");
      }
      if (data.fabric_id) {
        $("#fab_id").val(data.fabric_id).trigger("change");
      }

      // Build color ID → name map (if provided)
      const colorIdNameMap = {};
      if (Array.isArray(data.color_list)) {
        data.color_list.forEach(c => colorIdNameMap[c.id] = c.name);
      }

      // Group data by color
      const grouped = {};
      const selProg = Array.isArray(data.program_id)
        ? data.program_id.map(Number)
        : ([data.program_id].filter(x => x).map(Number));

      for (const colorId in data.color_grouped_details || {}) {
        const byDia = data.color_grouped_details[colorId];
        Object.values(byDia).flat().forEach(detail => {
          const pids = Array.isArray(detail.program_id)
            ? detail.program_id.map(Number)
            : [Number(detail.program_id)];
          if (!pids.some(x => selProg.includes(x))) return;

          const cid = detail.color_id;
          const cname = detail.color || colorIdNameMap[cid] || 'Unknown';
          const dia = detail.dia;

          const fabricInfo = Array.isArray(detail.fabric)
            ? `${detail.fabric[0]?.name} - ${detail.fabric[0]?.fabric_name}`.trim()
            : (detail.fabric?.fabric_name || detail.fabric_name || '');

          const entry = grouped[cid] ??= {
            colorName: cname,
            dias: new Set(),
            detail
          };
          entry.dias.add(dia);
        });
      }


    for (const cid in data.color_grouped_details || {}) {
    const diaGroups = data.color_grouped_details[cid];
    const allDetails = [];

    // Flatten and collect all details per color
    for (const dia_id in diaGroups) {
        diaGroups[dia_id].forEach(detail => {
        allDetails.push(detail);
        });
    }

    // Sort details by dia (optional)
    allDetails.sort((a, b) => Number(a.dia) - Number(b.dia));

    // Group row for color using rowspan
    const rowspan = allDetails.length;
    let isFirstRow = true;

    allDetails.forEach(detail => {
        const pg = (detail.program_bal_value || []).find(
        e => e.program_id == detail.program_id &&
            e.dia_id == detail.dia_id &&
            e.color_id == detail.color_id
        ) || {};

        const colorCell = isFirstRow
        ? `<td rowspan="${rowspan}" style="vertical-align: middle; text-align: center;">${detail.color || colorIdNameMap[detail.color_id] || 'Unknown'}</td>`
        : ''; // no color cell for subsequent rows


        const exists = document.querySelector(
    `#purchaseTable tbody tr td#programId[value="${detail.program_id}"]` // select all rows
    );

let rowExists = false;
$("#purchaseTable tbody tr").each(function () {
  const pid = $(this).find("#programId").text();
  const cid = $(this).find("#color_id").text();
  const did = $(this).find("#dia_id").text();

  if (parseInt(pid) === detail.program_id &&
      parseInt(cid) === detail.color_id &&
      parseInt(did) === detail.dia_id) {
    rowExists = true;
    return false; // break
  }
});

if (!rowExists) {
    addRow(
      fabricNameFrom(detail),
      detail.yarn_count || '',
      detail.tex || '',
      detail.gauge || '',
      detail.gsm || '',
      detail.program_name || '', 
    colorCell,

      detail.dia || '', 
      detail.lot_roll || 0, 
      detail.lot_roll_wt || 0,
      pg.out_rolls || 0,
      pg.out_wt || 0,

      pg.in_rolls || 0, 
      pg.in_gross_wt || 0,
      pg.in_wt || 0,

      pg.balance_roll || 0,
      pg.balance_wt || 0,
    //   detail.inward_roll || 0,
    //   detail.inward_gross_wt || 0,
    //   detail.inward_total_wt || 0,
      '', detail.fabric_id, '', detail.po_id, '', '', false,
      detail.program_id, lot_no,
      detail.yarn_count_id, detail.tex_id,
      detail.gauge_id, detail.dia_id,
      detail.color_id, detail.out_id,
      detail.program_id
    );
    updateFooterTotals();
}

    isFirstRow = false;
  });
}


    },
    error: function (xhr) {
      console.error('Error loading outward:', xhr);
    }
  });
}

// Helper for fabric name
function fabricNameFrom(detail) {
  if (Array.isArray(detail.fabric) && detail.fabric.length) {
    const f = detail.fabric[0];
    return `${f.name || ''} - ${f.fabric_name || ''}`.trim();
  }
  return detail.fabric?.fabric_name || detail.fabric_name || '';
}



$('#roll, #roll_wt').on('input', function () {
    const roll = parseFloat($('#roll').val()) || 0;
    const roll_wt = parseFloat($('#roll_wt').val()) || 0;
    const quantity = roll * roll_wt;
    $('#total_wt').val(quantity.toFixed(2));
});

// ````````````````````````````````````add in row ````````````````````````````````




function addManualRow() {
    console.log("Manual row function triggered");

    const fabric = $("#fabric_id option:selected").text();
    const fabricId = $("#fabric_id").val();
    
    const yarn_count = $("#yarn_count_id option:selected").text();
    const yarn_countId = $("#yarn_count_id").val();

    const tex = $("#tex_id option:selected").text();
    const texId = $("#tex_id").val();

    const gauge = $("#gauge_id option:selected").text();
    const gaugeId = $("#gauge_id").val();

    const dia = $("#dia_id option:selected").text();
    const diaId = $("#dia_id").val();
    const outId = $("#out_id").val()||0;

 
    const gsm = $("#gsm").val(); 
    const roll = $("#roll").val(); 
    const gross_wt =$("#gross_wt").val() ||0;
    const roll_wt = $("#roll_wt").val();
    const quantity = $("#total_wt").val() || 0;
    const lot_name = $("#lot_name").val();
    const tmId = 0;
    const id = 0;
    const tx_id = $("#tx_id").val() || 0;
    const prg_id = $("#prg_id").val() || 0;
    const lot_no = $("#lot_name").val() || 0;
    const po_id = $("#po_id").val();
    const deliver_to = $("#deliver_to option:selected").text() || '-';
    const deliver_id = $("#deliver_to").val() || 0;


    // Validate bag value
    if (roll <= 0) {
        notifier.show(
            'Error!',
            'Cannot add. Roll value must be greater than 0.',
            'error',
            "{% static 'assets/images/notification/high_priority-48.png' %}",
            4000
        );
        return;
    }

    // Proceed to add the row after validation
    addRow(
        fabric,yarn_count,tex,gauge,gsm, 
            dia,roll, roll_wt, quantity,gross_wt, id, fabricId,
            tmId, po_id, deliver_id, 
            lot_name, prg_id, lot_no, yarn_countId, 
            texId, gaugeId, diaId,outId,


             //  fabric,yarn_count,tex,gauge,gsm, gross_wt, roll, roll_wt, quantity,
             // id, fabricId, tmId, po_id, deliver_id, lot_name,prg_id,lot_no,yarn_countId,texId,gaugeId,diaId
        );
}





const loadedItemsMap = {};
let rowCounter = 0; // 

// Helper to check if a color already exists in the table
function isColorAlreadyAdded(color) {
    const rows = document.querySelectorAll("#purchaseTable tbody tr");
    for (let row of rows) {
        const cellColor = row.children[2]?.textContent?.trim();
        if (cellColor === color) {
            return true;
        }
    }
    return false;
}





// ```````````````````````````````````````add row function ``````````````````````````````````

function addRow(
  fabric, yarn_count, tex, gauge, gsm,
  prg_name, colorCell, dia,
  lot_roll, lot_roll_wt,
  total_roll, total_roll_wt,
  inward_roll, inward_gross_wt, inward_total_wt, balance_roll, balance_roll_wt,
  id, fabricId,
  tmId, po_id, deliver_id,
  lot_name, isInward, prg_id, lot_no,
  yarn_countId, tex_id, gauge_id, dia_id,
  color_id, out_id, program_id
) {
  if (!Array.isArray(dia)) dia = [dia];

  lot_roll = parseFloat(lot_roll) || 0;
  lot_roll_wt = parseFloat(lot_roll_wt) || 0;
  total_roll = parseFloat(total_roll) || 0;
  total_roll_wt = parseFloat(total_roll_wt) || 0;
  balance_roll = parseFloat(balance_roll) || 0;
  balance_roll_wt = parseFloat(balance_roll_wt) || 0;
  inward_roll = parseFloat(inward_roll) || 0;
  inward_gross_wt = parseFloat(inward_gross_wt) || 0;

  rowCounter++;
  const rowId = `row_${rowCounter}`;
  const tbody = document.querySelector("#purchaseTable tbody");

  const newRow = document.createElement("tr");
  newRow.setAttribute("data-row-id", rowId);

  newRow.innerHTML = `
    ${colorCell}
    <td>${dia}</td>
    <td class="total-roll">${total_roll}</td>
    <td class="total-roll-wt" style="text-align:center;">${total_roll_wt.toFixed(3)}</td>
    <td class="rec-roll">${inward_roll.toFixed(2)}</td>
    <td class="rec-roll-wt" style="text-align:center;">${inward_gross_wt.toFixed(3)}</td>
    <td><input type="number" class="form-control inward-roll" value="${balance_roll}" min="0" step="1" style="border: none;"></td>
    <td><input type="number" class="form-control inward-gross-wt" value="${balance_roll_wt.toFixed(3)}" min="0" step="0.01" style="border: none; text-align: center;"></td>
    <td class="inward-roll-wt" style="text-align:center;display:none;">${balance_roll_wt.toFixed(3)}</td>

    <td style="display:none" id="fabric_id">${fabricId}</td>
    <td style="display:none" id="po_id">${po_id}</td>
    <td style="display:none">${prg_id}</td>
    <td style="display:none" id="lot_no">${lot_no}</td>
    <td style="display:none" id="dia_id">${dia_id}</td>
    <td style="display:none" id="color_id">${color_id}</td>
    <td style="display:none" id="out_id">${out_id}</td>
    <td style="display:none" id="programId">${program_id}</td> 
    <td style="display:none">${tmId}</td>
    <td style="display:none">${id}</td>
    <td>
      <button class="btn btn-danger btn-xs remove-row"><i class="feather icon-trash-2"></i></button>
    </td>
  `;

  tbody.appendChild(newRow);

  const inwardRollInput = newRow.querySelector(".inward-roll");
  const inwardGrossWtInput = newRow.querySelector(".inward-gross-wt");
  const inwardRollWtDisplay = newRow.querySelector(".inward-roll-wt");
  const balanceRollDisplay = newRow.querySelector(".balance-roll");
  const balanceRollWtDisplay = newRow.querySelector(".balance-roll-wt");

  inwardRollInput.addEventListener("input", () => {
    const inwardVal = parseFloat(inwardRollInput.value) || 0;
    const avgWt = lot_roll ? (lot_roll_wt / lot_roll) : 0;
    const newGross = inwardVal * avgWt;

    inwardGrossWtInput.value = newGross.toFixed(3);
    inwardRollWtDisplay.textContent = newGross.toFixed(3);
    balanceRollDisplay.textContent = (balance_roll - inwardVal).toFixed(2);
    balanceRollWtDisplay.textContent = (balance_roll_wt - newGross).toFixed(3);

    updateFooterTotals();
  });

  newRow.querySelector(".remove-row").addEventListener("click", () => {
    newRow.remove();
    updateFooterTotals();
  });

  updateFooterTotals();
}

function updateFooterTotals() {
  let outwardRoll = 0, outwardWt = 0;
  let receivedRoll = 0, receivedWt = 0;
  let inwardRoll = 0, inwardGrossWt = 0, inwardRollWt = 0;

  $("#purchaseTable tbody tr").each(function () {
    outwardRoll += parseFloat($(this).find(".total-roll").text()) || 0;
    outwardWt += parseFloat($(this).find(".total-roll-wt").text()) || 0;

    receivedRoll += parseFloat($(this).find(".balance-roll").text()) || 0;
    receivedWt += parseFloat($(this).find(".balance-roll-wt").text()) || 0;

    inwardRoll += parseFloat($(this).find(".inward-roll").val()) || 0;
    inwardGrossWt += parseFloat($(this).find(".inward-gross-wt").val()) || 0;
    inwardRollWt += parseFloat($(this).find(".inward-roll-wt").text()) || 0;
  });

  $("#footer-outward-roll").text(outwardRoll);
  $("#footer-outward-wt").text(outwardWt.toFixed(3));
  $("#footer-received-roll").text(receivedRoll);
  $("#footer-received-wt").text(receivedWt.toFixed(3));
  $("#footer-inward-roll").text(inwardRoll);
  $("#footer-inward-gross-wt").text(inwardGrossWt.toFixed(3));
  $("#footer-inward-roll-wt").text(inwardRollWt.toFixed(3));
}




$('#purchaseTable').on('input', '.inward-roll, .inward-gross-wt', function () {
    updateFooterTotals();
});




// window.addEventListener('load', function () {
//     sessionStorage.clear(); // Clears session storage on page reload
//     localStorage.removeItem('selectedItems'); // Clears only the selectedItems key from localStorage
// });

// function updateFooterTotals_bk_14() {
//     let totalRoll = 0;
//     let totalGrossWt = 0;

//     document.querySelectorAll("#purchaseTable tbody .inward-roll").forEach(input => {
//         totalRoll += parseFloat(input.value) || 0;
//     });
 
//     document.querySelectorAll("#purchaseTable tbody .inward-gross-wt").forEach(input => {
//         totalGrossWt += parseFloat(input.value) || 0; 
//     });

//     document.getElementById("footer-roll-total").textContent = totalRoll.toFixed(0);
//     document.getElementById("footer-gross-wt-total").textContent = totalGrossWt.toFixed(3);
// }


// $("#footer-outward-roll").text(totalOutwardRoll.toFixed(0));
// $("#footer-outward-wt").text(totalOutwardWt.toFixed(3));
// $("#footer-received-roll").text(totalAlreadyReceivedRoll.toFixed(0));
// $("#footer-received-wt").text(totalAlreadyReceivedWt.toFixed(3));
// $("#footer-inward-roll").text(totalInwardRoll.toFixed(0));
// $("#footer-inward-gross-wt").text(totalInwardGrossWt.toFixed(3));
// $("#footer-inward-roll-wt").text(totalInwardRollWt.toFixed(3));

function updateFooterTotalsss() {
    let totalOutwardRoll = 0;
    let totalOutwardWt = 0;

    let totalAlreadyReceivedRoll = 0;
    let totalAlreadyReceivedWt = 0;

    let totalInwardRoll = 0;
    let totalInwardGrossWt = 0;
    let totalInwardRollWt = 0;

    $("#purchaseTable tbody tr").each(function () {
        totalOutwardRoll += parseFloat($(this).find(".total-roll").text()) || 0;
        totalOutwardWt += parseFloat($(this).find(".total-roll-wt").text()) || 0;

        totalAlreadyReceivedRoll += parseFloat($(this).find(".balance-roll").text()) || 0;
        totalAlreadyReceivedWt += parseFloat($(this).find(".balance-roll-wt").text()) || 0;

        totalInwardRoll += parseFloat($(this).find(".inward-roll").val()) || 0;
        totalInwardGrossWt += parseFloat($(this).find(".inward-gross-wt").val()) || 0;
        totalInwardRollWt += parseFloat($(this).find(".inward-roll-wt").text()) || 0;
    });

    // Update footer cells
    $("#footer-roll-total").text(totalInwardRoll.toFixed(0));            // Roll (inward)
    $("#footer-gross-wt-total").text(totalInwardGrossWt.toFixed(3));     // Gross Wt (inward)

    // Optional: display other footer values in hidden rows or console log
    console.log("Total Outward:", totalOutwardRoll, totalOutwardWt);
    console.log("Total Already Received:", totalAlreadyReceivedRoll, totalAlreadyReceivedWt);
    console.log("Total Inward:", totalInwardRoll, totalInwardGrossWt, totalInwardRollWt);
}





// function updateFooterTotals() {
//     let totalRoll = 0;
//     let totalGrossWt = 0;
//     let totalWeight = 0;

//     document.querySelectorAll("#purchaseTable tbody tr").forEach(row => {
//         const rollInput = row.querySelector(".inward-roll");
//         const grossInput = row.querySelector(".inward-gross-wt");
//         const weightDisplay = row.querySelector(".inward-roll-wt");

//         const rollVal = parseFloat(rollInput?.value) || 0;
//         const grossVal = parseFloat(grossInput?.value) || 0;
//         const weightVal = parseFloat(weightDisplay?.textContent) || 0;

//         totalRoll += rollVal;
//         totalGrossWt += grossVal;
//         totalWeight += weightVal;
//     });

//     // Display in footer cells
//     document.getElementById("qty_total_placeholder").textContent = totalRoll.toFixed(2);
//     document.getElementById("gross_total_placeholder").textContent = totalGrossWt.toFixed(3);
//     document.getElementById("roll_wt_total_placeholder").textContent = totalWeight.toFixed(3);
// }



// ````````````````````````` edit function `````````````````````````

var editIndex = -1; // Track the row being edited

function editRow(mrow) {
    // Get the row index and assign it to editIndex
    editIndex = $(mrow).closest('tr').index();

 
    // Fetch values from the selected table row
    var fabric = $(mrow).closest('tr').find('td:eq(0)').text().trim();
    var yarn_count = $(mrow).closest('tr').find('td:eq(1)').text().trim();
    var tex = $(mrow).closest('tr').find('td:eq(2)').text().trim();
    var gauge = $(mrow).closest('tr').find('td:eq(3)').text().trim();
    var gsm = $(mrow).closest('tr').find('td:eq(4)').text().trim();
    var dia = $(mrow).closest('tr').find('td:eq(5)').text().trim();
    var roll = $(mrow).closest('tr').find('td:eq(6)').text().trim();
    var roll_wt = $(mrow).closest('tr').find('td:eq(7)').text().trim();
    var gross_wt = $(mrow).closest('tr').find('td:eq(8)').text().trim();
    var quantity = $(mrow).closest('tr').find('td:eq(9)').text().trim();

    // Fetch hidden values
    var tmId = $(mrow).closest('tr').find('#tm_id').text().trim();
    var id = $(mrow).closest('tr').find('#id').text().trim();
    var fabricId = $(mrow).closest('tr').find('#fabric_id').text().trim();
    var diaId = $(mrow).closest('tr').find('#dia_id').text().trim();
    var yarn_countId = $(mrow).closest('tr').find('#yarn_count_id').text().trim();
    var texId = $(mrow).closest('tr').find('#tex_id').text().trim();
    var gaugeId = $(mrow).closest('tr').find('#gauge_id').text().trim();
    var program_id = $(mrow).closest('tr').find('#program_id').text().trim(); 
    var po_id = $(mrow).closest('tr').find('#po_id').text().trim(); 
    var receive_no = $(mrow).closest('tr').find('#receive_no').text().trim();
    var receive_date = $(mrow).closest('tr').find('#receive_date').text().trim();
    var deliver_id = $(mrow).closest('tr').find('#out_id').text().trim();
    var tx_id = $(mrow).closest('tr').find('#tx_id').text().trim();
    // Set form fields with extracted values
    // Set form fields with extracted values
    $("#dia_id").val(diaId).trigger("change");
    $("#fabric_id").val(fabricId).trigger("change");
    $("#yarn_count_id").val(yarn_countId).trigger("change");
    $("#tex_id").val(texId).trigger("change");
    $("#gauge_id").val(gaugeId).trigger("change");
    $("#deliver_to").val(deliver_id).trigger("change");
    $("#gsm").val(gsm);
    $("#roll").val(roll);
    $("#receive_no").val(receive_no);
    $("#receive_date").val(receive_date);
    $("#roll_wt").val(roll_wt);
    $("#total_wt").val(quantity);
    $("#gross_wt").val(gross_wt);
    
    // Store the values for backend reference if needed
    $("#tm_id").val(tmId);
    $("#tx_id").val(tx_id);
    $("#po_id").val(po_id);

    // Remove the row from the table (so it can be updated after editing)
    $(mrow).closest('tr').remove();
    // calculateTotalValue();
 
}


function storeTblValues() {
    const TableData = [];

    $('#purchaseTable tbody tr').each(function (index) {
        const row = $(this);

        const dia = row.find('td:eq(1)').text().trim();
        const color = row.find('td:eq(0)').text().trim() || row.prevAll('tr').find('td[rowspan]').first().text().trim();  // handle rowspan

        const lot_roll = row.find('.lot-roll').text().trim();
        const lot_roll_wt = row.find('.lot-roll-wt').text().trim();

        const total_received_roll = row.find('.total-roll').text().trim();
        const total_received_roll_wt = row.find('.total-roll-wt').text().trim();

        const balance_roll = row.find('.rec-roll').text().trim();
        const balance_roll_wt = row.find('.rec-roll-wt').text().trim();

        const roll = row.find('.inward-roll').val()?.trim() || '0';
        const gross_wt = row.find('.inward-gross-wt').val()?.trim() || '0';
        const wt_per_roll = row.find('.inward-roll-wt').text().trim();

        const fabric_id = row.find('#fabric_id').text().trim();
        const po_id = row.find('#po_id').text().trim();
        const prg_id = row.find('td:eq(13)').text().trim();
        const lot_no = row.find('#lot_no').text().trim();

        const dia_id = row.find('#dia_id').text().trim();
        const color_id = row.find('#color_id').text().trim();
        const outward_id = row.find('#out_id').text().trim();
        const program_id = row.find('#programId').text().trim();

        if (fabric_id) {
            TableData.push({
                "fabric_id": fabric_id,
                "dia_id": dia_id,
                "color_id": color_id,
                "roll": roll || 0,
                "roll_wt": wt_per_roll || 0,
                "quantity": 0, 
                "gross_wt": gross_wt || 0, 
                "po_id": po_id,
                "lot_no": lot_no,
                "outward_id": outward_id,
                "program_id": program_id,
            });
        } else {
            console.warn(`Row ${index + 1}: Skipped due to missing fabric_id.`);
        }
    });

    console.log('TABLE-DATA:', TableData);
    return TableData;
}



function storeTblValues_bk_1072025() {
    var TableData = [];

    $('#purchaseTable tbody tr').each(function(index) {
   
        var dia = $(this).find('td:eq(1)').text().trim();
        var color = $(this).find('td:eq(0)').text().trim();

        var lot_roll = $(this).find('td:eq(2)').text().trim();
        var lot_roll_wt = $(this).find('td:eq(3)').text().trim();

        var total_received_roll = $(this).find('td:eq(4)').text().trim();
        var total_received_roll_wt = $(this).find('td:eq(5)').text().trim();


        var balance_roll = $(this).find('td:eq(6)').text().trim();
        var balance_roll_wt = $(this).find('td:eq(7)').text().trim();


        var roll_input = $(this).find('td:eq(8) input');   
        var roll = roll_input.length ? roll_input.val().trim() : '0'; 

        var gross_wt_input = $(this).find('td:eq(9) input');
        console.log('gross_wt_input:',gross_wt_input);
        var gross_wt = gross_wt_input.length ? gross_wt_input.val().trim() : '0';

        console.log('g-wt:',gross_wt_input);
        var wt_per_roll = $(this).find('td:eq(10)').text().trim();
  
        
        var fabric_id = $(this).find('td:eq(11)').text().trim();
        var po_id = $(this).find('td:eq(12)').text().trim();
        var prg_id = $(this).find('td:eq(13)').text().trim();
        var lot_no = $(this).find('td:eq(14)').text().trim();
    
        
        var dia_id = $(this).find('td:eq(15)').text().trim(); 
        var color_id = $(this).find('td:eq(16)').text().trim(); 
        var outward_id = $(this).find('td:eq(17)').text().trim();
        var program_id = $(this).find('td:eq(18)').text().trim();

        console.log(`Row ${index + 1} - Data:`, { fabric_id, gross_wt, roll, wt_per_roll });

        if (fabric_id) {
            TableData.push({
                "fabric_id": fabric_id,
            
                "dia_id": dia_id,
                'color_id':color_id,
                // "fabric_name": fabric || 0,
                "roll": roll || 0,
                "roll_wt": wt_per_roll || 0,
                "quantity": 0,
                "gross_wt": gross_wt || 0,
                "po_id": po_id,
                "lot_no": lot_no,
                'outward_id':outward_id,
                'program_id':program_id,    
            });
        } else {
            console.warn(`Row ${index + 1}: Missing fabric_id, skipping...`);
        }
    });

    console.log('TABLE-DATA:', TableData);
    return TableData;
}

// ````````````````````````````` submit function ````````````````````````````````````````




$('#add_new').on('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    console.log("Submit button clicked"); // Debugging

    var TableData = storeTblValues();
    console.log('tbl-data:', TableData);

    if (TableData.length === 0) {
        // notifier.show(
        //     'Error!', 
        //     'Table is empty. Please insert the program details.', 
        //     'error', 
        //     "{% static 'assets/images/notification/high_priority-48.png' %}", 
        //     4000
        // ); 
        console.log('table is empty, please insert the data.');

        return;
    }

    if (confirm("Are you sure you want to save?")) {
        TableData = JSON.stringify(TableData); 
        var mdata = new FormData(this);
        mdata.append('chemical_data', TableData); 
        console.log('m-dsta:',mdata);

        var totalQty = $('#qty_total_placeholder').text();
        var totalGross = $('#gross_total_placeholder').text();
        var inw_no =$('#inward_no').val();
        // Append total values to FormData
        mdata.append('total_quantity', totalQty);  // This is where total_quantity is added 
        mdata.append('total_gross', totalGross);  // This is where total_quantity is added 
        mdata.append('inward_no', inw_no);  // This is where total_quantity is added 

        console.log('inw-no:',inw_no);
        

        $.ajax({
            type: "POST", 
            url: "/add-dyed-fab-inward/",
            data: mdata,
            processData: false,
            contentType: false,
            beforeSend: function() {
                console.log("Sending AJAX request...");
                $('#submit').attr('disabled', true).text('Processing...');
            },
            success: function(data) {
                console.log("Server Response:", data);
                $('#submit').attr('disabled', false).text('Save');

                if (data.status === 'success') {
                    notifier.show( 
                        'Well Done!', 
                        data.message || 'Added Successfully!', 
                        'success', 
                        "{% static 'assets/images/notification/ok-48.png' %}", 
                        4000
                    );  
 
					// <!-- $('#inward_no').val(data.inward_number); -->
				   // Temporarily enable, set the value, and disable again 
					$('#inward_no').prop('disabled', false);  // Enable the input
					$('#inward_no').val(data.inward_number);  // Set the value
					$('#inward_no').prop('disabled', true);   // Disable it again
					
					
                    // $('#add_new').trigger('reset'); 
                    //     // Clear dynamically added rows in the  table
                    $('#add_new').trigger('reset'); 
                    $('#purchaseTable tbody').empty(); 
                    $('#PO_summaryTable tbody').empty(); 
                    $('#supplier_id').val('').trigger("change");

                    $('#product_id').val('').trigger("change");
                    $('#po_list').val('').trigger("change");

                    $('#deliver_to').val('').trigger("change");

                    location.reload();
                } else {
                    notifier.show(
                        'Error!', 
                        data.message || 'Failed to add', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    ); 
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("AJAX Error:", textStatus, errorThrown);
                notifier.show(
                        'Error!', 
                        'Error adding data', 
                        'danger', 
                        "{% static 'assets/images/notification/high_priority-48.png' %}", 
                        4000
                    );  
                // alert('Error Adding data');
                $('#submit').attr('disabled', false).text('Save');
            }
        });
    }
});



// ```````````````````````````````````````````````````````````
$('.single-select').select2();

            // Get current date and time
    const currentDate = new Date();
    const currentDateString = currentDate.toISOString().slice(0, 10); // Format as YYYY-MM-DD
    const currentTimeString = currentDate.toTimeString().slice(0, 5); // Format as HH:     

    // Set default values for date and time fields
    document.getElementById('inward_date').value = currentDateString;
    // document.getElementById('receive_date').value = currentDateString;
    // document.getElementById('purchase_time').value = currentTimeString;



    


</script>