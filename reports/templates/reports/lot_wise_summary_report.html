{% include 'includes/header.html' %}
{% include 'includes/sidenavbar.html' %}
{% include 'includes/navbar.html' %}
{% load static %}


<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content"> 
                <div class="main-body">
                    <div class="page-wrapper">
                        
                        <div class="row"> 
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                        <!-- Breadcrumb moved here -->
                                        <div class="d-flex align-items-center">
                                            <div class="page-header-title">
  
                                                <h4 class="m-b-10 me-1  ">Summary Report</h4>
                                            </div> 


                                        </div> 
                                        <ul class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="/dashboard"><i class="feather icon-home"></i></a></li>
                                            <li class="breadcrumb-item">Report</li>
                                            <li class="breadcrumb-item"><a href="/dyed-fabric-summary-report">Lot-Wise Summary Report</a></li>
                                        </ul>
                                        
                                        <div class="card-header-right">
                                            <div class="btn-group card-option">
                                                <button type="button" class="btn dropdown-toggle btn-icon" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                    <i class="feather icon-more-horizontal"></i>
                                                </button>
                                                <ul class="list-unstyled card-option dropdown-menu dropdown-menu-end">
                                                    <li class="dropdown-item full-card"><a href="#!"><span><i class="feather icon-maximize"></i> maximize</span><span style="display:none"><i class="feather icon-minimize"></i> Restore</span></a></li>
                                                    <li class="dropdown-item minimize-card"><a href="#!"><span><i class="feather icon-minus"></i> collapse</span><span style="display:none"><i class="feather icon-plus"></i> expand</span></a></li>
                                                    <li class="dropdown-item reload-card"><a href="#!"><i class="feather icon-refresh-cw"></i> reload</a></li>
                                                    <li class="dropdown-item close-card"><a href="#!"><i class="feather icon-trash"></i> remove</a></li>
                                                </ul>
                                            </div>
                                        </div> 
                                    </div>
 
                                    <div class="card-body">  
                                        <div class="row">



                                            <div class="col-md-2 mt-2">
                                                <label class="form-label" for="yarn_count_id">Yarn Count</label>
                                                <!-- <select id="yarn_count_id" name="yarn_count_id" class="form-control  single-select" onchange="Loaddata()"> -->
                                                <select id="yarn_count_id" name="yarn_count_id" class="form-control  single-select" >
                                                    <option value="">Select </option>
                                                    {% for k in yarn %}
                                                    <option value="{{k.id}}"> {{k.name}} </option>

                                                    {% endfor %}
                                                    
                                                </select> 
                                            </div>
                                        
                                            <div class="col-md-2 mt-4">
                                                <button type="button" class="btn btn-gradient-success mt-3" onclick="Loaddata()">Load Stock</button> 

                                            </div>

                                        </div>                                      
                                        <div class="dt-responsive table-hover">
                                            <table id="purchaseTable" class="table table-striped table-bordered wrap w-100" cellpadding="0" cellspacing="0">
                                             
                                             {% csrf_token %} 
                                             
                                             <thead>
                                                    <tr>
                                                        <th>Yarn Count</th>
                                                        <th>Bag</th>
                                                        <th>per Bag Wt.</th>
                                                        <th>Gross Quantity</th>
                                                        <th>Party</th>
                                                        
                                                    </tr>
                                                </thead>
                                                <tbody>                            
                                                </tbody>
                                            </table>                                        
                                        </div>
                                    </div>
                                </div>                                      
                            </div>
                        </div>


                        
                            
                    </div>
                </div> 
            </div>
        </div>
    </div>
</div>

{% include 'includes/footer.html' %}
    
  

<script>

function Loaddata() {
    var yarn_count_id = $('#yarn_count_id').val();  
    console.log('Yarn-count-iD:', yarn_count_id);

    $.ajax({
        type: 'POST',
        url: '/get-yarn-summary-list/',
        data: {
            'yarn_count_id': yarn_count_id,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },

        success: function(data) {
            // Clear old options and add default
            $('#quality_id').empty().append('');
            $('#style_id').empty().append('');

            // Append quality if available  
            if (data.quality) {
                $('#quality_id').append(
                    '<option value="' + data.quality.id + '">' + data.quality.name + '</option>'
                );
                console.log('Quality:', data.quality.id, data.quality.name);
            }

            // Append style if available
            if (data.style) {
                $('#style_id').append(
                    '<option value="' + data.style.id + '">' + data.style.name + '</option>'
                );
                console.log('Style:', data.style.id, data.style.name);
            }

            // Assuming the actual table data is in data.data or just data if returned as array
            var tableData = data.data || data; // Adjust depending on your response structure
            
            // Clear the table body before appending new rows
            var tbody = $('#purchaseTable tbody');
            tbody.empty();

            // Check if tableData is an array and has values
            if (Array.isArray(tableData) && tableData.length > 0) {
                tableData.forEach(function(row) {
                    // Build the table row HTML
                    var tr = '<tr>' +
                        '<td>' + row.yarn_count + '</td>' +
                        '<td>' + row.bag + '</td>' +
                        '<td>' + row.bag_wt + '</td>' +
                        '<td>' + row.gross_quantity + '</td>' +
                        '<td>' + row.party + '</td>' +
                        '</tr>';

                    // Append the row to the table body
                    tbody.append(tr);
                });
            } else {
                // No data found, optionally add a row to indicate no records
                tbody.append('<tr><td colspan="5" class="text-center">No records found</td></tr>');
            }
        }, 

        error: function(xhr, status, error) {
            console.error('Error loading quality/style:', error);
        }
    });
}




const yarn = $('#yarn_count_id option:selected').text().trim();

// var yarn = $('#yarn_count_id').val();
console.log('yarn-id:', yarn);

if (yarn !== '' && !isNaN(yarn)) {
    var table = $('#purchaseTable').DataTable({
        language: {
            emptyTable: "Master purchase does not hold any data related to child table!"
        },
        processing: true,
        pageLength: 50,
        destroy: true,
        order: [],
        columns: [
            { data: "action", title: "Action" },
            { data: "yarn_count", title: "Yarn Count" },
            { data: "bag", title: "Bag" },
            { data: "bag_wt", title: "Bag Wt" },
            { data: "gross_quantity", title: "Gross Quantity" },
            { data: "party", title: "Party" },
            {
                data: "quantity",
                title: "Quantity",
                className: "text-center",
                render: function (data, type, row) {
                    const originalQty = row.original_quantity || data;
                    return `<span class="quantity" data-original-quantity="${originalQty}">${parseFloat(data).toFixed(3)}</span>`;
                }
            }
        ],
        ajax: {
            url: '/get-yarn-summary-list/',
            type: 'POST',
            data: function (data) {
                data.csrfmiddlewaretoken = $('[name="csrfmiddlewaretoken"]').val();
                data.yarn_count_id = yarn;
            },
            dataSrc: function (json) {
                console.log("Received JSON data:", json);
                if (json.status === "error") {
                    alert(json.message);
                    return [];
                }
                return json.data;
            }
        }
    });
} else {
    console.error("Invalid id:", yarn);
}


 function refresh_data() {
    if ($.fn.DataTable.isDataTable("#datatable")) { 
        $('#datatable').DataTable().ajax.reload(null, false);  // ✅ Refresh without resetting pagination
    }
 }

    $('.single-select').select2();

</script>